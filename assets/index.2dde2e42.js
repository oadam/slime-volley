var Sa=Object.defineProperty;var Wn=Object.getOwnPropertySymbols;var Ca=Object.prototype.hasOwnProperty,va=Object.prototype.propertyIsEnumerable;var Fi=(V,g,m)=>g in V?Sa(V,g,{enumerable:!0,configurable:!0,writable:!0,value:m}):V[g]=m,Yn=(V,g)=>{for(var m in g||(g={}))Ca.call(g,m)&&Fi(V,m,g[m]);if(Wn)for(var m of Wn(g))va.call(g,m)&&Fi(V,m,g[m]);return V};var Hs=(V,g,m)=>(Fi(V,typeof g!="symbol"?g+"":g,m),m);const ba=function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const b of document.querySelectorAll('link[rel="modulepreload"]'))j(b);new MutationObserver(b=>{for(const R of b)if(R.type==="childList")for(const E of R.addedNodes)E.tagName==="LINK"&&E.rel==="modulepreload"&&j(E)}).observe(document,{childList:!0,subtree:!0});function m(b){const R={};return b.integrity&&(R.integrity=b.integrity),b.referrerpolicy&&(R.referrerPolicy=b.referrerpolicy),b.crossorigin==="use-credentials"?R.credentials="include":b.crossorigin==="anonymous"?R.credentials="omit":R.credentials="same-origin",R}function j(b){if(b.ep)return;b.ep=!0;const R=m(b);fetch(b.href,R)}};ba();function Cs(){}function lo(V){return V()}function Kn(){return Object.create(null)}function Vs(V){V.forEach(lo)}function Va(V){return typeof V=="function"}function Ui(V,g){return V!=V?g==g:V!==g||V&&typeof V=="object"||typeof V=="function"}function wa(V){return Object.keys(V).length===0}function kt(V,g){V.appendChild(g)}function mo(V,g,m){V.insertBefore(g,m||null)}function Zi(V){V.parentNode.removeChild(V)}function Nt(V){return document.createElementNS("http://www.w3.org/2000/svg",V)}function Li(V){return document.createTextNode(V)}function $n(V,g,m,j){return V.addEventListener(g,m,j),()=>V.removeEventListener(g,m,j)}function X(V,g,m){m==null?V.removeAttribute(g):V.getAttribute(g)!==m&&V.setAttribute(g,m)}function ga(V){return Array.from(V.childNodes)}function to(V,g){g=""+g,V.wholeText!==g&&(V.data=g)}function Ti(V,g,m,j){m===null?V.style.removeProperty(g):V.style.setProperty(g,m,j?"important":"")}let vs;function As(V){vs=V}function Ma(){if(!vs)throw new Error("Function called outside component initialization");return vs}function Pa(V){Ma().$$.on_mount.push(V)}const ys=[],eo=[],Ys=[],so=[],Ia=Promise.resolve();let Ei=!1;function Ga(){Ei||(Ei=!0,Ia.then(ho))}function Ni(V){Ys.push(V)}const Ri=new Set;let Qs=0;function ho(){const V=vs;do{for(;Qs<ys.length;){const g=ys[Qs];Qs++,As(g),Da(g.$$)}for(As(null),ys.length=0,Qs=0;eo.length;)eo.pop()();for(let g=0;g<Ys.length;g+=1){const m=Ys[g];Ri.has(m)||(Ri.add(m),m())}Ys.length=0}while(ys.length);for(;so.length;)so.pop()();Ei=!1,Ri.clear(),As(V)}function Da(V){if(V.fragment!==null){V.update(),Vs(V.before_update);const g=V.dirty;V.dirty=[-1],V.fragment&&V.fragment.p(V.ctx,g),V.after_update.forEach(Ni)}}const Ks=new Set;let Fa;function $s(V,g){V&&V.i&&(Ks.delete(V),V.i(g))}function ji(V,g,m,j){if(V&&V.o){if(Ks.has(V))return;Ks.add(V),Fa.c.push(()=>{Ks.delete(V),j&&(m&&V.d(1),j())}),V.o(g)}}function Oi(V){V&&V.c()}function ti(V,g,m,j){const{fragment:b,on_mount:R,on_destroy:E,after_update:it}=V.$$;b&&b.m(g,m),j||Ni(()=>{const k=R.map(lo).filter(Va);E?E.push(...k):Vs(k),V.$$.on_mount=[]}),it.forEach(Ni)}function ei(V,g){const m=V.$$;m.fragment!==null&&(Vs(m.on_destroy),m.fragment&&m.fragment.d(g),m.on_destroy=m.fragment=null,m.ctx=[])}function La(V,g){V.$$.dirty[0]===-1&&(ys.push(V),Ga(),V.$$.dirty.fill(0)),V.$$.dirty[g/31|0]|=1<<g%31}function Hi(V,g,m,j,b,R,E,it=[-1]){const k=vs;As(V);const z=V.$$={fragment:null,ctx:null,props:R,update:Cs,not_equal:b,bound:Kn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(g.context||(k?k.$$.context:[])),callbacks:Kn(),dirty:it,skip_bound:!1,root:g.target||k.$$.root};E&&E(z.root);let mt=!1;if(z.ctx=m?m(V,g.props||{},(rt,ut,...N)=>{const Bt=N.length?N[0]:ut;return z.ctx&&b(z.ctx[rt],z.ctx[rt]=Bt)&&(!z.skip_bound&&z.bound[rt]&&z.bound[rt](Bt),mt&&La(V,rt)),ut}):[],z.update(),mt=!0,Vs(z.before_update),z.fragment=j?j(z.ctx):!1,g.target){if(g.hydrate){const rt=ga(g.target);z.fragment&&z.fragment.l(rt),rt.forEach(Zi)}else z.fragment&&z.fragment.c();g.intro&&$s(V.$$.fragment),ti(V,g.target,g.anchor,g.customElement),ho()}As(k)}class Qi{$destroy(){ei(this,1),this.$destroy=Cs}$on(g,m){const j=this.$$.callbacks[g]||(this.$$.callbacks[g]=[]);return j.push(m),()=>{const b=j.indexOf(m);b!==-1&&j.splice(b,1)}}$set(g){this.$$set&&!wa(g)&&(this.$$.skip_bound=!0,this.$$set(g),this.$$.skip_bound=!1)}}function Ta(V){let g,m,j,b,R,E,it,k,z,mt,rt,ut,N,Bt,At,Jt,Ht;return{c(){g=Nt("g"),m=Nt("defs"),j=Nt("clipPath"),b=Nt("rect"),it=Nt("g"),k=Nt("circle"),z=Nt("g"),mt=Nt("circle"),N=Nt("circle"),X(b,"x",R=-V[1]),X(b,"y","0"),X(b,"width",E=2*V[1]),X(b,"height",V[1]),X(j,"id","hide-player-bottom"),X(k,"cx","0"),X(k,"cy","0"),X(k,"r",V[1]),X(k,"fill",V[0]),X(mt,"cx",rt=.8*V[1]),X(mt,"cy","0"),X(mt,"r",ut=.1*V[1]),X(mt,"fill","white"),X(N,"cx",Bt=.8*V[1]),X(N,"cy","0"),X(N,"r",At=.05*V[1]),X(N,"fill","black"),X(z,"transform",Jt="rotate("+V[2]+")"),X(it,"clip-path","url(#hide-player-bottom)"),X(g,"transform",Ht="translate("+V[3]+" "+V[4]+")")},m(xt,nt){mo(xt,g,nt),kt(g,m),kt(m,j),kt(j,b),kt(g,it),kt(it,k),kt(it,z),kt(z,mt),kt(z,N)},p(xt,[nt]){nt&2&&R!==(R=-xt[1])&&X(b,"x",R),nt&2&&E!==(E=2*xt[1])&&X(b,"width",E),nt&2&&X(b,"height",xt[1]),nt&2&&X(k,"r",xt[1]),nt&1&&X(k,"fill",xt[0]),nt&2&&rt!==(rt=.8*xt[1])&&X(mt,"cx",rt),nt&2&&ut!==(ut=.1*xt[1])&&X(mt,"r",ut),nt&2&&Bt!==(Bt=.8*xt[1])&&X(N,"cx",Bt),nt&2&&At!==(At=.05*xt[1])&&X(N,"r",At),nt&4&&Jt!==(Jt="rotate("+xt[2]+")")&&X(z,"transform",Jt),nt&24&&Ht!==(Ht="translate("+xt[3]+" "+xt[4]+")")&&X(g,"transform",Ht)},i:Cs,o:Cs,d(xt){xt&&Zi(g)}}}function Ra(V,g,m){let{color:j="red"}=g,{radius:b=1}=g,{eyeAngle:R=40}=g,{x:E=0}=g,{y:it=0}=g;return V.$$set=k=>{"color"in k&&m(0,j=k.color),"radius"in k&&m(1,b=k.radius),"eyeAngle"in k&&m(2,R=k.eyeAngle),"x"in k&&m(3,E=k.x),"y"in k&&m(4,it=k.y)},[j,b,R,E,it]}class io extends Qi{constructor(g){super(),Hi(this,g,Ra,Ta,Ui,{color:0,radius:1,eyeAngle:2,x:3,y:4})}}const ps=.9*window.innerWidth,no=.9*window.innerHeight,Ws=50,si=10,ii=20,Ee=1.8,ka=10,oo=30/3.6,ro=20,qa=1,Wi=.3,za=.4,Ji=.8,ao=.3,Xi=1.5,xs=.1,ni=.15,bs=.8*si/2,Ss={x:bs,y:5,vy:15},Bs=10,Yt={timeStep:1/60,velocityIterations:6,positionIterations:2},Ye=[{left:"q",jump:"z",right:"d"},{left:"ArrowLeft",jump:"ArrowUp",right:"ArrowRight"}];var Ea=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},Pt={exports:{}};(function(V,g){(function(m,j){j(g)})(Ea,function(m){function j(d,...t){if(!d)throw new Error(...t)}function b(d,t){return d!==void 0?d:t}const R=1e37,E=1e-5,it=E*E,k=3.14159265359,z=2,mt=8,rt=.1,ut=2,N=.008,Bt=2/180*k,At=2*N,Jt=8,Ht=32,xt=1,nt=.2,It=8/180*k,ae=2,Ae=ae*ae,at=.5*k,qt=at*at,K=.2,H=.75,$=-1,Gt=2147483647,Kt=.75,le=1,fe=.25,Pe=.5,Ie=2,Ke=Ie*Ie,Ne=256,je=2.5,we=.5,$e=.01,ws=2/180*k;function gs(d){return null}function oi(d){}function ri(d,...t){}class Oe{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const ts=new Oe(2,3,2),co="master",_o="fbf51801d80fc389d43dc46524520e89043b6faf";function uo(d){return parseInt(d,10)}function fo(d){return Math.abs(parseInt(d,10))}function Xt(d,t){const e=new Array(d);for(let i=0;i<d;++i)e[i]=t(i);return e}function po(d){const t=new Array(d);for(let e=0;e<d;++e)t[e]=null;return t}function ge(d,t=0){const e=new Array(d);for(let i=0;i<d;++i)e[i]=t;return e}const Yi=k/180,Ki=180/k,ai=2*k,ht=Math.abs;function et(d,t){return d<t?d:t}function W(d,t){return d>t?d:t}function Vt(d,t,e){return d<t?t:d>e?e:d}function yo(d,t){const e=d[0];d[0]=t[0],t[0]=e}const Bo=isFinite;function Je(d){return d*d}function li(d){return 1/Math.sqrt(d)}const pe=Math.sqrt,$i=Math.pow;function Ao(d){return d*Yi}function xo(d){return d*Ki}const So=Math.cos,Co=Math.sin,vo=Math.acos,tn=Math.asin,mi=Math.atan2;function bo(d){return d|=d>>1&2147483647,d|=d>>2&1073741823,d|=d>>4&268435455,d|=d>>8&16777215,d|=d>>16&65535,d+1}function Vo(d){return d>0&&(d&d-1)===0}function wo(){return Math.random()*2-1}function go(d,t){return(t-d)*Math.random()+d}class s{constructor(...t){if(t[0]instanceof Float32Array){if(t[0].length!==2)throw new Error;this.data=t[0]}else{const e=typeof t[0]=="number"?t[0]:0,i=typeof t[1]=="number"?t[1]:0;this.data=new Float32Array([e,i])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}Clone(){return new s(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=E){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=E){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=et(this.x,t.x),this.y=et(this.y,t.y),this}SelfMaxV(t){return this.x=W(this.x,t.x),this.y=W(this.y,t.y),this}SelfAbs(){return this.x=ht(this.x),this.y=ht(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return Xt(t,e=>new s)}static AbsV(t,e){return e.x=ht(t.x),e.y=ht(t.y),e}static MinV(t,e,i){return i.x=et(t.x,e.x),i.y=et(t.y,e.y),i}static MaxV(t,e,i){return i.x=W(t.x,e.x),i.y=W(t.y,e.y),i}static ClampV(t,e,i,n){return n.x=Vt(t.x,e.x,i.x),n.y=Vt(t.y,e.y,i.y),n}static RotateV(t,e,i){const n=t.x,o=t.y,r=Math.cos(e),a=Math.sin(e);return i.x=r*n-a*o,i.y=a*n+r*o,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const n=t.x;return i.x=e*t.y,i.y=-e*n,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const n=e.x;return i.x=-t*e.y,i.y=t*n,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n}static SubVMulSV(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n}static AddVCrossSV(t,e,i,n){const o=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*o,n}static MidVV(t,e,i){return i.x=(t.x+e.x)*.5,i.y=(t.y+e.y)*.5,i}static ExtVV(t,e,i){return i.x=(e.x-t.x)*.5,i.y=(e.y-t.y)*.5,i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static DistanceSquaredVV(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}s.ZERO=new s(0,0),s.UNITX=new s(1,0),s.UNITY=new s(0,1),s.s_t0=new s,s.s_t1=new s,s.s_t2=new s,s.s_t3=new s;const Mo=new s(0,0);class Ct{constructor(...t){if(t[0]instanceof Float32Array){if(t[0].length!==3)throw new Error;this.data=t[0]}else{const e=typeof t[0]=="number"?t[0]:0,i=typeof t[1]=="number"?t[1]:0,n=typeof t[2]=="number"?t[2]:0;this.data=new Float32Array([e,i,n])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new Ct(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const n=t.x,o=t.y,r=t.z,a=e.x,l=e.y,c=e.z;return i.x=o*c-r*l,i.y=r*a-n*c,i.z=n*l-o*a,i}}Ct.ZERO=new Ct(0,0,0),Ct.s_t0=new Ct;class ft{constructor(){this.data=new Float32Array([1,0,0,1]),this.ex=new s(this.data.subarray(0,2)),this.ey=new s(this.data.subarray(2,4))}Clone(){return new ft().Copy(this)}static FromVV(t,e){return new ft().SetVV(t,e)}static FromSSSS(t,e,i,n){return new ft().SetSSSS(t,e,i,n)}static FromAngle(t){return new ft().SetAngle(t)}SetSSSS(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,o=this.ey.y;let r=e*o-i*n;return r!==0&&(r=1/r),t.ex.x=r*o,t.ey.x=-r*i,t.ex.y=-r*n,t.ey.y=r*e,t}Solve(t,e,i){const n=this.ex.x,o=this.ey.x,r=this.ex.y,a=this.ey.y;let l=n*a-o*r;return l!==0&&(l=1/l),i.x=l*(a*t-o*e),i.y=l*(n*e-r*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,n=t.ey;return e.ex.x=ht(i.x),e.ex.y=ht(i.y),e.ey.x=ht(n.x),e.ey.y=ht(n.y),e}static MulMV(t,e,i){const n=t.ex,o=t.ey,r=e.x,a=e.y;return i.x=n.x*r+o.x*a,i.y=n.y*r+o.y*a,i}static MulTMV(t,e,i){const n=t.ex,o=t.ey,r=e.x,a=e.y;return i.x=n.x*r+n.y*a,i.y=o.x*r+o.y*a,i}static AddMM(t,e,i){const n=t.ex,o=t.ey,r=e.ex,a=e.ey;return i.ex.x=n.x+r.x,i.ex.y=n.y+r.y,i.ey.x=o.x+a.x,i.ey.y=o.y+a.y,i}static MulMM(t,e,i){const n=t.ex.x,o=t.ex.y,r=t.ey.x,a=t.ey.y,l=e.ex.x,c=e.ex.y,_=e.ey.x,h=e.ey.y;return i.ex.x=n*l+r*c,i.ex.y=o*l+a*c,i.ey.x=n*_+r*h,i.ey.y=o*_+a*h,i}static MulTMM(t,e,i){const n=t.ex.x,o=t.ex.y,r=t.ey.x,a=t.ey.y,l=e.ex.x,c=e.ex.y,_=e.ey.x,h=e.ey.y;return i.ex.x=n*l+o*c,i.ex.y=r*l+a*c,i.ey.x=n*_+o*h,i.ey.y=r*_+a*h,i}}ft.IDENTITY=new ft;class me{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Ct(this.data.subarray(0,3)),this.ey=new Ct(this.data.subarray(3,6)),this.ez=new Ct(this.data.subarray(6,9))}Clone(){return new me().Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,n){const o=this.ex.x,r=this.ex.y,a=this.ex.z,l=this.ey.x,c=this.ey.y,_=this.ey.z,h=this.ez.x,u=this.ez.y,f=this.ez.z;let p=o*(c*f-_*u)+r*(_*h-l*f)+a*(l*u-c*h);return p!==0&&(p=1/p),n.x=p*(t*(c*f-_*u)+e*(_*h-l*f)+i*(l*u-c*h)),n.y=p*(o*(e*f-i*u)+r*(i*h-t*f)+a*(t*u-e*h)),n.z=p*(o*(c*i-_*e)+r*(_*t-l*i)+a*(l*e-c*t)),n}Solve22(t,e,i){const n=this.ex.x,o=this.ey.x,r=this.ex.y,a=this.ey.y;let l=n*a-o*r;return l!==0&&(l=1/l),i.x=l*(a*t-o*e),i.y=l*(n*e-r*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,o=this.ey.y;let r=e*o-i*n;r!==0&&(r=1/r),t.ex.x=r*o,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*n,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=Ct.DotV3V3(this.ex,Ct.CrossV3V3(this.ey,this.ez,Ct.s_t0));e!==0&&(e=1/e);const i=this.ex.x,n=this.ey.x,o=this.ez.x,r=this.ey.y,a=this.ez.y,l=this.ez.z;t.ex.x=e*(r*l-a*a),t.ex.y=e*(o*a-n*l),t.ex.z=e*(n*a-o*r),t.ey.x=t.ex.y,t.ey.y=e*(i*l-o*o),t.ey.z=e*(o*n-i*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-n*n)}static MulM33V3(t,e,i){const n=e.x,o=e.y,r=e.z;return i.x=t.ex.x*n+t.ey.x*o+t.ez.x*r,i.y=t.ex.y*n+t.ey.y*o+t.ez.y*r,i.z=t.ex.z*n+t.ey.z*o+t.ez.z*r,i}static MulM33XYZ(t,e,i,n,o){return o.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,o.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,o.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,o}static MulM33V2(t,e,i){const n=e.x,o=e.y;return i.x=t.ex.x*n+t.ey.x*o,i.y=t.ex.y*n+t.ey.y*o,i}static MulM33XY(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n}}me.IDENTITY=new me;class w{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return new w().Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const n=t.c,o=t.s,r=e.c,a=e.s;return i.s=o*r+n*a,i.c=n*r-o*a,i}static MulTRR(t,e,i){const n=t.c,o=t.s,r=e.c,a=e.s;return i.s=n*a-o*r,i.c=n*r+o*a,i}static MulRV(t,e,i){const n=t.c,o=t.s,r=e.x,a=e.y;return i.x=n*r-o*a,i.y=o*r+n*a,i}static MulTRV(t,e,i){const n=t.c,o=t.s,r=e.x,a=e.y;return i.x=n*r+o*a,i.y=-o*r+n*a,i}}w.IDENTITY=new w;class P{constructor(){this.p=new s,this.q=new w}Clone(){return new P().Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const n=t.q.c,o=t.q.s,r=e.x,a=e.y;return i.x=n*r-o*a+t.p.x,i.y=o*r+n*a+t.p.y,i}static MulTXV(t,e,i){const n=t.q.c,o=t.q.s,r=e.x-t.p.x,a=e.y-t.p.y;return i.x=n*r+o*a,i.y=-o*r+n*a,i}static MulXX(t,e,i){return w.MulRR(t.q,e.q,i.q),s.AddVV(w.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return w.MulTRR(t.q,e.q,i.q),w.MulTRV(t.q,s.SubVV(e.p,t.p,i.p),i.p),i}}P.IDENTITY=new P;class $t{constructor(){this.localCenter=new s,this.c0=new s,this.c=new s,this.a0=0,this.a=0,this.alpha0=0}Clone(){return new $t().Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(w.MulRV(t.q,this.localCenter,s.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=ai*Math.floor(this.a0/ai);this.a0-=t,this.a-=t}}class dt{constructor(...t){if(t[0]instanceof Float32Array){if(t[0].length!==4)throw new Error;this.data=t[0]}else{const e=typeof t[0]=="number"?t[0]:.5,i=typeof t[1]=="number"?t[1]:.5,n=typeof t[2]=="number"?t[2]:.5,o=typeof t[3]=="number"?t[3]:1;this.data=new Float32Array([e,i,n,o])}}get r(){return this.data[0]}set r(t){this.data[0]=t}get g(){return this.data[1]}set g(t){this.data[1]=t}get b(){return this.data[2]}set b(t){this.data[2]=t}get a(){return this.data[3]}set a(t){this.data[3]=t}Clone(){return new dt().Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return this.r===0&&this.g===0&&this.b===0&&this.a===0}Set(t,e,i,n=this.a){this.SetRGBA(t,e,i,n)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){dt.MixColors(this,t,e)}static MixColors(t,e,i){const n=i*(e.r-t.r),o=i*(e.g-t.g),r=i*(e.b-t.b),a=i*(e.a-t.a);t.r+=n,t.g+=o,t.b+=r,t.a+=a,e.r-=n,e.g-=o,e.b-=r,e.a-=a}MakeStyleString(t=this.a){return dt.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,n=1){return t*=255,e*=255,i*=255,n<1?`rgba(${t},${e},${i},${n})`:`rgb(${t},${e},${i})`}}dt.ZERO=new dt(0,0,0,0),dt.RED=new dt(1,0,0),dt.GREEN=new dt(0,1,0),dt.BLUE=new dt(0,0,1),function(d){d[d.e_none=0]="e_none",d[d.e_shapeBit=1]="e_shapeBit",d[d.e_jointBit=2]="e_jointBit",d[d.e_aabbBit=4]="e_aabbBit",d[d.e_pairBit=8]="e_pairBit",d[d.e_centerOfMassBit=16]="e_centerOfMassBit",d[d.e_particleBit=32]="e_particleBit",d[d.e_controllerBit=64]="e_controllerBit",d[d.e_all=63]="e_all"}(m.b2DrawFlags||(m.b2DrawFlags={}));class Po{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}}class Xe{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class Io{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}class en{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=Xt(t,e=>null),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,t===null)throw new Error;return t}GetCount(){return this.m_count}}class Go{}class Do{}class Ge{constructor(){this.m_buffer=s.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=s.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const o=s.DotVV(this.m_vertices[n],t);o>i&&(e=n,i=o)}return e}GetSupportVertex(t){let e=0,i=s.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const o=s.DotVV(this.m_vertices[n],t);o>i&&(e=n,i=o)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class hi{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class ci{constructor(){this.proxyA=new Ge,this.proxyB=new Ge,this.transformA=new P,this.transformB=new P,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class _i{constructor(){this.pointA=new s,this.pointB=new s,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}class Fo{constructor(){this.proxyA=new Ge,this.proxyB=new Ge,this.transformA=new P,this.transformB=new P,this.translationB=new s}}class Lo{constructor(){this.point=new s,this.normal=new s,this.lambda=0,this.iterations=0}}m.b2_gjkCalls=0,m.b2_gjkIters=0,m.b2_gjkMaxIters=0;function To(){m.b2_gjkCalls=0,m.b2_gjkIters=0,m.b2_gjkMaxIters=0}class Ms{constructor(){this.wA=new s,this.wB=new s,this.w=new s,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class _e{constructor(){this.m_v1=new Ms,this.m_v2=new Ms,this.m_v3=new Ms,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,n,o){this.m_count=t.count;const r=this.m_vertices;for(let a=0;a<this.m_count;++a){const l=r[a];l.indexA=t.indexA[a],l.indexB=t.indexB[a];const c=e.GetVertex(l.indexA),_=n.GetVertex(l.indexB);P.MulXV(i,c,l.wA),P.MulXV(o,_,l.wB),s.SubVV(l.wB,l.wA,l.w),l.a=0}if(this.m_count>1){const a=t.metric,l=this.GetMetric();(l<.5*a||2*a<l||l<E)&&(this.m_count=0)}if(this.m_count===0){const a=r[0];a.indexA=0,a.indexB=0;const l=e.GetVertex(0),c=n.GetVertex(0);P.MulXV(i,l,a.wA),P.MulXV(o,c,a.wB),s.SubVV(a.wB,a.wA,a.w),a.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return s.NegV(this.m_v1.w,t);case 2:{const e=s.SubVV(this.m_v2.w,this.m_v1.w,t);return s.CrossVV(e,s.NegV(this.m_v1.w,s.s_t0))>0?s.CrossOneV(e,t):s.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:return t.SetZero();default:return t.SetZero()}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break}}GetMetric(){switch(this.m_count){case 0:return 0;case 1:return 0;case 2:return s.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return s.CrossVV(s.SubVV(this.m_v2.w,this.m_v1.w,s.s_t0),s.SubVV(this.m_v3.w,this.m_v1.w,s.s_t1));default:return 0}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=s.SubVV(e,t,_e.s_e12),n=-s.DotVV(t,i);if(n<=0){this.m_v1.a=1,this.m_count=1;return}const o=s.DotVV(e,i);if(o<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.Copy(this.m_v2);return}const r=1/(o+n);this.m_v1.a=o*r,this.m_v2.a=n*r,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=s.SubVV(e,t,_e.s_e12),o=s.DotVV(t,n),a=s.DotVV(e,n),l=-o,c=s.SubVV(i,t,_e.s_e13),_=s.DotVV(t,c),u=s.DotVV(i,c),f=-_,p=s.SubVV(i,e,_e.s_e23),y=s.DotVV(e,p),A=s.DotVV(i,p),x=-y,C=s.CrossVV(n,c),v=C*s.CrossVV(e,i),M=C*s.CrossVV(i,t),G=C*s.CrossVV(t,e);if(l<=0&&f<=0){this.m_v1.a=1,this.m_count=1;return}if(a>0&&l>0&&G<=0){const T=1/(a+l);this.m_v1.a=a*T,this.m_v2.a=l*T,this.m_count=2;return}if(u>0&&f>0&&M<=0){const T=1/(u+f);this.m_v1.a=u*T,this.m_v3.a=f*T,this.m_count=2,this.m_v2.Copy(this.m_v3);return}if(a<=0&&x<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.Copy(this.m_v2);return}if(u<=0&&A<=0){this.m_v3.a=1,this.m_count=1,this.m_v1.Copy(this.m_v3);return}if(A>0&&x>0&&v<=0){const T=1/(A+x);this.m_v2.a=A*T,this.m_v3.a=x*T,this.m_count=2,this.m_v1.Copy(this.m_v3);return}const I=1/(v+M+G);this.m_v1.a=v*I,this.m_v2.a=M*I,this.m_v3.a=G*I,this.m_count=3}}_e.s_e12=new s,_e.s_e13=new s,_e.s_e23=new s;const Ro=new _e,ko=[0,0,0],qo=[0,0,0],zo=new s,Eo=new s,No=new s,jo=new s,Oo=new s;function ui(d,t,e){++m.b2_gjkCalls;const i=e.proxyA,n=e.proxyB,o=e.transformA,r=e.transformB,a=Ro;a.ReadCache(t,i,o,n,r);const l=a.m_vertices,c=20,_=ko,h=qo;let u=0,f=0;for(;f<c;){u=a.m_count;for(let A=0;A<u;++A)_[A]=l[A].indexA,h[A]=l[A].indexB;switch(a.m_count){case 1:break;case 2:a.Solve2();break;case 3:a.Solve3();break}if(a.m_count===3)break;const p=a.GetSearchDirection(Eo);if(p.LengthSquared()<it)break;const y=l[a.m_count];y.indexA=i.GetSupport(w.MulTRV(o.q,s.NegV(p,s.s_t0),jo)),P.MulXV(o,i.GetVertex(y.indexA),y.wA),y.indexB=n.GetSupport(w.MulTRV(r.q,p,Oo)),P.MulXV(r,n.GetVertex(y.indexB),y.wB),s.SubVV(y.wB,y.wA,y.w),++f,++m.b2_gjkIters;let B=!1;for(let A=0;A<u;++A)if(y.indexA===_[A]&&y.indexB===h[A]){B=!0;break}if(B)break;++a.m_count}if(m.b2_gjkMaxIters=W(m.b2_gjkMaxIters,f),a.GetWitnessPoints(d.pointA,d.pointB),d.distance=s.DistanceVV(d.pointA,d.pointB),d.iterations=f,a.WriteCache(t),e.useRadii){const p=i.m_radius,y=n.m_radius;if(d.distance>p+y&&d.distance>E){d.distance-=p+y;const B=s.SubVV(d.pointB,d.pointA,No);B.Normalize(),d.pointA.SelfMulAdd(p,B),d.pointB.SelfMulSub(y,B)}else{const B=s.MidVV(d.pointA,d.pointB,zo);d.pointA.Copy(B),d.pointB.Copy(B),d.distance=0}}}const Jo=new s,Xo=new _e,sn=new s,nn=new s,Uo=new s,Zo=new s,Ho=new s,Qo=new s;function Wo(d,t){d.iterations=0,d.lambda=1,d.normal.SetZero(),d.point.SetZero();const e=t.proxyA,i=t.proxyB,n=W(e.m_radius,At),o=W(i.m_radius,At),r=n+o,a=t.transformA,l=t.transformB,c=t.translationB,_=Jo.Set(0,0);let h=0;const u=Xo;u.m_count=0;const f=u.m_vertices;let p=e.GetSupport(w.MulTRV(a.q,s.NegV(c,s.s_t1),s.s_t0)),y=P.MulXV(a,e.GetVertex(p),sn),B=i.GetSupport(w.MulTRV(l.q,c,s.s_t0)),A=P.MulXV(l,i.GetVertex(B),nn);const x=s.SubVV(y,A,Uo),C=W(At,r-At),v=.5*N,M=20;let G=0;for(;G<M&&ht(x.Length()-C)>v;){d.iterations+=1,p=e.GetSupport(w.MulTRV(a.q,s.NegV(x,s.s_t1),s.s_t0)),y=P.MulXV(a,e.GetVertex(p),sn),B=i.GetSupport(w.MulTRV(l.q,x,s.s_t0)),A=P.MulXV(l,i.GetVertex(B),nn);const F=s.SubVV(y,A,Zo);x.Normalize();const q=s.DotVV(x,F),J=s.DotVV(x,c);if(q-C>h*J){if(J<=0||(h=(q-C)/J,h>1))return!1;_.Copy(x).SelfNeg(),u.m_count=0}const L=f[u.m_count];switch(L.indexA=B,L.wA.Copy(A).SelfMulAdd(h,c),L.indexB=p,L.wB.Copy(y),L.w.Copy(L.wB).SelfSub(L.wA),L.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3();break}if(u.m_count===3)return!1;u.GetClosestPoint(x),++G}const I=Ho,T=Qo;return u.GetWitnessPoints(I,T),x.LengthSquared()>0&&(_.Copy(x).SelfNeg(),_.Normalize()),d.normal.Copy(_),d.lambda=h,d.iterations=G,!0}(function(d){d[d.e_vertex=0]="e_vertex",d[d.e_face=1]="e_face"})(m.b2ContactFeatureType||(m.b2ContactFeatureType={}));class on{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=this._key&255,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class Ue{constructor(){this.cf=new on}Copy(t){return this.key=t.key,this}Clone(){return new Ue().Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class Ps{constructor(){this.localPoint=new s,this.normalImpulse=0,this.tangentImpulse=0,this.id=new Ue}static MakeArray(t){return Xt(t,e=>new Ps)}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}(function(d){d[d.e_unknown=-1]="e_unknown",d[d.e_circles=0]="e_circles",d[d.e_faceA=1]="e_faceA",d[d.e_faceB=2]="e_faceB"})(m.b2ManifoldType||(m.b2ManifoldType={}));class es{constructor(){this.points=Ps.MakeArray(z),this.localNormal=new s,this.localPoint=new s,this.type=m.b2ManifoldType.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<z;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=m.b2ManifoldType.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<z;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return new es().Copy(this)}}class wt{constructor(){this.normal=new s,this.points=s.MakeArray(z),this.separations=ge(z)}Initialize(t,e,i,n,o){if(t.pointCount!==0)switch(t.type){case m.b2ManifoldType.e_circles:{this.normal.Set(1,0);const r=P.MulXV(e,t.localPoint,wt.Initialize_s_pointA),a=P.MulXV(n,t.points[0].localPoint,wt.Initialize_s_pointB);s.DistanceSquaredVV(r,a)>it&&s.SubVV(a,r,this.normal).SelfNormalize();const l=s.AddVMulSV(r,i,this.normal,wt.Initialize_s_cA),c=s.SubVMulSV(a,o,this.normal,wt.Initialize_s_cB);s.MidVV(l,c,this.points[0]),this.separations[0]=s.DotVV(s.SubVV(c,l,s.s_t0),this.normal);break}case m.b2ManifoldType.e_faceA:{w.MulRV(e.q,t.localNormal,this.normal);const r=P.MulXV(e,t.localPoint,wt.Initialize_s_planePoint);for(let a=0;a<t.pointCount;++a){const l=P.MulXV(n,t.points[a].localPoint,wt.Initialize_s_clipPoint),c=i-s.DotVV(s.SubVV(l,r,s.s_t0),this.normal),_=s.AddVMulSV(l,c,this.normal,wt.Initialize_s_cA),h=s.SubVMulSV(l,o,this.normal,wt.Initialize_s_cB);s.MidVV(_,h,this.points[a]),this.separations[a]=s.DotVV(s.SubVV(h,_,s.s_t0),this.normal)}break}case m.b2ManifoldType.e_faceB:{w.MulRV(n.q,t.localNormal,this.normal);const r=P.MulXV(n,t.localPoint,wt.Initialize_s_planePoint);for(let a=0;a<t.pointCount;++a){const l=P.MulXV(e,t.points[a].localPoint,wt.Initialize_s_clipPoint),c=o-s.DotVV(s.SubVV(l,r,s.s_t0),this.normal),_=s.AddVMulSV(l,c,this.normal,wt.Initialize_s_cB),h=s.SubVMulSV(l,i,this.normal,wt.Initialize_s_cA);s.MidVV(h,_,this.points[a]),this.separations[a]=s.DotVV(s.SubVV(h,_,s.s_t0),this.normal)}this.normal.SelfNeg();break}}}}wt.Initialize_s_pointA=new s,wt.Initialize_s_pointB=new s,wt.Initialize_s_cA=new s,wt.Initialize_s_cB=new s,wt.Initialize_s_planePoint=new s,wt.Initialize_s_clipPoint=new s,function(d){d[d.b2_nullState=0]="b2_nullState",d[d.b2_addState=1]="b2_addState",d[d.b2_persistState=2]="b2_persistState",d[d.b2_removeState=3]="b2_removeState"}(m.b2PointState||(m.b2PointState={}));function Yo(d,t,e,i){let n;for(n=0;n<e.pointCount;++n){const r=e.points[n].id.key;d[n]=m.b2PointState.b2_removeState;for(let a=0,l=i.pointCount;a<l;++a)if(i.points[a].id.key===r){d[n]=m.b2PointState.b2_persistState;break}}for(;n<z;++n)d[n]=m.b2PointState.b2_nullState;for(n=0;n<i.pointCount;++n){const r=i.points[n].id.key;t[n]=m.b2PointState.b2_addState;for(let a=0,l=e.pointCount;a<l;++a)if(e.points[a].id.key===r){t[n]=m.b2PointState.b2_persistState;break}}for(;n<z;++n)t[n]=m.b2PointState.b2_nullState}class xe{constructor(){this.v=new s,this.id=new Ue}static MakeArray(t){return Xt(t,e=>new xe)}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class Is{constructor(){this.p1=new s,this.p2=new s,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class di{constructor(){this.normal=new s,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class Dt{constructor(){this.lowerBound=new s,this.upperBound=new s,this.m_cache_center=new s,this.m_cache_extent=new s}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}GetCenter(){return s.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return s.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){const t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y;return 2*(t+e)}Combine1(t){return this.lowerBound.x=et(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=et(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=W(this.upperBound.x,t.upperBound.x),this.upperBound.y=W(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=et(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=et(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=W(t.upperBound.x,e.upperBound.x),this.upperBound.y=W(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)}RayCast(t,e){let i=-R,n=R;const o=e.p1.x,r=e.p1.y,a=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,c=ht(a),_=ht(l),h=t.normal;if(c<E){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{const u=1/a;let f=(this.lowerBound.x-o)*u,p=(this.upperBound.x-o)*u,y=-1;if(f>p){const B=f;f=p,p=B,y=1}if(f>i&&(h.x=y,h.y=0,i=f),n=et(n,p),i>n)return!1}if(_<E){if(r<this.lowerBound.y||this.upperBound.y<r)return!1}else{const u=1/l;let f=(this.lowerBound.y-r)*u,p=(this.upperBound.y-r)*u,y=-1;if(f>p){const B=f;f=p,p=B,y=1}if(f>i&&(h.x=0,h.y=y,i=f),n=et(n,p),i>n)return!1}return i<0||e.maxFraction<i?!1:(t.fraction=i,!0)}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function fi(d,t){return!(d.upperBound.x<t.lowerBound.x||d.upperBound.y<t.lowerBound.y||t.upperBound.x<d.lowerBound.x||t.upperBound.y<d.lowerBound.y)}function ss(d,t,e,i,n){let o=0;const r=t[0],a=t[1],l=s.DotVV(e,r.v)-i,c=s.DotVV(e,a.v)-i;if(l<=0&&d[o++].Copy(r),c<=0&&d[o++].Copy(a),l*c<0){const _=l/(l-c),h=d[o].v;h.x=r.v.x+_*(a.v.x-r.v.x),h.y=r.v.y+_*(a.v.y-r.v.y);const u=d[o].id;u.cf.indexA=n,u.cf.indexB=r.id.cf.indexB,u.cf.typeA=m.b2ContactFeatureType.e_vertex,u.cf.typeB=m.b2ContactFeatureType.e_face,++o}return o}const Ko=new ci,$o=new hi,tr=new _i;function pi(d,t,e,i,n,o){const r=Ko.Reset();r.proxyA.SetShape(d,t),r.proxyB.SetShape(e,i),r.transformA.Copy(n),r.transformB.Copy(o),r.useRadii=!0;const a=$o.Reset();a.count=0;const l=tr.Reset();return ui(l,a,r),l.distance<10*E}function gt(d){if(d===null)throw new Error;return d}class rn{constructor(t=0){this.m_id=0,this.aabb=new Dt,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}get userData(){if(this._userData===null)throw new Error;return this._userData}set userData(t){if(this._userData!==null)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return this.child1===null}}class lt{constructor(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new en(256)}Query(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(n!==null&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(n!==null&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}RayCast(t,e){const i=t.p1,n=t.p2,o=s.SubVV(n,i,lt.s_r);o.Normalize();const r=s.CrossOneV(o,lt.s_v),a=s.AbsV(r,lt.s_abs_v);let l=t.maxFraction;const c=lt.s_segmentAABB;let _=i.x+l*(n.x-i.x),h=i.y+l*(n.y-i.y);c.lowerBound.x=et(i.x,_),c.lowerBound.y=et(i.y,h),c.upperBound.x=W(i.x,_),c.upperBound.y=W(i.y,h);const u=this.m_stack.Reset();for(u.Push(this.m_root);u.GetCount()>0;){const f=u.Pop();if(f===null||!fi(f.aabb,c))continue;const p=f.aabb.GetCenter(),y=f.aabb.GetExtents();if(!(ht(s.DotVV(r,s.SubVV(i,p,s.s_t0)))-s.DotVV(a,y)>0))if(f.IsLeaf()){const A=lt.s_subInput;A.p1.Copy(t.p1),A.p2.Copy(t.p2),A.maxFraction=l;const x=e(A,f);if(x===0)return;x>0&&(l=x,_=i.x+l*(n.x-i.x),h=i.y+l*(n.y-i.y),c.lowerBound.x=et(i.x,_),c.lowerBound.y=et(i.y,h),c.upperBound.x=W(i.x,_),c.upperBound.y=W(i.y,h))}else u.Push(f.child1),u.Push(f.child2)}}AllocateNode(){if(this.m_freeList!==null){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new rn(lt.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),n=rt,o=rt;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-o,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+o,i.userData=e,i.height=0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);const n=rt,o=rt;t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-o,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+o;const r=ut*i.x,a=ut*i.y;return r<0?t.aabb.lowerBound.x+=r:t.aabb.upperBound.x+=r,a<0?t.aabb.lowerBound.y+=a:t.aabb.upperBound.y+=a,this.InsertLeaf(t),!0}InsertLeaf(t){if(++this.m_insertionCount,this.m_root===null){this.m_root=t,this.m_root.parent=null;return}const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const a=gt(i.child1),l=gt(i.child2),c=i.aabb.GetPerimeter(),_=lt.s_combinedAABB;_.Combine2(i.aabb,e);const h=_.GetPerimeter(),u=2*h,f=2*(h-c);let p;const y=lt.s_aabb;let B,A;a.IsLeaf()?(y.Combine2(e,a.aabb),p=y.GetPerimeter()+f):(y.Combine2(e,a.aabb),B=a.aabb.GetPerimeter(),A=y.GetPerimeter(),p=A-B+f);let x;if(l.IsLeaf()?(y.Combine2(e,l.aabb),x=y.GetPerimeter()+f):(y.Combine2(e,l.aabb),B=l.aabb.GetPerimeter(),A=y.GetPerimeter(),x=A-B+f),u<p&&u<x)break;p<x?i=a:i=l}const n=i.parent,o=this.AllocateNode();o.parent=n,o.aabb.Combine2(e,i.aabb),o.height=i.height+1,n!==null?(n.child1===i?n.child1=o:n.child2=o,o.child1=i,o.child2=t,i.parent=o,t.parent=o):(o.child1=i,o.child2=t,i.parent=o,t.parent=o,this.m_root=o);let r=t.parent;for(;r!==null;){r=this.Balance(r);const a=gt(r.child1),l=gt(r.child2);r.height=1+W(a.height,l.height),r.aabb.Combine2(a.aabb,l.aabb),r=r.parent}}RemoveLeaf(t){if(t===this.m_root){this.m_root=null;return}const e=gt(t.parent),i=e&&e.parent,n=gt(e.child1===t?e.child2:e.child1);if(i!==null){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);let o=i;for(;o!==null;){o=this.Balance(o);const r=gt(o.child1),a=gt(o.child2);o.aabb.Combine2(r.aabb,a.aabb),o.height=1+W(r.height,a.height),o=o.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=gt(t.child1),i=gt(t.child2),n=i.height-e.height;if(n>1){const o=gt(i.child1),r=gt(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,i.parent!==null?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,o.height>r.height?(i.child2=o,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),i.aabb.Combine2(t.aabb,o.aabb),t.height=1+W(e.height,r.height),i.height=1+W(t.height,o.height)):(i.child2=r,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),i.aabb.Combine2(t.aabb,r.aabb),t.height=1+W(e.height,o.height),i.height=1+W(t.height,r.height)),i}if(n<-1){const o=gt(e.child1),r=gt(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,e.parent!==null?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,o.height>r.height?(e.child2=o,t.child1=r,r.parent=t,t.aabb.Combine2(i.aabb,r.aabb),e.aabb.Combine2(t.aabb,o.aabb),t.height=1+W(i.height,r.height),e.height=1+W(t.height,o.height)):(e.child2=r,t.child1=o,o.parent=t,t.aabb.Combine2(i.aabb,o.aabb),e.aabb.Combine2(t.aabb,r.aabb),t.height=1+W(i.height,o.height),e.height=1+W(t.height,r.height)),e}return t}GetHeight(){return this.m_root===null?0:this.m_root.height}static GetAreaNode(t){if(t===null||t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=lt.GetAreaNode(t.child1),e+=lt.GetAreaNode(t.child2),e}GetAreaRatio(){if(this.m_root===null)return 0;const e=this.m_root.aabb.GetPerimeter();return lt.GetAreaNode(this.m_root)/e}static ComputeHeightNode(t){if(t===null||t.IsLeaf())return 0;const e=lt.ComputeHeightNode(t.child1),i=lt.ComputeHeightNode(t.child2);return 1+W(e,i)}ComputeHeight(){return lt.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(t===null||(this.m_root,t.IsLeaf()))return;const e=gt(t.child1),i=gt(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(t===null||t.IsLeaf())return;const e=gt(t.child1),i=gt(t.child2);lt.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(t===null||t.height<=1)return e;const i=gt(t.child1),n=gt(t.child2),o=ht(n.height-i.height);return W(e,o)}GetMaxBalance(){return lt.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(t===null||t.height<=1)return;const i=t.child1,n=t.child2;lt.ShiftOriginNode(i,e),lt.ShiftOriginNode(n,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){lt.ShiftOriginNode(this.m_root,t)}}lt.s_r=new s,lt.s_v=new s,lt.s_abs_v=new s,lt.s_segmentAABB=new Dt,lt.s_subInput=new Is,lt.s_combinedAABB=new Dt,lt.s_aabb=new Dt,lt.s_node_id=0;function er(d,t,e){const i=d[t];d[t]=d[e],d[e]=i}function sr(d,t){return d<t}function ir(d,t=0,e=d.length-t,i=sr){let n=t;const o=[];let r=0;for(;;){for(;n+1<e;e++){const a=d[n+Math.floor(Math.random()*(e-n))];o[r++]=e;for(let l=n-1;;){for(;i(d[++l],a););for(;i(a,d[--e]););if(l>=e)break;er(d,l,e)}}if(r===0)break;n=e,e=o[--r]}return d}class an{constructor(t,e){this.proxyA=t,this.proxyB=e}}class ln{constructor(){this.m_tree=new lt,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let i=0;i<this.m_moveCount;++i){const n=this.m_moveBuffer[i];if(n===null)continue;const o=n.aabb;this.m_tree.Query(o,r=>{if(r.m_id===n.m_id)return!0;let a,l;if(r.m_id<n.m_id?(a=r,l=n):(a=n,l=r),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new an(a,l);else{const c=this.m_pairBuffer[this.m_pairCount];c.proxyA=a,c.proxyB=l}return++this.m_pairCount,!0})}this.m_moveCount=0,ir(this.m_pairBuffer,0,this.m_pairCount,mn);let e=0;for(;e<this.m_pairCount;){const i=this.m_pairBuffer[e],n=i.proxyA.userData,o=i.proxyB.userData;for(t(n,o),++e;e<this.m_pairCount;){const r=this.m_pairBuffer[e];if(r.proxyA.m_id!==i.proxyA.m_id||r.proxyB.m_id!==i.proxyB.m_id)break;++e}}}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}function mn(d,t){return d.proxyA.m_id<t.proxyA.m_id?!0:d.proxyA.m_id===t.proxyA.m_id?d.proxyB.m_id<t.proxyB.m_id:!1}m.b2_toiTime=0,m.b2_toiMaxTime=0,m.b2_toiCalls=0,m.b2_toiIters=0,m.b2_toiMaxIters=0,m.b2_toiRootIters=0,m.b2_toiMaxRootIters=0;function nr(){m.b2_toiTime=0,m.b2_toiMaxTime=0,m.b2_toiCalls=0,m.b2_toiIters=0,m.b2_toiMaxIters=0,m.b2_toiRootIters=0,m.b2_toiMaxRootIters=0}const Gs=new P,Ds=new P,Se=new s,Ce=new s,Ze=new s,hn=new s,cn=new s;class yi{constructor(){this.proxyA=new Ge,this.proxyB=new Ge,this.sweepA=new $t,this.sweepB=new $t,this.tMax=0}}(function(d){d[d.e_unknown=0]="e_unknown",d[d.e_failed=1]="e_failed",d[d.e_overlapped=2]="e_overlapped",d[d.e_touching=3]="e_touching",d[d.e_separated=4]="e_separated"})(m.b2TOIOutputState||(m.b2TOIOutputState={}));class Bi{constructor(){this.state=m.b2TOIOutputState.e_unknown,this.t=0}}(function(d){d[d.e_unknown=-1]="e_unknown",d[d.e_points=0]="e_points",d[d.e_faceA=1]="e_faceA",d[d.e_faceB=2]="e_faceB"})(m.b2SeparationFunctionType||(m.b2SeparationFunctionType={}));class _n{constructor(){this.m_sweepA=new $t,this.m_sweepB=new $t,this.m_type=m.b2SeparationFunctionType.e_unknown,this.m_localPoint=new s,this.m_axis=new s}Initialize(t,e,i,n,o,r){this.m_proxyA=e,this.m_proxyB=n;const a=t.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(o);const l=Gs,c=Ds;if(this.m_sweepA.GetTransform(l,r),this.m_sweepB.GetTransform(c,r),a===1){this.m_type=m.b2SeparationFunctionType.e_points;const _=this.m_proxyA.GetVertex(t.indexA[0]),h=this.m_proxyB.GetVertex(t.indexB[0]),u=P.MulXV(l,_,Se),f=P.MulXV(c,h,Ce);s.SubVV(f,u,this.m_axis);const p=this.m_axis.Normalize();return this.m_localPoint.SetZero(),p}else if(t.indexA[0]===t.indexA[1]){this.m_type=m.b2SeparationFunctionType.e_faceB;const _=this.m_proxyB.GetVertex(t.indexB[0]),h=this.m_proxyB.GetVertex(t.indexB[1]);s.CrossVOne(s.SubVV(h,_,s.s_t0),this.m_axis).SelfNormalize();const u=w.MulRV(c.q,this.m_axis,Ze);s.MidVV(_,h,this.m_localPoint);const f=P.MulXV(c,this.m_localPoint,Ce),p=this.m_proxyA.GetVertex(t.indexA[0]),y=P.MulXV(l,p,Se);let B=s.DotVV(s.SubVV(y,f,s.s_t0),u);return B<0&&(this.m_axis.SelfNeg(),B=-B),B}else{this.m_type=m.b2SeparationFunctionType.e_faceA;const _=this.m_proxyA.GetVertex(t.indexA[0]),h=this.m_proxyA.GetVertex(t.indexA[1]);s.CrossVOne(s.SubVV(h,_,s.s_t0),this.m_axis).SelfNormalize();const u=w.MulRV(l.q,this.m_axis,Ze);s.MidVV(_,h,this.m_localPoint);const f=P.MulXV(l,this.m_localPoint,Se),p=this.m_proxyB.GetVertex(t.indexB[0]),y=P.MulXV(c,p,Ce);let B=s.DotVV(s.SubVV(y,f,s.s_t0),u);return B<0&&(this.m_axis.SelfNeg(),B=-B),B}}FindMinSeparation(t,e,i){const n=Gs,o=Ds;switch(this.m_sweepA.GetTransform(n,i),this.m_sweepB.GetTransform(o,i),this.m_type){case m.b2SeparationFunctionType.e_points:{const r=w.MulTRV(n.q,this.m_axis,hn),a=w.MulTRV(o.q,s.NegV(this.m_axis,s.s_t0),cn);t[0]=this.m_proxyA.GetSupport(r),e[0]=this.m_proxyB.GetSupport(a);const l=this.m_proxyA.GetVertex(t[0]),c=this.m_proxyB.GetVertex(e[0]),_=P.MulXV(n,l,Se),h=P.MulXV(o,c,Ce);return s.DotVV(s.SubVV(h,_,s.s_t0),this.m_axis)}case m.b2SeparationFunctionType.e_faceA:{const r=w.MulRV(n.q,this.m_axis,Ze),a=P.MulXV(n,this.m_localPoint,Se),l=w.MulTRV(o.q,s.NegV(r,s.s_t0),cn);t[0]=-1,e[0]=this.m_proxyB.GetSupport(l);const c=this.m_proxyB.GetVertex(e[0]),_=P.MulXV(o,c,Ce);return s.DotVV(s.SubVV(_,a,s.s_t0),r)}case m.b2SeparationFunctionType.e_faceB:{const r=w.MulRV(o.q,this.m_axis,Ze),a=P.MulXV(o,this.m_localPoint,Ce),l=w.MulTRV(n.q,s.NegV(r,s.s_t0),hn);e[0]=-1,t[0]=this.m_proxyA.GetSupport(l);const c=this.m_proxyA.GetVertex(t[0]),_=P.MulXV(n,c,Se);return s.DotVV(s.SubVV(_,a,s.s_t0),r)}default:return t[0]=-1,e[0]=-1,0}}Evaluate(t,e,i){const n=Gs,o=Ds;switch(this.m_sweepA.GetTransform(n,i),this.m_sweepB.GetTransform(o,i),this.m_type){case m.b2SeparationFunctionType.e_points:{const r=this.m_proxyA.GetVertex(t),a=this.m_proxyB.GetVertex(e),l=P.MulXV(n,r,Se),c=P.MulXV(o,a,Ce);return s.DotVV(s.SubVV(c,l,s.s_t0),this.m_axis)}case m.b2SeparationFunctionType.e_faceA:{const r=w.MulRV(n.q,this.m_axis,Ze),a=P.MulXV(n,this.m_localPoint,Se),l=this.m_proxyB.GetVertex(e),c=P.MulXV(o,l,Ce);return s.DotVV(s.SubVV(c,a,s.s_t0),r)}case m.b2SeparationFunctionType.e_faceB:{const r=w.MulRV(o.q,this.m_axis,Ze),a=P.MulXV(o,this.m_localPoint,Ce),l=this.m_proxyA.GetVertex(t),c=P.MulXV(n,l,Se);return s.DotVV(s.SubVV(c,a,s.s_t0),r)}default:return 0}}}const or=new Xe,rr=new hi,ar=new ci,lr=new _i,mr=new _n,hr=[0],cr=[0],_r=new $t,ur=new $t;function Ai(d,t){const e=or.Reset();++m.b2_toiCalls,d.state=m.b2TOIOutputState.e_unknown,d.t=t.tMax;const i=t.proxyA,n=t.proxyB,o=W(mt,W(i.m_count,n.m_count)),r=_r.Copy(t.sweepA),a=ur.Copy(t.sweepB);r.Normalize(),a.Normalize();const l=t.tMax,c=i.m_radius+n.m_radius,_=W(N,c-3*N),h=.25*N;let u=0;const f=20;let p=0;const y=rr;y.count=0;const B=ar;for(B.proxyA.Copy(t.proxyA),B.proxyB.Copy(t.proxyB),B.useRadii=!1;;){const x=Gs,C=Ds;r.GetTransform(x,u),a.GetTransform(C,u),B.transformA.Copy(x),B.transformB.Copy(C);const v=lr;if(ui(v,y,B),v.distance<=0){d.state=m.b2TOIOutputState.e_overlapped,d.t=0;break}if(v.distance<_+h){d.state=m.b2TOIOutputState.e_touching,d.t=u;break}const M=mr;M.Initialize(y,i,r,n,a,u);let G=!1,I=l,T=0;for(;;){const F=hr,q=cr;let J=M.FindMinSeparation(F,q,I);if(J>_+h){d.state=m.b2TOIOutputState.e_separated,d.t=l,G=!0;break}if(J>_-h){u=I;break}let L=M.Evaluate(F[0],q[0],u);if(L<_-h){d.state=m.b2TOIOutputState.e_failed,d.t=u,G=!0;break}if(L<=_+h){d.state=m.b2TOIOutputState.e_touching,d.t=u,G=!0;break}let D=0,Z=u,U=I;for(;;){let tt=0;D&1?tt=Z+(_-L)*(U-Z)/(J-L):tt=.5*(Z+U),++D,++m.b2_toiRootIters;const ct=M.Evaluate(F[0],q[0],tt);if(ht(ct-_)<h){I=tt;break}if(ct>_?(Z=tt,L=ct):(U=tt,J=ct),D===50)break}if(m.b2_toiMaxRootIters=W(m.b2_toiMaxRootIters,D),++T,T===o)break}if(++p,++m.b2_toiIters,G)break;if(p===f){d.state=m.b2TOIOutputState.e_failed,d.t=u;break}}m.b2_toiMaxIters=W(m.b2_toiMaxIters,p);const A=e.GetMilliseconds();m.b2_toiMaxTime=W(m.b2_toiMaxTime,A),m.b2_toiTime+=A}const dr=new s,fr=new s;function un(d,t,e,i,n){d.pointCount=0;const o=P.MulXV(e,t.m_p,dr),r=P.MulXV(n,i.m_p,fr),a=s.DistanceSquaredVV(o,r),l=t.m_radius+i.m_radius;a>l*l||(d.type=m.b2ManifoldType.e_circles,d.localPoint.Copy(t.m_p),d.localNormal.SetZero(),d.pointCount=1,d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0)}const pr=new s,yr=new s,Br=new s;function dn(d,t,e,i,n){d.pointCount=0;const o=P.MulXV(n,i.m_p,pr),r=P.MulTXV(e,o,yr);let a=0,l=-R;const c=t.m_radius+i.m_radius,_=t.m_count,h=t.m_vertices,u=t.m_normals;for(let C=0;C<_;++C){const v=s.DotVV(u[C],s.SubVV(r,h[C],s.s_t0));if(v>c)return;v>l&&(l=v,a=C)}const f=a,p=(f+1)%_,y=h[f],B=h[p];if(l<E){d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,d.localNormal.Copy(u[a]),s.MidVV(y,B,d.localPoint),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0;return}const A=s.DotVV(s.SubVV(r,y,s.s_t0),s.SubVV(B,y,s.s_t1)),x=s.DotVV(s.SubVV(r,B,s.s_t0),s.SubVV(y,B,s.s_t1));if(A<=0){if(s.DistanceSquaredVV(r,y)>c*c)return;d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,s.SubVV(r,y,d.localNormal).SelfNormalize(),d.localPoint.Copy(y),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0}else if(x<=0){if(s.DistanceSquaredVV(r,B)>c*c)return;d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,s.SubVV(r,B,d.localNormal).SelfNormalize(),d.localPoint.Copy(B),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0}else{const C=s.MidVV(y,B,Br);if(s.DotVV(s.SubVV(r,C,s.s_t1),u[f])>c)return;d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,d.localNormal.Copy(u[f]).SelfNormalize(),d.localPoint.Copy(C),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0}}const Ar=new s,xr=new s,Sr=new s,Cr=new s;function Fs(d,t,e,i,n){const o=d.m_vertices,r=d.m_normals,a=i.m_count,l=i.m_vertices,c=w.MulRV(t.q,r[e],Ar),_=w.MulTRV(n.q,c,xr);let h=0,u=R;for(let B=0;B<a;++B){const A=s.DotVV(l[B],_);A<u&&(u=A,h=B)}const f=P.MulXV(t,o[e],Sr),p=P.MulXV(n,l[h],Cr);return s.DotVV(s.SubVV(p,f,s.s_t0),c)}const vr=new s,br=new s;function fn(d,t,e,i,n){const o=t.m_count,r=t.m_normals,a=s.SubVV(P.MulXV(n,i.m_centroid,s.s_t0),P.MulXV(e,t.m_centroid,s.s_t1),vr),l=w.MulTRV(e.q,a,br);let c=0,_=-R;for(let C=0;C<o;++C){const v=s.DotVV(r[C],l);v>_&&(_=v,c=C)}let h=Fs(t,e,c,i,n);const u=(c+o-1)%o,f=Fs(t,e,u,i,n),p=(c+1)%o,y=Fs(t,e,p,i,n);let B=0,A=0,x=0;if(f>h&&f>y)x=-1,B=u,A=f;else if(y>h)x=1,B=p,A=y;else return d[0]=c,h;for(;x===-1?c=(B+o-1)%o:c=(B+1)%o,h=Fs(t,e,c,i,n),h>A;)B=c,A=h;return d[0]=B,A}const Vr=new s;function wr(d,t,e,i,n,o){const r=t.m_normals,a=n.m_count,l=n.m_vertices,c=n.m_normals,_=w.MulTRV(o.q,w.MulRV(e.q,r[i],s.s_t0),Vr);let h=0,u=R;for(let C=0;C<a;++C){const v=s.DotVV(_,c[C]);v<u&&(u=v,h=C)}const f=h,p=(f+1)%a,y=d[0];P.MulXV(o,l[f],y.v);const B=y.id.cf;B.indexA=i,B.indexB=f,B.typeA=m.b2ContactFeatureType.e_face,B.typeB=m.b2ContactFeatureType.e_vertex;const A=d[1];P.MulXV(o,l[p],A.v);const x=A.id.cf;x.indexA=i,x.indexB=p,x.typeA=m.b2ContactFeatureType.e_face,x.typeB=m.b2ContactFeatureType.e_vertex}const gr=xe.MakeArray(2),Mr=xe.MakeArray(2),Pr=xe.MakeArray(2),Ir=[0],Gr=[0],Dr=new s,Fr=new s,Lr=new s,Tr=new s,Rr=new s,kr=new s,qr=new s,zr=new s;function pn(d,t,e,i,n){d.pointCount=0;const o=t.m_radius+i.m_radius,r=Ir;r[0]=0;const a=fn(r,t,e,i,n);if(a>o)return;const l=Gr;l[0]=0;const c=fn(l,i,n,t,e);if(c>o)return;let _,h,u,f,p=0,y=0;const B=.98,A=.001;c>B*a+A?(_=i,h=t,u=n,f=e,p=l[0],d.type=m.b2ManifoldType.e_faceB,y=1):(_=t,h=i,u=e,f=n,p=r[0],d.type=m.b2ManifoldType.e_faceA,y=0);const x=gr;wr(x,_,u,p,h,f);const C=_.m_count,v=_.m_vertices,M=p,G=(p+1)%C,I=v[M],T=v[G],F=s.SubVV(T,I,Dr);F.Normalize();const q=s.CrossVOne(F,Fr),J=s.MidVV(I,T,Lr),L=w.MulRV(u.q,F,Rr),D=s.CrossVOne(L,Tr),Z=P.MulXV(u,I,qr),U=P.MulXV(u,T,zr),tt=s.DotVV(D,Z),ct=-s.DotVV(L,Z)+o,_t=s.DotVV(L,U)+o,Lt=Mr,Tt=Pr;let Rt;const Qe=s.NegV(L,kr);if(Rt=ss(Lt,x,Qe,ct,M),Rt<2||(Rt=ss(Tt,Lt,L,_t,G),Rt<2))return;d.localNormal.Copy(q),d.localPoint.Copy(J);let Be=0;for(let We=0;We<z;++We){const Zt=Tt[We];if(s.DotVV(D,Zt.v)-tt<=o){const Mt=d.points[Be];if(P.MulTXV(f,Zt.v,Mt.localPoint),Mt.id.Copy(Zt.id),y){const de=Mt.id.cf;Mt.id.cf.indexA=de.indexB,Mt.id.cf.indexB=de.indexA,Mt.id.cf.typeA=de.typeB,Mt.id.cf.typeB=de.typeA}++Be}}d.pointCount=Be}const Er=new s,Nr=new s,xi=new s,jr=new s,Or=new s,Jr=new s,Xr=new s,Ur=new Ue;function Si(d,t,e,i,n){d.pointCount=0;const o=P.MulTXV(e,P.MulXV(n,i.m_p,s.s_t0),Er),r=t.m_vertex1,a=t.m_vertex2,l=s.SubVV(a,r,Nr),c=s.DotVV(l,s.SubVV(a,o,s.s_t0)),_=s.DotVV(l,s.SubVV(o,r,s.s_t0)),h=t.m_radius+i.m_radius,u=Ur;if(u.cf.indexB=0,u.cf.typeB=m.b2ContactFeatureType.e_vertex,_<=0){const x=r,C=s.SubVV(o,x,xi);if(s.DotVV(C,C)>h*h)return;if(t.m_hasVertex0){const M=t.m_vertex0,G=r,I=s.SubVV(G,M,jr);if(s.DotVV(I,s.SubVV(G,o,s.s_t0))>0)return}u.cf.indexA=0,u.cf.typeA=m.b2ContactFeatureType.e_vertex,d.pointCount=1,d.type=m.b2ManifoldType.e_circles,d.localNormal.SetZero(),d.localPoint.Copy(x),d.points[0].id.Copy(u),d.points[0].localPoint.Copy(i.m_p);return}if(c<=0){const x=a,C=s.SubVV(o,x,xi);if(s.DotVV(C,C)>h*h)return;if(t.m_hasVertex3){const M=t.m_vertex3,G=a,I=s.SubVV(M,G,Or);if(s.DotVV(I,s.SubVV(o,G,s.s_t0))>0)return}u.cf.indexA=1,u.cf.typeA=m.b2ContactFeatureType.e_vertex,d.pointCount=1,d.type=m.b2ManifoldType.e_circles,d.localNormal.SetZero(),d.localPoint.Copy(x),d.points[0].id.Copy(u),d.points[0].localPoint.Copy(i.m_p);return}const f=s.DotVV(l,l),p=Jr;p.x=1/f*(c*r.x+_*a.x),p.y=1/f*(c*r.y+_*a.y);const y=s.SubVV(o,p,xi);if(s.DotVV(y,y)>h*h)return;const A=Xr.Set(-l.y,l.x);s.DotVV(A,s.SubVV(o,r,s.s_t0))<0&&A.Set(-A.x,-A.y),A.Normalize(),u.cf.indexA=0,u.cf.typeA=m.b2ContactFeatureType.e_face,d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,d.localNormal.Copy(A),d.localPoint.Copy(r),d.points[0].id.Copy(u),d.points[0].localPoint.Copy(i.m_p)}var te;(function(d){d[d.e_unknown=0]="e_unknown",d[d.e_edgeA=1]="e_edgeA",d[d.e_edgeB=2]="e_edgeB"})(te||(te={}));class yn{constructor(){this.type=te.e_unknown,this.index=0,this.separation=0}}class Zr{constructor(){this.vertices=[],this.normals=[],this.count=0}}class Hr{constructor(){this.i1=0,this.i2=0,this.v1=new s,this.v2=new s,this.normal=new s,this.sideNormal1=new s,this.sideOffset1=0,this.sideNormal2=new s,this.sideOffset2=0}}var Ls;(function(d){d[d.e_isolated=0]="e_isolated",d[d.e_concave=1]="e_concave",d[d.e_convex=2]="e_convex"})(Ls||(Ls={}));class yt{constructor(){this.m_polygonB=new Zr,this.m_xf=new P,this.m_centroidB=new s,this.m_v0=new s,this.m_v1=new s,this.m_v2=new s,this.m_v3=new s,this.m_normal0=new s,this.m_normal1=new s,this.m_normal2=new s,this.m_normal=new s,this.m_type1=Ls.e_isolated,this.m_type2=Ls.e_isolated,this.m_lowerLimit=new s,this.m_upperLimit=new s,this.m_radius=0,this.m_front=!1}Collide(t,e,i,n,o){P.MulTXX(i,o,this.m_xf),P.MulXV(this.m_xf,n.m_centroid,this.m_centroidB),this.m_v0.Copy(e.m_vertex0),this.m_v1.Copy(e.m_vertex1),this.m_v2.Copy(e.m_vertex2),this.m_v3.Copy(e.m_vertex3);const r=e.m_hasVertex0,a=e.m_hasVertex3,l=s.SubVV(this.m_v2,this.m_v1,yt.s_edge1);l.Normalize(),this.m_normal1.Set(l.y,-l.x);const c=s.DotVV(this.m_normal1,s.SubVV(this.m_centroidB,this.m_v1,s.s_t0));let _=0,h=0,u=!1,f=!1;if(r){const F=s.SubVV(this.m_v1,this.m_v0,yt.s_edge0);F.Normalize(),this.m_normal0.Set(F.y,-F.x),u=s.CrossVV(F,l)>=0,_=s.DotVV(this.m_normal0,s.SubVV(this.m_centroidB,this.m_v0,s.s_t0))}if(a){const F=s.SubVV(this.m_v3,this.m_v2,yt.s_edge2);F.Normalize(),this.m_normal2.Set(F.y,-F.x),f=s.CrossVV(l,F)>0,h=s.DotVV(this.m_normal2,s.SubVV(this.m_centroidB,this.m_v2,s.s_t0))}r&&a?u&&f?(this.m_front=_>=0||c>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):u?(this.m_front=_>=0||c>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):f?(this.m_front=h>=0||_>=0&&c>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&c>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):r?u?(this.m_front=_>=0||c>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&c>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):a?f?(this.m_front=c>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=c>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=c>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=n.m_count;for(let F=0;F<n.m_count;++F)this.m_polygonB.vertices.length<=F&&this.m_polygonB.vertices.push(new s),this.m_polygonB.normals.length<=F&&this.m_polygonB.normals.push(new s),P.MulXV(this.m_xf,n.m_vertices[F],this.m_polygonB.vertices[F]),w.MulRV(this.m_xf.q,n.m_normals[F],this.m_polygonB.normals[F]);this.m_radius=n.m_radius+e.m_radius,t.pointCount=0;const p=this.ComputeEdgeSeparation(yt.s_edgeAxis);if(p.type===te.e_unknown||p.separation>this.m_radius)return;const y=this.ComputePolygonSeparation(yt.s_polygonAxis);if(y.type!==te.e_unknown&&y.separation>this.m_radius)return;const B=.98,A=.001;let x;y.type===te.e_unknown?x=p:y.separation>B*p.separation+A?x=y:x=p;const C=yt.s_ie,v=yt.s_rf;if(x.type===te.e_edgeA){t.type=m.b2ManifoldType.e_faceA;let F=0,q=s.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(let U=1;U<this.m_polygonB.count;++U){const tt=s.DotVV(this.m_normal,this.m_polygonB.normals[U]);tt<q&&(q=tt,F=U)}const J=F,L=(J+1)%this.m_polygonB.count,D=C[0];D.v.Copy(this.m_polygonB.vertices[J]),D.id.cf.indexA=0,D.id.cf.indexB=J,D.id.cf.typeA=m.b2ContactFeatureType.e_face,D.id.cf.typeB=m.b2ContactFeatureType.e_vertex;const Z=C[1];Z.v.Copy(this.m_polygonB.vertices[L]),Z.id.cf.indexA=0,Z.id.cf.indexB=L,Z.id.cf.typeA=m.b2ContactFeatureType.e_face,Z.id.cf.typeB=m.b2ContactFeatureType.e_vertex,this.m_front?(v.i1=0,v.i2=1,v.v1.Copy(this.m_v1),v.v2.Copy(this.m_v2),v.normal.Copy(this.m_normal1)):(v.i1=1,v.i2=0,v.v1.Copy(this.m_v2),v.v2.Copy(this.m_v1),v.normal.Copy(this.m_normal1).SelfNeg())}else{t.type=m.b2ManifoldType.e_faceB;const F=C[0];F.v.Copy(this.m_v1),F.id.cf.indexA=0,F.id.cf.indexB=x.index,F.id.cf.typeA=m.b2ContactFeatureType.e_vertex,F.id.cf.typeB=m.b2ContactFeatureType.e_face;const q=C[1];q.v.Copy(this.m_v2),q.id.cf.indexA=0,q.id.cf.indexB=x.index,q.id.cf.typeA=m.b2ContactFeatureType.e_vertex,q.id.cf.typeB=m.b2ContactFeatureType.e_face,v.i1=x.index,v.i2=(v.i1+1)%this.m_polygonB.count,v.v1.Copy(this.m_polygonB.vertices[v.i1]),v.v2.Copy(this.m_polygonB.vertices[v.i2]),v.normal.Copy(this.m_polygonB.normals[v.i1])}v.sideNormal1.Set(v.normal.y,-v.normal.x),v.sideNormal2.Copy(v.sideNormal1).SelfNeg(),v.sideOffset1=s.DotVV(v.sideNormal1,v.v1),v.sideOffset2=s.DotVV(v.sideNormal2,v.v2);const M=yt.s_clipPoints1,G=yt.s_clipPoints2;let I=0;if(I=ss(M,C,v.sideNormal1,v.sideOffset1,v.i1),I<z||(I=ss(G,M,v.sideNormal2,v.sideOffset2,v.i2),I<z))return;x.type===te.e_edgeA?(t.localNormal.Copy(v.normal),t.localPoint.Copy(v.v1)):(t.localNormal.Copy(n.m_normals[v.i1]),t.localPoint.Copy(n.m_vertices[v.i1]));let T=0;for(let F=0;F<z;++F){let q;if(q=s.DotVV(v.normal,s.SubVV(G[F].v,v.v1,s.s_t0)),q<=this.m_radius){const J=t.points[T];x.type===te.e_edgeA?(P.MulTXV(this.m_xf,G[F].v,J.localPoint),J.id.Copy(G[F].id)):(J.localPoint.Copy(G[F].v),J.id.cf.typeA=G[F].id.cf.typeB,J.id.cf.typeB=G[F].id.cf.typeA,J.id.cf.indexA=G[F].id.cf.indexB,J.id.cf.indexB=G[F].id.cf.indexA),++T}}t.pointCount=T}ComputeEdgeSeparation(t){const e=t;e.type=te.e_edgeA,e.index=this.m_front?0:1,e.separation=R;for(let i=0;i<this.m_polygonB.count;++i){const n=s.DotVV(this.m_normal,s.SubVV(this.m_polygonB.vertices[i],this.m_v1,s.s_t0));n<e.separation&&(e.separation=n)}return e}ComputePolygonSeparation(t){const e=t;e.type=te.e_unknown,e.index=-1,e.separation=-R;const i=yt.s_perp.Set(-this.m_normal.y,this.m_normal.x);for(let n=0;n<this.m_polygonB.count;++n){const o=s.NegV(this.m_polygonB.normals[n],yt.s_n),r=s.DotVV(o,s.SubVV(this.m_polygonB.vertices[n],this.m_v1,s.s_t0)),a=s.DotVV(o,s.SubVV(this.m_polygonB.vertices[n],this.m_v2,s.s_t0)),l=et(r,a);if(l>this.m_radius)return e.type=te.e_edgeB,e.index=n,e.separation=l,e;if(s.DotVV(o,i)>=0){if(s.DotVV(s.SubVV(o,this.m_upperLimit,s.s_t0),this.m_normal)<-Bt)continue}else if(s.DotVV(s.SubVV(o,this.m_lowerLimit,s.s_t0),this.m_normal)<-Bt)continue;l>e.separation&&(e.type=te.e_edgeB,e.index=n,e.separation=l)}return e}}yt.s_edge1=new s,yt.s_edge0=new s,yt.s_edge2=new s,yt.s_ie=xe.MakeArray(2),yt.s_rf=new Hr,yt.s_clipPoints1=xe.MakeArray(2),yt.s_clipPoints2=xe.MakeArray(2),yt.s_edgeAxis=new yn,yt.s_polygonAxis=new yn,yt.s_n=new s,yt.s_perp=new s;const Qr=new yt;function Ci(d,t,e,i,n){Qr.Collide(d,t,e,i,n)}class Ts{constructor(){this.mass=0,this.center=new s(0,0),this.I=0}}(function(d){d[d.e_unknown=-1]="e_unknown",d[d.e_circleShape=0]="e_circleShape",d[d.e_edgeShape=1]="e_edgeShape",d[d.e_polygonShape=2]="e_polygonShape",d[d.e_chainShape=3]="e_chainShape",d[d.e_shapeTypeCount=4]="e_shapeTypeCount"})(m.b2ShapeType||(m.b2ShapeType={}));class De{constructor(t,e){this.m_type=m.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=t,this.m_radius=e}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class zt extends De{constructor(t=0){super(m.b2ShapeType.e_circleShape,t),this.m_p=new s}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return new zt().Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=P.MulXV(t,this.m_p,zt.TestPoint_s_center),n=s.SubVV(e,i,zt.TestPoint_s_d);return s.DotVV(n,n)<=Je(this.m_radius)}ComputeDistance(t,e,i,n){const o=P.MulXV(t,this.m_p,zt.ComputeDistance_s_center);return s.SubVV(e,o,i),i.Normalize()-this.m_radius}RayCast(t,e,i,n){const o=P.MulXV(i,this.m_p,zt.RayCast_s_position),r=s.SubVV(e.p1,o,zt.RayCast_s_s),a=s.DotVV(r,r)-Je(this.m_radius),l=s.SubVV(e.p2,e.p1,zt.RayCast_s_r),c=s.DotVV(r,l),_=s.DotVV(l,l),h=c*c-_*a;if(h<0||_<E)return!1;let u=-(c+pe(h));return 0<=u&&u<=e.maxFraction*_?(u/=_,t.fraction=u,s.AddVMulSV(r,u,l,t.normal).SelfNormalize(),!0):!1}ComputeAABB(t,e,i){const n=P.MulXV(e,this.m_p,zt.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)}ComputeMass(t,e){const i=Je(this.m_radius);t.mass=e*k*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+s.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const o=P.MulXV(i,this.m_p,new s),r=-(s.DotVV(t,o)-e);if(r<-this.m_radius+E)return 0;if(r>this.m_radius)return n.Copy(o),k*this.m_radius*this.m_radius;const a=this.m_radius*this.m_radius,l=r*r,c=a*(tn(r/this.m_radius)+k/2)+r*pe(a-l),_=-2/3*$i(a-l,1.5)/c;return n.x=o.x+t.x*_,n.y=o.y+t.y*_,c}Dump(t){t(`    const shape: b2CircleShape = new b2CircleShape();
`),t(`    shape.m_radius = %.15f;
`,this.m_radius),t(`    shape.m_p.Set(%.15f, %.15f);
`,this.m_p.x,this.m_p.y)}}zt.TestPoint_s_center=new s,zt.TestPoint_s_d=new s,zt.ComputeDistance_s_center=new s,zt.RayCast_s_position=new s,zt.RayCast_s_s=new s,zt.RayCast_s_r=new s,zt.ComputeAABB_s_p=new s;class Q extends De{constructor(){super(m.b2ShapeType.e_polygonShape,At),this.m_centroid=new s(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return new Q().Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=s.MakeArray(this.m_count),this.m_normals=s.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if(typeof t[0][0]=="number"){const e=t[0];if(e.length%2!==0)throw new Error;return this._Set(i=>({x:e[i*2],y:e[i*2+1]}),e.length/2)}else{const e=t[0],i=t[1]||e.length;return this._Set(n=>e[n],i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const n=[];for(let _=0;_<i;++_){const h=t(_);let u=!0;for(let f=0;f<n.length;++f)if(s.DistanceSquaredVV(h,n[f])<.5*N*(.5*N)){u=!1;break}u&&n.push(h)}if(i=n.length,i<3)return this.SetAsBox(1,1);let o=0,r=n[0].x;for(let _=1;_<i;++_){const h=n[_].x;(h>r||h===r&&n[_].y<n[o].y)&&(o=_,r=h)}const a=[];let l=0,c=o;for(;;){a[l]=c;let _=0;for(let h=1;h<i;++h){if(_===c){_=h;continue}const u=s.SubVV(n[_],n[a[l]],Q.Set_s_r),f=s.SubVV(n[h],n[a[l]],Q.Set_s_v),p=s.CrossVV(u,f);p<0&&(_=h),p===0&&f.LengthSquared()>u.LengthSquared()&&(_=h)}if(++l,c=_,_===o)break}this.m_count=l,this.m_vertices=s.MakeArray(this.m_count),this.m_normals=s.MakeArray(this.m_count);for(let _=0;_<l;++_)this.m_vertices[_].Copy(n[a[_]]);for(let _=0;_<l;++_){const h=this.m_vertices[_],u=this.m_vertices[(_+1)%l],f=s.SubVV(u,h,s.s_t0);s.CrossVOne(f,this.m_normals[_]).SelfNormalize()}return Q.ComputeCentroid(this.m_vertices,l,this.m_centroid),this}SetAsBox(t,e,i,n=0){if(this.m_count=4,this.m_vertices=s.MakeArray(this.m_count),this.m_normals=s.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const o=new P;o.SetPosition(i),o.SetRotationAngle(n);for(let r=0;r<this.m_count;++r)P.MulXV(o,this.m_vertices[r],this.m_vertices[r]),w.MulRV(o.q,this.m_normals[r],this.m_normals[r])}return this}TestPoint(t,e){const i=P.MulTXV(t,e,Q.TestPoint_s_pLocal);for(let n=0;n<this.m_count;++n)if(s.DotVV(this.m_normals[n],s.SubVV(i,this.m_vertices[n],s.s_t0))>0)return!1;return!0}ComputeDistance(t,e,i,n){const o=P.MulTXV(t,e,Q.ComputeDistance_s_pLocal);let r=-R;const a=Q.ComputeDistance_s_normalForMaxDistance.Copy(o);for(let l=0;l<this.m_count;++l){const c=s.DotVV(this.m_normals[l],s.SubVV(o,this.m_vertices[l],s.s_t0));c>r&&(r=c,a.Copy(this.m_normals[l]))}if(r>0){const l=Q.ComputeDistance_s_minDistance.Copy(a);let c=r*r;for(let _=0;_<this.m_count;++_){const h=s.SubVV(o,this.m_vertices[_],Q.ComputeDistance_s_distance),u=h.LengthSquared();c>u&&(l.Copy(h),c=u)}return w.MulRV(t.q,l,i),i.Normalize(),Math.sqrt(c)}else return w.MulRV(t.q,a,i),r}RayCast(t,e,i,n){const o=P.MulTXV(i,e.p1,Q.RayCast_s_p1),r=P.MulTXV(i,e.p2,Q.RayCast_s_p2),a=s.SubVV(r,o,Q.RayCast_s_d);let l=0,c=e.maxFraction,_=-1;for(let h=0;h<this.m_count;++h){const u=s.DotVV(this.m_normals[h],s.SubVV(this.m_vertices[h],o,s.s_t0)),f=s.DotVV(this.m_normals[h],a);if(f===0){if(u<0)return!1}else f<0&&u<l*f?(l=u/f,_=h):f>0&&u<c*f&&(c=u/f);if(c<l)return!1}return _>=0?(t.fraction=l,w.MulRV(i.q,this.m_normals[_],t.normal),!0):!1}ComputeAABB(t,e,i){const n=P.MulXV(e,this.m_vertices[0],t.lowerBound),o=t.upperBound.Copy(n);for(let a=0;a<this.m_count;++a){const l=P.MulXV(e,this.m_vertices[a],Q.ComputeAABB_s_v);s.MinV(l,n,n),s.MaxV(l,o,o)}const r=this.m_radius;n.SelfSubXY(r,r),o.SelfAddXY(r,r)}ComputeMass(t,e){const i=Q.ComputeMass_s_center.SetZero();let n=0,o=0;const r=Q.ComputeMass_s_s.SetZero();for(let l=0;l<this.m_count;++l)r.SelfAdd(this.m_vertices[l]);r.SelfMul(1/this.m_count);const a=1/3;for(let l=0;l<this.m_count;++l){const c=s.SubVV(this.m_vertices[l],r,Q.ComputeMass_s_e1),_=s.SubVV(this.m_vertices[(l+1)%this.m_count],r,Q.ComputeMass_s_e2),h=s.CrossVV(c,_),u=.5*h;n+=u,i.SelfAdd(s.MulSV(u*a,s.AddVV(c,_,s.s_t0),s.s_t1));const f=c.x,p=c.y,y=_.x,B=_.y,A=f*f+y*f+y*y,x=p*p+B*p+B*B;o+=.25*a*h*(A+x)}t.mass=e*n,i.SelfMul(1/n),s.AddVV(i,r,t.center),t.I=e*o,t.I+=t.mass*(s.DotVV(t.center,t.center)-s.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,n=this.m_vertices[e],o=s.SubVV(this.m_vertices[i],n,Q.Validate_s_e);for(let r=0;r<this.m_count;++r){if(r===e||r===i)continue;const a=s.SubVV(this.m_vertices[r],n,Q.Validate_s_v);if(s.CrossVV(o,a)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const o=w.MulTRV(i.q,t,Q.ComputeSubmergedArea_s_normalL),r=e-s.DotVV(t,i.p),a=[];let l=0,c=-1,_=-1,h=!1;for(let I=0;I<this.m_count;++I){a[I]=s.DotVV(o,this.m_vertices[I])-r;const T=a[I]<-E;I>0&&(T?h||(c=I-1,l++):h&&(_=I-1,l++)),h=T}switch(l){case 0:if(h){const I=Q.ComputeSubmergedArea_s_md;return this.ComputeMass(I,1),P.MulXV(i,I.center,n),I.mass}else return 0;case 1:c===-1?c=this.m_count-1:_=this.m_count-1;break}const u=(c+1)%this.m_count,f=(_+1)%this.m_count,p=(0-a[c])/(a[u]-a[c]),y=(0-a[_])/(a[f]-a[_]),B=Q.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[c].x*(1-p)+this.m_vertices[u].x*p,this.m_vertices[c].y*(1-p)+this.m_vertices[u].y*p),A=Q.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[_].x*(1-y)+this.m_vertices[f].x*y,this.m_vertices[_].y*(1-y)+this.m_vertices[f].y*y);let x=0;const C=Q.ComputeSubmergedArea_s_center.SetZero();let v=this.m_vertices[u],M,G=u;for(;G!==f;){G=(G+1)%this.m_count,G===f?M=A:M=this.m_vertices[G];const I=.5*((v.x-B.x)*(M.y-B.y)-(v.y-B.y)*(M.x-B.x));x+=I,C.x+=I*(B.x+v.x+M.x)/3,C.y+=I*(B.y+v.y+M.y)/3,v=M}return C.SelfMul(1/x),P.MulXV(i,C,n),x}Dump(t){t(`    const shape: b2PolygonShape = new b2PolygonShape();
`),t(`    const vs: b2Vec2[] = [];
`);for(let e=0;e<this.m_count;++e)t(`    vs[%d] = new b2Vec2(%.15f, %.15f);
`,e,this.m_vertices[e].x,this.m_vertices[e].y);t(`    shape.Set(vs, %d);
`,this.m_count)}static ComputeCentroid(t,e,i){const n=i;n.SetZero();let o=0;const r=Q.ComputeCentroid_s_pRef.SetZero(),a=1/3;for(let l=0;l<e;++l){const c=r,_=t[l],h=t[(l+1)%e],u=s.SubVV(_,c,Q.ComputeCentroid_s_e1),f=s.SubVV(h,c,Q.ComputeCentroid_s_e2),p=s.CrossVV(u,f),y=.5*p;o+=y,n.x+=y*a*(c.x+_.x+h.x),n.y+=y*a*(c.y+_.y+h.y)}return n.SelfMul(1/o),n}}Q.Set_s_r=new s,Q.Set_s_v=new s,Q.TestPoint_s_pLocal=new s,Q.ComputeDistance_s_pLocal=new s,Q.ComputeDistance_s_normalForMaxDistance=new s,Q.ComputeDistance_s_minDistance=new s,Q.ComputeDistance_s_distance=new s,Q.RayCast_s_p1=new s,Q.RayCast_s_p2=new s,Q.RayCast_s_d=new s,Q.ComputeAABB_s_v=new s,Q.ComputeMass_s_center=new s,Q.ComputeMass_s_s=new s,Q.ComputeMass_s_e1=new s,Q.ComputeMass_s_e2=new s,Q.Validate_s_e=new s,Q.Validate_s_v=new s,Q.ComputeSubmergedArea_s_normalL=new s,Q.ComputeSubmergedArea_s_md=new Ts,Q.ComputeSubmergedArea_s_intoVec=new s,Q.ComputeSubmergedArea_s_outoVec=new s,Q.ComputeSubmergedArea_s_center=new s,Q.ComputeCentroid_s_pRef=new s,Q.ComputeCentroid_s_e1=new s,Q.ComputeCentroid_s_e2=new s;class ot extends De{constructor(){super(m.b2ShapeType.e_edgeShape,At),this.m_vertex1=new s,this.m_vertex2=new s,this.m_vertex0=new s,this.m_vertex3=new s,this.m_hasVertex0=!1,this.m_hasVertex3=!1}Set(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}Clone(){return new ot().Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const o=P.MulXV(t,this.m_vertex1,ot.ComputeDistance_s_v1),r=P.MulXV(t,this.m_vertex2,ot.ComputeDistance_s_v2),a=s.SubVV(e,o,ot.ComputeDistance_s_d),l=s.SubVV(r,o,ot.ComputeDistance_s_s),c=s.DotVV(a,l);if(c>0){const _=s.DotVV(l,l);c>_?s.SubVV(e,r,a):a.SelfMulSub(c/_,l)}return i.Copy(a),i.Normalize()}RayCast(t,e,i,n){const o=P.MulTXV(i,e.p1,ot.RayCast_s_p1),r=P.MulTXV(i,e.p2,ot.RayCast_s_p2),a=s.SubVV(r,o,ot.RayCast_s_d),l=this.m_vertex1,c=this.m_vertex2,_=s.SubVV(c,l,ot.RayCast_s_e),h=t.normal.Set(_.y,-_.x).SelfNormalize(),u=s.DotVV(h,s.SubVV(l,o,s.s_t0)),f=s.DotVV(h,a);if(f===0)return!1;const p=u/f;if(p<0||e.maxFraction<p)return!1;const y=s.AddVMulSV(o,p,a,ot.RayCast_s_q),B=s.SubVV(c,l,ot.RayCast_s_r),A=s.DotVV(B,B);if(A===0)return!1;const x=s.DotVV(s.SubVV(y,l,s.s_t0),B)/A;return x<0||1<x?!1:(t.fraction=p,w.MulRV(i.q,t.normal,t.normal),u>0&&t.normal.SelfNeg(),!0)}ComputeAABB(t,e,i){const n=P.MulXV(e,this.m_vertex1,ot.ComputeAABB_s_v1),o=P.MulXV(e,this.m_vertex2,ot.ComputeAABB_s_v2);s.MinV(n,o,t.lowerBound),s.MaxV(n,o,t.upperBound);const r=this.m_radius;t.lowerBound.SelfSubXY(r,r),t.upperBound.SelfAddXY(r,r)}ComputeMass(t,e){t.mass=0,s.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t(`    const shape: b2EdgeShape = new b2EdgeShape();
`),t(`    shape.m_radius = %.15f;
`,this.m_radius),t(`    shape.m_vertex0.Set(%.15f, %.15f);
`,this.m_vertex0.x,this.m_vertex0.y),t(`    shape.m_vertex1.Set(%.15f, %.15f);
`,this.m_vertex1.x,this.m_vertex1.y),t(`    shape.m_vertex2.Set(%.15f, %.15f);
`,this.m_vertex2.x,this.m_vertex2.y),t(`    shape.m_vertex3.Set(%.15f, %.15f);
`,this.m_vertex3.x,this.m_vertex3.y),t(`    shape.m_hasVertex0 = %s;
`,this.m_hasVertex0),t(`    shape.m_hasVertex3 = %s;
`,this.m_hasVertex3)}}ot.ComputeDistance_s_v1=new s,ot.ComputeDistance_s_v2=new s,ot.ComputeDistance_s_d=new s,ot.ComputeDistance_s_s=new s,ot.RayCast_s_p1=new s,ot.RayCast_s_p2=new s,ot.RayCast_s_d=new s,ot.RayCast_s_e=new s,ot.RayCast_s_q=new s,ot.RayCast_s_r=new s,ot.ComputeAABB_s_v1=new s,ot.ComputeAABB_s_v2=new s;class ue extends De{constructor(){super(m.b2ShapeType.e_chainShape,At),this.m_vertices=[],this.m_count=0,this.m_prevVertex=new s,this.m_nextVertex=new s,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1}CreateLoop(...t){if(typeof t[0][0]=="number"){const e=t[0];if(e.length%2!==0)throw new Error;return this._CreateLoop(i=>({x:e[i*2],y:e[i*2+1]}),e.length/2)}else{const e=t[0],i=t[1]||e.length;return this._CreateLoop(n=>e[n],i)}}_CreateLoop(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=s.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}CreateChain(...t){if(typeof t[0][0]=="number"){const e=t[0];if(e.length%2!==0)throw new Error;return this._CreateChain(i=>({x:e[i*2],y:e[i*2+1]}),e.length/2)}else{const e=t[0],i=t[1]||e.length;return this._CreateChain(n=>e[n],i)}}_CreateChain(t,e){this.m_count=e,this.m_vertices=s.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}SetPrevVertex(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this}SetNextVertex(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this}Clone(){return new ue().Copy(this)}Copy(t){return super.Copy(t),this._CreateChain(e=>t.m_vertices[e],t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const o=ue.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,n),o.ComputeDistance(t,e,i,0)}RayCast(t,e,i,n){const o=ue.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[n]),o.m_vertex2.Copy(this.m_vertices[(n+1)%this.m_count]),o.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const n=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],r=P.MulXV(e,n,ue.ComputeAABB_s_v1),a=P.MulXV(e,o,ue.ComputeAABB_s_v2);s.MinV(r,a,t.lowerBound),s.MaxV(r,a,t.upperBound)}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t(`    const shape: b2ChainShape = new b2ChainShape();
`),t(`    const vs: b2Vec2[] = [];
`);for(let e=0;e<this.m_count;++e)t(`    vs[%d] = new bVec2(%.15f, %.15f);
`,e,this.m_vertices[e].x,this.m_vertices[e].y);t(`    shape.CreateChain(vs, %d);
`,this.m_count),t(`    shape.m_prevVertex.Set(%.15f, %.15f);
`,this.m_prevVertex.x,this.m_prevVertex.y),t(`    shape.m_nextVertex.Set(%.15f, %.15f);
`,this.m_nextVertex.x,this.m_nextVertex.y),t(`    shape.m_hasPrevVertex = %s;
`,this.m_hasPrevVertex?"true":"false"),t(`    shape.m_hasNextVertex = %s;
`,this.m_hasNextVertex?"true":"false")}}ue.ComputeDistance_s_edgeShape=new ot,ue.RayCast_s_edgeShape=new ot,ue.ComputeAABB_s_v1=new s,ue.ComputeAABB_s_v2=new s;class Me{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return new Me().Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}Me.DEFAULT=new Me;class Bn{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new Me}}class Fe{constructor(t,e){this.aabb=new Dt,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e,i){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{const n=Fe.Synchronize_s_aabb1,o=Fe.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(n,t,this.childIndex),this.fixture.m_shape.ComputeAABB(o,e,this.childIndex),this.aabb.Combine2(n,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}}}Fe.Synchronize_s_aabb1=new Dt,Fe.Synchronize_s_aabb2=new Dt;class An{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new Me,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=b(e.userData,null),this.m_friction=b(e.friction,.2),this.m_restitution=b(e.restitution,0),this.m_filter.Copy(b(e.filter,Me.DEFAULT)),this.m_isSensor=b(e.isSensor,!1),this.m_density=b(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();(i===this||n===this)&&e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new Ts){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t(`    const fd: b2FixtureDef = new b2FixtureDef();
`),t(`    fd.friction = %.15f;
`,this.m_friction),t(`    fd.restitution = %.15f;
`,this.m_restitution),t(`    fd.density = %.15f;
`,this.m_density),t(`    fd.isSensor = %s;
`,this.m_isSensor?"true":"false"),t(`    fd.filter.categoryBits = %d;
`,this.m_filter.categoryBits),t(`    fd.filter.maskBits = %d;
`,this.m_filter.maskBits),t(`    fd.filter.groupIndex = %d;
`,this.m_filter.groupIndex),this.m_shape.Dump(t),t(`
`),t(`    fd.shape = shape;
`),t(`
`),t(`    bodies[%d].CreateFixture(fd);
`,e)}CreateProxies(){if(this.m_proxies.length!==0)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new Fe(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}SynchronizeProxies(t,e,i){for(const n of this.m_proxies)n.Synchronize(t,e,i)}}(function(d){d[d.b2_unknown=-1]="b2_unknown",d[d.b2_staticBody=0]="b2_staticBody",d[d.b2_kinematicBody=1]="b2_kinematicBody",d[d.b2_dynamicBody=2]="b2_dynamicBody"})(m.b2BodyType||(m.b2BodyType={}));class Wr{constructor(){this.type=m.b2BodyType.b2_staticBody,this.position=new s(0,0),this.angle=0,this.linearVelocity=new s(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}}class Et{constructor(t,e){this.m_type=m.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new P,this.m_xf0=new P,this.m_sweep=new $t,this.m_linearVelocity=new s,this.m_angularVelocity=0,this.m_force=new s,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=b(t.bullet,!1),this.m_fixedRotationFlag=b(t.fixedRotation,!1),this.m_autoSleepFlag=b(t.allowSleep,!0),this.m_awakeFlag=b(t.awake,!0),this.m_activeFlag=b(t.active,!0),this.m_world=e,this.m_xf.p.Copy(b(t.position,s.ZERO)),this.m_xf.q.SetAngle(b(t.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(b(t.linearVelocity,s.ZERO)),this.m_angularVelocity=b(t.angularVelocity,0),this.m_linearDamping=b(t.linearDamping,0),this.m_angularDamping=b(t.angularDamping,0),this.m_gravityScale=b(t.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=b(t.type,m.b2BodyType.b2_staticBody),t.type===m.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e=0){return t instanceof De?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new An(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e}CreateFixtureShapeDensity(t,e=0){const i=Et.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;e!==null;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let n=this.m_contactList;for(;n;){const o=n.contact;n=n.next;const r=o.GetFixtureA(),a=o.GetFixtureB();(t===r||t===a)&&this.m_world.m_contactManager.Destroy(o)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),P.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(this.m_xf,this.m_xf,s.ZERO);this.m_world.m_contactManager.FindNewContacts()}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(t){this.m_type!==m.b2BodyType.b2_staticBody&&(s.DotVV(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(t){this.m_type!==m.b2BodyType.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(t,e,i=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))}ApplyForceToCenter(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))}ApplyTorque(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))}ApplyLinearImpulse(t,e,i=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)))}ApplyLinearImpulseToCenter(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))}ApplyAngularImpulse(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*s.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*s.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==m.b2BodyType.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&!this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*s.DotVV(t.center,t.center),this.m_invI=1/this.m_I);const e=Et.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t.center),P.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(this.m_sweep.c,e,s.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===m.b2BodyType.b2_staticBody||this.m_type===m.b2BodyType.b2_kinematicBody){this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a;return}const t=Et.ResetMassData_s_localCenter.SetZero();for(let i=this.m_fixtureList;i;i=i.m_next){if(i.m_density===0)continue;const n=i.GetMassData(Et.ResetMassData_s_massData);this.m_mass+=n.mass,t.x+=n.center.x*n.mass,t.y+=n.center.y*n.mass,this.m_I+=n.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,t.x*=this.m_invMass,t.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*s.DotVV(t,t),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const e=Et.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t),P.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(this.m_sweep.c,e,s.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return P.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return w.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return P.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return w.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(t,this.m_sweep.c,s.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t)return;this.m_type=t,this.ResetMassData(),this.m_type===m.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let e=this.m_contactList;for(;e;){const i=e;e=e.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(let i=this.m_fixtureList;i;i=i.m_next)i.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}IsAwake(){return this.m_awakeFlag}SetActive(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(let e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(let i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxies();let e=this.m_contactList;for(;e;){const i=e;e=e.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null}}IsActive(){return this.m_activeFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(t){const e=this.m_islandIndex;t(`{
`),t(`  const bd: b2BodyDef = new b2BodyDef();
`);let i="";switch(this.m_type){case m.b2BodyType.b2_staticBody:i="b2BodyType.b2_staticBody";break;case m.b2BodyType.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case m.b2BodyType.b2_dynamicBody:i="b2BodyType.b2_dynamicBody";break}t(`  bd.type = %s;
`,i),t(`  bd.position.Set(%.15f, %.15f);
`,this.m_xf.p.x,this.m_xf.p.y),t(`  bd.angle = %.15f;
`,this.m_sweep.a),t(`  bd.linearVelocity.Set(%.15f, %.15f);
`,this.m_linearVelocity.x,this.m_linearVelocity.y),t(`  bd.angularVelocity = %.15f;
`,this.m_angularVelocity),t(`  bd.linearDamping = %.15f;
`,this.m_linearDamping),t(`  bd.angularDamping = %.15f;
`,this.m_angularDamping),t(`  bd.allowSleep = %s;
`,this.m_autoSleepFlag?"true":"false"),t(`  bd.awake = %s;
`,this.m_awakeFlag?"true":"false"),t(`  bd.fixedRotation = %s;
`,this.m_fixedRotationFlag?"true":"false"),t(`  bd.bullet = %s;
`,this.m_bulletFlag?"true":"false"),t(`  bd.active = %s;
`,this.m_activeFlag?"true":"false"),t(`  bd.gravityScale = %.15f;
`,this.m_gravityScale),t(`
`),t(`  bodies[%d] = this.m_world.CreateBody(bd);
`,this.m_islandIndex),t(`
`);for(let n=this.m_fixtureList;n;n=n.m_next)t(`  {
`),n.Dump(t,e),t(`  }
`);t(`}
`)}SynchronizeFixtures(){const t=Et.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),w.MulRV(t.q,this.m_sweep.localCenter,t.p),s.SubVV(this.m_sweep.c0,t.p,t.p);const e=s.SubVV(this.m_sweep.c,this.m_sweep.c0,Et.SynchronizeFixtures_s_displacement);for(let i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,e)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),w.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),s.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(t){return this.m_type===m.b2BodyType.b2_staticBody&&t.m_type===m.b2BodyType.b2_staticBody?!1:this.ShouldCollideConnected(t)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),w.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),s.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}Et.CreateFixtureShapeDensity_s_def=new Bn,Et.SetMassData_s_oldCenter=new s,Et.ResetMassData_s_localCenter=new s,Et.ResetMassData_s_oldCenter=new s,Et.ResetMassData_s_massData=new Ts,Et.SynchronizeFixtures_s_xf1=new P,Et.SynchronizeFixtures_s_displacement=new s,function(d){d[d.e_unknownJoint=0]="e_unknownJoint",d[d.e_revoluteJoint=1]="e_revoluteJoint",d[d.e_prismaticJoint=2]="e_prismaticJoint",d[d.e_distanceJoint=3]="e_distanceJoint",d[d.e_pulleyJoint=4]="e_pulleyJoint",d[d.e_mouseJoint=5]="e_mouseJoint",d[d.e_gearJoint=6]="e_gearJoint",d[d.e_wheelJoint=7]="e_wheelJoint",d[d.e_weldJoint=8]="e_weldJoint",d[d.e_frictionJoint=9]="e_frictionJoint",d[d.e_ropeJoint=10]="e_ropeJoint",d[d.e_motorJoint=11]="e_motorJoint",d[d.e_areaJoint=12]="e_areaJoint"}(m.b2JointType||(m.b2JointType={})),function(d){d[d.e_inactiveLimit=0]="e_inactiveLimit",d[d.e_atLowerLimit=1]="e_atLowerLimit",d[d.e_atUpperLimit=2]="e_atUpperLimit",d[d.e_equalLimits=3]="e_equalLimits"}(m.b2LimitState||(m.b2LimitState={}));class Yr{constructor(){this.linear=new s,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}}class vi{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(this._other===null)throw new Error;return this._other}set other(t){if(this._other!==null)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class ee{constructor(t){this.type=m.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=t}}class se{constructor(t){this.m_type=m.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new vi(this),this.m_edgeB=new vi(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_edgeA.other=t.bodyB,this.m_edgeB.other=t.bodyA,this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=b(t.collideConnected,!1),this.m_userData=b(t.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsActive(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t(`// Dump is not supported for this joint type.
`)}ShiftOrigin(t){}}class xn extends ee{constructor(){super(m.b2JointType.e_distanceJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.length=1,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=s.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0}}class ie extends se{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_gamma=0,this.m_impulse=0,this.m_length=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new s,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=t.length}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){this.m_length=t}Length(){return this.m_length}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2DistanceJointDef = new b2DistanceJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.length = %.15f;
`,this.m_length),t(`  jd.frequencyHz = %.15f;
`,this.m_frequencyHz),t(`  jd.dampingRatio = %.15f;
`,this.m_dampingRatio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(a);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),w.MulRV(_,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),w.MulRV(h,this.m_lalcB,this.m_rB),this.m_u.x=r.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=r.y+this.m_rB.y-e.y-this.m_rA.y;const u=this.m_u.Length();u>N?this.m_u.SelfMul(1/u):this.m_u.SetZero();const f=s.CrossVV(this.m_rA,this.m_u),p=s.CrossVV(this.m_rB,this.m_u);let y=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=y!==0?1/y:0,this.m_frequencyHz>0){const B=u-this.m_length,A=2*k*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*A,C=this.m_mass*A*A,v=t.step.dt;this.m_gamma=v*(x+v*C),this.m_gamma=this.m_gamma!==0?1/this.m_gamma:0,this.m_bias=B*v*C*this.m_gamma,y+=this.m_gamma,this.m_mass=y!==0?1/y:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const B=s.MulSV(this.m_impulse,this.m_u,ie.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,B),o-=this.m_invIA*s.CrossVV(this.m_rA,B),l.SelfMulAdd(this.m_invMassB,B),c+=this.m_invIB*s.CrossVV(this.m_rB,B)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=s.AddVCrossSV(e,i,this.m_rA,ie.SolveVelocityConstraints_s_vpA),a=s.AddVCrossSV(n,o,this.m_rB,ie.SolveVelocityConstraints_s_vpB),l=s.DotVV(this.m_u,s.SubVV(a,r,s.s_t0)),c=-this.m_mass*(l+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=c;const _=s.MulSV(c,this.m_u,ie.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*s.CrossVV(this.m_rA,_),n.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*s.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){if(this.m_frequencyHz>0)return!0;const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o),l=w.MulRV(r,this.m_lalcA,this.m_rA),c=w.MulRV(a,this.m_lalcB,this.m_rB),_=this.m_u;_.x=n.x+c.x-e.x-l.x,_.y=n.y+c.y-e.y-l.y;let u=this.m_u.Normalize()-this.m_length;u=Vt(u,-nt,nt);const f=-this.m_mass*u,p=s.MulSV(f,_,ie.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*s.CrossVV(l,p),n.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*s.CrossVV(c,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,ht(u)<N}}ie.InitVelocityConstraints_s_P=new s,ie.SolveVelocityConstraints_s_vpA=new s,ie.SolveVelocityConstraints_s_vpB=new s,ie.SolveVelocityConstraints_s_P=new s,ie.SolvePositionConstraints_s_P=new s;class Kr extends ee{constructor(){super(m.b2JointType.e_areaJoint),this.bodies=[],this.frequencyHz=0,this.dampingRatio=0}AddBody(t){this.bodies.push(t),this.bodies.length===1?this.bodyA=t:this.bodies.length===2&&(this.bodyB=t)}}class Sn extends se{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new s,this.m_bodies=t.bodies,this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_targetLengths=ge(t.bodies.length),this.m_normals=s.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=s.MakeArray(t.bodies.length);const e=new xn;e.frequencyHz=this.m_frequencyHz,e.dampingRatio=this.m_dampingRatio,this.m_targetArea=0;for(let i=0;i<this.m_bodies.length;++i){const n=this.m_bodies[i],o=this.m_bodies[(i+1)%this.m_bodies.length],r=n.GetWorldCenter(),a=o.GetWorldCenter();this.m_targetLengths[i]=s.DistanceVV(r,a),this.m_targetArea+=s.CrossVV(r,a),e.Initialize(n,o,r,a),this.m_joints[i]=n.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetFrequency(t){this.m_frequencyHz=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)}GetDampingRatio(){return this.m_dampingRatio}Dump(t){t(`Area joint dumping is not supported.
`)}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],o=t.positions[i.m_islandIndex].c,r=t.positions[n.m_islandIndex].c,a=this.m_deltas[e];s.SubVV(r,o,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,o=this.m_deltas[e];n.x+=i.m_invMass*o.y*.5*this.m_impulse,n.y+=i.m_invMass*-o.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let o=0;o<this.m_bodies.length;++o){const r=this.m_bodies[o],a=t.velocities[r.m_islandIndex].v,l=this.m_deltas[o];e+=l.LengthSquared()/r.GetMass(),i+=s.CrossVV(a,l)}const n=-2*i/e;this.m_impulse+=n;for(let o=0;o<this.m_bodies.length;++o){const r=this.m_bodies[o],a=t.velocities[r.m_islandIndex].v,l=this.m_deltas[o];a.x+=r.m_invMass*l.y*.5*n,a.y+=r.m_invMass*-l.x*.5*n}}SolvePositionConstraints(t){let e=0,i=0;for(let a=0;a<this.m_bodies.length;++a){const l=this.m_bodies[a],c=this.m_bodies[(a+1)%this.m_bodies.length],_=t.positions[l.m_islandIndex].c,h=t.positions[c.m_islandIndex].c,u=s.SubVV(h,_,this.m_delta);let f=u.Length();f<E&&(f=1),this.m_normals[a].x=u.y/f,this.m_normals[a].y=-u.x/f,e+=f,i+=s.CrossVV(_,h)}i*=.5;const n=this.m_targetArea-i,o=.5*n/e;let r=!0;for(let a=0;a<this.m_bodies.length;++a){const l=this.m_bodies[a],c=t.positions[l.m_islandIndex].c,_=(a+1)%this.m_bodies.length,h=s.AddVV(this.m_normals[a],this.m_normals[_],this.m_delta);h.SelfMul(o);const u=h.LengthSquared();u>Je(nt)&&h.SelfMul(nt/pe(u)),u>Je(N)&&(r=!1),c.x+=h.x,c.y+=h.y}return r}}class $r extends ee{constructor(){super(m.b2JointType.e_frictionJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}class ve extends se{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_linearImpulse=new s,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new ft,this.m_angularMass=0,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_K=new ft,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=b(t.maxForce,0),this.m_maxTorque=b(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const _=w.MulRV(l,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=w.MulRV(c,this.m_lalcB,this.m_rB),u=this.m_invMassA,f=this.m_invMassB,p=this.m_invIA,y=this.m_invIB,B=this.m_K;if(B.ex.x=u+f+p*_.y*_.y+y*h.y*h.y,B.ex.y=-p*_.x*_.y-y*h.x*h.y,B.ey.x=B.ex.y,B.ey.y=u+f+p*_.x*_.x+y*h.x*h.x,B.GetInverse(this.m_linearMass),this.m_angularMass=p+y,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const A=this.m_linearImpulse;i.SelfMulSub(u,A),n-=p*(s.CrossVV(this.m_rA,A)+this.m_angularImpulse),r.SelfMulAdd(f,A),a+=y*(s.CrossVV(this.m_rB,A)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB,_=t.step.dt;{const h=o-i;let u=-this.m_angularMass*h;const f=this.m_angularImpulse,p=_*this.m_maxTorque;this.m_angularImpulse=Vt(this.m_angularImpulse+u,-p,p),u=this.m_angularImpulse-f,i-=l*u,o+=c*u}{const h=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),ve.SolveVelocityConstraints_s_Cdot_v2),u=ft.MulMV(this.m_linearMass,h,ve.SolveVelocityConstraints_s_impulseV).SelfNeg(),f=ve.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(u);const p=_*this.m_maxForce;this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),s.SubVV(this.m_linearImpulse,f,u),e.SelfMulSub(r,u),i-=l*s.CrossVV(this.m_rA,u),n.SelfMulAdd(a,u),o+=c*s.CrossVV(this.m_rB,u)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2FrictionJointDef = new b2FrictionJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.maxForce = %.15f;
`,this.m_maxForce),t(`  jd.maxTorque = %.15f;
`,this.m_maxTorque),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}ve.SolveVelocityConstraints_s_Cdot_v2=new s,ve.SolveVelocityConstraints_s_impulseV=new s,ve.SolveVelocityConstraints_s_oldImpulseV=new s;class ta extends ee{constructor(){super(m.b2JointType.e_gearJoint),this.ratio=1}}class pt extends se{constructor(t){super(t),this.m_typeA=m.b2JointType.e_unknownJoint,this.m_typeB=m.b2JointType.e_unknownJoint,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_localAnchorC=new s,this.m_localAnchorD=new s,this.m_localAxisC=new s,this.m_localAxisD=new s,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new s,this.m_lcB=new s,this.m_lcC=new s,this.m_lcD=new s,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new s,this.m_JvBD=new s,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new w,this.m_qB=new w,this.m_qC=new w,this.m_qD=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_lalcC=new s,this.m_lalcD=new s,this.m_joint1=t.joint1,this.m_joint2=t.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType();let e,i;this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const n=this.m_bodyA.m_xf,o=this.m_bodyA.m_sweep.a,r=this.m_bodyC.m_xf,a=this.m_bodyC.m_sweep.a;if(this.m_typeA===m.b2JointType.e_revoluteJoint){const u=t.joint1;this.m_localAnchorC.Copy(u.m_localAnchorA),this.m_localAnchorA.Copy(u.m_localAnchorB),this.m_referenceAngleA=u.m_referenceAngle,this.m_localAxisC.SetZero(),e=o-a-this.m_referenceAngleA}else{const u=t.joint1;this.m_localAnchorC.Copy(u.m_localAnchorA),this.m_localAnchorA.Copy(u.m_localAnchorB),this.m_referenceAngleA=u.m_referenceAngle,this.m_localAxisC.Copy(u.m_localXAxisA);const f=this.m_localAnchorC,p=w.MulTRV(r.q,s.AddVV(w.MulRV(n.q,this.m_localAnchorA,s.s_t0),s.SubVV(n.p,r.p,s.s_t1),s.s_t0),s.s_t0);e=s.DotVV(s.SubVV(p,f,s.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const l=this.m_bodyB.m_xf,c=this.m_bodyB.m_sweep.a,_=this.m_bodyD.m_xf,h=this.m_bodyD.m_sweep.a;if(this.m_typeB===m.b2JointType.e_revoluteJoint){const u=t.joint2;this.m_localAnchorD.Copy(u.m_localAnchorA),this.m_localAnchorB.Copy(u.m_localAnchorB),this.m_referenceAngleB=u.m_referenceAngle,this.m_localAxisD.SetZero(),i=c-h-this.m_referenceAngleB}else{const u=t.joint2;this.m_localAnchorD.Copy(u.m_localAnchorA),this.m_localAnchorB.Copy(u.m_localAnchorB),this.m_referenceAngleB=u.m_referenceAngle,this.m_localAxisD.Copy(u.m_localXAxisA);const f=this.m_localAnchorD,p=w.MulTRV(_.q,s.AddVV(w.MulRV(l.q,this.m_localAnchorB,s.s_t0),s.SubVV(l.p,_.p,s.s_t1),s.s_t0),s.s_t0);i=s.DotVV(s.SubVV(p,f,s.s_t0),this.m_localAxisD)}this.m_ratio=b(t.ratio,1),this.m_constant=e+this.m_ratio*i,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=t.positions[this.m_indexC].a,c=t.velocities[this.m_indexC].v;let _=t.velocities[this.m_indexC].w;const h=t.positions[this.m_indexD].a,u=t.velocities[this.m_indexD].v;let f=t.velocities[this.m_indexD].w;const p=this.m_qA.SetAngle(e),y=this.m_qB.SetAngle(o),B=this.m_qC.SetAngle(l),A=this.m_qD.SetAngle(h);if(this.m_mass=0,this.m_typeA===m.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const x=w.MulRV(B,this.m_localAxisC,pt.InitVelocityConstraints_s_u);s.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const C=w.MulRV(B,this.m_lalcC,pt.InitVelocityConstraints_s_rC);s.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const v=w.MulRV(p,this.m_lalcA,pt.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(x),this.m_JwC=s.CrossVV(C,x),this.m_JwA=s.CrossVV(v,x),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===m.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const x=w.MulRV(A,this.m_localAxisD,pt.InitVelocityConstraints_s_u);s.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const C=w.MulRV(A,this.m_lalcD,pt.InitVelocityConstraints_s_rD);s.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const v=w.MulRV(y,this.m_lalcB,pt.InitVelocityConstraints_s_rB);s.MulSV(this.m_ratio,x,this.m_JvBD),this.m_JwD=this.m_ratio*s.CrossVV(C,x),this.m_JwB=this.m_ratio*s.CrossVV(v,x),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(i.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),n+=this.m_iA*this.m_impulse*this.m_JwA,r.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,c.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),_-=this.m_iC*this.m_impulse*this.m_JwC,u.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),f-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a,t.velocities[this.m_indexC].w=_,t.velocities[this.m_indexD].w=f}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=t.velocities[this.m_indexC].v;let a=t.velocities[this.m_indexC].w;const l=t.velocities[this.m_indexD].v;let c=t.velocities[this.m_indexD].w,_=s.DotVV(this.m_JvAC,s.SubVV(e,r,s.s_t0))+s.DotVV(this.m_JvBD,s.SubVV(n,l,s.s_t0));_+=this.m_JwA*i-this.m_JwC*a+(this.m_JwB*o-this.m_JwD*c);const h=-this.m_mass*_;this.m_impulse+=h,e.SelfMulAdd(this.m_mA*h,this.m_JvAC),i+=this.m_iA*h*this.m_JwA,n.SelfMulAdd(this.m_mB*h,this.m_JvBD),o+=this.m_iB*h*this.m_JwB,r.SelfMulSub(this.m_mC*h,this.m_JvAC),a-=this.m_iC*h*this.m_JwC,l.SelfMulSub(this.m_mD*h,this.m_JvBD),c-=this.m_iD*h*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=c}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=t.positions[this.m_indexC].c;let a=t.positions[this.m_indexC].a;const l=t.positions[this.m_indexD].c;let c=t.positions[this.m_indexD].a;const _=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o),u=this.m_qC.SetAngle(a),f=this.m_qD.SetAngle(c),p=0;let y,B;const A=this.m_JvAC,x=this.m_JvBD;let C,v,M,G,I=0;if(this.m_typeA===m.b2JointType.e_revoluteJoint)A.SetZero(),C=1,M=1,I+=this.m_iA+this.m_iC,y=i-a-this.m_referenceAngleA;else{const q=w.MulRV(u,this.m_localAxisC,pt.SolvePositionConstraints_s_u),J=w.MulRV(u,this.m_lalcC,pt.SolvePositionConstraints_s_rC),L=w.MulRV(_,this.m_lalcA,pt.SolvePositionConstraints_s_rA);A.Copy(q),M=s.CrossVV(J,q),C=s.CrossVV(L,q),I+=this.m_mC+this.m_mA+this.m_iC*M*M+this.m_iA*C*C;const D=this.m_lalcC,Z=w.MulTRV(u,s.AddVV(L,s.SubVV(e,r,s.s_t0),s.s_t0),s.s_t0);y=s.DotVV(s.SubVV(Z,D,s.s_t0),this.m_localAxisC)}if(this.m_typeB===m.b2JointType.e_revoluteJoint)x.SetZero(),v=this.m_ratio,G=this.m_ratio,I+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),B=o-c-this.m_referenceAngleB;else{const q=w.MulRV(f,this.m_localAxisD,pt.SolvePositionConstraints_s_u),J=w.MulRV(f,this.m_lalcD,pt.SolvePositionConstraints_s_rD),L=w.MulRV(h,this.m_lalcB,pt.SolvePositionConstraints_s_rB);s.MulSV(this.m_ratio,q,x),G=this.m_ratio*s.CrossVV(J,q),v=this.m_ratio*s.CrossVV(L,q),I+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*G*G+this.m_iB*v*v;const D=this.m_lalcD,Z=w.MulTRV(f,s.AddVV(L,s.SubVV(n,l,s.s_t0),s.s_t0),s.s_t0);B=s.DotVV(s.SubVV(Z,D,s.s_t0),this.m_localAxisD)}const T=y+this.m_ratio*B-this.m_constant;let F=0;return I>0&&(F=-T/I),e.SelfMulAdd(this.m_mA*F,A),i+=this.m_iA*F*C,n.SelfMulAdd(this.m_mB*F,x),o+=this.m_iB*F*v,r.SelfMulSub(this.m_mC*F,A),a-=this.m_iC*F*M,l.SelfMulSub(this.m_mD*F,x),c-=this.m_iD*F*G,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,t.positions[this.m_indexC].a=a,t.positions[this.m_indexD].a=c,p<N}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return s.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,o=this.m_joint2.m_index;t(`  const jd: b2GearJointDef = new b2GearJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.joint1 = joints[%d];
`,n),t(`  jd.joint2 = joints[%d];
`,o),t(`  jd.ratio = %.15f;
`,this.m_ratio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}pt.InitVelocityConstraints_s_u=new s,pt.InitVelocityConstraints_s_rA=new s,pt.InitVelocityConstraints_s_rB=new s,pt.InitVelocityConstraints_s_rC=new s,pt.InitVelocityConstraints_s_rD=new s,pt.SolvePositionConstraints_s_u=new s,pt.SolvePositionConstraints_s_rA=new s,pt.SolvePositionConstraints_s_rB=new s,pt.SolvePositionConstraints_s_rC=new s,pt.SolvePositionConstraints_s_rD=new s;class ea extends ee{constructor(){super(m.b2JointType.e_motorJoint),this.linearOffset=new s(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i}}class be extends se{constructor(t){super(t),this.m_linearOffset=new s,this.m_angularOffset=0,this.m_linearImpulse=new s,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_linearError=new s,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new ft,this.m_angularMass=0,this.m_qA=new w,this.m_qB=new w,this.m_K=new ft,this.m_linearOffset.Copy(b(t.linearOffset,s.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=b(t.maxForce,0),this.m_maxTorque=b(t.maxTorque,0),this.m_correctionFactor=b(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return s.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){s.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(a),u=w.MulRV(_,s.SubVV(this.m_linearOffset,this.m_localCenterA,s.s_t0),this.m_rA),f=w.MulRV(h,s.NegV(this.m_localCenterB,s.s_t0),this.m_rB),p=this.m_invMassA,y=this.m_invMassB,B=this.m_invIA,A=this.m_invIB,x=this.m_K;if(x.ex.x=p+y+B*u.y*u.y+A*f.y*f.y,x.ex.y=-B*u.x*u.y-A*f.x*f.y,x.ey.x=x.ex.y,x.ey.y=p+y+B*u.x*u.x+A*f.x*f.x,x.GetInverse(this.m_linearMass),this.m_angularMass=B+A,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),s.SubVV(s.AddVV(r,f,s.s_t0),s.AddVV(e,u,s.s_t1),this.m_linearError),this.m_angularError=a-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const C=this.m_linearImpulse;n.SelfMulSub(p,C),o-=B*(s.CrossVV(u,C)+this.m_angularImpulse),l.SelfMulAdd(y,C),c+=A*(s.CrossVV(f,C)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB,_=t.step.dt,h=t.step.inv_dt;{const u=o-i+h*this.m_correctionFactor*this.m_angularError;let f=-this.m_angularMass*u;const p=this.m_angularImpulse,y=_*this.m_maxTorque;this.m_angularImpulse=Vt(this.m_angularImpulse+f,-y,y),f=this.m_angularImpulse-p,i-=l*f,o+=c*f}{const u=this.m_rA,f=this.m_rB,p=s.AddVV(s.SubVV(s.AddVV(n,s.CrossSV(o,f,s.s_t0),s.s_t0),s.AddVV(e,s.CrossSV(i,u,s.s_t1),s.s_t1),s.s_t2),s.MulSV(h*this.m_correctionFactor,this.m_linearError,s.s_t3),be.SolveVelocityConstraints_s_Cdot_v2),y=ft.MulMV(this.m_linearMass,p,be.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),B=be.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);const A=_*this.m_maxForce;this.m_linearImpulse.LengthSquared()>A*A&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(A)),s.SubVV(this.m_linearImpulse,B,y),e.SelfMulSub(r,y),i-=l*s.CrossVV(u,y),n.SelfMulAdd(a,y),o+=c*s.CrossVV(f,y)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2MotorJointDef = new b2MotorJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.linearOffset.Set(%.15f, %.15f);
`,this.m_linearOffset.x,this.m_linearOffset.y),t(`  jd.angularOffset = %.15f;
`,this.m_angularOffset),t(`  jd.maxForce = %.15f;
`,this.m_maxForce),t(`  jd.maxTorque = %.15f;
`,this.m_maxTorque),t(`  jd.correctionFactor = %.15f;
`,this.m_correctionFactor),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}be.SolveVelocityConstraints_s_Cdot_v2=new s,be.SolveVelocityConstraints_s_impulse_v2=new s,be.SolveVelocityConstraints_s_oldImpulse_v2=new s;class sa extends ee{constructor(){super(m.b2JointType.e_mouseJoint),this.target=new s,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7}}class Ve extends se{constructor(t){super(t),this.m_localAnchorB=new s,this.m_targetA=new s,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_beta=0,this.m_impulse=new s,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new s,this.m_localCenterB=new s,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new ft,this.m_C=new s,this.m_qB=new w,this.m_lalcB=new s,this.m_K=new ft,this.m_targetA.Copy(b(t.target,s.ZERO)),P.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=b(t.maxForce,0),this.m_impulse.SetZero(),this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),l=2*k*this.m_frequencyHz,c=2*a*this.m_dampingRatio*l,_=a*(l*l),h=t.step.dt;this.m_gamma=h*(c+h*_),this.m_gamma!==0&&(this.m_gamma=1/this.m_gamma),this.m_beta=h*_*this.m_gamma,s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),w.MulRV(r,this.m_lalcB,this.m_rB);const u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),o*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,o+=this.m_invIB*s.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const n=s.AddVCrossSV(e,i,this.m_rB,Ve.SolveVelocityConstraints_s_Cdot),o=ft.MulMV(this.m_mass,s.AddVV(n,s.AddVV(this.m_C,s.MulSV(this.m_gamma,this.m_impulse,s.s_t0),s.s_t0),s.s_t0).SelfNeg(),Ve.SolveVelocityConstraints_s_impulse),r=Ve.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);const a=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>a*a&&this.m_impulse.SelfMul(a/this.m_impulse.Length()),s.SubVV(this.m_impulse,r,o),e.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*s.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return s.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t(`Mouse joint dumping is not supported.
`)}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}Ve.SolveVelocityConstraints_s_Cdot=new s,Ve.SolveVelocityConstraints_s_impulse=new s,Ve.SolveVelocityConstraints_s_oldImpulse=new s;class ia extends ee{constructor(){super(m.b2JointType.e_prismaticJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.localAxisA=new s(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class st extends se{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_localXAxisA=new s,this.m_localYAxisA=new s,this.m_referenceAngle=0,this.m_impulse=new Ct(0,0,0),this.m_motorImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new s(0,0),this.m_perp=new s(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new me,this.m_K3=new me,this.m_K2=new ft,this.m_motorMass=0,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_rA=new s,this.m_rB=new s,this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_localXAxisA.Copy(b(t.localAxisA,new s(1,0))).SelfNormalize(),s.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=b(t.referenceAngle,0),this.m_lowerTranslation=b(t.lowerTranslation,0),this.m_upperTranslation=b(t.upperTranslation,0),this.m_maxMotorForce=b(t.maxMotorForce,0),this.m_motorSpeed=b(t.motorSpeed,0),this.m_enableLimit=b(t.enableLimit,!1),this.m_enableMotor=b(t.enableMotor,!1)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(a);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const u=w.MulRV(_,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const f=w.MulRV(h,this.m_lalcB,this.m_rB),p=s.AddVV(s.SubVV(r,e,s.s_t0),s.SubVV(f,u,s.s_t1),st.InitVelocityConstraints_s_d),y=this.m_invMassA,B=this.m_invMassB,A=this.m_invIA,x=this.m_invIB;if(w.MulRV(_,this.m_localXAxisA,this.m_axis),this.m_a1=s.CrossVV(s.AddVV(p,u,s.s_t0),this.m_axis),this.m_a2=s.CrossVV(f,this.m_axis),this.m_motorMass=y+B+A*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),w.MulRV(_,this.m_localYAxisA,this.m_perp),this.m_s1=s.CrossVV(s.AddVV(p,u,s.s_t0),this.m_perp),this.m_s2=s.CrossVV(f,this.m_perp),this.m_K.ex.x=y+B+A*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=A*this.m_s1+x*this.m_s2,this.m_K.ex.z=A*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=A+x,this.m_K.ey.y===0&&(this.m_K.ey.y=1),this.m_K.ey.z=A*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=y+B+A*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){const C=s.DotVV(this.m_axis,p);ht(this.m_upperTranslation-this.m_lowerTranslation)<2*N?this.m_limitState=m.b2LimitState.e_equalLimits:C<=this.m_lowerTranslation?this.m_limitState!==m.b2LimitState.e_atLowerLimit&&(this.m_limitState=m.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):C>=this.m_upperTranslation?this.m_limitState!==m.b2LimitState.e_atUpperLimit&&(this.m_limitState=m.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;const C=s.AddVV(s.MulSV(this.m_impulse.x,this.m_perp,s.s_t0),s.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,s.s_t1),st.InitVelocityConstraints_s_P),v=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,M=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;n.SelfMulSub(y,C),o-=A*v,l.SelfMulAdd(B,C),c+=x*M}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==m.b2LimitState.e_equalLimits){const u=s.DotVV(this.m_axis,s.SubVV(n,e,s.s_t0))+this.m_a2*o-this.m_a1*i;let f=this.m_motorMass*(this.m_motorSpeed-u);const p=this.m_motorImpulse,y=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=Vt(this.m_motorImpulse+f,-y,y),f=this.m_motorImpulse-p;const B=s.MulSV(f,this.m_axis,st.SolveVelocityConstraints_s_P),A=f*this.m_a1,x=f*this.m_a2;e.SelfMulSub(r,B),i-=l*A,n.SelfMulAdd(a,B),o+=c*x}const _=s.DotVV(this.m_perp,s.SubVV(n,e,s.s_t0))+this.m_s2*o-this.m_s1*i,h=o-i;if(this.m_enableLimit&&this.m_limitState!==m.b2LimitState.e_inactiveLimit){const u=s.DotVV(this.m_axis,s.SubVV(n,e,s.s_t0))+this.m_a2*o-this.m_a1*i,f=st.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),p=this.m_K.Solve33(-_,-h,-u,st.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(p),this.m_limitState===m.b2LimitState.e_atLowerLimit?this.m_impulse.z=W(this.m_impulse.z,0):this.m_limitState===m.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=et(this.m_impulse.z,0));const y=-_-(this.m_impulse.z-f.z)*this.m_K.ez.x,B=-h-(this.m_impulse.z-f.z)*this.m_K.ez.y,A=this.m_K.Solve22(y,B,st.SolveVelocityConstraints_s_f2r);A.x+=f.x,A.y+=f.y,this.m_impulse.x=A.x,this.m_impulse.y=A.y,p.x=this.m_impulse.x-f.x,p.y=this.m_impulse.y-f.y,p.z=this.m_impulse.z-f.z;const x=s.AddVV(s.MulSV(p.x,this.m_perp,s.s_t0),s.MulSV(p.z,this.m_axis,s.s_t1),st.SolveVelocityConstraints_s_P),C=p.x*this.m_s1+p.y+p.z*this.m_a1,v=p.x*this.m_s2+p.y+p.z*this.m_a2;e.SelfMulSub(r,x),i-=l*C,n.SelfMulAdd(a,x),o+=c*v}else{const u=this.m_K.Solve22(-_,-h,st.SolveVelocityConstraints_s_df2);this.m_impulse.x+=u.x,this.m_impulse.y+=u.y;const f=s.MulSV(u.x,this.m_perp,st.SolveVelocityConstraints_s_P),p=u.x*this.m_s1+u.y,y=u.x*this.m_s2+u.y;e.SelfMulSub(r,f),i-=l*p,n.SelfMulAdd(a,f),o+=c*y}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o),l=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,h=this.m_invIB,u=w.MulRV(r,this.m_lalcA,this.m_rA),f=w.MulRV(a,this.m_lalcB,this.m_rB),p=s.SubVV(s.AddVV(n,f,s.s_t0),s.AddVV(e,u,s.s_t1),st.SolvePositionConstraints_s_d),y=w.MulRV(r,this.m_localXAxisA,this.m_axis),B=s.CrossVV(s.AddVV(p,u,s.s_t0),y),A=s.CrossVV(f,y),x=w.MulRV(r,this.m_localYAxisA,this.m_perp),C=s.CrossVV(s.AddVV(p,u,s.s_t0),x),v=s.CrossVV(f,x);let M=st.SolvePositionConstraints_s_impulse;const G=s.DotVV(x,p),I=o-i-this.m_referenceAngle;let T=ht(G);const F=ht(I);let q=!1,J=0;if(this.m_enableLimit){const U=s.DotVV(y,p);ht(this.m_upperTranslation-this.m_lowerTranslation)<2*N?(J=Vt(U,-nt,nt),T=W(T,ht(U)),q=!0):U<=this.m_lowerTranslation?(J=Vt(U-this.m_lowerTranslation+N,-nt,0),T=W(T,this.m_lowerTranslation-U),q=!0):U>=this.m_upperTranslation&&(J=Vt(U-this.m_upperTranslation-N,0,nt),T=W(T,U-this.m_upperTranslation),q=!0)}if(q){const U=l+c+_*C*C+h*v*v,tt=_*C+h*v,ct=_*C*B+h*v*A;let _t=_+h;_t===0&&(_t=1);const Lt=_*B+h*A,Tt=l+c+_*B*B+h*A*A,Rt=this.m_K3;Rt.ex.SetXYZ(U,tt,ct),Rt.ey.SetXYZ(tt,_t,Lt),Rt.ez.SetXYZ(ct,Lt,Tt),M=Rt.Solve33(-G,-I,-J,M)}else{const U=l+c+_*C*C+h*v*v,tt=_*C+h*v;let ct=_+h;ct===0&&(ct=1);const _t=this.m_K2;_t.ex.Set(U,tt),_t.ey.Set(tt,ct);const Lt=_t.Solve(-G,-I,st.SolvePositionConstraints_s_impulse1);M.x=Lt.x,M.y=Lt.y,M.z=0}const L=s.AddVV(s.MulSV(M.x,x,s.s_t0),s.MulSV(M.z,y,s.s_t1),st.SolvePositionConstraints_s_P),D=M.x*C+M.y+M.z*B,Z=M.x*v+M.y+M.z*A;return e.SelfMulSub(l,L),i-=_*D,n.SelfMulAdd(c,L),o+=h*Z,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,T<=N&&F<=Bt}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,st.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,st.GetJointTranslation_s_pB),i=s.SubVV(e,t,st.GetJointTranslation_s_d),n=this.m_bodyA.GetWorldVector(this.m_localXAxisA,st.GetJointTranslation_s_axis);return s.DotVV(i,n)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;s.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=w.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=w.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),o=s.AddVV(t.m_sweep.c,i,s.s_t0),r=s.AddVV(e.m_sweep.c,n,s.s_t1),a=s.SubVV(r,o,s.s_t2),l=t.GetWorldVector(this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,_=e.m_linearVelocity,h=t.m_angularVelocity,u=e.m_angularVelocity;return s.DotVV(a,s.CrossSV(h,l,s.s_t0))+s.DotVV(l,s.SubVV(s.AddVCrossSV(_,u,n,s.s_t0),s.AddVCrossSV(c,h,i,s.s_t1),s.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){(t!==this.m_lowerTranslation||e!==this.m_upperTranslation)&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.localAxisA.Set(%.15f, %.15f);
`,this.m_localXAxisA.x,this.m_localXAxisA.y),t(`  jd.referenceAngle = %.15f;
`,this.m_referenceAngle),t(`  jd.enableLimit = %s;
`,this.m_enableLimit?"true":"false"),t(`  jd.lowerTranslation = %.15f;
`,this.m_lowerTranslation),t(`  jd.upperTranslation = %.15f;
`,this.m_upperTranslation),t(`  jd.enableMotor = %s;
`,this.m_enableMotor?"true":"false"),t(`  jd.motorSpeed = %.15f;
`,this.m_motorSpeed),t(`  jd.maxMotorForce = %.15f;
`,this.m_maxMotorForce),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}st.InitVelocityConstraints_s_d=new s,st.InitVelocityConstraints_s_P=new s,st.SolveVelocityConstraints_s_P=new s,st.SolveVelocityConstraints_s_f2r=new s,st.SolveVelocityConstraints_s_f1=new Ct,st.SolveVelocityConstraints_s_df3=new Ct,st.SolveVelocityConstraints_s_df2=new s,st.SolvePositionConstraints_s_d=new s,st.SolvePositionConstraints_s_impulse=new Ct,st.SolvePositionConstraints_s_impulse1=new s,st.SolvePositionConstraints_s_P=new s,st.GetJointTranslation_s_pA=new s,st.GetJointTranslation_s_pB=new s,st.GetJointTranslation_s_d=new s,st.GetJointTranslation_s_axis=new s;const na=2;class oa extends ee{constructor(){super(m.b2JointType.e_pulleyJoint),this.groundAnchorA=new s(-1,1),this.groundAnchorB=new s(1,1),this.localAnchorA=new s(-1,0),this.localAnchorB=new s(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,n,o,r,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(o,this.localAnchorA),this.bodyB.GetLocalPoint(r,this.localAnchorB),this.lengthA=s.DistanceVV(o,i),this.lengthB=s.DistanceVV(r,n),this.ratio=a}}class St extends se{constructor(t){super(t),this.m_groundAnchorA=new s,this.m_groundAnchorB=new s,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new s,this.m_uB=new s,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_groundAnchorA.Copy(b(t.groundAnchorA,new s(-1,1))),this.m_groundAnchorB.Copy(b(t.groundAnchorB,new s(1,0))),this.m_localAnchorA.Copy(b(t.localAnchorA,new s(-1,0))),this.m_localAnchorB.Copy(b(t.localAnchorB,new s(1,0))),this.m_lengthA=b(t.lengthA,0),this.m_lengthB=b(t.lengthB,0),this.m_ratio=b(t.ratio,1),this.m_constant=b(t.lengthA,0)+this.m_ratio*b(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(a);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),w.MulRV(_,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),w.MulRV(h,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(r).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const u=this.m_uA.Length(),f=this.m_uB.Length();u>10*N?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),f>10*N?this.m_uB.SelfMul(1/f):this.m_uB.SetZero();const p=s.CrossVV(this.m_rA,this.m_uA),y=s.CrossVV(this.m_rB,this.m_uB),B=this.m_invMassA+this.m_invIA*p*p,A=this.m_invMassB+this.m_invIB*y*y;if(this.m_mass=B+this.m_ratio*this.m_ratio*A,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const x=s.MulSV(-this.m_impulse,this.m_uA,St.InitVelocityConstraints_s_PA),C=s.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,St.InitVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,x),o+=this.m_invIA*s.CrossVV(this.m_rA,x),l.SelfMulAdd(this.m_invMassB,C),c+=this.m_invIB*s.CrossVV(this.m_rB,C)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=s.AddVCrossSV(e,i,this.m_rA,St.SolveVelocityConstraints_s_vpA),a=s.AddVCrossSV(n,o,this.m_rB,St.SolveVelocityConstraints_s_vpB),l=-s.DotVV(this.m_uA,r)-this.m_ratio*s.DotVV(this.m_uB,a),c=-this.m_mass*l;this.m_impulse+=c;const _=s.MulSV(-c,this.m_uA,St.SolveVelocityConstraints_s_PA),h=s.MulSV(-this.m_ratio*c,this.m_uB,St.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,_),i+=this.m_invIA*s.CrossVV(this.m_rA,_),n.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*s.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=w.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=w.MulRV(a,this.m_lalcB,this.m_rB),_=this.m_uA.Copy(e).SelfAdd(l).SelfSub(this.m_groundAnchorA),h=this.m_uB.Copy(n).SelfAdd(c).SelfSub(this.m_groundAnchorB),u=_.Length(),f=h.Length();u>10*N?_.SelfMul(1/u):_.SetZero(),f>10*N?h.SelfMul(1/f):h.SetZero();const p=s.CrossVV(l,_),y=s.CrossVV(c,h),B=this.m_invMassA+this.m_invIA*p*p,A=this.m_invMassB+this.m_invIB*y*y;let x=B+this.m_ratio*this.m_ratio*A;x>0&&(x=1/x);const C=this.m_constant-u-this.m_ratio*f,v=ht(C),M=-x*C,G=s.MulSV(-M,_,St.SolvePositionConstraints_s_PA),I=s.MulSV(-this.m_ratio*M,h,St.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,G),i+=this.m_invIA*s.CrossVV(l,G),n.SelfMulAdd(this.m_invMassB,I),o+=this.m_invIB*s.CrossVV(c,I),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,v<N}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,St.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return s.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,St.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return s.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2PulleyJointDef = new b2PulleyJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.groundAnchorA.Set(%.15f, %.15f);
`,this.m_groundAnchorA.x,this.m_groundAnchorA.y),t(`  jd.groundAnchorB.Set(%.15f, %.15f);
`,this.m_groundAnchorB.x,this.m_groundAnchorB.y),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.lengthA = %.15f;
`,this.m_lengthA),t(`  jd.lengthB = %.15f;
`,this.m_lengthB),t(`  jd.ratio = %.15f;
`,this.m_ratio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}St.InitVelocityConstraints_s_PA=new s,St.InitVelocityConstraints_s_PB=new s,St.SolveVelocityConstraints_s_vpA=new s,St.SolveVelocityConstraints_s_vpB=new s,St.SolveVelocityConstraints_s_PA=new s,St.SolveVelocityConstraints_s_PB=new s,St.SolvePositionConstraints_s_PA=new s,St.SolvePositionConstraints_s_PB=new s,St.GetCurrentLengthA_s_p=new s,St.GetCurrentLengthB_s_p=new s;class ra extends ee{constructor(){super(m.b2JointType.e_revoluteJoint),this.localAnchorA=new s(0,0),this.localAnchorB=new s(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class vt extends se{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_impulse=new Ct,this.m_motorImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new me,this.m_motorMass=0,this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_K=new ft,this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_referenceAngle=b(t.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=b(t.lowerAngle,0),this.m_upperAngle=b(t.upperAngle,0),this.m_maxMotorTorque=b(t.maxMotorTorque,0),this.m_motorSpeed=b(t.motorSpeed,0),this.m_enableLimit=b(t.enableLimit,!1),this.m_enableMotor=b(t.enableMotor,!1),this.m_limitState=m.b2LimitState.e_inactiveLimit}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),w.MulRV(l,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),w.MulRV(c,this.m_lalcB,this.m_rB);const _=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=u+f===0;if(this.m_mass.ex.x=_+h+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*f,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*f,this.m_mass.ez.x=-this.m_rA.y*u-this.m_rB.y*f,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=_+h+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*f,this.m_mass.ez.y=this.m_rA.x*u+this.m_rB.x*f,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=u+f,this.m_motorMass=u+f,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),(!this.m_enableMotor||p)&&(this.m_motorImpulse=0),this.m_enableLimit&&!p){const y=o-e-this.m_referenceAngle;ht(this.m_upperAngle-this.m_lowerAngle)<2*Bt?this.m_limitState=m.b2LimitState.e_equalLimits:y<=this.m_lowerAngle?(this.m_limitState!==m.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=m.b2LimitState.e_atLowerLimit):y>=this.m_upperAngle?(this.m_limitState!==m.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=m.b2LimitState.e_atUpperLimit):(this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=m.b2LimitState.e_inactiveLimit;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;const y=vt.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(_,y),n-=u*(s.CrossVV(this.m_rA,y)+this.m_motorImpulse+this.m_impulse.z),r.SelfMulAdd(h,y),a+=f*(s.CrossVV(this.m_rB,y)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB,_=l+c===0;if(this.m_enableMotor&&this.m_limitState!==m.b2LimitState.e_equalLimits&&!_){const h=o-i-this.m_motorSpeed;let u=-this.m_motorMass*h;const f=this.m_motorImpulse,p=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Vt(this.m_motorImpulse+u,-p,p),u=this.m_motorImpulse-f,i-=l*u,o+=c*u}if(this.m_enableLimit&&this.m_limitState!==m.b2LimitState.e_inactiveLimit&&!_){const h=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),vt.SolveVelocityConstraints_s_Cdot1),u=o-i,f=this.m_mass.Solve33(h.x,h.y,u,vt.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===m.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(f);else if(this.m_limitState===m.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+f.z<0){const B=-h.x+this.m_impulse.z*this.m_mass.ez.x,A=-h.y+this.m_impulse.z*this.m_mass.ez.y,x=this.m_mass.Solve22(B,A,vt.SolveVelocityConstraints_s_reduced_v2);f.x=x.x,f.y=x.y,f.z=-this.m_impulse.z,this.m_impulse.x+=x.x,this.m_impulse.y+=x.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(f);else if(this.m_limitState===m.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+f.z>0){const B=-h.x+this.m_impulse.z*this.m_mass.ez.x,A=-h.y+this.m_impulse.z*this.m_mass.ez.y,x=this.m_mass.Solve22(B,A,vt.SolveVelocityConstraints_s_reduced_v2);f.x=x.x,f.y=x.y,f.z=-this.m_impulse.z,this.m_impulse.x+=x.x,this.m_impulse.y+=x.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(f);const p=vt.SolveVelocityConstraints_s_P.Set(f.x,f.y);e.SelfMulSub(r,p),i-=l*(s.CrossVV(this.m_rA,p)+f.z),n.SelfMulAdd(a,p),o+=c*(s.CrossVV(this.m_rB,p)+f.z)}else{const h=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),vt.SolveVelocityConstraints_s_Cdot_v2),u=this.m_mass.Solve22(-h.x,-h.y,vt.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=u.x,this.m_impulse.y+=u.y,e.SelfMulSub(r,u),i-=l*s.CrossVV(this.m_rA,u),n.SelfMulAdd(a,u),o+=c*s.CrossVV(this.m_rB,u)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);let l=0,c=0;const _=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==m.b2LimitState.e_inactiveLimit&&!_){const h=o-i-this.m_referenceAngle;let u=0;if(this.m_limitState===m.b2LimitState.e_equalLimits){const f=Vt(h-this.m_lowerAngle,-It,It);u=-this.m_motorMass*f,l=ht(f)}else if(this.m_limitState===m.b2LimitState.e_atLowerLimit){let f=h-this.m_lowerAngle;l=-f,f=Vt(f+Bt,-It,0),u=-this.m_motorMass*f}else if(this.m_limitState===m.b2LimitState.e_atUpperLimit){let f=h-this.m_upperAngle;l=f,f=Vt(f-Bt,0,It),u=-this.m_motorMass*f}i-=this.m_invIA*u,o+=this.m_invIB*u}{r.SetAngle(i),a.SetAngle(o),s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=w.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const u=w.MulRV(a,this.m_lalcB,this.m_rB),f=s.SubVV(s.AddVV(n,u,s.s_t0),s.AddVV(e,h,s.s_t1),vt.SolvePositionConstraints_s_C_v2);c=f.Length();const p=this.m_invMassA,y=this.m_invMassB,B=this.m_invIA,A=this.m_invIB,x=this.m_K;x.ex.x=p+y+B*h.y*h.y+A*u.y*u.y,x.ex.y=-B*h.x*h.y-A*u.x*u.y,x.ey.x=x.ex.y,x.ey.y=p+y+B*h.x*h.x+A*u.x*u.x;const C=x.Solve(f.x,f.y,vt.SolvePositionConstraints_s_impulse).SelfNeg();e.SelfMulSub(p,C),i-=B*s.CrossVV(h,C),n.SelfMulAdd(y,C),o+=A*s.CrossVV(u,C)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,c<=N&&l<=Bt}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){(t!==this.m_lowerAngle||e!==this.m_upperAngle)&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.referenceAngle = %.15f;
`,this.m_referenceAngle),t(`  jd.enableLimit = %s;
`,this.m_enableLimit?"true":"false"),t(`  jd.lowerAngle = %.15f;
`,this.m_lowerAngle),t(`  jd.upperAngle = %.15f;
`,this.m_upperAngle),t(`  jd.enableMotor = %s;
`,this.m_enableMotor?"true":"false"),t(`  jd.motorSpeed = %.15f;
`,this.m_motorSpeed),t(`  jd.maxMotorTorque = %.15f;
`,this.m_maxMotorTorque),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}vt.InitVelocityConstraints_s_P=new s,vt.SolveVelocityConstraints_s_P=new s,vt.SolveVelocityConstraints_s_Cdot_v2=new s,vt.SolveVelocityConstraints_s_Cdot1=new s,vt.SolveVelocityConstraints_s_impulse_v3=new Ct,vt.SolveVelocityConstraints_s_reduced_v2=new s,vt.SolveVelocityConstraints_s_impulse_v2=new s,vt.SolvePositionConstraints_s_C_v2=new s,vt.SolvePositionConstraints_s_impulse=new s;class aa extends ee{constructor(){super(m.b2JointType.e_ropeJoint),this.localAnchorA=new s(-1,0),this.localAnchorB=new s(1,0),this.maxLength=0}}class ne extends se{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_maxLength=0,this.m_length=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new s,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_state=m.b2LimitState.e_inactiveLimit,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_localAnchorA.Copy(b(t.localAnchorA,new s(-1,0))),this.m_localAnchorB.Copy(b(t.localAnchorB,new s(1,0))),this.m_maxLength=b(t.maxLength,0)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(a);if(s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),w.MulRV(_,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),w.MulRV(h,this.m_lalcB,this.m_rB),this.m_u.Copy(r).SelfAdd(this.m_rB).SelfSub(e).SelfSub(this.m_rA),this.m_length=this.m_u.Length(),this.m_length-this.m_maxLength>0?this.m_state=m.b2LimitState.e_atUpperLimit:this.m_state=m.b2LimitState.e_inactiveLimit,this.m_length>N)this.m_u.SelfMul(1/this.m_length);else{this.m_u.SetZero(),this.m_mass=0,this.m_impulse=0;return}const f=s.CrossVV(this.m_rA,this.m_u),p=s.CrossVV(this.m_rB,this.m_u),y=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=y!==0?1/y:0,t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const B=s.MulSV(this.m_impulse,this.m_u,ne.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,B),o-=this.m_invIA*s.CrossVV(this.m_rA,B),l.SelfMulAdd(this.m_invMassB,B),c+=this.m_invIB*s.CrossVV(this.m_rB,B)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=s.AddVCrossSV(e,i,this.m_rA,ne.SolveVelocityConstraints_s_vpA),a=s.AddVCrossSV(n,o,this.m_rB,ne.SolveVelocityConstraints_s_vpB),l=this.m_length-this.m_maxLength;let c=s.DotVV(this.m_u,s.SubVV(a,r,s.s_t0));l<0&&(c+=t.step.inv_dt*l);let _=-this.m_mass*c;const h=this.m_impulse;this.m_impulse=et(0,this.m_impulse+_),_=this.m_impulse-h;const u=s.MulSV(_,this.m_u,ne.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*s.CrossVV(this.m_rA,u),n.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*s.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=w.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=w.MulRV(a,this.m_lalcB,this.m_rB),_=this.m_u.Copy(n).SelfAdd(c).SelfSub(e).SelfSub(l),h=_.Normalize();let u=h-this.m_maxLength;u=Vt(u,0,nt);const f=-this.m_mass*u,p=s.MulSV(f,_,ne.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*s.CrossVV(l,p),n.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*s.CrossVV(c,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,h-this.m_maxLength<N}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return s.MulSV(t*this.m_impulse,this.m_u,e)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxLength(t){this.m_maxLength=t}GetMaxLength(){return this.m_maxLength}GetLimitState(){return this.m_state}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2RopeJointDef = new b2RopeJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.maxLength = %.15f;
`,this.m_maxLength),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}ne.InitVelocityConstraints_s_P=new s,ne.SolveVelocityConstraints_s_vpA=new s,ne.SolveVelocityConstraints_s_vpB=new s,ne.SolveVelocityConstraints_s_P=new s,ne.SolvePositionConstraints_s_P=new s;class la extends ee{constructor(){super(m.b2JointType.e_weldJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.referenceAngle=0,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class bt extends se{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new Ct(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new me,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_K=new me,this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_referenceAngle=b(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),w.MulRV(l,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),w.MulRV(c,this.m_lalcB,this.m_rB);const _=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=this.m_K;if(p.ex.x=_+h+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*f,p.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*f,p.ez.x=-this.m_rA.y*u-this.m_rB.y*f,p.ex.y=p.ey.x,p.ey.y=_+h+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*f,p.ez.y=this.m_rA.x*u+this.m_rB.x*f,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=u+f,this.m_frequencyHz>0){p.GetInverse22(this.m_mass);let y=u+f;const B=y>0?1/y:0,A=o-e-this.m_referenceAngle,x=2*k*this.m_frequencyHz,C=2*B*this.m_dampingRatio*x,v=B*x*x,M=t.step.dt;this.m_gamma=M*(C+M*v),this.m_gamma=this.m_gamma!==0?1/this.m_gamma:0,this.m_bias=A*M*v*this.m_gamma,y+=this.m_gamma,this.m_mass.ez.z=y!==0?1/y:0}else p.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const y=bt.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(_,y),n-=u*(s.CrossVV(this.m_rA,y)+this.m_impulse.z),r.SelfMulAdd(h,y),a+=f*(s.CrossVV(this.m_rB,y)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB;if(this.m_frequencyHz>0){const _=o-i,h=-this.m_mass.ez.z*(_+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,i-=l*h,o+=c*h;const u=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),bt.SolveVelocityConstraints_s_Cdot1),f=me.MulM33XY(this.m_mass,u.x,u.y,bt.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;const p=f;e.SelfMulSub(r,p),i-=l*s.CrossVV(this.m_rA,p),n.SelfMulAdd(a,p),o+=c*s.CrossVV(this.m_rB,p)}else{const _=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),bt.SolveVelocityConstraints_s_Cdot1),h=o-i,u=me.MulM33XYZ(this.m_mass,_.x,_.y,h,bt.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(u);const f=bt.SolveVelocityConstraints_s_P.Set(u.x,u.y);e.SelfMulSub(r,f),i-=l*(s.CrossVV(this.m_rA,f)+u.z),n.SelfMulAdd(a,f),o+=c*(s.CrossVV(this.m_rB,f)+u.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o),l=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,h=this.m_invIB;s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const u=w.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const f=w.MulRV(a,this.m_lalcB,this.m_rB);let p,y;const B=this.m_K;if(B.ex.x=l+c+u.y*u.y*_+f.y*f.y*h,B.ey.x=-u.y*u.x*_-f.y*f.x*h,B.ez.x=-u.y*_-f.y*h,B.ex.y=B.ey.x,B.ey.y=l+c+u.x*u.x*_+f.x*f.x*h,B.ez.y=u.x*_+f.x*h,B.ex.z=B.ez.x,B.ey.z=B.ez.y,B.ez.z=_+h,this.m_frequencyHz>0){const A=s.SubVV(s.AddVV(n,f,s.s_t0),s.AddVV(e,u,s.s_t1),bt.SolvePositionConstraints_s_C1);p=A.Length(),y=0;const x=B.Solve22(A.x,A.y,bt.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(l,x),i-=_*s.CrossVV(u,x),n.SelfMulAdd(c,x),o+=h*s.CrossVV(f,x)}else{const A=s.SubVV(s.AddVV(n,f,s.s_t0),s.AddVV(e,u,s.s_t1),bt.SolvePositionConstraints_s_C1),x=o-i-this.m_referenceAngle;p=A.Length(),y=ht(x);const C=B.Solve33(A.x,A.y,x,bt.SolvePositionConstraints_s_impulse).SelfNeg(),v=bt.SolvePositionConstraints_s_P.Set(C.x,C.y);e.SelfMulSub(l,v),i-=_*(s.CrossVV(this.m_rA,v)+C.z),n.SelfMulAdd(c,v),o+=h*(s.CrossVV(this.m_rB,v)+C.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,p<=N&&y<=Bt}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2WeldJointDef = new b2WeldJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.referenceAngle = %.15f;
`,this.m_referenceAngle),t(`  jd.frequencyHz = %.15f;
`,this.m_frequencyHz),t(`  jd.dampingRatio = %.15f;
`,this.m_dampingRatio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}bt.InitVelocityConstraints_s_P=new s,bt.SolveVelocityConstraints_s_Cdot1=new s,bt.SolveVelocityConstraints_s_impulse1=new s,bt.SolveVelocityConstraints_s_impulse=new Ct,bt.SolveVelocityConstraints_s_P=new s,bt.SolvePositionConstraints_s_C1=new s,bt.SolvePositionConstraints_s_P=new s,bt.SolvePositionConstraints_s_impulse=new Ct;class ma extends ee{constructor(){super(m.b2JointType.e_wheelJoint),this.localAnchorA=new s(0,0),this.localAnchorB=new s(0,0),this.localAxisA=new s(1,0),this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.frequencyHz=2,this.dampingRatio=.7}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)}}class Qt extends se{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_localXAxisA=new s,this.m_localYAxisA=new s,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new s,this.m_ay=new s,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new w,this.m_qB=new w,this.m_lalcA=new s,this.m_lalcB=new s,this.m_rA=new s,this.m_rB=new s,this.m_frequencyHz=b(t.frequencyHz,2),this.m_dampingRatio=b(t.dampingRatio,.7),this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_localXAxisA.Copy(b(t.localAxisA,s.UNITX)),s.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_maxMotorTorque=b(t.maxMotorTorque,0),this.m_motorSpeed=b(t.motorSpeed,0),this.m_enableMotor=b(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero()}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_frequencyHz=t}GetSpringFrequencyHz(){return this.m_frequencyHz}SetSpringDampingRatio(t){this.m_dampingRatio=t}GetSpringDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,o=this.m_invIB,r=t.positions[this.m_indexA].c,a=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v;let c=t.velocities[this.m_indexA].w;const _=t.positions[this.m_indexB].c,h=t.positions[this.m_indexB].a,u=t.velocities[this.m_indexB].v;let f=t.velocities[this.m_indexB].w;const p=this.m_qA.SetAngle(a),y=this.m_qB.SetAngle(h);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const B=w.MulRV(p,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const A=w.MulRV(y,this.m_lalcB,this.m_rB),x=s.SubVV(s.AddVV(_,A,s.s_t0),s.AddVV(r,B,s.s_t1),Qt.InitVelocityConstraints_s_d);if(w.MulRV(p,this.m_localYAxisA,this.m_ay),this.m_sAy=s.CrossVV(s.AddVV(x,B,s.s_t0),this.m_ay),this.m_sBy=s.CrossVV(A,this.m_ay),this.m_mass=e+i+n*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){w.MulRV(p,this.m_localXAxisA,this.m_ax),this.m_sAx=s.CrossVV(s.AddVV(x,B,s.s_t0),this.m_ax),this.m_sBx=s.CrossVV(A,this.m_ax);const C=e+i+n*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(C>0){this.m_springMass=1/C;const v=s.DotVV(x,this.m_ax),M=2*k*this.m_frequencyHz,G=2*this.m_springMass*this.m_dampingRatio*M,I=this.m_springMass*M*M,T=t.step.dt;this.m_gamma=T*(G+T*I),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=v*T*I*this.m_gamma,this.m_springMass=C+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const C=s.AddVV(s.MulSV(this.m_impulse,this.m_ay,s.s_t0),s.MulSV(this.m_springImpulse,this.m_ax,s.s_t1),Qt.InitVelocityConstraints_s_P),v=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,M=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,C),c-=this.m_invIA*v,u.SelfMulAdd(this.m_invMassB,C),f+=this.m_invIB*M}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=c,t.velocities[this.m_indexB].w=f}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,o=this.m_invIB,r=t.velocities[this.m_indexA].v;let a=t.velocities[this.m_indexA].w;const l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;{const _=s.DotVV(this.m_ax,s.SubVV(l,r,s.s_t0))+this.m_sBx*c-this.m_sAx*a,h=-this.m_springMass*(_+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;const u=s.MulSV(h,this.m_ax,Qt.SolveVelocityConstraints_s_P),f=h*this.m_sAx,p=h*this.m_sBx;r.SelfMulSub(e,u),a-=n*f,l.SelfMulAdd(i,u),c+=o*p}{const _=c-a-this.m_motorSpeed;let h=-this.m_motorMass*_;const u=this.m_motorImpulse,f=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Vt(this.m_motorImpulse+h,-f,f),h=this.m_motorImpulse-u,a-=n*h,c+=o*h}{const _=s.DotVV(this.m_ay,s.SubVV(l,r,s.s_t0))+this.m_sBy*c-this.m_sAy*a,h=-this.m_mass*_;this.m_impulse+=h;const u=s.MulSV(h,this.m_ay,Qt.SolveVelocityConstraints_s_P),f=h*this.m_sAy,p=h*this.m_sBy;r.SelfMulSub(e,u),a-=n*f,l.SelfMulAdd(i,u),c+=o*p}t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=c}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=w.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=w.MulRV(a,this.m_lalcB,this.m_rB),_=s.AddVV(s.SubVV(n,e,s.s_t0),s.SubVV(c,l,s.s_t1),Qt.SolvePositionConstraints_s_d),h=w.MulRV(r,this.m_localYAxisA,this.m_ay),u=s.CrossVV(s.AddVV(_,l,s.s_t0),h),f=s.CrossVV(c,h),p=s.DotVV(_,this.m_ay),y=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let B;y!==0?B=-p/y:B=0;const A=s.MulSV(B,h,Qt.SolvePositionConstraints_s_P),x=B*u,C=B*f;return e.SelfMulSub(this.m_invMassA,A),i-=this.m_invIA*x,n.SelfMulAdd(this.m_invMassB,A),o+=this.m_invIB*C,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,ht(p)<=N}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new s),n=e.GetWorldPoint(this.m_localAnchorB,new s),o=s.SubVV(n,i,new s),r=t.GetWorldVector(this.m_localXAxisA,new s);return s.DotVV(o,r)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;s.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=w.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=w.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),o=s.AddVV(t.m_sweep.c,i,s.s_t0),r=s.AddVV(e.m_sweep.c,n,s.s_t1),a=s.SubVV(r,o,s.s_t2),l=t.GetWorldVector(this.m_localXAxisA,new s),c=t.m_linearVelocity,_=e.m_linearVelocity,h=t.m_angularVelocity,u=e.m_angularVelocity;return s.DotVV(a,s.CrossSV(h,l,s.s_t0))+s.DotVV(l,s.SubVV(s.AddVCrossSV(_,u,n,s.s_t0),s.AddVCrossSV(c,h,i,s.s_t1),s.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2WheelJointDef = new b2WheelJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.localAxisA.Set(%.15f, %.15f);
`,this.m_localXAxisA.x,this.m_localXAxisA.y),t(`  jd.enableMotor = %s;
`,this.m_enableMotor?"true":"false"),t(`  jd.motorSpeed = %.15f;
`,this.m_motorSpeed),t(`  jd.maxMotorTorque = %.15f;
`,this.m_maxMotorTorque),t(`  jd.frequencyHz = %.15f;
`,this.m_frequencyHz),t(`  jd.dampingRatio = %.15f;
`,this.m_dampingRatio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}Qt.InitVelocityConstraints_s_d=new s,Qt.InitVelocityConstraints_s_P=new s,Qt.SolveVelocityConstraints_s_P=new s,Qt.SolvePositionConstraints_s_d=new s,Qt.SolvePositionConstraints_s_P=new s;function bi(d,t){return pe(d*t)}function Vi(d,t){return d>t?d:t}class wi{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(this._other===null)throw new Error;return this._other}set other(t){if(this._other!==null)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class oe{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new wi(this),this.m_nodeB=new wi(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new es,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new es}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),o=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),o.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=bi(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=Vi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=bi(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Vi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const n=this.m_touchingFlag,o=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),a=o||r,l=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),_=l.GetTransform(),h=c.GetTransform();if(a){const u=this.GetShapeA(),f=this.GetShapeB();i=pi(u,this.m_indexA,f,this.m_indexB,_,h),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,_,h),i=this.m_manifold.pointCount>0;for(let u=0;u<this.m_manifold.pointCount;++u){const f=this.m_manifold.points[u];f.normalImpulse=0,f.tangentImpulse=0;const p=f.id;for(let y=0;y<this.m_oldManifold.pointCount;++y){const B=this.m_oldManifold.points[y];if(B.id.key===p.key){f.normalImpulse=B.normalImpulse,f.tangentImpulse=B.tangentImpulse;break}}}i!==n&&(l.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!a&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=oe.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=N;const n=oe.ComputeTOI_s_output;return Ai(n,i),n.t}}oe.ComputeTOI_s_input=new yi,oe.ComputeTOI_s_output=new Bi;class is extends oe{static Create(){return new is}static Destroy(t){}Evaluate(t,e,i){un(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class ns extends oe{static Create(){return new ns}static Destroy(t){}Evaluate(t,e,i){pn(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class os extends oe{static Create(){return new os}static Destroy(t){}Evaluate(t,e,i){dn(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class rs extends oe{static Create(){return new rs}static Destroy(t){}Evaluate(t,e,i){Si(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class as extends oe{static Create(){return new as}static Destroy(t){}Evaluate(t,e,i){Ci(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Le extends oe{static Create(){return new Le}static Destroy(t){}Evaluate(t,e,i){const n=Le.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Si(t,n,e,this.GetShapeB(),i)}}Le.Evaluate_s_edge=new ot;class Te extends oe{static Create(){return new Te}static Destroy(t){}Evaluate(t,e,i){const n=Te.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Ci(t,n,e,this.GetShapeB(),i)}}Te.Evaluate_s_edge=new ot;class Cn{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class vn{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,n){const o=[];function r(){return o.pop()||t()}function a(l){o.push(l)}this.m_registers[i][n].pool=o,this.m_registers[i][n].createFcn=r,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=o,this.m_registers[n][i].createFcn=r,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!1)}InitializeRegisters(){for(let t=0;t<m.b2ShapeType.e_shapeTypeCount;t++){this.m_registers[t]=[];for(let e=0;e<m.b2ShapeType.e_shapeTypeCount;e++)this.m_registers[t][e]=new Cn}this.AddType(is.Create,is.Destroy,m.b2ShapeType.e_circleShape,m.b2ShapeType.e_circleShape),this.AddType(os.Create,os.Destroy,m.b2ShapeType.e_polygonShape,m.b2ShapeType.e_circleShape),this.AddType(ns.Create,ns.Destroy,m.b2ShapeType.e_polygonShape,m.b2ShapeType.e_polygonShape),this.AddType(rs.Create,rs.Destroy,m.b2ShapeType.e_edgeShape,m.b2ShapeType.e_circleShape),this.AddType(as.Create,as.Destroy,m.b2ShapeType.e_edgeShape,m.b2ShapeType.e_polygonShape),this.AddType(Le.Create,Le.Destroy,m.b2ShapeType.e_chainShape,m.b2ShapeType.e_circleShape),this.AddType(Te.Create,Te.Destroy,m.b2ShapeType.e_chainShape,m.b2ShapeType.e_polygonShape)}Create(t,e,i,n){const o=t.GetType(),r=i.GetType(),a=this.m_registers[o][r];if(a.createFcn){const l=a.createFcn();return a.primary?l.Reset(t,e,i,n):l.Reset(i,n,t,e),l}else return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)}}class ha{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t,e){}}class Rs{ShouldCollide(t,e){const i=t.GetBody(),n=e.GetBody();if(n.GetType()===m.b2BodyType.b2_staticBody&&i.GetType()===m.b2BodyType.b2_staticBody||!n.ShouldCollideConnected(i))return!1;const o=t.GetFilterData(),r=e.GetFilterData();return o.groupIndex===r.groupIndex&&o.groupIndex!==0?o.groupIndex>0:(o.maskBits&r.categoryBits)!==0&&(o.categoryBits&r.maskBits)!==0}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}Rs.b2_defaultFilter=new Rs;class bn{constructor(){this.normalImpulses=ge(z),this.tangentImpulses=ge(z),this.count=0}}class ks{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}ks.b2_defaultListener=new ks;class ye{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class Vn{ReportFixture(t,e,i,n){return n}ReportParticle(t,e,i,n,o){return 0}ShouldQueryParticleSystem(t){return!0}}class wn{constructor(){this.m_broadPhase=new ln,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=Rs.b2_defaultFilter,this.m_contactListener=ks.b2_defaultListener,this.m_contactFactory=new vn}AddPair(t,e){let i=t.fixture,n=e.fixture,o=t.childIndex,r=e.childIndex,a=i.GetBody(),l=n.GetBody();if(a===l)return;let c=l.GetContactList();for(;c;){if(c.other===a){const h=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),f=c.contact.GetChildIndexA(),p=c.contact.GetChildIndexB();if(h===i&&u===n&&f===o&&p===r||h===n&&u===i&&f===r&&p===o)return}c=c.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n))return;const _=this.m_contactFactory.Create(i,o,n,r);_!==null&&(i=_.GetFixtureA(),n=_.GetFixtureB(),o=_.GetChildIndexA(),r=_.GetChildIndexB(),a=i.m_body,l=n.m_body,_.m_prev=null,_.m_next=this.m_contactList,this.m_contactList!==null&&(this.m_contactList.m_prev=_),this.m_contactList=_,_.m_nodeA.other=l,_.m_nodeA.prev=null,_.m_nodeA.next=a.m_contactList,a.m_contactList!==null&&(a.m_contactList.prev=_.m_nodeA),a.m_contactList=_.m_nodeA,_.m_nodeB.other=a,_.m_nodeB.prev=null,_.m_nodeB.next=l.m_contactList,l.m_contactList!==null&&(l.m_contactList.prev=_.m_nodeB),l.m_contactList=_.m_nodeB,!i.IsSensor()&&!n.IsSensor()&&(a.SetAwake(!0),l.SetAwake(!0)),++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs((t,e)=>{this.AddPair(t,e)})}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),o=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===o.m_contactList&&(o.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let t=this.m_contactList;for(;t;){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=t.GetChildIndexA(),o=t.GetChildIndexB(),r=e.GetBody(),a=i.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(e,i)){const f=t;t=f.m_next,this.Destroy(f);continue}t.m_filterFlag=!1}const l=r.IsAwake()&&r.m_type!==m.b2BodyType.b2_staticBody,c=a.IsAwake()&&a.m_type!==m.b2BodyType.b2_staticBody;if(!l&&!c){t=t.m_next;continue}const _=e.m_proxies[n].treeNode,h=i.m_proxies[o].treeNode;if(!fi(_.aabb,h.aabb)){const f=t;t=f.m_next,this.Destroy(f);continue}t.Update(this.m_contactListener),t=t.m_next}}}class gi{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class Re{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class ls{constructor(){this.c=new s,this.a=0}static MakeArray(t){return Xt(t,e=>new ls)}}class ms{constructor(){this.v=new s,this.w=0}static MakeArray(t){return Xt(t,e=>new ms)}}class gn{constructor(){this.step=new Re}}let Mi=!1;class qs{constructor(){this.rA=new s,this.rB=new s,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return Xt(t,e=>new qs)}}class hs{constructor(){this.points=qs.MakeArray(z),this.normal=new s,this.tangent=new s,this.normalMass=new ft,this.K=new ft,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return Xt(t,e=>new hs)}}class cs{constructor(){this.localPoints=s.MakeArray(z),this.localNormal=new s,this.localPoint=new s,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new s,this.localCenterB=new s,this.invIA=0,this.invIB=0,this.type=m.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return Xt(t,e=>new cs)}}class Mn{constructor(){this.step=new Re,this.count=0}}class he{constructor(){this.normal=new s,this.point=new s,this.separation=0}Initialize(t,e,i,n){const o=he.Initialize_s_pointA,r=he.Initialize_s_pointB,a=he.Initialize_s_planePoint,l=he.Initialize_s_clipPoint;switch(t.type){case m.b2ManifoldType.e_circles:{P.MulXV(e,t.localPoint,o),P.MulXV(i,t.localPoints[0],r),s.SubVV(r,o,this.normal).SelfNormalize(),s.MidVV(o,r,this.point),this.separation=s.DotVV(s.SubVV(r,o,s.s_t0),this.normal)-t.radiusA-t.radiusB;break}case m.b2ManifoldType.e_faceA:{w.MulRV(e.q,t.localNormal,this.normal),P.MulXV(e,t.localPoint,a),P.MulXV(i,t.localPoints[n],l),this.separation=s.DotVV(s.SubVV(l,a,s.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(l);break}case m.b2ManifoldType.e_faceB:{w.MulRV(i.q,t.localNormal,this.normal),P.MulXV(i,t.localPoint,a),P.MulXV(e,t.localPoints[n],l),this.separation=s.DotVV(s.SubVV(l,a,s.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(l),this.normal.SelfNeg();break}}}}he.Initialize_s_pointA=new s,he.Initialize_s_pointB=new s,he.Initialize_s_planePoint=new s,he.Initialize_s_clipPoint=new s;class O{constructor(){this.m_step=new Re,this.m_positionConstraints=cs.MakeArray(1024),this.m_velocityConstraints=hs.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const e=W(this.m_positionConstraints.length*2,this.m_count);for(;this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new cs}if(this.m_velocityConstraints.length<this.m_count){const e=W(this.m_velocityConstraints.length*2,this.m_count);for(;this.m_velocityConstraints.length<e;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new hs}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let e=0;e<this.m_count;++e){const i=this.m_contacts[e],n=i.m_fixtureA,o=i.m_fixtureB,r=n.GetShape(),a=o.GetShape(),l=r.m_radius,c=a.m_radius,_=n.GetBody(),h=o.GetBody(),u=i.GetManifold(),f=u.pointCount,p=this.m_velocityConstraints[e];p.friction=i.m_friction,p.restitution=i.m_restitution,p.tangentSpeed=i.m_tangentSpeed,p.indexA=_.m_islandIndex,p.indexB=h.m_islandIndex,p.invMassA=_.m_invMass,p.invMassB=h.m_invMass,p.invIA=_.m_invI,p.invIB=h.m_invI,p.contactIndex=e,p.pointCount=f,p.K.SetZero(),p.normalMass.SetZero();const y=this.m_positionConstraints[e];y.indexA=_.m_islandIndex,y.indexB=h.m_islandIndex,y.invMassA=_.m_invMass,y.invMassB=h.m_invMass,y.localCenterA.Copy(_.m_sweep.localCenter),y.localCenterB.Copy(h.m_sweep.localCenter),y.invIA=_.m_invI,y.invIB=h.m_invI,y.localNormal.Copy(u.localNormal),y.localPoint.Copy(u.localPoint),y.pointCount=f,y.radiusA=l,y.radiusB=c,y.type=u.type;for(let B=0;B<f;++B){const A=u.points[B],x=p.points[B];this.m_step.warmStarting?(x.normalImpulse=this.m_step.dtRatio*A.normalImpulse,x.tangentImpulse=this.m_step.dtRatio*A.tangentImpulse):(x.normalImpulse=0,x.tangentImpulse=0),x.rA.SetZero(),x.rB.SetZero(),x.normalMass=0,x.tangentMass=0,x.velocityBias=0,y.localPoints[B].Copy(A.localPoint)}}return this}InitializeVelocityConstraints(){const t=O.InitializeVelocityConstraints_s_xfA,e=O.InitializeVelocityConstraints_s_xfB,i=O.InitializeVelocityConstraints_s_worldManifold,n=1e3;for(let o=0;o<this.m_count;++o){const r=this.m_velocityConstraints[o],a=this.m_positionConstraints[o],l=a.radiusA,c=a.radiusB,_=this.m_contacts[r.contactIndex].GetManifold(),h=r.indexA,u=r.indexB,f=r.invMassA,p=r.invMassB,y=r.invIA,B=r.invIB,A=a.localCenterA,x=a.localCenterB,C=this.m_positions[h].c,v=this.m_positions[h].a,M=this.m_velocities[h].v,G=this.m_velocities[h].w,I=this.m_positions[u].c,T=this.m_positions[u].a,F=this.m_velocities[u].v,q=this.m_velocities[u].w;t.q.SetAngle(v),e.q.SetAngle(T),s.SubVV(C,w.MulRV(t.q,A,s.s_t0),t.p),s.SubVV(I,w.MulRV(e.q,x,s.s_t0),e.p),i.Initialize(_,t,l,e,c),r.normal.Copy(i.normal),s.CrossVOne(r.normal,r.tangent);const J=r.pointCount;for(let L=0;L<J;++L){const D=r.points[L];s.SubVV(i.points[L],C,D.rA),s.SubVV(i.points[L],I,D.rB);const Z=s.CrossVV(D.rA,r.normal),U=s.CrossVV(D.rB,r.normal),tt=f+p+y*Z*Z+B*U*U;D.normalMass=tt>0?1/tt:0;const ct=r.tangent,_t=s.CrossVV(D.rA,ct),Lt=s.CrossVV(D.rB,ct),Tt=f+p+y*_t*_t+B*Lt*Lt;D.tangentMass=Tt>0?1/Tt:0,D.velocityBias=0;const Rt=s.DotVV(r.normal,s.SubVV(s.AddVCrossSV(F,q,D.rB,s.s_t0),s.AddVCrossSV(M,G,D.rA,s.s_t1),s.s_t0));Rt<-xt&&(D.velocityBias+=-r.restitution*Rt)}if(r.pointCount===2&&Mi){const L=r.points[0],D=r.points[1],Z=s.CrossVV(L.rA,r.normal),U=s.CrossVV(L.rB,r.normal),tt=s.CrossVV(D.rA,r.normal),ct=s.CrossVV(D.rB,r.normal),_t=f+p+y*Z*Z+B*U*U,Lt=f+p+y*tt*tt+B*ct*ct,Tt=f+p+y*Z*tt+B*U*ct;_t*_t<n*(_t*Lt-Tt*Tt)?(r.K.ex.Set(_t,Tt),r.K.ey.Set(Tt,Lt),r.K.GetInverse(r.normalMass)):r.pointCount=1}}}WarmStart(){const t=O.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],n=i.indexA,o=i.indexB,r=i.invMassA,a=i.invIA,l=i.invMassB,c=i.invIB,_=i.pointCount,h=this.m_velocities[n].v;let u=this.m_velocities[n].w;const f=this.m_velocities[o].v;let p=this.m_velocities[o].w;const y=i.normal,B=i.tangent;for(let A=0;A<_;++A){const x=i.points[A];s.AddVV(s.MulSV(x.normalImpulse,y,s.s_t0),s.MulSV(x.tangentImpulse,B,s.s_t1),t),u-=a*s.CrossVV(x.rA,t),h.SelfMulSub(r,t),p+=c*s.CrossVV(x.rB,t),f.SelfMulAdd(l,t)}this.m_velocities[n].w=u,this.m_velocities[o].w=p}}SolveVelocityConstraints(){const t=O.SolveVelocityConstraints_s_dv,e=O.SolveVelocityConstraints_s_dv1,i=O.SolveVelocityConstraints_s_dv2,n=O.SolveVelocityConstraints_s_P,o=O.SolveVelocityConstraints_s_a,r=O.SolveVelocityConstraints_s_b,a=O.SolveVelocityConstraints_s_x,l=O.SolveVelocityConstraints_s_d,c=O.SolveVelocityConstraints_s_P1,_=O.SolveVelocityConstraints_s_P2,h=O.SolveVelocityConstraints_s_P1P2;for(let u=0;u<this.m_count;++u){const f=this.m_velocityConstraints[u],p=f.indexA,y=f.indexB,B=f.invMassA,A=f.invIA,x=f.invMassB,C=f.invIB,v=f.pointCount,M=this.m_velocities[p].v;let G=this.m_velocities[p].w;const I=this.m_velocities[y].v;let T=this.m_velocities[y].w;const F=f.normal,q=f.tangent,J=f.friction;for(let L=0;L<v;++L){const D=f.points[L];s.SubVV(s.AddVCrossSV(I,T,D.rB,s.s_t0),s.AddVCrossSV(M,G,D.rA,s.s_t1),t);const Z=s.DotVV(t,q)-f.tangentSpeed;let U=D.tangentMass*-Z;const tt=J*D.normalImpulse,ct=Vt(D.tangentImpulse+U,-tt,tt);U=ct-D.tangentImpulse,D.tangentImpulse=ct,s.MulSV(U,q,n),M.SelfMulSub(B,n),G-=A*s.CrossVV(D.rA,n),I.SelfMulAdd(x,n),T+=C*s.CrossVV(D.rB,n)}if(f.pointCount===1||Mi===!1)for(let L=0;L<v;++L){const D=f.points[L];s.SubVV(s.AddVCrossSV(I,T,D.rB,s.s_t0),s.AddVCrossSV(M,G,D.rA,s.s_t1),t);const Z=s.DotVV(t,F);let U=-D.normalMass*(Z-D.velocityBias);const tt=W(D.normalImpulse+U,0);U=tt-D.normalImpulse,D.normalImpulse=tt,s.MulSV(U,F,n),M.SelfMulSub(B,n),G-=A*s.CrossVV(D.rA,n),I.SelfMulAdd(x,n),T+=C*s.CrossVV(D.rB,n)}else{const L=f.points[0],D=f.points[1];o.Set(L.normalImpulse,D.normalImpulse),s.SubVV(s.AddVCrossSV(I,T,L.rB,s.s_t0),s.AddVCrossSV(M,G,L.rA,s.s_t1),e),s.SubVV(s.AddVCrossSV(I,T,D.rB,s.s_t0),s.AddVCrossSV(M,G,D.rA,s.s_t1),i);let Z=s.DotVV(e,F),U=s.DotVV(i,F);for(r.x=Z-L.velocityBias,r.y=U-D.velocityBias,r.SelfSub(ft.MulMV(f.K,o,s.s_t0));;){if(ft.MulMV(f.normalMass,r,a).SelfNeg(),a.x>=0&&a.y>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,c),s.MulSV(l.y,F,_),s.AddVV(c,_,h),M.SelfMulSub(B,h),G-=A*(s.CrossVV(L.rA,c)+s.CrossVV(D.rA,_)),I.SelfMulAdd(x,h),T+=C*(s.CrossVV(L.rB,c)+s.CrossVV(D.rB,_)),L.normalImpulse=a.x,D.normalImpulse=a.y;break}if(a.x=-L.normalMass*r.x,a.y=0,Z=0,U=f.K.ex.y*a.x+r.y,a.x>=0&&U>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,c),s.MulSV(l.y,F,_),s.AddVV(c,_,h),M.SelfMulSub(B,h),G-=A*(s.CrossVV(L.rA,c)+s.CrossVV(D.rA,_)),I.SelfMulAdd(x,h),T+=C*(s.CrossVV(L.rB,c)+s.CrossVV(D.rB,_)),L.normalImpulse=a.x,D.normalImpulse=a.y;break}if(a.x=0,a.y=-D.normalMass*r.y,Z=f.K.ey.x*a.y+r.x,U=0,a.y>=0&&Z>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,c),s.MulSV(l.y,F,_),s.AddVV(c,_,h),M.SelfMulSub(B,h),G-=A*(s.CrossVV(L.rA,c)+s.CrossVV(D.rA,_)),I.SelfMulAdd(x,h),T+=C*(s.CrossVV(L.rB,c)+s.CrossVV(D.rB,_)),L.normalImpulse=a.x,D.normalImpulse=a.y;break}if(a.x=0,a.y=0,Z=r.x,U=r.y,Z>=0&&U>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,c),s.MulSV(l.y,F,_),s.AddVV(c,_,h),M.SelfMulSub(B,h),G-=A*(s.CrossVV(L.rA,c)+s.CrossVV(D.rA,_)),I.SelfMulAdd(x,h),T+=C*(s.CrossVV(L.rB,c)+s.CrossVV(D.rB,_)),L.normalImpulse=a.x,D.normalImpulse=a.y;break}break}}this.m_velocities[p].w=G,this.m_velocities[y].w=T}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let n=0;n<e.pointCount;++n)i.points[n].normalImpulse=e.points[n].normalImpulse,i.points[n].tangentImpulse=e.points[n].tangentImpulse}}SolvePositionConstraints(){const t=O.SolvePositionConstraints_s_xfA,e=O.SolvePositionConstraints_s_xfB,i=O.SolvePositionConstraints_s_psm,n=O.SolvePositionConstraints_s_rA,o=O.SolvePositionConstraints_s_rB,r=O.SolvePositionConstraints_s_P;let a=0;for(let l=0;l<this.m_count;++l){const c=this.m_positionConstraints[l],_=c.indexA,h=c.indexB,u=c.localCenterA,f=c.invMassA,p=c.invIA,y=c.localCenterB,B=c.invMassB,A=c.invIB,x=c.pointCount,C=this.m_positions[_].c;let v=this.m_positions[_].a;const M=this.m_positions[h].c;let G=this.m_positions[h].a;for(let I=0;I<x;++I){t.q.SetAngle(v),e.q.SetAngle(G),s.SubVV(C,w.MulRV(t.q,u,s.s_t0),t.p),s.SubVV(M,w.MulRV(e.q,y,s.s_t0),e.p),i.Initialize(c,t,e,I);const T=i.normal,F=i.point,q=i.separation;s.SubVV(F,C,n),s.SubVV(F,M,o),a=et(a,q);const J=Vt(K*(q+N),-nt,0),L=s.CrossVV(n,T),D=s.CrossVV(o,T),Z=f+B+p*L*L+A*D*D,U=Z>0?-J/Z:0;s.MulSV(U,T,r),C.SelfMulSub(f,r),v-=p*s.CrossVV(n,r),M.SelfMulAdd(B,r),G+=A*s.CrossVV(o,r)}this.m_positions[_].a=v,this.m_positions[h].a=G}return a>-3*N}SolveTOIPositionConstraints(t,e){const i=O.SolveTOIPositionConstraints_s_xfA,n=O.SolveTOIPositionConstraints_s_xfB,o=O.SolveTOIPositionConstraints_s_psm,r=O.SolveTOIPositionConstraints_s_rA,a=O.SolveTOIPositionConstraints_s_rB,l=O.SolveTOIPositionConstraints_s_P;let c=0;for(let _=0;_<this.m_count;++_){const h=this.m_positionConstraints[_],u=h.indexA,f=h.indexB,p=h.localCenterA,y=h.localCenterB,B=h.pointCount;let A=0,x=0;(u===t||u===e)&&(A=h.invMassA,x=h.invIA);let C=0,v=0;(f===t||f===e)&&(C=h.invMassB,v=h.invIB);const M=this.m_positions[u].c;let G=this.m_positions[u].a;const I=this.m_positions[f].c;let T=this.m_positions[f].a;for(let F=0;F<B;++F){i.q.SetAngle(G),n.q.SetAngle(T),s.SubVV(M,w.MulRV(i.q,p,s.s_t0),i.p),s.SubVV(I,w.MulRV(n.q,y,s.s_t0),n.p),o.Initialize(h,i,n,F);const q=o.normal,J=o.point,L=o.separation;s.SubVV(J,M,r),s.SubVV(J,I,a),c=et(c,L);const D=Vt(H*(L+N),-nt,0),Z=s.CrossVV(r,q),U=s.CrossVV(a,q),tt=A+C+x*Z*Z+v*U*U,ct=tt>0?-D/tt:0;s.MulSV(ct,q,l),M.SelfMulSub(A,l),G-=x*s.CrossVV(r,l),I.SelfMulAdd(C,l),T+=v*s.CrossVV(a,l)}this.m_positions[u].a=G,this.m_positions[f].a=T}return c>=-1.5*N}}O.InitializeVelocityConstraints_s_xfA=new P,O.InitializeVelocityConstraints_s_xfB=new P,O.InitializeVelocityConstraints_s_worldManifold=new wt,O.WarmStart_s_P=new s,O.SolveVelocityConstraints_s_dv=new s,O.SolveVelocityConstraints_s_dv1=new s,O.SolveVelocityConstraints_s_dv2=new s,O.SolveVelocityConstraints_s_P=new s,O.SolveVelocityConstraints_s_a=new s,O.SolveVelocityConstraints_s_b=new s,O.SolveVelocityConstraints_s_x=new s,O.SolveVelocityConstraints_s_d=new s,O.SolveVelocityConstraints_s_P1=new s,O.SolveVelocityConstraints_s_P2=new s,O.SolveVelocityConstraints_s_P1P2=new s,O.SolvePositionConstraints_s_xfA=new P,O.SolvePositionConstraints_s_xfB=new P,O.SolvePositionConstraints_s_psm=new he,O.SolvePositionConstraints_s_rA=new s,O.SolvePositionConstraints_s_rB=new s,O.SolvePositionConstraints_s_P=new s,O.SolveTOIPositionConstraints_s_xfA=new P,O.SolveTOIPositionConstraints_s_xfB=new P,O.SolveTOIPositionConstraints_s_psm=new he,O.SolveTOIPositionConstraints_s_rA=new s,O.SolveTOIPositionConstraints_s_rB=new s,O.SolveTOIPositionConstraints_s_P=new s;class Ft{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=ls.MakeArray(1024),this.m_velocities=ms.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t){const o=W(this.m_positions.length*2,t);for(;this.m_positions.length<o;)this.m_positions[this.m_positions.length]=new ls}if(this.m_velocities.length<t){const o=W(this.m_velocities.length*2,t);for(;this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new ms}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(t,e,i,n){const o=Ft.s_timer.Reset(),r=e.dt;for(let h=0;h<this.m_bodyCount;++h){const u=this.m_bodies[h];this.m_positions[h].c.Copy(u.m_sweep.c);const f=u.m_sweep.a,p=this.m_velocities[h].v.Copy(u.m_linearVelocity);let y=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===m.b2BodyType.b2_dynamicBody&&(p.x+=r*(u.m_gravityScale*i.x+u.m_invMass*u.m_force.x),p.y+=r*(u.m_gravityScale*i.y+u.m_invMass*u.m_force.y),y+=r*u.m_invI*u.m_torque,p.SelfMul(1/(1+r*u.m_linearDamping)),y*=1/(1+r*u.m_angularDamping)),this.m_positions[h].a=f,this.m_velocities[h].w=y}o.Reset();const a=Ft.s_solverData;a.step.Copy(e),a.positions=this.m_positions,a.velocities=this.m_velocities;const l=Ft.s_contactSolverDef;l.step.Copy(e),l.contacts=this.m_contacts,l.count=this.m_contactCount,l.positions=this.m_positions,l.velocities=this.m_velocities;const c=Ft.s_contactSolver.Initialize(l);c.InitializeVelocityConstraints(),e.warmStarting&&c.WarmStart();for(let h=0;h<this.m_jointCount;++h)this.m_joints[h].InitVelocityConstraints(a);t.solveInit=o.GetMilliseconds(),o.Reset();for(let h=0;h<e.velocityIterations;++h){for(let u=0;u<this.m_jointCount;++u)this.m_joints[u].SolveVelocityConstraints(a);c.SolveVelocityConstraints()}c.StoreImpulses(),t.solveVelocity=o.GetMilliseconds();for(let h=0;h<this.m_bodyCount;++h){const u=this.m_positions[h].c;let f=this.m_positions[h].a;const p=this.m_velocities[h].v;let y=this.m_velocities[h].w;const B=s.MulSV(r,p,Ft.s_translation);if(s.DotVV(B,B)>Ae){const x=ae/B.Length();p.SelfMul(x)}const A=r*y;A*A>qt&&(y*=at/ht(A)),u.x+=r*p.x,u.y+=r*p.y,f+=r*y,this.m_positions[h].a=f,this.m_velocities[h].w=y}o.Reset();let _=!1;for(let h=0;h<e.positionIterations;++h){const u=c.SolvePositionConstraints();let f=!0;for(let p=0;p<this.m_jointCount;++p){const y=this.m_joints[p].SolvePositionConstraints(a);f=f&&y}if(u&&f){_=!0;break}}for(let h=0;h<this.m_bodyCount;++h){const u=this.m_bodies[h];u.m_sweep.c.Copy(this.m_positions[h].c),u.m_sweep.a=this.m_positions[h].a,u.m_linearVelocity.Copy(this.m_velocities[h].v),u.m_angularVelocity=this.m_velocities[h].w,u.SynchronizeTransform()}if(t.solvePosition=o.GetMilliseconds(),this.Report(c.m_velocityConstraints),n){let h=R;const u=$e*$e,f=ws*ws;for(let p=0;p<this.m_bodyCount;++p){const y=this.m_bodies[p];y.GetType()!==m.b2BodyType.b2_staticBody&&(!y.m_autoSleepFlag||y.m_angularVelocity*y.m_angularVelocity>f||s.DotVV(y.m_linearVelocity,y.m_linearVelocity)>u?(y.m_sleepTime=0,h=0):(y.m_sleepTime+=r,h=et(h,y.m_sleepTime)))}if(h>=we&&_)for(let p=0;p<this.m_bodyCount;++p)this.m_bodies[p].SetAwake(!1)}}SolveTOI(t,e,i){for(let a=0;a<this.m_bodyCount;++a){const l=this.m_bodies[a];this.m_positions[a].c.Copy(l.m_sweep.c),this.m_positions[a].a=l.m_sweep.a,this.m_velocities[a].v.Copy(l.m_linearVelocity),this.m_velocities[a].w=l.m_angularVelocity}const n=Ft.s_contactSolverDef;n.contacts=this.m_contacts,n.count=this.m_contactCount,n.step.Copy(t),n.positions=this.m_positions,n.velocities=this.m_velocities;const o=Ft.s_contactSolver.Initialize(n);for(let a=0;a<t.positionIterations&&!o.SolveTOIPositionConstraints(e,i);++a);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,o.InitializeVelocityConstraints();for(let a=0;a<t.velocityIterations;++a)o.SolveVelocityConstraints();const r=t.dt;for(let a=0;a<this.m_bodyCount;++a){const l=this.m_positions[a].c;let c=this.m_positions[a].a;const _=this.m_velocities[a].v;let h=this.m_velocities[a].w;const u=s.MulSV(r,_,Ft.s_translation);if(s.DotVV(u,u)>Ae){const y=ae/u.Length();_.SelfMul(y)}const f=r*h;f*f>qt&&(h*=at/ht(f)),l.SelfMulAdd(r,_),c+=r*h,this.m_positions[a].a=c,this.m_velocities[a].w=h;const p=this.m_bodies[a];p.m_sweep.c.Copy(l),p.m_sweep.a=c,p.m_linearVelocity.Copy(_),p.m_angularVelocity=h,p.SynchronizeTransform()}this.Report(o.m_velocityConstraints)}Report(t){if(this.m_listener!==null)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const n=t[e],o=Ft.s_impulse;o.count=n.pointCount;for(let r=0;r<n.pointCount;++r)o.normalImpulses[r]=n.points[r].normalImpulse,o.tangentImpulses[r]=n.points[r].tangentImpulse;this.m_listener.PostSolve(i,o)}}}Ft.s_timer=new Xe,Ft.s_solverData=new gn,Ft.s_contactSolverDef=new Mn,Ft.s_contactSolver=new O,Ft.s_translation=new s,Ft.s_impulse=new bn,function(d){d[d.b2_waterParticle=0]="b2_waterParticle",d[d.b2_zombieParticle=2]="b2_zombieParticle",d[d.b2_wallParticle=4]="b2_wallParticle",d[d.b2_springParticle=8]="b2_springParticle",d[d.b2_elasticParticle=16]="b2_elasticParticle",d[d.b2_viscousParticle=32]="b2_viscousParticle",d[d.b2_powderParticle=64]="b2_powderParticle",d[d.b2_tensileParticle=128]="b2_tensileParticle",d[d.b2_colorMixingParticle=256]="b2_colorMixingParticle",d[d.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",d[d.b2_barrierParticle=1024]="b2_barrierParticle",d[d.b2_staticPressureParticle=2048]="b2_staticPressureParticle",d[d.b2_reactiveParticle=4096]="b2_reactiveParticle",d[d.b2_repulsiveParticle=8192]="b2_repulsiveParticle",d[d.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",d[d.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",d[d.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",d[d.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle"}(m.b2ParticleFlag||(m.b2ParticleFlag={}));class Pi{constructor(){this.flags=0,this.position=new s,this.velocity=new s,this.color=new dt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}}function Pn(d,t,e){const o=Math.ceil(Math.sqrt(d/(.01*t))*e);return Vt(o,1,8)}class In{constructor(){this.m_index=$}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}(function(d){d[d.b2_solidParticleGroup=1]="b2_solidParticleGroup",d[d.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",d[d.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",d[d.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",d[d.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",d[d.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask"})(m.b2ParticleGroupFlag||(m.b2ParticleGroupFlag={}));class Gn{constructor(){this.flags=0,this.groupFlags=0,this.position=new s,this.angle=0,this.linearVelocity=new s,this.angularVelocity=0,this.color=new dt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}}class _s{constructor(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new s,this.m_linearVelocity=new s,this.m_angularVelocity=0,this.m_transform=new P,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){if(!this.m_system.m_flagsBuffer.data)throw new Error;let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(t){t|=this.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,t)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=_s.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(this.m_system.m_world.IsLocked())throw new Error;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;const t=new s,e=new s;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[n]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[n]);if(this.m_mass>0){const n=1/this.m_mass;this.m_center.SelfMul(n),this.m_linearVelocity.SelfMul(n)}this.m_inertia=0,this.m_angularVelocity=0;for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)s.SubVV(this.m_system.m_positionBuffer.data[n],this.m_center,t),s.SubVV(this.m_system.m_velocityBuffer.data[n],this.m_linearVelocity,e),this.m_inertia+=i*s.DotVV(t,t),this.m_angularVelocity+=i*s.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}_s.GetLinearVelocityFromWorldPoint_s_t0=new s;class ca{constructor(t){this.m_front=0,this.m_back=0,this.m_capacity=0,this.m_buffer=Xt(t,e=>null),this.m_capacity=t}Push(t){if(this.m_back>=this.m_capacity){for(let e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0,this.m_back>=this.m_capacity&&(this.m_capacity>0?(this.m_buffer.concat(Xt(this.m_capacity,e=>null)),this.m_capacity*=2):(this.m_buffer.concat(Xt(1,e=>null)),this.m_capacity=1))}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_buffer[this.m_front]=null,this.m_front++}Empty(){return this.m_front===this.m_back}Front(){const t=this.m_buffer[this.m_front];if(!t)throw new Error;return t}}class _a{constructor(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=Xt(t,e=>new ua),this.m_generatorCapacity=t}AddGenerator(t,e,i){const n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i}Generate(t,e){const i=1/t,n=new s(+R,+R),o=new s(-R,-R);let r=0;for(let l=0;l<this.m_generatorCount;l++){const c=this.m_generatorBuffer[l];c.necessary&&(s.MinV(n,c.center,n),s.MaxV(o,c.center,o),++r)}if(r===0){this.m_countX=0,this.m_countY=0;return}n.x-=e,n.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(i*(o.x-n.x)),this.m_countY=1+Math.floor(i*(o.y-n.y)),this.m_diagram=[];const a=new ca(4*this.m_countX*this.m_countY);for(let l=0;l<this.m_generatorCount;l++){const c=this.m_generatorBuffer[l];c.center.SelfSub(n).SelfMul(i);const _=Math.floor(c.center.x),h=Math.floor(c.center.y);_>=0&&h>=0&&_<this.m_countX&&h<this.m_countY&&a.Push(new re(_,h,_+h*this.m_countX,c))}for(;!a.Empty();){const l=a.Front(),c=l.m_x,_=l.m_y,h=l.m_i,u=l.m_generator;a.Pop(),this.m_diagram[h]||(this.m_diagram[h]=u,c>0&&a.Push(new re(c-1,_,h-1,u)),_>0&&a.Push(new re(c,_-1,h-this.m_countX,u)),c<this.m_countX-1&&a.Push(new re(c+1,_,h+1,u)),_<this.m_countY-1&&a.Push(new re(c,_+1,h+this.m_countX,u)))}for(let l=0;l<this.m_countY;l++)for(let c=0;c<this.m_countX-1;c++){const _=c+l*this.m_countX,h=this.m_diagram[_],u=this.m_diagram[_+1];h!==u&&(a.Push(new re(c,l,_,u)),a.Push(new re(c+1,l,_+1,h)))}for(let l=0;l<this.m_countY-1;l++)for(let c=0;c<this.m_countX;c++){const _=c+l*this.m_countX,h=this.m_diagram[_],u=this.m_diagram[_+this.m_countX];h!==u&&(a.Push(new re(c,l,_,u)),a.Push(new re(c,l+1,_+this.m_countX,h)))}for(;!a.Empty();){const l=a.Front(),c=l.m_x,_=l.m_y,h=l.m_i,u=l.m_generator;a.Pop();const f=this.m_diagram[h],p=u;if(f!==p){const y=f.center.x-c,B=f.center.y-_,A=p.center.x-c,x=p.center.y-_,C=y*y+B*B,v=A*A+x*x;C>v&&(this.m_diagram[h]=p,c>0&&a.Push(new re(c-1,_,h-1,p)),_>0&&a.Push(new re(c,_-1,h-this.m_countX,p)),c<this.m_countX-1&&a.Push(new re(c+1,_,h+1,p)),_<this.m_countY-1&&a.Push(new re(c,_+1,h+this.m_countX,p)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){const n=i+e*this.m_countX,o=this.m_diagram[n],r=this.m_diagram[n+1],a=this.m_diagram[n+this.m_countX],l=this.m_diagram[n+1+this.m_countX];r!==a&&(o!==r&&o!==a&&(o.necessary||r.necessary||a.necessary)&&t(o.tag,r.tag,a.tag),l!==r&&l!==a&&(o.necessary||r.necessary||a.necessary)&&t(r.tag,l.tag,a.tag))}}}class ua{constructor(){this.center=new s,this.tag=0,this.necessary=!1}}class re{constructor(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n}}function zs(d,t,e){const i=d[t];d[t]=d[e],d[e]=i}function Dn(d,t){return d<t}function Es(d,t=0,e=d.length-t,i=Dn){let n=t;const o=[];let r=0;for(;;){for(;n+1<e;e++){const a=d[n+Math.floor(Math.random()*(e-n))];o[r++]=e;for(let l=n-1;;){for(;i(d[++l],a););for(;i(a,d[--e]););if(l>=e)break;zs(d,l,e)}}if(r===0)break;n=e,e=o[--r]}return d}function Fn(d,t=0,e=d.length-t,i=Dn){return Es(d,t,e,i)}function Ln(d,t,e=d.length){let i=0;for(let n=0;n<e;++n)if(!t(d[n])){if(n===i){++i;continue}zs(d,i++,n)}return i}function Tn(d,t,e,i,n){let o=e-t;for(;o>0;){const r=Math.floor(o/2);let a=t+r;n(d[a],i)?(t=++a,o-=r+1):o=r}return t}function Rn(d,t,e,i,n){let o=e-t;for(;o>0;){const r=Math.floor(o/2);let a=t+r;n(i,d[a])?o=r:(t=++a,o-=r+1)}return t}function Wt(d,t,e,i){let n=e;for(;t!==n;)zs(d,t++,n++),n===i?n=e:t===e&&(e=n)}function da(d,t,e,i){if(t===e)return e;let n=t;for(;++t!==e;)i(d[n],d[t])||zs(d,++n,t);return++n}class ke{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){const t=this.capacity?2*this.capacity:Ne;this.Reserve(t)}Free(){this.data.length!==0&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){this.count=Ln(this.data,t,this.count)}Unique(t){this.count=da(this.data,0,this.count,t)}}class Ii extends ye{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const i=t.GetShape().GetChildCount();for(let n=0;n<i;n++){const o=t.GetAABB(n),r=this.m_system.GetInsideBoundsEnumerator(o);let a;for(;(a=r.GetNext())>=0;)this.ReportFixtureAndParticle(t,n,a)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class kn{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new s,this.flags=0}SetIndices(t,e){this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&ht(this.weight-t.weight)<.01&&s.DistanceSquaredVV(this.normal,t.normal)<1e-4}}class qn{constructor(){this.index=0,this.weight=0,this.normal=new s,this.mass=0}}class zn{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class En{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new s(0,0),this.pb=new s(0,0),this.pc=new s(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class Ns{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return new Ns().Copy(this)}}class S{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new ce,this.m_flagsBuffer=new ce,this.m_positionBuffer=new ce,this.m_velocityBuffer=new ce,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new ce,this.m_groupBuffer=[],this.m_userDataBuffer=new ce,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new ce,this.m_bodyContactCountBuffer=new ce,this.m_consecutiveContactStepsBuffer=new ce,this.m_stuckParticleBuffer=new ke(()=>0),this.m_proxyBuffer=new ke(()=>new qe),this.m_contactBuffer=new ke(()=>new kn),this.m_bodyContactBuffer=new ke(()=>new qn),this.m_pairBuffer=new ke(()=>new zn),this.m_triadBuffer=new ke(()=>new En),this.m_expirationTimeBuffer=new ce,this.m_indexByExpirationTimeBuffer=new ce,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new Ns,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+S.yOffset>>>0<<S.yShift)+(S.xScale*t+S.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<S.yShift)+(e<<S.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){const l=this.m_count?2*this.m_count:Ne;this.ReallocateInternalAllocatedBuffers(l)}if(this.m_count>=this.m_internalAllocatedCapacity)if(this.m_def.destroyByAge)this.DestroyOldestParticle(0,!1),this.SolveZombie();else return $;const e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new s).Copy(b(t.position,s.ZERO)),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new s).Copy(b(t.velocity,s.ZERO)),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new s).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0);const i=new dt().Copy(b(t.color,dt.ZERO));(this.m_colorBuffer.data||!i.IsZero())&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new dt).Copy(i)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);const n=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],o=b(t.lifetime,0),r=o>0;(this.m_expirationTimeBuffer.data||r)&&(this.SetParticleLifetime(e,r?o:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),n.index=e;const a=b(t.group,null);return this.m_groupBuffer[e]=a,a&&(a.m_firstIndex<a.m_lastIndex?(this.RotateBuffer(a.m_firstIndex,a.m_lastIndex,e),a.m_lastIndex=e+1):(a.m_firstIndex=e,a.m_lastIndex=e+1)),this.SetParticleFlags(e,b(t.flags,0)),e}GetParticleHandleFromIndex(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||(e=new In,e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(t,e=!1){let i=m.b2ParticleFlag.b2_zombieParticle;e&&(i|=m.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|i)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],o=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:o,e)}DestroyParticlesInShape(t,e,i=!1){const n=S.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;const o=new Xn(this,t,e,i),r=n;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(o,r),o.Destroyed()}CreateParticleGroup(t){const e=S.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;const i=e;i.SetPositionAngle(b(t.position,s.ZERO),b(t.angle,0));const n=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,b(t.shapeCount,t.shapes.length),t,i),t.positionData){const l=b(t.particleCount,t.positionData.length);for(let c=0;c<l;c++){const _=t.positionData[c];this.CreateParticleForGroup(t,i,_)}}const o=this.m_count;let r=new _s(this);r.m_firstIndex=n,r.m_lastIndex=o,r.m_strength=b(t.strength,1),r.m_userData=t.userData,r.m_transform.Copy(i),r.m_prev=null,r.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=r),this.m_groupList=r,++this.m_groupCount;for(let l=n;l<o;l++)this.m_groupBuffer[l]=r;this.SetGroupFlags(r,b(t.groupFlags,0));const a=new js;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(n,o,a),t.group&&(this.JoinParticleGroups(t.group,r),r=t.group),r}JoinParticleGroups(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);const i=new Un(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let o=e.m_firstIndex;o<e.m_lastIndex;o++)this.m_groupBuffer[o]=t;const n=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,n),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);const e=t.GetParticleCount(),i=Xt(e,o=>new jn);S.InitializeParticleLists(t,i),this.MergeParticleListsInContact(t,i);const n=S.FindLongestParticleList(t,i);this.MergeZombieParticleListNodes(t,i,n),this.CreateParticleGroupsFromParticleList(t,i,n),this.UpdatePairsAndTriadsWithParticleList(t,i)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(t,e){this.m_flagsBuffer.data[t]&~e&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&e&&(e&m.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),e&m.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=e),this.m_flagsBuffer.data[t]=e}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)}SetPositionBuffer(t){if(t instanceof Float32Array){if(t.length%2!==0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new s(t.subarray(n*2,n*2+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)}SetVelocityBuffer(t){if(t instanceof Float32Array){if(t.length%2!==0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new s(t.subarray(n*2,n*2+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)}SetColorBuffer(t){if(t instanceof Float32Array){if(t.length%4!==0)throw new Error;const e=t.length/4,i=new Array(e);for(let n=0;n<e;++n)i[n]=new dt(t.subarray(n*4,n*4+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)}SetUserDataBuffer(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){const t=S.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data;let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n],r=o.indexA,a=o.indexB,l=o.normal,c=s.SubVV(e[a],e[r],t),_=s.DotVV(c,l);_<0&&(i+=_*_)}return .5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){const i=this.m_indexByExpirationTimeBuffer.data===null;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){const r=this.GetParticleCount();for(let a=0;a<r;++a)this.m_indexByExpirationTimeBuffer.data[a]=a}const n=e/this.m_def.lifetimeGranularity,o=n>0?this.GetQuantizedTimeElapsed()+n:n;o!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=o,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){const n=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),a=new s().Copy(i).SelfMul(1/r);for(let l=t;l<e;l++)n[l].SelfAdd(a)}static IsSignificantForce(t){return t.x!==0||t.y!==0}ParticleApplyForce(t,e){S.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){const n=new s().Copy(i).SelfMul(1/(e-t));if(S.IsSignificantForce(n)){this.PrepareForceBuffer();for(let o=t;o<e;o++)this.m_forceBuffer[o].SelfAdd(n)}}GetNext(){return this.m_next}QueryAABB(t,e){if(this.m_proxyBuffer.count===0)return;const i=0,n=this.m_proxyBuffer.count,o=Tn(this.m_proxyBuffer.data,i,n,S.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),qe.CompareProxyTag),r=Rn(this.m_proxyBuffer.data,o,n,S.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),qe.CompareTagProxy),a=this.m_positionBuffer.data;for(let l=o;l<r;++l){const _=this.m_proxyBuffer.data[l].index,h=a[_];if(e.lowerBound.x<h.x&&h.x<e.upperBound.x&&e.lowerBound.y<h.y&&h.y<e.upperBound.y&&!t.ReportParticle(this,_))break}}QueryShapeAABB(t,e,i,n=0){const r=S.QueryShapeAABB_s_aabb;e.ComputeAABB(r,i,n),this.QueryAABB(t,r)}QueryPointAABB(t,e,i=N){const o=S.QueryPointAABB_s_aabb;o.lowerBound.Set(e.x-i,e.y-i),o.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,o)}RayCast(t,e,i){const n=S.RayCast_s_aabb,o=S.RayCast_s_p,r=S.RayCast_s_v,a=S.RayCast_s_n,l=S.RayCast_s_point;if(this.m_proxyBuffer.count===0)return;const c=this.m_positionBuffer.data,_=n;s.MinV(e,i,_.lowerBound),s.MaxV(e,i,_.upperBound);let h=1;const u=s.SubVV(i,e,r),f=s.DotVV(u,u),p=this.GetInsideBoundsEnumerator(_);let y;for(;(y=p.GetNext())>=0;){const B=s.SubVV(e,c[y],o),A=s.DotVV(B,u),x=s.DotVV(B,B),C=A*A-f*(x-this.m_squaredDiameter);if(C>=0){const v=pe(C);let M=(-A-v)/f;if(M>h||M<0&&(M=(-A+v)/f,M<0||M>h))continue;const G=s.AddVMulSV(B,M,u,a);G.Normalize();const I=t.ReportParticle(this,y,s.AddVMulSV(e,M,u,l),G,M);if(h=et(h,I),h<=0)break}}}ComputeAABB(t){const e=this.GetParticleCount();t.lowerBound.x=+R,t.lowerBound.y=+R,t.upperBound.x=-R,t.upperBound.y=-R;const i=this.m_positionBuffer.data;for(let n=0;n<e;n++){const o=i[n];s.MinV(t.lowerBound,o,t.lowerBound),s.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){t!==null&&(t.length=0)}FreeUserOverridableBuffer(t){t.userSuppliedCapacity===0&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){if(i<=e)throw new Error;const n=t?t.slice():[];return n.length=i,n}ReallocateBuffer5(t,e,i,n,o){if(n<=i)throw new Error;if(!(!e||n<=e))throw new Error;return(!o||t)&&!e&&(t=this.ReallocateBuffer3(t,i,n)),t}ReallocateBuffer4(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)}RequestBuffer(t){return t||(this.m_internalAllocatedCapacity===0&&this.ReallocateInternalAllocatedBuffers(Ne),t=[],t.length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(i,n){return n&&i>n?n:i}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);const i=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,i){const n=new Pi;n.flags=b(t.flags,0),P.MulXV(e,i,n.position),s.AddVV(b(t.linearVelocity,s.ZERO),s.CrossSV(b(t.angularVelocity,0),s.SubVV(n.position,b(t.position,s.ZERO),s.s_t0),s.s_t0),n.velocity),n.color.Copy(b(t.color,dt.ZERO)),n.lifetime=b(t.lifetime,0),n.userData=t.userData,this.CreateParticle(n)}CreateParticlesStrokeShapeForGroup(t,e,i){const n=S.CreateParticlesStrokeShapeForGroup_s_edge,o=S.CreateParticlesStrokeShapeForGroup_s_d,r=S.CreateParticlesStrokeShapeForGroup_s_p;let a=b(e.stride,0);a===0&&(a=this.GetParticleStride());let l=0;const c=t.GetChildCount();for(let _=0;_<c;_++){let h=null;t.GetType()===m.b2ShapeType.e_edgeShape?h=t:(h=n,t.GetChildEdge(h,_));const u=s.SubVV(h.m_vertex2,h.m_vertex1,o),f=u.Length();for(;l<f;){const p=s.AddVMulSV(h.m_vertex1,l/f,u,r);this.CreateParticleForGroup(e,i,p),l+=a}l-=f}}CreateParticlesFillShapeForGroup(t,e,i){const n=S.CreateParticlesFillShapeForGroup_s_aabb,o=S.CreateParticlesFillShapeForGroup_s_p;let r=b(e.stride,0);r===0&&(r=this.GetParticleStride());const a=P.IDENTITY,l=n;t.ComputeAABB(l,a,0);for(let c=Math.floor(l.lowerBound.y/r)*r;c<l.upperBound.y;c+=r)for(let _=Math.floor(l.lowerBound.x/r)*r;_<l.upperBound.x;_+=r){const h=o.Set(_,c);t.TestPoint(a,h)&&this.CreateParticleForGroup(e,i,h)}}CreateParticlesWithShapeForGroup(t,e,i){switch(t.GetType()){case m.b2ShapeType.e_edgeShape:case m.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,e,i);break;case m.b2ShapeType.e_polygonShape:case m.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(t,e,i);break}}CreateParticlesWithShapesForGroup(t,e,i,n){const o=new Zn(t,e);this.CreateParticlesFillShapeForGroup(o,i,n)}CloneParticle(t,e){const i=new Pi;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;const n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){const o=this.m_handleIndexBuffer.data[t];o&&o.SetIndex(n),this.m_handleIndexBuffer.data[n]=o,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(t,e){return(t&(m.b2ParticleFlag.b2_wallParticle|m.b2ParticleFlag.b2_springParticle|m.b2ParticleFlag.b2_elasticParticle))!==0||e!==null&&(e.GetGroupFlags()&m.b2ParticleGroupFlag.b2_rigidParticleGroup)!==0}UpdatePairsAndTriads(t,e,i){const n=S.UpdatePairsAndTriads_s_dab,o=S.UpdatePairsAndTriads_s_dbc,r=S.UpdatePairsAndTriads_s_dca,a=this.m_positionBuffer.data;let l=0;for(let c=t;c<e;c++)l|=this.m_flagsBuffer.data[c];if(l&S.k_pairFlags)for(let c=0;c<this.m_contactBuffer.count;c++){const _=this.m_contactBuffer.data[c],h=_.indexA,u=_.indexB,f=this.m_flagsBuffer.data[h],p=this.m_flagsBuffer.data[u],y=this.m_groupBuffer[h],B=this.m_groupBuffer[u];if(h>=t&&h<e&&u>=t&&u<e&&!((f|p)&m.b2ParticleFlag.b2_zombieParticle)&&(f|p)&S.k_pairFlags&&(i.IsNecessary(h)||i.IsNecessary(u))&&S.ParticleCanBeConnected(f,y)&&S.ParticleCanBeConnected(p,B)&&i.ShouldCreatePair(h,u)){const A=this.m_pairBuffer.data[this.m_pairBuffer.Append()];A.indexA=h,A.indexB=u,A.flags=_.flags,A.strength=et(y?y.m_strength:1,B?B.m_strength:1),A.distance=s.DistanceVV(a[h],a[u])}Fn(this.m_pairBuffer.data,0,this.m_pairBuffer.count,S.ComparePairIndices),this.m_pairBuffer.Unique(S.MatchPairIndices)}if(l&S.k_triadFlags){const c=new _a(e-t);for(let f=t;f<e;f++){const p=this.m_flagsBuffer.data[f],y=this.m_groupBuffer[f];!(p&m.b2ParticleFlag.b2_zombieParticle)&&S.ParticleCanBeConnected(p,y)&&c.AddGenerator(a[f],f,i.IsNecessary(f))}const _=this.GetParticleStride();c.Generate(_/2,_*2);const h=this,u=(f,p,y)=>{const B=h.m_flagsBuffer.data[f],A=h.m_flagsBuffer.data[p],x=h.m_flagsBuffer.data[y];if((B|A|x)&S.k_triadFlags&&i.ShouldCreateTriad(f,p,y)){const C=a[f],v=a[p],M=a[y],G=s.SubVV(C,v,n),I=s.SubVV(v,M,o),T=s.SubVV(M,C,r),F=Ke*h.m_squaredDiameter;if(s.DotVV(G,G)>F||s.DotVV(I,I)>F||s.DotVV(T,T)>F)return;const q=h.m_groupBuffer[f],J=h.m_groupBuffer[p],L=h.m_groupBuffer[y],D=h.m_triadBuffer.data[h.m_triadBuffer.Append()];D.indexA=f,D.indexB=p,D.indexC=y,D.flags=B|A|x,D.strength=et(et(q?q.m_strength:1,J?J.m_strength:1),L?L.m_strength:1);const Z=(C.x+v.x+M.x)/3,U=(C.y+v.y+M.y)/3;D.pa.x=C.x-Z,D.pa.y=C.y-U,D.pb.x=v.x-Z,D.pb.y=v.y-U,D.pc.x=M.x-Z,D.pc.y=M.y-U,D.ka=-s.DotVV(T,G),D.kb=-s.DotVV(G,I),D.kc=-s.DotVV(I,T),D.s=s.CrossVV(C,v)+s.CrossVV(v,M)+s.CrossVV(M,C)}};c.GetNodes(u),Fn(this.m_triadBuffer.data,0,this.m_triadBuffer.count,S.CompareTriadIndices),this.m_triadBuffer.Unique(S.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){const t=new Hn(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&=~m.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~m.b2ParticleFlag.b2_reactiveParticle}static ComparePairIndices(t,e){const i=t.indexA-e.indexA;return i!==0?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){const i=t.indexA-e.indexA;if(i!==0)return i<0;const n=t.indexB-e.indexB;return n!==0?n<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){const i=t.GetBufferIndex(),n=t.GetParticleCount();for(let o=0;o<n;o++){const r=e[o];r.list=r,r.next=null,r.count=1,r.index=o+i}}MergeParticleListsInContact(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n],r=o.indexA,a=o.indexB;if(!t.ContainsParticle(r)||!t.ContainsParticle(a))continue;let l=e[r-i].list,c=e[a-i].list;if(l!==c){if(l.count<c.count){const _=l;l=c,c=_}S.MergeParticleLists(l,c)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;const n=i.next;if(n)i=n;else{i.next=t.next;break}}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){const i=t.GetParticleCount();let n=e[0];for(let o=0;o<i;o++){const r=e[o];n.count<r.count&&(n=r)}return n}MergeZombieParticleListNodes(t,e,i){const n=t.GetParticleCount();for(let o=0;o<n;o++){const r=e[o];r!==i&&this.m_flagsBuffer.data[r.index]&m.b2ParticleFlag.b2_zombieParticle&&S.MergeParticleListAndNode(i,r)}}static MergeParticleListAndNode(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(t,e,i){const n=t.GetParticleCount(),o=new Gn;o.groupFlags=t.GetGroupFlags(),o.userData=t.GetUserData();for(let r=0;r<n;r++){const a=e[r];if(!a.count||a===i)continue;const l=this.CreateParticleGroup(o);for(let c=a;c;c=c.next){const _=c.index,h=this.CloneParticle(_,l);this.m_flagsBuffer.data[_]|=m.b2ParticleFlag.b2_zombieParticle,c.index=h}}}UpdatePairsAndTriadsWithParticleList(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_pairBuffer.count;n++){const o=this.m_pairBuffer.data[n],r=o.indexA,a=o.indexB;t.ContainsParticle(r)&&(o.indexA=e[r-i].index),t.ContainsParticle(a)&&(o.indexB=e[a-i].index)}for(let n=0;n<this.m_triadBuffer.count;n++){const o=this.m_triadBuffer.data[n],r=o.indexA,a=o.indexB,l=o.indexC;t.ContainsParticle(r)&&(o.indexA=e[r-i].index),t.ContainsParticle(a)&&(o.indexB=e[a-i].index),t.ContainsParticle(l)&&(o.indexC=e[l-i].index)}}ComputeDepth(){const t=[];let e=0;for(let r=0;r<this.m_contactBuffer.count;r++){const a=this.m_contactBuffer.data[r],l=a.indexA,c=a.indexB,_=this.m_groupBuffer[l],h=this.m_groupBuffer[c];_&&_===h&&_.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(t[e++]=a)}const i=[];let n=0;for(let r=this.m_groupList;r;r=r.GetNext())if(r.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){i[n++]=r,this.SetGroupFlags(r,r.m_groupFlags&~m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(let a=r.m_firstIndex;a<r.m_lastIndex;a++)this.m_accumulationBuffer[a]=0}for(let r=0;r<e;r++){const a=t[r],l=a.indexA,c=a.indexB,_=a.weight;this.m_accumulationBuffer[l]+=_,this.m_accumulationBuffer[c]+=_}for(let r=0;r<n;r++){const a=i[r];for(let l=a.m_firstIndex;l<a.m_lastIndex;l++){const c=this.m_accumulationBuffer[l];this.m_depthBuffer[l]=c<.8?0:R}}const o=pe(this.m_count)>>0;for(let r=0;r<o;r++){let a=!1;for(let l=0;l<e;l++){const c=t[l],_=c.indexA,h=c.indexB,u=1-c.weight,f=this.m_depthBuffer[_],p=this.m_depthBuffer[h],y=p+u,B=f+u;f>y&&(this.m_depthBuffer[_]=y,a=!0),p>B&&(this.m_depthBuffer[h]=B,a=!0)}if(!a)break}for(let r=0;r<n;r++){const a=i[r];for(let l=a.m_firstIndex;l<a.m_lastIndex;l++)this.m_depthBuffer[l]<R?this.m_depthBuffer[l]*=this.m_particleDiameter:this.m_depthBuffer[l]=0}}GetInsideBoundsEnumerator(t){const e=S.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=S.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),n=0,o=this.m_proxyBuffer.count,r=Tn(this.m_proxyBuffer.data,n,o,e,qe.CompareProxyTag),a=Rn(this.m_proxyBuffer.data,n,o,i,qe.CompareTagProxy);return new Nn(this,e,i,r,a)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){const n=this.m_flagsBuffer.data,o=this.m_positionBuffer.data,r=s.SubVV(o[e],o[t],S.AddContact_s_d),a=s.DotVV(r,r);if(0<a&&a<this.m_squaredDiameter){let l=li(a);const c=this.m_contactBuffer.data[this.m_contactBuffer.Append()];c.indexA=t,c.indexB=e,c.flags=n[t]|n[e],c.weight=1-a*l*this.m_inverseDiameter,c.normal.x=l*r.x,c.normal.y=l*r.y}}FindContacts_Reference(t){const i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let n=0,o=0;n<i;n++){const r=S.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,0);for(let c=n+1;c<i&&!(r<this.m_proxyBuffer.data[c].tag);c++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[c].index,this.m_contactBuffer);const a=S.computeRelativeTag(this.m_proxyBuffer.data[n].tag,-1,1);for(;o<i&&!(a<=this.m_proxyBuffer.data[o].tag);o++);const l=S.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,1);for(let c=o;c<i&&!(l<this.m_proxyBuffer.data[c].tag);c++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[c].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){const e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let n=0;n<this.m_proxyBuffer.count;++n){const o=this.m_proxyBuffer.data[n],r=o.index,a=e[r];o.tag=S.computeTag(i*a.x,i*a.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){Es(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,qe.CompareProxyProxy)}FilterContacts(t){const e=this.GetParticleContactFilter();if(e===null)return;const i=this,n=o=>(o.flags&m.b2ParticleFlag.b2_particleContactFilterParticle)!==0&&!e.ShouldCollideParticleParticle(i,o.indexA,o.indexB);this.m_contactBuffer.RemoveIf(n)}NotifyContactListenerPreContact(t){if(this.GetParticleContactListener()!==null)throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){const e=this.GetParticleContactListener();if(e!==null){for(let i=0;i<this.m_contactBuffer.count;++i){const n=this.m_contactBuffer.data[i];e.BeginContactParticleParticle(this,n)}throw new Error}}static b2ParticleContactIsZombie(t){return(t.flags&m.b2ParticleFlag.b2_zombieParticle)===m.b2ParticleFlag.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);const e=new Jn;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(S.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(this.GetFixtureContactListener()!==null)throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){const e=this.GetFixtureContactListener();if(e!==null){for(let i=0;i<this.m_bodyContactBuffer.count;i++){const n=this.m_bodyContactBuffer.data[i];e.BeginContactFixtureParticle(this,n)}throw new Error}}UpdateBodyContacts(){const t=S.UpdateBodyContacts_s_aabb,e=new On;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){const o=this.GetParticleCount();for(let r=0;r<o;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);const i=t;this.ComputeAABB(i),this.UpdateBodyContacts_callback===null&&(this.UpdateBodyContacts_callback=new ze(this));const n=this.UpdateBodyContacts_callback;n.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(n,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(t){const e=S.Solve_s_subStep;if(this.m_count!==0&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(t),this.m_allParticleFlags&m.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<t.particleIterations;this.m_iterationIndex++){++this.m_timestamp;const i=e.Copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&m.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&m.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(i),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(i),this.SolvePressure(i),this.SolveDamping(i),this.m_allParticleFlags&S.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&m.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_springParticle&&this.SolveSpring(i),this.LimitVelocity(i),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&m.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(i),this.SolveCollision(i),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(let n=0;n<this.m_count;n++)this.m_positionBuffer.data[n].SelfMulAdd(i.dt,this.m_velocityBuffer.data[n])}}SolveCollision(t){const e=S.SolveCollision_s_aabb,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=e;o.lowerBound.x=+R,o.lowerBound.y=+R,o.upperBound.x=-R,o.upperBound.y=-R;for(let a=0;a<this.m_count;a++){const l=n[a],c=i[a],_=c.x+t.dt*l.x,h=c.y+t.dt*l.y;o.lowerBound.x=et(o.lowerBound.x,et(c.x,_)),o.lowerBound.y=et(o.lowerBound.y,et(c.y,h)),o.upperBound.x=W(o.upperBound.x,W(c.x,_)),o.upperBound.y=W(o.upperBound.y,W(c.y,h))}this.SolveCollision_callback===null&&(this.SolveCollision_callback=new Ut(this,t));const r=this.SolveCollision_callback;r.m_step=t,this.m_world.QueryAABB(r,o)}LimitVelocity(t){const e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let n=0;n<this.m_count;n++){const o=e[n],r=s.DotVV(o,o);r>i&&o.SelfMul(pe(i/r))}}SolveGravity(t){const e=S.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,n=s.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let o=0;o<this.m_count;o++)i[o].SelfAdd(n)}SolveBarrier(t){const e=S.SolveBarrier_s_aabb,i=S.SolveBarrier_s_va,n=S.SolveBarrier_s_vb,o=S.SolveBarrier_s_pba,r=S.SolveBarrier_s_vba,a=S.SolveBarrier_s_vc,l=S.SolveBarrier_s_pca,c=S.SolveBarrier_s_vca,_=S.SolveBarrier_s_qba,h=S.SolveBarrier_s_qca,u=S.SolveBarrier_s_dv,f=S.SolveBarrier_s_f,p=this.m_positionBuffer.data,y=this.m_velocityBuffer.data;for(let x=0;x<this.m_count;x++)(this.m_flagsBuffer.data[x]&S.k_barrierWallFlags)!==0&&y[x].SetZero();const B=je*t.dt,A=this.GetParticleMass();for(let x=0;x<this.m_pairBuffer.count;x++){const C=this.m_pairBuffer.data[x];if(C.flags&m.b2ParticleFlag.b2_barrierParticle){const v=C.indexA,M=C.indexB,G=p[v],I=p[M],T=e;s.MinV(G,I,T.lowerBound),s.MaxV(G,I,T.upperBound);const F=this.m_groupBuffer[v],q=this.m_groupBuffer[M],J=this.GetLinearVelocity(F,v,G,i),L=this.GetLinearVelocity(q,M,I,n),D=s.SubVV(I,G,o),Z=s.SubVV(L,J,r),U=this.GetInsideBoundsEnumerator(T);let tt;for(;(tt=U.GetNext())>=0;){const ct=p[tt],_t=this.m_groupBuffer[tt];if(F!==_t&&q!==_t){const Lt=this.GetLinearVelocity(_t,tt,ct,a),Tt=s.SubVV(ct,G,l),Rt=s.SubVV(Lt,J,c),Qe=s.CrossVV(Z,Rt),Be=s.CrossVV(D,Rt)-s.CrossVV(Tt,Z),We=s.CrossVV(D,Tt);let Zt,Ot;const Mt=_,de=h;if(Qe===0){if(Be===0||(Ot=-We/Be,!(Ot>=0&&Ot<B))||(s.AddVMulSV(D,Ot,Z,Mt),s.AddVMulSV(Tt,Ot,Rt,de),Zt=s.DotVV(Mt,de)/s.DotVV(Mt,Mt),!(Zt>=0&&Zt<=1)))continue}else{const ds=Be*Be-4*We*Qe;if(ds<0)continue;const fs=pe(ds);let Us=(-Be-fs)/(2*Qe),Zs=(-Be+fs)/(2*Qe);if(Us>Zs){const xa=Us;Us=Zs,Zs=xa}if(Ot=Us,s.AddVMulSV(D,Ot,Z,Mt),s.AddVMulSV(Tt,Ot,Rt,de),Zt=s.DotVV(Mt,de)/s.DotVV(Mt,Mt),!(Ot>=0&&Ot<B&&Zt>=0&&Zt<=1)&&(Ot=Zs,!(Ot>=0&&Ot<B)||(s.AddVMulSV(D,Ot,Z,Mt),s.AddVMulSV(Tt,Ot,Rt,de),Zt=s.DotVV(Mt,de)/s.DotVV(Mt,Mt),!(Zt>=0&&Zt<=1))))continue}const Xs=u;Xs.x=J.x+Zt*Z.x-Lt.x,Xs.y=J.y+Zt*Z.y-Lt.y;const Di=s.MulSV(A,Xs,f);if(_t&&this.IsRigidGroup(_t)){const ds=_t.GetMass(),fs=_t.GetInertia();ds>0&&_t.m_linearVelocity.SelfMulAdd(1/ds,Di),fs>0&&(_t.m_angularVelocity+=s.CrossVV(s.SubVV(ct,_t.GetCenter(),s.s_t0),Di)/fs)}else y[tt].SelfAdd(Xs);this.ParticleApplyForce(tt,Di.SelfMul(-t.inv_dt))}}}}}SolveStaticPressure(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);const e=this.GetCriticalPressure(t),i=this.m_def.staticPressureStrength*e,n=fe*e,o=this.m_def.staticPressureRelaxation;for(let r=0;r<this.m_def.staticPressureIterations;r++){for(let a=0;a<this.m_count;a++)this.m_accumulationBuffer[a]=0;for(let a=0;a<this.m_contactBuffer.count;a++){const l=this.m_contactBuffer.data[a];if(l.flags&m.b2ParticleFlag.b2_staticPressureParticle){const c=l.indexA,_=l.indexB,h=l.weight;this.m_accumulationBuffer[c]+=h*this.m_staticPressureBuffer[_],this.m_accumulationBuffer[_]+=h*this.m_staticPressureBuffer[c]}}for(let a=0;a<this.m_count;a++){const l=this.m_weightBuffer[a];if(this.m_flagsBuffer.data[a]&m.b2ParticleFlag.b2_staticPressureParticle){const _=(this.m_accumulationBuffer[a]+i*(l-le))/(l+o);this.m_staticPressureBuffer[a]=Vt(_,0,n)}else this.m_staticPressureBuffer[a]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],i=e.index,n=e.weight;this.m_weightBuffer[i]+=n}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],i=e.indexA,n=e.indexB,o=e.weight;this.m_weightBuffer[i]+=o,this.m_weightBuffer[n]+=o}}SolvePressure(t){const e=S.SolvePressure_s_f,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.GetCriticalPressure(t),r=this.m_def.pressureStrength*o,a=fe*o;for(let _=0;_<this.m_count;_++){const h=this.m_weightBuffer[_],u=r*W(0,h-le);this.m_accumulationBuffer[_]=et(u,a)}if(this.m_allParticleFlags&S.k_noPressureFlags)for(let _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&S.k_noPressureFlags&&(this.m_accumulationBuffer[_]=0);if(this.m_allParticleFlags&m.b2ParticleFlag.b2_staticPressureParticle)for(let _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&m.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);const l=t.dt/(this.m_def.density*this.m_particleDiameter),c=this.GetParticleInvMass();for(let _=0;_<this.m_bodyContactBuffer.count;_++){const h=this.m_bodyContactBuffer.data[_],u=h.index,f=h.body,p=h.weight,y=h.mass,B=h.normal,A=i[u],x=this.m_accumulationBuffer[u]+r*p,C=s.MulSV(l*p*y*x,B,e);n[u].SelfMulSub(c,C),f.ApplyLinearImpulse(C,A,!0)}for(let _=0;_<this.m_contactBuffer.count;_++){const h=this.m_contactBuffer.data[_],u=h.indexA,f=h.indexB,p=h.weight,y=h.normal,B=this.m_accumulationBuffer[u]+this.m_accumulationBuffer[f],A=s.MulSV(l*p*B,y,e);n[u].SelfSub(A),n[f].SelfAdd(A)}}SolveDamping(t){const e=S.SolveDamping_s_v,i=S.SolveDamping_s_f,n=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,r=this.m_def.dampingStrength,a=1/this.GetCriticalVelocity(t),l=this.GetParticleInvMass();for(let c=0;c<this.m_bodyContactBuffer.count;c++){const _=this.m_bodyContactBuffer.data[c],h=_.index,u=_.body,f=_.weight,p=_.mass,y=_.normal,B=n[h],A=s.SubVV(u.GetLinearVelocityFromWorldPoint(B,s.s_t0),o[h],e),x=s.DotVV(A,y);if(x<0){const C=W(r*f,et(-a*x,.5)),v=s.MulSV(C*p*x,y,i);o[h].SelfMulAdd(l,v),u.ApplyLinearImpulse(v.SelfNeg(),B,!0)}}for(let c=0;c<this.m_contactBuffer.count;c++){const _=this.m_contactBuffer.data[c],h=_.indexA,u=_.indexB,f=_.weight,p=_.normal,y=s.SubVV(o[u],o[h],e),B=s.DotVV(y,p);if(B<0){const A=W(r*f,et(-a*B,.5)),x=s.MulSV(A*B,p,i);o[h].SelfAdd(x),o[u].SelfSub(x)}}}SolveRigidDamping(){const t=S.SolveRigidDamping_s_t0,e=S.SolveRigidDamping_s_t1,i=S.SolveRigidDamping_s_p,n=S.SolveRigidDamping_s_v,o=[0],r=[0],a=[0],l=[0],c=[0],_=[0],h=this.m_positionBuffer.data,u=this.m_def.dampingStrength;for(let f=0;f<this.m_bodyContactBuffer.count;f++){const p=this.m_bodyContactBuffer.data[f],y=p.index,B=this.m_groupBuffer[y];if(B&&this.IsRigidGroup(B)){const A=p.body,x=p.normal,C=p.weight,v=h[y],M=s.SubVV(A.GetLinearVelocityFromWorldPoint(v,t),B.GetLinearVelocityFromWorldPoint(v,e),n),G=s.DotVV(M,x);if(G<0){this.InitDampingParameterWithRigidGroupOrParticle(o,r,a,!0,B,y,v,x),this.InitDampingParameter(l,c,_,A.GetMass(),A.GetInertia()-A.GetMass()*A.GetLocalCenter().LengthSquared(),A.GetWorldCenter(),v,x);const I=u*et(C,1)*this.ComputeDampingImpulse(o[0],r[0],a[0],l[0],c[0],_[0],G);this.ApplyDamping(o[0],r[0],a[0],!0,B,y,I,x),A.ApplyLinearImpulse(s.MulSV(-I,x,s.s_t0),v,!0)}}}for(let f=0;f<this.m_contactBuffer.count;f++){const p=this.m_contactBuffer.data[f],y=p.indexA,B=p.indexB,A=p.normal,x=p.weight,C=this.m_groupBuffer[y],v=this.m_groupBuffer[B],M=this.IsRigidGroup(C),G=this.IsRigidGroup(v);if(C!==v&&(M||G)){const I=s.MidVV(h[y],h[B],i),T=s.SubVV(this.GetLinearVelocity(v,B,I,t),this.GetLinearVelocity(C,y,I,e),n),F=s.DotVV(T,A);if(F<0){this.InitDampingParameterWithRigidGroupOrParticle(o,r,a,M,C,y,I,A),this.InitDampingParameterWithRigidGroupOrParticle(l,c,_,G,v,B,I,A);const q=u*x*this.ComputeDampingImpulse(o[0],r[0],a[0],l[0],c[0],_[0],F);this.ApplyDamping(o[0],r[0],a[0],M,C,y,q,A),this.ApplyDamping(l[0],c[0],_[0],G,v,B,-q,A)}}}}SolveExtraDamping(){const t=S.SolveExtraDamping_s_v,e=S.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,n=this.m_positionBuffer.data,o=this.GetParticleInvMass();for(let r=0;r<this.m_bodyContactBuffer.count;r++){const a=this.m_bodyContactBuffer.data[r],l=a.index;if(this.m_flagsBuffer.data[l]&S.k_extraDampingFlags){const c=a.body,_=a.mass,h=a.normal,u=n[l],f=s.SubVV(c.GetLinearVelocityFromWorldPoint(u,s.s_t0),i[l],t),p=s.DotVV(f,h);if(p<0){const y=s.MulSV(.5*_*p,h,e);i[l].SelfMulAdd(o,y),c.ApplyLinearImpulse(y.SelfNeg(),u,!0)}}}}SolveWall(){const t=this.m_velocityBuffer.data;for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&m.b2ParticleFlag.b2_wallParticle&&t[e].SetZero()}SolveRigid(t){const e=S.SolveRigid_s_position,i=S.SolveRigid_s_rotation,n=S.SolveRigid_s_transform,o=S.SolveRigid_s_velocityTransform,r=this.m_positionBuffer.data,a=this.m_velocityBuffer.data;for(let l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();const c=i;c.SetAngle(t.dt*l.m_angularVelocity);const _=s.AddVV(l.m_center,s.SubVV(s.MulSV(t.dt,l.m_linearVelocity,s.s_t0),w.MulRV(c,l.m_center,s.s_t1),s.s_t0),e),h=n;h.SetPositionRotation(_,c),P.MulXX(h,l.m_transform,l.m_transform);const u=o;u.p.x=t.inv_dt*h.p.x,u.p.y=t.inv_dt*h.p.y,u.q.s=t.inv_dt*h.q.s,u.q.c=t.inv_dt*(h.q.c-1);for(let f=l.m_firstIndex;f<l.m_lastIndex;f++)P.MulXV(u,r[f],a[f])}}SolveElastic(t){const e=S.SolveElastic_s_pa,i=S.SolveElastic_s_pb,n=S.SolveElastic_s_pc,o=S.SolveElastic_s_r,r=S.SolveElastic_s_t0,a=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,c=t.inv_dt*this.m_def.elasticStrength;for(let _=0;_<this.m_triadBuffer.count;_++){const h=this.m_triadBuffer.data[_];if(h.flags&m.b2ParticleFlag.b2_elasticParticle){const u=h.indexA,f=h.indexB,p=h.indexC,y=h.pa,B=h.pb,A=h.pc,x=e.Copy(a[u]),C=i.Copy(a[f]),v=n.Copy(a[p]),M=l[u],G=l[f],I=l[p];x.SelfMulAdd(t.dt,M),C.SelfMulAdd(t.dt,G),v.SelfMulAdd(t.dt,I);const T=(x.x+C.x+v.x)/3,F=(x.y+C.y+v.y)/3;x.x-=T,x.y-=F,C.x-=T,C.y-=F,v.x-=T,v.y-=F;const q=o;q.s=s.CrossVV(y,x)+s.CrossVV(B,C)+s.CrossVV(A,v),q.c=s.DotVV(y,x)+s.DotVV(B,C)+s.DotVV(A,v);const J=q.s*q.s+q.c*q.c;let L=li(J);isFinite(L)||(L=198177537e11),q.s*=L,q.c*=L;const D=c*h.strength;w.MulRV(q,y,r),s.SubVV(r,x,r),s.MulSV(D,r,r),M.SelfAdd(r),w.MulRV(q,B,r),s.SubVV(r,C,r),s.MulSV(D,r,r),G.SelfAdd(r),w.MulRV(q,A,r),s.SubVV(r,v,r),s.MulSV(D,r,r),I.SelfAdd(r)}}}SolveSpring(t){const e=S.SolveSpring_s_pa,i=S.SolveSpring_s_pb,n=S.SolveSpring_s_d,o=S.SolveSpring_s_f,r=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,l=t.inv_dt*this.m_def.springStrength;for(let c=0;c<this.m_pairBuffer.count;c++){const _=this.m_pairBuffer.data[c];if(_.flags&m.b2ParticleFlag.b2_springParticle){const h=_.indexA,u=_.indexB,f=e.Copy(r[h]),p=i.Copy(r[u]),y=a[h],B=a[u];f.SelfMulAdd(t.dt,y),p.SelfMulAdd(t.dt,B);const A=s.SubVV(p,f,n),x=_.distance,C=A.Length(),v=l*_.strength,M=s.MulSV(v*(x-C)/C,A,o);y.SelfSub(M),B.SelfAdd(M)}}}SolveTensile(t){const e=S.SolveTensile_s_weightedNormal,i=S.SolveTensile_s_s,n=S.SolveTensile_s_f,o=this.m_velocityBuffer.data;for(let _=0;_<this.m_count;_++)this.m_accumulation2Buffer[_]=new s,this.m_accumulation2Buffer[_].SetZero();for(let _=0;_<this.m_contactBuffer.count;_++){const h=this.m_contactBuffer.data[_];if(h.flags&m.b2ParticleFlag.b2_tensileParticle){const u=h.indexA,f=h.indexB,p=h.weight,y=h.normal,B=s.MulSV((1-p)*p,y,e);this.m_accumulation2Buffer[u].SelfSub(B),this.m_accumulation2Buffer[f].SelfAdd(B)}}const r=this.GetCriticalVelocity(t),a=this.m_def.surfaceTensionPressureStrength*r,l=this.m_def.surfaceTensionNormalStrength*r,c=Pe*r;for(let _=0;_<this.m_contactBuffer.count;_++){const h=this.m_contactBuffer.data[_];if(h.flags&m.b2ParticleFlag.b2_tensileParticle){const u=h.indexA,f=h.indexB,p=h.weight,y=h.normal,B=this.m_weightBuffer[u]+this.m_weightBuffer[f],A=s.SubVV(this.m_accumulation2Buffer[f],this.m_accumulation2Buffer[u],i),x=et(a*(B-2)+l*s.DotVV(A,y),c)*p,C=s.MulSV(x,y,n);o[u].SelfSub(C),o[f].SelfAdd(C)}}}SolveViscous(){const t=S.SolveViscous_s_v,e=S.SolveViscous_s_f,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.m_def.viscousStrength,r=this.GetParticleInvMass();for(let a=0;a<this.m_bodyContactBuffer.count;a++){const l=this.m_bodyContactBuffer.data[a],c=l.index;if(this.m_flagsBuffer.data[c]&m.b2ParticleFlag.b2_viscousParticle){const _=l.body,h=l.weight,u=l.mass,f=i[c],p=s.SubVV(_.GetLinearVelocityFromWorldPoint(f,s.s_t0),n[c],t),y=s.MulSV(o*u*h,p,e);n[c].SelfMulAdd(r,y),_.ApplyLinearImpulse(y.SelfNeg(),f,!0)}}for(let a=0;a<this.m_contactBuffer.count;a++){const l=this.m_contactBuffer.data[a];if(l.flags&m.b2ParticleFlag.b2_viscousParticle){const c=l.indexA,_=l.indexB,h=l.weight,u=s.SubVV(n[_],n[c],t),f=s.MulSV(o*h,u,e);n[c].SelfAdd(f),n[_].SelfSub(f)}}}SolveRepulsive(t){const e=S.SolveRepulsive_s_f,i=this.m_velocityBuffer.data,n=this.m_def.repulsiveStrength*this.GetCriticalVelocity(t);for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o];if(r.flags&m.b2ParticleFlag.b2_repulsiveParticle){const a=r.indexA,l=r.indexB;if(this.m_groupBuffer[a]!==this.m_groupBuffer[l]){const c=r.weight,_=r.normal,h=s.MulSV(n*c,_,e);i[a].SelfSub(h),i[l].SelfAdd(h)}}}}SolvePowder(t){const e=S.SolvePowder_s_f,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.m_def.powderStrength*this.GetCriticalVelocity(t),r=1-Kt,a=this.GetParticleInvMass();for(let l=0;l<this.m_bodyContactBuffer.count;l++){const c=this.m_bodyContactBuffer.data[l],_=c.index;if(this.m_flagsBuffer.data[_]&m.b2ParticleFlag.b2_powderParticle){const h=c.weight;if(h>r){const u=c.body,f=c.mass,p=i[_],y=c.normal,B=s.MulSV(o*f*(h-r),y,e);n[_].SelfMulSub(a,B),u.ApplyLinearImpulse(B,p,!0)}}}for(let l=0;l<this.m_contactBuffer.count;l++){const c=this.m_contactBuffer.data[l];if(c.flags&m.b2ParticleFlag.b2_powderParticle){const _=c.weight;if(_>r){const h=c.indexA,u=c.indexB,f=c.normal,p=s.MulSV(o*(_-r),f,e);n[h].SelfSub(p),n[u].SelfAdd(p)}}}}SolveSolid(t){const e=S.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);const n=t.inv_dt*this.m_def.ejectionStrength;for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o],a=r.indexA,l=r.indexB;if(this.m_groupBuffer[a]!==this.m_groupBuffer[l]){const c=r.weight,_=r.normal,h=this.m_depthBuffer[a]+this.m_depthBuffer[l],u=s.MulSV(n*h*c,_,e);i[a].SelfSub(u),i[l].SelfAdd(u)}}}SolveForce(t){const e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let n=0;n<this.m_count;n++)e[n].SelfMulAdd(i,this.m_forceBuffer[n]);this.m_hasForce=!1}SolveColorMixing(){const t=.5*this.m_def.colorMixingStrength;if(t)for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e],n=i.indexA,o=i.indexB;if(this.m_flagsBuffer.data[n]&this.m_flagsBuffer.data[o]&m.b2ParticleFlag.b2_colorMixingParticle){const r=this.m_colorBuffer.data[n],a=this.m_colorBuffer.data[o];dt.MixColors(r,a,t)}}}SolveZombie(){let t=0;const e=[];for(let o=0;o<this.m_count;o++)e[o]=$;let i=0;for(let o=0;o<this.m_count;o++){const r=this.m_flagsBuffer.data[o];if(r&m.b2ParticleFlag.b2_zombieParticle){const a=this.m_world.m_destructionListener;if(r&m.b2ParticleFlag.b2_destructionListenerParticle&&a&&a.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){const l=this.m_handleIndexBuffer.data[o];l&&(l.SetIndex($),this.m_handleIndexBuffer.data[o]=null)}e[o]=$}else{if(e[o]=t,o!==t){if(this.m_handleIndexBuffer.data){const a=this.m_handleIndexBuffer.data[o];a&&a.SetIndex(t),this.m_handleIndexBuffer.data[t]=a}this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[t]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[o])}t++,i|=r}}const n={IsProxyInvalid:o=>o.index<0,IsContactInvalid:o=>o.indexA<0||o.indexB<0,IsBodyContactInvalid:o=>o.index<0,IsPairInvalid:o=>o.indexA<0||o.indexB<0,IsTriadInvalid:o=>o.indexA<0||o.indexB<0||o.indexC<0};for(let o=0;o<this.m_proxyBuffer.count;o++){const r=this.m_proxyBuffer.data[o];r.index=e[r.index]}this.m_proxyBuffer.RemoveIf(n.IsProxyInvalid);for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o];r.indexA=e[r.indexA],r.indexB=e[r.indexB]}this.m_contactBuffer.RemoveIf(n.IsContactInvalid);for(let o=0;o<this.m_bodyContactBuffer.count;o++){const r=this.m_bodyContactBuffer.data[o];r.index=e[r.index]}this.m_bodyContactBuffer.RemoveIf(n.IsBodyContactInvalid);for(let o=0;o<this.m_pairBuffer.count;o++){const r=this.m_pairBuffer.data[o];r.indexA=e[r.indexA],r.indexB=e[r.indexB]}this.m_pairBuffer.RemoveIf(n.IsPairInvalid);for(let o=0;o<this.m_triadBuffer.count;o++){const r=this.m_triadBuffer.data[o];r.indexA=e[r.indexA],r.indexB=e[r.indexB],r.indexC=e[r.indexC]}if(this.m_triadBuffer.RemoveIf(n.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data){let o=0;for(let r=0;r<this.m_count;r++){const a=e[this.m_indexByExpirationTimeBuffer.data[r]];a!==$&&(this.m_indexByExpirationTimeBuffer.data[o++]=a)}}for(let o=this.m_groupList;o;o=o.GetNext()){let r=t,a=0,l=!1;for(let c=o.m_firstIndex;c<o.m_lastIndex;c++){const _=e[c];_>=0?(r=et(r,_),a=W(a,_+1)):l=!0}r<a?(o.m_firstIndex=r,o.m_lastIndex=a,l&&o.m_groupFlags&m.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(o,o.m_groupFlags|m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(o.m_firstIndex=0,o.m_lastIndex=0,o.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(o,o.m_groupFlags|m.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=t,this.m_allParticleFlags=i,this.m_needsUpdateAllParticleFlags=!1;for(let o=this.m_groupList;o;){const r=o.GetNext();o.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(o),o=r}}SolveLifetimes(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);const e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,o=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(Es(n,0,o,(a,l)=>{const c=i[a],_=i[l],h=c<=0,u=_<=0;return h===u?c>_:h}),this.m_expirationTimeBufferRequiresSorting=!1);for(let r=o-1;r>=0;--r){const a=n[r],l=i[a];if(e<l||l<=0)break;this.DestroyParticle(a)}}RotateBuffer(t,e,i){if(t===e||e===i)return;function n(o){return o<t?o:o<e?o+i-e:o<i?o+t-e:o}if(Wt(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&Wt(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&Wt(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&Wt(this.m_consecutiveContactStepsBuffer.data,t,e,i),Wt(this.m_positionBuffer.data,t,e,i),Wt(this.m_velocityBuffer.data,t,e,i),Wt(this.m_groupBuffer,t,e,i),this.m_hasForce&&Wt(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&Wt(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&Wt(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&Wt(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&Wt(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){Wt(this.m_handleIndexBuffer.data,t,e,i);for(let o=t;o<i;++o){const r=this.m_handleIndexBuffer.data[o];r&&r.SetIndex(n(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Wt(this.m_expirationTimeBuffer.data,t,e,i);const o=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(let a=0;a<o;++a)r[a]=n(r[a])}for(let o=0;o<this.m_proxyBuffer.count;o++){const r=this.m_proxyBuffer.data[o];r.index=n(r.index)}for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o];r.indexA=n(r.indexA),r.indexB=n(r.indexB)}for(let o=0;o<this.m_bodyContactBuffer.count;o++){const r=this.m_bodyContactBuffer.data[o];r.index=n(r.index)}for(let o=0;o<this.m_pairBuffer.count;o++){const r=this.m_pairBuffer.data[o];r.indexA=n(r.indexA),r.indexB=n(r.indexB)}for(let o=0;o<this.m_triadBuffer.count;o++){const r=this.m_triadBuffer.data[o];r.indexA=n(r.indexA),r.indexB=n(r.indexB),r.indexC=n(r.indexC)}for(let o=this.m_groupList;o;o=o.GetNext())o.m_firstIndex=n(o.m_firstIndex),o.m_lastIndex=n(o.m_lastIndex-1)+1}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){const e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return Kt*this.m_particleDiameter}GetParticleMass(){const t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){const t=this.m_inverseDiameter*(1/Kt);return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e){t.data=e,t.userSuppliedCapacity=e.length}SetGroupFlags(t,e){const i=t.m_groupFlags;(i^e)&m.b2ParticleGroupFlag.b2_solidParticleGroup&&(e|=m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),i&~e&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&e&&(e&m.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=e),t.m_groupFlags=e}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){Es(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,S.BodyContactCompare);const t=S.RemoveSpuriousBodyContacts_s_n,e=S.RemoveSpuriousBodyContacts_s_pos,i=S.RemoveSpuriousBodyContacts_s_normal,n=3,o=this;let r=-1,a=0;const l=c=>{if(c.index!==r&&(a=0,r=c.index),a++>n)return!0;const _=t.Copy(c.normal);_.SelfMul(o.m_particleDiameter*(1-c.weight));const h=s.AddVV(o.m_positionBuffer.data[c.index],_,e);if(!c.fixture.TestPoint(h)){const u=c.fixture.GetShape().GetChildCount();for(let f=0;f<u;f++){const p=i;if(c.fixture.ComputeDistance(h,p,f)<N)return!1}return!0}return!1};this.m_bodyContactBuffer.count=Ln(this.m_bodyContactBuffer.data,l,this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],this.m_bodyContactCountBuffer.data[t]===2&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==$}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(t){return!(t&m.b2ParticleFlag.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(t){return t!==null&&(t.m_groupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup)!==0}GetLinearVelocity(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,n,o,r,a,l){t[0]=n>0?1/n:0,e[0]=o>0?1/o:0,i[0]=s.CrossVV(s.SubVV(a,r,s.s_t0),l)}InitDampingParameterWithRigidGroupOrParticle(t,e,i,n,o,r,a,l){if(o&&n)this.InitDampingParameter(t,e,i,o.GetMass(),o.GetInertia(),o.GetCenter(),a,l);else{const c=this.m_flagsBuffer.data[r];this.InitDampingParameter(t,e,i,c&m.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,l)}}ComputeDampingImpulse(t,e,i,n,o,r,a){const l=t+e*i*i+n+o*r*r;return l>0?a/l:0}ApplyDamping(t,e,i,n,o,r,a,l){o&&n?(o.m_linearVelocity.SelfMulAdd(a*t,l),o.m_angularVelocity+=a*i*e):this.m_velocityBuffer.data[r].SelfMulAdd(a*t,l)}}S.xTruncBits=12,S.yTruncBits=12,S.tagBits=8*4,S.yOffset=1<<S.yTruncBits-1,S.yShift=S.tagBits-S.yTruncBits,S.xShift=S.tagBits-S.yTruncBits-S.xTruncBits,S.xScale=1<<S.xShift,S.xOffset=S.xScale*(1<<S.xTruncBits-1),S.yMask=(1<<S.yTruncBits)-1<<S.yShift,S.xMask=~S.yMask,S.DestroyParticlesInShape_s_aabb=new Dt,S.CreateParticleGroup_s_transform=new P,S.ComputeCollisionEnergy_s_v=new s,S.QueryShapeAABB_s_aabb=new Dt,S.QueryPointAABB_s_aabb=new Dt,S.RayCast_s_aabb=new Dt,S.RayCast_s_p=new s,S.RayCast_s_v=new s,S.RayCast_s_n=new s,S.RayCast_s_point=new s,S.k_pairFlags=m.b2ParticleFlag.b2_springParticle,S.k_triadFlags=m.b2ParticleFlag.b2_elasticParticle,S.k_noPressureFlags=m.b2ParticleFlag.b2_powderParticle|m.b2ParticleFlag.b2_tensileParticle,S.k_extraDampingFlags=m.b2ParticleFlag.b2_staticPressureParticle,S.k_barrierWallFlags=m.b2ParticleFlag.b2_barrierParticle|m.b2ParticleFlag.b2_wallParticle,S.CreateParticlesStrokeShapeForGroup_s_edge=new ot,S.CreateParticlesStrokeShapeForGroup_s_d=new s,S.CreateParticlesStrokeShapeForGroup_s_p=new s,S.CreateParticlesFillShapeForGroup_s_aabb=new Dt,S.CreateParticlesFillShapeForGroup_s_p=new s,S.UpdatePairsAndTriads_s_dab=new s,S.UpdatePairsAndTriads_s_dbc=new s,S.UpdatePairsAndTriads_s_dca=new s,S.AddContact_s_d=new s,S.UpdateBodyContacts_s_aabb=new Dt,S.Solve_s_subStep=new Re,S.SolveCollision_s_aabb=new Dt,S.SolveGravity_s_gravity=new s,S.SolveBarrier_s_aabb=new Dt,S.SolveBarrier_s_va=new s,S.SolveBarrier_s_vb=new s,S.SolveBarrier_s_pba=new s,S.SolveBarrier_s_vba=new s,S.SolveBarrier_s_vc=new s,S.SolveBarrier_s_pca=new s,S.SolveBarrier_s_vca=new s,S.SolveBarrier_s_qba=new s,S.SolveBarrier_s_qca=new s,S.SolveBarrier_s_dv=new s,S.SolveBarrier_s_f=new s,S.SolvePressure_s_f=new s,S.SolveDamping_s_v=new s,S.SolveDamping_s_f=new s,S.SolveRigidDamping_s_t0=new s,S.SolveRigidDamping_s_t1=new s,S.SolveRigidDamping_s_p=new s,S.SolveRigidDamping_s_v=new s,S.SolveExtraDamping_s_v=new s,S.SolveExtraDamping_s_f=new s,S.SolveRigid_s_position=new s,S.SolveRigid_s_rotation=new w,S.SolveRigid_s_transform=new P,S.SolveRigid_s_velocityTransform=new P,S.SolveElastic_s_pa=new s,S.SolveElastic_s_pb=new s,S.SolveElastic_s_pc=new s,S.SolveElastic_s_r=new w,S.SolveElastic_s_t0=new s,S.SolveSpring_s_pa=new s,S.SolveSpring_s_pb=new s,S.SolveSpring_s_d=new s,S.SolveSpring_s_f=new s,S.SolveTensile_s_weightedNormal=new s,S.SolveTensile_s_s=new s,S.SolveTensile_s_f=new s,S.SolveViscous_s_v=new s,S.SolveViscous_s_f=new s,S.SolveRepulsive_s_f=new s,S.SolvePowder_s_f=new s,S.SolveSolid_s_f=new s,S.RemoveSpuriousBodyContacts_s_n=new s,S.RemoveSpuriousBodyContacts_s_pos=new s,S.RemoveSpuriousBodyContacts_s_normal=new s;class ce{constructor(){this._data=null,this.userSuppliedCapacity=0}get data(){return this._data}set data(t){this._data=t}}class qe{constructor(){this.index=$,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}}class Nn{constructor(t,e,i,n,o){this.m_system=t,this.m_xLower=(e&S.xMask)>>>0,this.m_xUpper=(i&S.xMask)>>>0,this.m_yLower=(e&S.yMask)>>>0,this.m_yUpper=(i&S.yMask)>>>0,this.m_first=n,this.m_last=o}GetNext(){for(;this.m_first<this.m_last;){const t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&S.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return $}}class jn{constructor(){this.next=null,this.count=0,this.index=0}}class Gi{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}}class fa{constructor(t,e){this.second=$,this.first=t,this.second=e}}class On extends Gi{Initialize(t,e){}Find(t){return $}}class pa{constructor(t,e){this.first=$,this.second=$,this.first=t,this.second=e}}class Jn extends Gi{Initialize(t,e){}Find(t){return $}}class js{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}}class Xn extends ye{constructor(t,e,i,n){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=n,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t!==this.m_system?!1:(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}}class Un extends js{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}}class Zn extends De{constructor(t,e=t.length){super(m.b2ShapeType.e_unknown,0),this.m_shapeCount=0,this.m_shapes=t,this.m_shapeCount=e}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,n){return 0}RayCast(t,e,i,n){return!1}ComputeAABB(t,e,i){const n=new Dt;t.lowerBound.x=+R,t.lowerBound.y=+R,t.upperBound.x=-R,t.upperBound.y=-R;for(let o=0;o<this.m_shapeCount;o++){const r=this.m_shapes[o].GetChildCount();for(let a=0;a<r;a++){const l=n;this.m_shapes[o].ComputeAABB(l,e,a),t.Combine1(l)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,n){return 0}Dump(t){}}class Hn extends js{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(t){return(this.m_flagsBuffer.data[t]&m.b2ParticleFlag.b2_reactiveParticle)!==0}}class ze extends Ii{constructor(t,e=null){super(t),this.m_contactFilter=null,this.m_contactFilter=e}ShouldCollideFixtureParticle(t,e,i){return this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&m.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,i):!0}ReportFixtureAndParticle(t,e,i){const n=ze.ReportFixtureAndParticle_s_n,o=ze.ReportFixtureAndParticle_s_rp,r=this.m_system.m_positionBuffer.data[i],a=n,l=t.ComputeDistance(r,a,e);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(t,this.m_system,i)){const c=t.GetBody(),_=c.GetWorldCenter(),h=c.GetMass(),u=c.GetInertia()-h*c.GetLocalCenter().LengthSquared(),f=h>0?1/h:0,p=u>0?1/u:0,y=this.m_system.m_flagsBuffer.data[i]&m.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),B=s.SubVV(r,_,o),A=s.CrossVV(B,a),x=y+f+p*A*A,C=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];C.index=i,C.body=c,C.fixture=t,C.weight=1-l*this.m_system.m_inverseDiameter,C.normal.Copy(a.SelfNeg()),C.mass=x>0?1/x:0,this.m_system.DetectStuckParticle(i)}}}ze.ReportFixtureAndParticle_s_n=new s,ze.ReportFixtureAndParticle_s_rp=new s;class Ut extends Ii{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(t,e,i){const n=Ut.ReportFixtureAndParticle_s_p1,o=Ut.ReportFixtureAndParticle_s_output,r=Ut.ReportFixtureAndParticle_s_input,a=Ut.ReportFixtureAndParticle_s_p,l=Ut.ReportFixtureAndParticle_s_v,c=Ut.ReportFixtureAndParticle_s_f,_=t.GetBody(),h=this.m_system.m_positionBuffer.data[i],u=this.m_system.m_velocityBuffer.data[i],f=o,p=r;if(this.m_system.m_iterationIndex===0){const y=P.MulTXV(_.m_xf0,h,n);t.GetShape().GetType()===m.b2ShapeType.e_circleShape&&(y.SelfSub(_.GetLocalCenter()),w.MulRV(_.m_xf0.q,y,y),w.MulTRV(_.m_xf.q,y,y),y.SelfAdd(_.GetLocalCenter())),P.MulXV(_.m_xf,y,p.p1)}else p.p1.Copy(h);if(s.AddVMulSV(h,this.m_step.dt,u,p.p2),p.maxFraction=1,t.RayCast(f,p,e)){const y=f.normal,B=a;B.x=(1-f.fraction)*p.p1.x+f.fraction*p.p2.x+N*y.x,B.y=(1-f.fraction)*p.p1.y+f.fraction*p.p2.y+N*y.y;const A=l;A.x=this.m_step.inv_dt*(B.x-h.x),A.y=this.m_step.inv_dt*(B.y-h.y),this.m_system.m_velocityBuffer.data[i].Copy(A);const x=c;x.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(u.x-A.x),x.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(u.y-A.y),this.m_system.ParticleApplyForce(i,x)}}ReportParticle(t,e){return!1}}Ut.ReportFixtureAndParticle_s_p1=new s,Ut.ReportFixtureAndParticle_s_output=new di,Ut.ReportFixtureAndParticle_s_input=new Is,Ut.ReportFixtureAndParticle_s_p=new s,Ut.ReportFixtureAndParticle_s_v=new s,Ut.ReportFixtureAndParticle_s_f=new s;class Y{constructor(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new wn,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new s,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new gi,this.m_island=new Ft,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new Et(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const r=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(r.joint),this.DestroyJoint(r.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const r=i;i=i.nextController,r.controller.RemoveBody(t)}let n=t.m_contactList;for(;n;){const r=n;n=n.next,this.m_contactManager.Destroy(r.contact)}t.m_contactList=null;let o=t.m_fixtureList;for(;o;){const r=o;o=o.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(r),r.DestroyProxies(),r.Reset(),t.m_fixtureList=o,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(t){switch(t.type){case m.b2JointType.e_distanceJoint:return new ie(t);case m.b2JointType.e_mouseJoint:return new Ve(t);case m.b2JointType.e_prismaticJoint:return new st(t);case m.b2JointType.e_revoluteJoint:return new vt(t);case m.b2JointType.e_pulleyJoint:return new St(t);case m.b2JointType.e_gearJoint:return new pt(t);case m.b2JointType.e_wheelJoint:return new Qt(t);case m.b2JointType.e_weldJoint:return new bt(t);case m.b2JointType.e_frictionJoint:return new ve(t);case m.b2JointType.e_ropeJoint:return new ne(t);case m.b2JointType.e_motorJoint:return new be(t);case m.b2JointType.e_areaJoint:return new Sn(t)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=Y._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,n=e.m_bodyB;if(!e.m_collideConnected){let r=n.GetContactList();for(;r;)r.other===i&&r.contact.FlagForFiltering(),r=r.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,n=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),Y._Joint_Destroy(t),--this.m_jointCount,!n){let o=i.GetContactList();for(;o;)o.other===e&&o.contact.FlagForFiltering(),o=o.next}}CreateParticleSystem(t){if(this.IsLocked())throw new Error;const e=new S(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)}CalculateReasonableParticleIterations(t){if(this.m_particleSystemList===null)return 1;function e(i){let n=R;for(let o=i.GetParticleSystemList();o!==null;o=o.m_next)n=et(n,o.GetRadius());return n}return Pn(this.m_gravity.Length(),e(this),t)}Step(t,e,i,n=this.CalculateReasonableParticleIterations(t)){const o=Y.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;const r=Y.Step_s_step;r.dt=t,r.velocityIterations=e,r.positionIterations=i,r.particleIterations=n,t>0?r.inv_dt=1/t:r.inv_dt=0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;const a=Y.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=a.GetMilliseconds(),this.m_stepComplete&&r.dt>0){const l=Y.Step_s_timer.Reset();for(let c=this.m_particleSystemList;c;c=c.m_next)c.Solve(r);this.Solve(r),this.m_profile.solve=l.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){const l=Y.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=l.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){if(this.m_debugDraw===null)return;const e=t.GetParticleCount();if(e){const i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){const o=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,o,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}DrawDebugData(){if(this.m_debugDraw===null)return;const t=this.m_debugDraw.GetFlags(),e=Y.DrawDebugData_s_color.SetRGB(0,0,0);if(t&m.b2DrawFlags.e_shapeBit)for(let i=this.m_bodyList;i;i=i.m_next){const n=i.m_xf;this.m_debugDraw.PushTransform(n);for(let o=i.GetFixtureList();o;o=o.m_next)i.IsActive()?i.GetType()===m.b2BodyType.b2_staticBody?(e.SetRGB(.5,.9,.5),this.DrawShape(o,e)):i.GetType()===m.b2BodyType.b2_kinematicBody?(e.SetRGB(.5,.5,.9),this.DrawShape(o,e)):i.IsAwake()?(e.SetRGB(.9,.7,.7),this.DrawShape(o,e)):(e.SetRGB(.6,.6,.6),this.DrawShape(o,e)):(e.SetRGB(.5,.5,.3),this.DrawShape(o,e));this.m_debugDraw.PopTransform(n)}if(t&m.b2DrawFlags.e_particleBit)for(let i=this.m_particleSystemList;i;i=i.m_next)this.DrawParticleSystem(i);if(t&m.b2DrawFlags.e_jointBit)for(let i=this.m_jointList;i;i=i.m_next)this.DrawJoint(i);if(t&m.b2DrawFlags.e_aabbBit){e.SetRGB(.9,.3,.9);const i=Y.DrawDebugData_s_vs;for(let n=this.m_bodyList;n;n=n.m_next)if(!!n.IsActive())for(let o=n.GetFixtureList();o;o=o.m_next)for(let r=0;r<o.m_proxyCount;++r){const l=o.m_proxies[r].treeNode.aabb;i[0].Set(l.lowerBound.x,l.lowerBound.y),i[1].Set(l.upperBound.x,l.lowerBound.y),i[2].Set(l.upperBound.x,l.upperBound.y),i[3].Set(l.lowerBound.x,l.upperBound.y),this.m_debugDraw.DrawPolygon(i,4,e)}}if(t&m.b2DrawFlags.e_centerOfMassBit)for(let i=this.m_bodyList;i;i=i.m_next){const n=Y.DrawDebugData_s_xf;n.q.Copy(i.m_xf.q),n.p.Copy(i.GetWorldCenter()),this.m_debugDraw.DrawTransform(n)}if(t&m.b2DrawFlags.e_controllerBit)for(let i=this.m_controllerList;i;i=i.m_next)i.Draw(this.m_debugDraw)}QueryAABB(...t){t[0]instanceof ye?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,n=>{const r=n.userData.fixture;return t?t.ReportFixture(r):i?i(r):!0}),t instanceof ye)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryAABB(t,e)}QueryAllAABB(t,e=[]){return this.QueryAABB(t,i=>(e.push(i),!0)),e}QueryPointAABB(...t){t[0]instanceof ye?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,n=>{const r=n.userData.fixture;return t?t.ReportFixture(r):i?i(r):!0}),t instanceof ye)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,i=>(e.push(i),!0)),e}QueryFixtureShape(...t){t[0]instanceof ye?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,n,o){const r=Y.QueryFixtureShape_s_aabb;if(e.ComputeAABB(r,n,i),this.m_contactManager.m_broadPhase.Query(r,a=>{const l=a.userData,c=l.fixture;if(pi(e,i,c.GetShape(),l.childIndex,n,c.GetBody().GetTransform())){if(t)return t.ReportFixture(c);if(o)return o(c)}return!0}),t instanceof ye)for(let a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.QueryAABB(t,r)}QueryAllFixtureShape(t,e,i,n=[]){return this.QueryFixtureShape(t,e,i,o=>(n.push(o),!0)),n}QueryFixturePoint(...t){t[0]instanceof ye?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,n=>{const r=n.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(i)return i(r)}return!0}),t)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,i=>(e.push(i),!0)),e}RayCast(...t){t[0]instanceof Vn?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,n){const o=Y.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(e),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,(r,a)=>{const l=a.userData,c=l.fixture,_=l.childIndex,h=Y.RayCast_s_output;if(c.RayCast(h,r,_)){const f=h.fraction,p=Y.RayCast_s_point;if(p.Set((1-f)*e.x+f*i.x,(1-f)*e.y+f*i.y),t)return t.ReportFixture(c,p,h.normal,f);if(n)return n(c,p,h.normal,f)}return r.maxFraction}),t)for(let r=this.m_particleSystemList;r;r=r.m_next)t.ShouldQueryParticleSystem(r)&&r.RayCast(t,e,i)}RayCastOne(t,e){let i=null,n=1;return this.RayCast(t,e,(o,r,a,l)=>(l<n&&(n=l,i=o),n)),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,(n,o,r,a)=>(i.push(n),1)),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!s.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(t){if(this.m_locked)return;t(`const g: b2Vec2 = new b2Vec2(%.15f, %.15f);
`,this.m_gravity.x,this.m_gravity.y),t(`this.m_world.SetGravity(g);
`),t(`const bodies: b2Body[] = [];
`),t(`const joints: b2Joint[] = [];
`);let e=0;for(let i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=e,i.Dump(t),++e;e=0;for(let i=this.m_jointList;i;i=i.m_next)i.m_index=e,++e;for(let i=this.m_jointList;i;i=i.m_next)i.m_type!==m.b2JointType.e_gearJoint&&(t(`{
`),i.Dump(t),t(`}
`));for(let i=this.m_jointList;i;i=i.m_next)i.m_type===m.b2JointType.e_gearJoint&&(t(`{
`),i.Dump(t),t(`}
`))}DrawJoint(t){if(this.m_debugDraw===null)return;const e=t.GetBodyA(),i=t.GetBodyB(),n=e.m_xf,o=i.m_xf,r=n.p,a=o.p,l=t.GetAnchorA(Y.DrawJoint_s_p1),c=t.GetAnchorB(Y.DrawJoint_s_p2),_=Y.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(t.m_type){case m.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,c,_);break;case m.b2JointType.e_pulleyJoint:{const h=t,u=h.GetGroundAnchorA(),f=h.GetGroundAnchorB();this.m_debugDraw.DrawSegment(u,l,_),this.m_debugDraw.DrawSegment(f,c,_),this.m_debugDraw.DrawSegment(u,f,_);break}case m.b2JointType.e_mouseJoint:{const h=Y.DrawJoint_s_c;h.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,h),this.m_debugDraw.DrawPoint(c,4,h),h.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,c,h);break}default:this.m_debugDraw.DrawSegment(r,l,_),this.m_debugDraw.DrawSegment(l,c,_),this.m_debugDraw.DrawSegment(a,c,_)}}DrawShape(t,e){if(this.m_debugDraw===null)return;const i=t.GetShape();switch(i.m_type){case m.b2ShapeType.e_circleShape:{const n=i,o=n.m_p,r=n.m_radius,a=s.UNITX;this.m_debugDraw.DrawSolidCircle(o,r,a,e);break}case m.b2ShapeType.e_edgeShape:{const n=i,o=n.m_vertex1,r=n.m_vertex2;this.m_debugDraw.DrawSegment(o,r,e);break}case m.b2ShapeType.e_chainShape:{const n=i,o=n.m_count,r=n.m_vertices,a=Y.DrawShape_s_ghostColor.SetRGBA(.75*e.r,.75*e.g,.75*e.b,e.a);let l=r[0];if(this.m_debugDraw.DrawPoint(l,4,e),n.m_hasPrevVertex){const c=n.m_prevVertex;this.m_debugDraw.DrawSegment(c,l,a),this.m_debugDraw.DrawCircle(c,.1,a)}for(let c=1;c<o;++c){const _=r[c];this.m_debugDraw.DrawSegment(l,_,e),this.m_debugDraw.DrawPoint(_,4,e),l=_}if(n.m_hasNextVertex){const c=n.m_nextVertex;this.m_debugDraw.DrawSegment(c,l,a),this.m_debugDraw.DrawCircle(c,.1,a)}break}case m.b2ShapeType.e_polygonShape:{const n=i,o=n.m_count,r=n.m_vertices;this.m_debugDraw.DrawSolidPolygon(r,o,e);break}}}Solve(t){for(let o=this.m_bodyList;o;o=o.m_next)o.m_xf0.Copy(o.m_xf);for(let o=this.m_controllerList;o;o=o.m_next)o.Step(t);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const e=this.m_island;e.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(let o=this.m_contactManager.m_contactList;o;o=o.m_next)o.m_islandFlag=!1;for(let o=this.m_jointList;o;o=o.m_next)o.m_islandFlag=!1;const i=this.s_stack;for(let o=this.m_bodyList;o;o=o.m_next){if(o.m_islandFlag||!o.IsAwake()||!o.IsActive()||o.GetType()===m.b2BodyType.b2_staticBody)continue;e.Clear();let r=0;for(i[r++]=o,o.m_islandFlag=!0;r>0;){const l=i[--r];if(!l)throw new Error;if(e.AddBody(l),l.m_awakeFlag=!0,l.GetType()!==m.b2BodyType.b2_staticBody){for(let c=l.m_contactList;c;c=c.next){const _=c.contact;if(_.m_islandFlag||!_.IsEnabled()||!_.IsTouching())continue;const h=_.m_fixtureA.m_isSensor,u=_.m_fixtureB.m_isSensor;if(h||u)continue;e.AddContact(_),_.m_islandFlag=!0;const f=c.other;f.m_islandFlag||(i[r++]=f,f.m_islandFlag=!0)}for(let c=l.m_jointList;c;c=c.next){if(c.joint.m_islandFlag)continue;const _=c.other;!_.IsActive()||(e.AddJoint(c.joint),c.joint.m_islandFlag=!0,!_.m_islandFlag&&(i[r++]=_,_.m_islandFlag=!0))}}}const a=new gi;e.Solve(a,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=a.solveInit,this.m_profile.solveVelocity+=a.solveVelocity,this.m_profile.solvePosition+=a.solvePosition;for(let l=0;l<e.m_bodyCount;++l){const c=e.m_bodies[l];c.GetType()===m.b2BodyType.b2_staticBody&&(c.m_islandFlag=!1)}}for(let o=0;o<i.length&&i[o];++o)i[o]=null;const n=new Xe;for(let o=this.m_bodyList;o;o=o.m_next)!o.m_islandFlag||o.GetType()!==m.b2BodyType.b2_staticBody&&o.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=n.GetMilliseconds()}SolveTOI(t){const e=this.m_island;if(e.Initialize(2*Ht,Ht,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let i=this.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1,i.m_sweep.alpha0=0;for(let i=this.m_contactManager.m_contactList;i;i=i.m_next)i.m_toiFlag=!1,i.m_islandFlag=!1,i.m_toiCount=0,i.m_toi=1}for(;;){let i=null,n=1;for(let u=this.m_contactManager.m_contactList;u;u=u.m_next){if(!u.IsEnabled()||u.m_toiCount>Jt)continue;let f=1;if(u.m_toiFlag)f=u.m_toi;else{const p=u.GetFixtureA(),y=u.GetFixtureB();if(p.IsSensor()||y.IsSensor())continue;const B=p.GetBody(),A=y.GetBody(),x=B.m_type,C=A.m_type,v=B.IsAwake()&&x!==m.b2BodyType.b2_staticBody,M=A.IsAwake()&&C!==m.b2BodyType.b2_staticBody;if(!v&&!M)continue;const G=B.IsBullet()||x!==m.b2BodyType.b2_dynamicBody,I=A.IsBullet()||C!==m.b2BodyType.b2_dynamicBody;if(!G&&!I)continue;let T=B.m_sweep.alpha0;B.m_sweep.alpha0<A.m_sweep.alpha0?(T=A.m_sweep.alpha0,B.m_sweep.Advance(T)):A.m_sweep.alpha0<B.m_sweep.alpha0&&(T=B.m_sweep.alpha0,A.m_sweep.Advance(T));const F=u.GetChildIndexA(),q=u.GetChildIndexB(),J=Y.SolveTOI_s_toi_input;J.proxyA.SetShape(p.GetShape(),F),J.proxyB.SetShape(y.GetShape(),q),J.sweepA.Copy(B.m_sweep),J.sweepB.Copy(A.m_sweep),J.tMax=1;const L=Y.SolveTOI_s_toi_output;Ai(L,J);const D=L.t;L.state===m.b2TOIOutputState.e_touching?f=et(T+(1-T)*D,1):f=1,u.m_toi=f,u.m_toiFlag=!0}f<n&&(i=u,n=f)}if(i===null||1-10*E<n){this.m_stepComplete=!0;break}const o=i.GetFixtureA(),r=i.GetFixtureB(),a=o.GetBody(),l=r.GetBody(),c=Y.SolveTOI_s_backup1.Copy(a.m_sweep),_=Y.SolveTOI_s_backup2.Copy(l.m_sweep);if(a.Advance(n),l.Advance(n),i.Update(this.m_contactManager.m_contactListener),i.m_toiFlag=!1,++i.m_toiCount,!i.IsEnabled()||!i.IsTouching()){i.SetEnabled(!1),a.m_sweep.Copy(c),l.m_sweep.Copy(_),a.SynchronizeTransform(),l.SynchronizeTransform();continue}a.SetAwake(!0),l.SetAwake(!0),e.Clear(),e.AddBody(a),e.AddBody(l),e.AddContact(i),a.m_islandFlag=!0,l.m_islandFlag=!0,i.m_islandFlag=!0;for(let u=0;u<2;++u){const f=u===0?a:l;if(f.m_type===m.b2BodyType.b2_dynamicBody)for(let p=f.m_contactList;p&&!(e.m_bodyCount===e.m_bodyCapacity||e.m_contactCount===e.m_contactCapacity);p=p.next){const y=p.contact;if(y.m_islandFlag)continue;const B=p.other;if(B.m_type===m.b2BodyType.b2_dynamicBody&&!f.IsBullet()&&!B.IsBullet())continue;const A=y.m_fixtureA.m_isSensor,x=y.m_fixtureB.m_isSensor;if(A||x)continue;const C=Y.SolveTOI_s_backup.Copy(B.m_sweep);if(B.m_islandFlag||B.Advance(n),y.Update(this.m_contactManager.m_contactListener),!y.IsEnabled()){B.m_sweep.Copy(C),B.SynchronizeTransform();continue}if(!y.IsTouching()){B.m_sweep.Copy(C),B.SynchronizeTransform();continue}y.m_islandFlag=!0,e.AddContact(y),!B.m_islandFlag&&(B.m_islandFlag=!0,B.m_type!==m.b2BodyType.b2_staticBody&&B.SetAwake(!0),e.AddBody(B))}}const h=Y.SolveTOI_s_subStep;h.dt=(1-n)*t.dt,h.inv_dt=1/h.dt,h.dtRatio=1,h.positionIterations=20,h.velocityIterations=t.velocityIterations,h.particleIterations=t.particleIterations,h.warmStarting=!1,e.SolveTOI(h,a.m_islandIndex,l.m_islandIndex);for(let u=0;u<e.m_bodyCount;++u){const f=e.m_bodies[u];if(f.m_islandFlag=!1,f.m_type===m.b2BodyType.b2_dynamicBody){f.SynchronizeFixtures();for(let p=f.m_contactList;p;p=p.next)p.contact.m_toiFlag=!1,p.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t}}Y.Step_s_step=new Re,Y.Step_s_stepTimer=new Xe,Y.Step_s_timer=new Xe,Y.DrawDebugData_s_color=new dt(0,0,0),Y.DrawDebugData_s_vs=s.MakeArray(4),Y.DrawDebugData_s_xf=new P,Y.QueryFixtureShape_s_aabb=new Dt,Y.RayCast_s_input=new Is,Y.RayCast_s_output=new di,Y.RayCast_s_point=new s,Y.DrawJoint_s_p1=new s,Y.DrawJoint_s_p2=new s,Y.DrawJoint_s_color=new dt(.5,.8,.8),Y.DrawJoint_s_c=new dt,Y.DrawShape_s_ghostColor=new dt,Y.SolveTOI_s_subStep=new Re,Y.SolveTOI_s_backup=new $t,Y.SolveTOI_s_backup1=new $t,Y.SolveTOI_s_backup2=new $t,Y.SolveTOI_s_toi_input=new yi,Y.SolveTOI_s_toi_output=new Bi;class Qn{constructor(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e}}class He{constructor(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}GetNext(){return this.m_next}GetPrev(){return this.m_prev}GetBodyList(){return this.m_bodyList}AddBody(t){const e=new Qn(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount}RemoveBody(t){if(this.m_bodyCount<=0)throw new Error;let e=this.m_bodyList;for(;e&&e.body!==t;)e=e.nextBody;if(e===null)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount}Clear(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0}}class ya extends He{constructor(){super(...arguments),this.normal=new s(0,1),this.offset=0,this.density=0,this.velocity=new s(0,0),this.linearDrag=0,this.angularDrag=0,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=new s(0,0)}Step(t){if(!!this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body;if(!i.IsAwake())continue;const n=new s,o=new s;let r=0,a=0;for(let _=i.GetFixtureList();_;_=_.m_next){const h=new s,u=_.GetShape().ComputeSubmergedArea(this.normal,this.offset,i.GetTransform(),h);r+=u,n.x+=u*h.x,n.y+=u*h.y;let f=0;this.useDensity?f=_.GetDensity():f=1,a+=u*f,o.x+=u*h.x*f,o.y+=u*h.y*f}if(n.x/=r,n.y/=r,o.x/=a,o.y/=a,r<E)continue;const l=this.gravity.Clone().SelfNeg();l.SelfMul(this.density*r),i.ApplyForce(l,o);const c=i.GetLinearVelocityFromWorldPoint(n,new s);c.SelfSub(this.velocity),c.SelfMul(-this.linearDrag*r),i.ApplyForce(c,n),i.ApplyTorque(-i.GetInertia()/i.GetMass()*r*i.GetAngularVelocity()*this.angularDrag)}}}Draw(t){const i=new s,n=new s;i.x=this.normal.x*this.offset+this.normal.y*100,i.y=this.normal.y*this.offset-this.normal.x*100,n.x=this.normal.x*this.offset-this.normal.y*100,n.y=this.normal.y*this.offset+this.normal.x*100;const o=new dt(0,0,.8);t.DrawSegment(i,n,o)}}class Os extends He{constructor(){super(...arguments),this.A=new s(0,0)}Step(t){const e=s.MulSV(t.dt,this.A,Os.Step_s_dtA);for(let i=this.m_bodyList;i;i=i.nextBody){const n=i.body;!n.IsAwake()||n.SetLinearVelocity(s.AddVV(n.GetLinearVelocity(),e,s.s_t0))}}Draw(t){}}Os.Step_s_dtA=new s;class Ba extends He{constructor(){super(...arguments),this.F=new s(0,0)}Step(t){for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body;!i.IsAwake()||i.ApplyForce(this.F,i.GetWorldCenter())}}Draw(t){}}class us extends He{constructor(){super(...arguments),this.G=1,this.invSqr=!0}Step(t){if(this.invSqr)for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body,n=i.GetWorldCenter(),o=i.GetMass();for(let r=this.m_bodyList;r&&r!==e;r=r.nextBody){const a=r.body,l=a.GetWorldCenter(),c=a.GetMass(),_=l.x-n.x,h=l.y-n.y,u=_*_+h*h;if(u<E)continue;const f=us.Step_s_f.Set(_,h);f.SelfMul(this.G/u/pe(u)*o*c),i.IsAwake()&&i.ApplyForce(f,n),a.IsAwake()&&a.ApplyForce(f.SelfMul(-1),l)}}else for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body,n=i.GetWorldCenter(),o=i.GetMass();for(let r=this.m_bodyList;r&&r!==e;r=r.nextBody){const a=r.body,l=a.GetWorldCenter(),c=a.GetMass(),_=l.x-n.x,h=l.y-n.y,u=_*_+h*h;if(u<E)continue;const f=us.Step_s_f.Set(_,h);f.SelfMul(this.G/u*o*c),i.IsAwake()&&i.ApplyForce(f,n),a.IsAwake()&&a.ApplyForce(f.SelfMul(-1),l)}}}Draw(t){}}us.Step_s_f=new s;class Js extends He{constructor(){super(...arguments),this.T=new ft,this.maxTimestep=0}Step(t){let e=t.dt;if(!(e<=E)){e>this.maxTimestep&&this.maxTimestep>0&&(e=this.maxTimestep);for(let i=this.m_bodyList;i;i=i.nextBody){const n=i.body;if(!n.IsAwake())continue;const o=n.GetWorldVector(ft.MulMV(this.T,n.GetLocalVector(n.GetLinearVelocity(),s.s_t0),s.s_t1),Js.Step_s_damping);n.SetLinearVelocity(s.AddVV(n.GetLinearVelocity(),s.MulSV(e,o,s.s_t0),s.s_t1))}}}Draw(t){}SetAxisAligned(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,t>0||e>0?this.maxTimestep=1/W(t,e):this.maxTimestep=0}}Js.Step_s_damping=new s;class Aa{constructor(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new s(0,0),this.damping=.1,this.k2=.9,this.k3=.1}}class jt{constructor(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new s,this.m_damping=0,this.m_k2=1,this.m_k3=.1}GetVertexCount(){return this.m_count}GetVertices(){return this.m_ps}Initialize(t){this.m_count=t.count,this.m_ps=s.MakeArray(this.m_count),this.m_p0s=s.MakeArray(this.m_count),this.m_vs=s.MakeArray(this.m_count),this.m_ims=ge(this.m_count);for(let n=0;n<this.m_count;++n){this.m_ps[n].Copy(t.vertices[n]),this.m_p0s[n].Copy(t.vertices[n]),this.m_vs[n].SetZero();const o=t.masses[n];o>0?this.m_ims[n]=1/o:this.m_ims[n]=0}const e=this.m_count-1,i=this.m_count-2;this.m_Ls=ge(e),this.m_as=ge(i);for(let n=0;n<e;++n){const o=this.m_ps[n],r=this.m_ps[n+1];this.m_Ls[n]=s.DistanceVV(o,r)}for(let n=0;n<i;++n){const o=this.m_ps[n],r=this.m_ps[n+1],a=this.m_ps[n+2],l=s.SubVV(r,o,s.s_t0),c=s.SubVV(a,r,s.s_t1),_=s.CrossVV(l,c),h=s.DotVV(l,c);this.m_as[n]=mi(_,h)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3}Step(t,e){if(t===0)return;const i=Math.exp(-t*this.m_damping);for(let o=0;o<this.m_count;++o)this.m_p0s[o].Copy(this.m_ps[o]),this.m_ims[o]>0&&this.m_vs[o].SelfMulAdd(t,this.m_gravity),this.m_vs[o].SelfMul(i),this.m_ps[o].SelfMulAdd(t,this.m_vs[o]);for(let o=0;o<e;++o)this.SolveC2(),this.SolveC3(),this.SolveC2();const n=1/t;for(let o=0;o<this.m_count;++o)s.MulSV(n,s.SubVV(this.m_ps[o],this.m_p0s[o],s.s_t0),this.m_vs[o])}SolveC2(){const t=this.m_count-1;for(let e=0;e<t;++e){const i=this.m_ps[e],n=this.m_ps[e+1],o=s.SubVV(n,i,jt.s_d),r=o.Normalize(),a=this.m_ims[e],l=this.m_ims[e+1];if(a+l===0)continue;const c=a/(a+l),_=l/(a+l);i.SelfMulSub(this.m_k2*c*(this.m_Ls[e]-r),o),n.SelfMulAdd(this.m_k2*_*(this.m_Ls[e]-r),o)}}SetAngle(t){const e=this.m_count-2;for(let i=0;i<e;++i)this.m_as[i]=t}SolveC3(){const t=this.m_count-2;for(let e=0;e<t;++e){const i=this.m_ps[e],n=this.m_ps[e+1],o=this.m_ps[e+2],r=this.m_ims[e],a=this.m_ims[e+1],l=this.m_ims[e+2],c=s.SubVV(n,i,jt.s_d1),_=s.SubVV(o,n,jt.s_d2),h=c.LengthSquared(),u=_.LengthSquared();if(h*u===0)continue;const f=s.CrossVV(c,_),p=s.DotVV(c,_);let y=mi(f,p);const B=s.MulSV(-1/h,c.SelfSkew(),jt.s_Jd1),A=s.MulSV(1/u,_.SelfSkew(),jt.s_Jd2),x=s.NegV(B,jt.s_J1),C=s.SubVV(B,A,jt.s_J2),v=A;let M=r*s.DotVV(x,x)+a*s.DotVV(C,C)+l*s.DotVV(v,v);if(M===0)continue;M=1/M;let G=y-this.m_as[e];for(;G>k;)y-=2*k,G=y-this.m_as[e];for(;G<-k;)y+=2*k,G=y-this.m_as[e];const I=-this.m_k3*M*G;i.SelfMulAdd(r*I,x),n.SelfMulAdd(a*I,C),o.SelfMulAdd(l*I,v)}}Draw(t){const e=new dt(.4,.5,.7);for(let i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)}}jt.s_d=new s,jt.s_d1=new s,jt.s_d2=new s,jt.s_Jd1=new s,jt.s_Jd2=new s,jt.s_J1=new s,jt.s_J2=new s,m.b2AABB=Dt,m.b2Abs=ht,m.b2Acos=vo,m.b2Alloc=gs,m.b2AreaJoint=Sn,m.b2AreaJointDef=Kr,m.b2Asin=tn,m.b2Assert=j,m.b2Atan2=mi,m.b2BlockAllocator=Go,m.b2Body=Et,m.b2BodyDef=Wr,m.b2BroadPhase=ln,m.b2BuoyancyController=ya,m.b2CalculateParticleIterations=Pn,m.b2ChainAndCircleContact=Le,m.b2ChainAndPolygonContact=Te,m.b2ChainShape=ue,m.b2CircleContact=is,m.b2CircleShape=zt,m.b2Clamp=Vt,m.b2ClipSegmentToLine=ss,m.b2ClipVertex=xe,m.b2CollideCircles=un,m.b2CollideEdgeAndCircle=Si,m.b2CollideEdgeAndPolygon=Ci,m.b2CollidePolygonAndCircle=dn,m.b2CollidePolygons=pn,m.b2Color=dt,m.b2ConstantAccelController=Os,m.b2ConstantForceController=Ba,m.b2Contact=oe,m.b2ContactEdge=wi,m.b2ContactFactory=vn,m.b2ContactFeature=on,m.b2ContactFilter=Rs,m.b2ContactID=Ue,m.b2ContactImpulse=bn,m.b2ContactListener=ks,m.b2ContactManager=wn,m.b2ContactPositionConstraint=cs,m.b2ContactRegister=Cn,m.b2ContactSolver=O,m.b2ContactSolverDef=Mn,m.b2ContactVelocityConstraint=hs,m.b2Controller=He,m.b2ControllerEdge=Qn,m.b2Cos=So,m.b2Counter=Io,m.b2DegToRad=Ao,m.b2DestructionListener=ha,m.b2Distance=ui,m.b2DistanceInput=ci,m.b2DistanceJoint=ie,m.b2DistanceJointDef=xn,m.b2DistanceOutput=_i,m.b2DistanceProxy=Ge,m.b2Draw=Po,m.b2DynamicTree=lt,m.b2EdgeAndCircleContact=rs,m.b2EdgeAndPolygonContact=as,m.b2EdgeShape=ot,m.b2Filter=Me,m.b2Fixture=An,m.b2FixtureDef=Bn,m.b2FixtureParticleQueryCallback=Ii,m.b2FixtureProxy=Fe,m.b2Free=oi,m.b2FrictionJoint=ve,m.b2FrictionJointDef=$r,m.b2GearJoint=pt,m.b2GearJointDef=ta,m.b2GetPointStates=Yo,m.b2GravityController=us,m.b2GrowableBuffer=ke,m.b2GrowableStack=en,m.b2InvSqrt=li,m.b2IsPowerOfTwo=Vo,m.b2IsValid=Bo,m.b2Island=Ft,m.b2Jacobian=Yr,m.b2Joint=se,m.b2JointDef=ee,m.b2JointEdge=vi,m.b2Log=ri,m.b2MakeArray=Xt,m.b2MakeNullArray=po,m.b2MakeNumberArray=ge,m.b2Manifold=es,m.b2ManifoldPoint=Ps,m.b2MassData=Ts,m.b2Mat22=ft,m.b2Mat33=me,m.b2Max=W,m.b2Maybe=b,m.b2Min=et,m.b2MixFriction=bi,m.b2MixRestitution=Vi,m.b2MotorJoint=be,m.b2MotorJointDef=ea,m.b2MouseJoint=Ve,m.b2MouseJointDef=sa,m.b2NextPowerOfTwo=bo,m.b2Pair=an,m.b2PairLessThan=mn,m.b2ParseInt=uo,m.b2ParseUInt=fo,m.b2ParticleBodyContact=qn,m.b2ParticleContact=kn,m.b2ParticleDef=Pi,m.b2ParticleGroup=_s,m.b2ParticleGroupDef=Gn,m.b2ParticleHandle=In,m.b2ParticlePair=zn,m.b2ParticlePairSet=Jn,m.b2ParticleSystem=S,m.b2ParticleSystemDef=Ns,m.b2ParticleSystem_CompositeShape=Zn,m.b2ParticleSystem_ConnectionFilter=js,m.b2ParticleSystem_DestroyParticlesInShapeCallback=Xn,m.b2ParticleSystem_FixedSetAllocator=Gi,m.b2ParticleSystem_FixtureParticle=fa,m.b2ParticleSystem_FixtureParticleSet=On,m.b2ParticleSystem_InsideBoundsEnumerator=Nn,m.b2ParticleSystem_JoinParticleGroupsFilter=Un,m.b2ParticleSystem_ParticleListNode=jn,m.b2ParticleSystem_ParticlePair=pa,m.b2ParticleSystem_Proxy=qe,m.b2ParticleSystem_ReactiveFilter=Hn,m.b2ParticleSystem_SolveCollisionCallback=Ut,m.b2ParticleSystem_UpdateBodyContactsCallback=ze,m.b2ParticleSystem_UserOverridableBuffer=ce,m.b2ParticleTriad=En,m.b2PolygonAndCircleContact=os,m.b2PolygonContact=ns,m.b2PolygonShape=Q,m.b2Position=ls,m.b2PositionSolverManifold=he,m.b2Pow=$i,m.b2PrismaticJoint=st,m.b2PrismaticJointDef=ia,m.b2Profile=gi,m.b2PulleyJoint=St,m.b2PulleyJointDef=oa,m.b2QueryCallback=ye,m.b2RadToDeg=xo,m.b2Random=wo,m.b2RandomRange=go,m.b2RayCastCallback=Vn,m.b2RayCastInput=Is,m.b2RayCastOutput=di,m.b2RevoluteJoint=vt,m.b2RevoluteJointDef=ra,m.b2Rope=jt,m.b2RopeDef=Aa,m.b2RopeJoint=ne,m.b2RopeJointDef=aa,m.b2Rot=w,m.b2SeparationFunction=_n,m.b2Shape=De,m.b2ShapeCast=Wo,m.b2ShapeCastInput=Fo,m.b2ShapeCastOutput=Lo,m.b2Simplex=_e,m.b2SimplexCache=hi,m.b2SimplexVertex=Ms,m.b2Sin=Co,m.b2SolverData=gn,m.b2Sq=Je,m.b2Sqrt=pe,m.b2StackAllocator=Do,m.b2Swap=yo,m.b2Sweep=$t,m.b2TOIInput=yi,m.b2TOIOutput=Bi,m.b2TensorDampingController=Js,m.b2TestOverlapAABB=fi,m.b2TestOverlapShape=pi,m.b2TimeOfImpact=Ai,m.b2TimeStep=Re,m.b2Timer=Xe,m.b2Transform=P,m.b2TreeNode=rn,m.b2Vec2=s,m.b2Vec2_zero=Mo,m.b2Vec3=Ct,m.b2Velocity=ms,m.b2VelocityConstraintPoint=qs,m.b2Version=Oe,m.b2WeldJoint=bt,m.b2WeldJointDef=la,m.b2WheelJoint=Qt,m.b2WheelJointDef=ma,m.b2World=Y,m.b2WorldManifold=wt,m.b2_180_over_pi=Ki,m.b2_aabbExtension=rt,m.b2_aabbMultiplier=ut,m.b2_angularSleepTolerance=ws,m.b2_angularSlop=Bt,m.b2_barrierCollisionTime=je,m.b2_baumgarte=K,m.b2_branch=co,m.b2_commit=_o,m.b2_epsilon=E,m.b2_epsilon_sq=it,m.b2_gjk_reset=To,m.b2_invalidParticleIndex=$,m.b2_linearSleepTolerance=$e,m.b2_linearSlop=N,m.b2_maxAngularCorrection=It,m.b2_maxFloat=R,m.b2_maxLinearCorrection=nt,m.b2_maxManifoldPoints=z,m.b2_maxParticleForce=Pe,m.b2_maxParticleIndex=Gt,m.b2_maxParticlePressure=fe,m.b2_maxPolygonVertices=mt,m.b2_maxRotation=at,m.b2_maxRotationSquared=qt,m.b2_maxSubSteps=Jt,m.b2_maxTOIContacts=Ht,m.b2_maxTranslation=ae,m.b2_maxTranslationSquared=Ae,m.b2_maxTriadDistance=Ie,m.b2_maxTriadDistanceSquared=Ke,m.b2_minParticleSystemBufferCapacity=Ne,m.b2_minParticleWeight=le,m.b2_minPulleyLength=na,m.b2_particleStride=Kt,m.b2_pi=k,m.b2_pi_over_180=Yi,m.b2_polygonRadius=At,m.b2_timeToSleep=we,m.b2_toiBaumgarte=H,m.b2_toi_reset=nr,m.b2_two_pi=ai,m.b2_velocityThreshold=xt,m.b2_version=ts,m.g_blockSolve=Mi,Object.defineProperty(m,"__esModule",{value:!0})})})(Pt,Pt.exports);function ki(){const V=new Pt.exports.b2Vec2(0,-Bs),g=new Pt.exports.b2World(V),m=new Pt.exports.b2BodyDef;m.position.Set(0,-xs/2),m.userData={kind:"GROUND"};const j=g.CreateBody(m),b=new Pt.exports.b2PolygonShape;b.SetAsBox(ii*5,xs/2),j.CreateFixture(b,0);const R=new Pt.exports.b2BodyDef;R.position.Set(0,Xi/2);const E=g.CreateBody(R),it=new Pt.exports.b2PolygonShape;it.SetAsBox(ni/2,Xi/2);const k=new Pt.exports.b2FixtureDef;k.shape=it,k.restitution=ao,k.friction=ao,E.CreateFixture(k);const z=new Pt.exports.b2BodyDef;z.type=Pt.exports.b2BodyType.b2_dynamicBody,z.position.Set(Ss.x,Ss.y),z.userData={kind:"BALL"},z.linearDamping=za;let mt=g.CreateBody(z);const rt=new Pt.exports.b2CircleShape;rt.Set({x:0,y:0},Wi);const ut=new Pt.exports.b2FixtureDef;return ut.shape=rt,ut.density=1,ut.restitution=Ji,ut.friction=Ji,mt.CreateFixture(ut),{world:g,ball:mt}}function qi(V,g){const m=new Pt.exports.b2BodyDef;m.type=Pt.exports.b2BodyType.b2_kinematicBody;const j=g==0?-bs:bs;m.position.Set(j,0),m.userData={kind:"PLAYER",playerIndex:g};const b=V.CreateBody(m),R=new Pt.exports.b2ChainShape,E=[];for(let k=0;k<ro;k++){const z=Math.PI*(1-k/(ro-1));E.push({x:Math.cos(z)*Ee,y:Math.sin(z)*Ee})}R.CreateLoop(E);const it=new Pt.exports.b2FixtureDef;return it.shape=R,it.density=1,it.restitution=Ji,b.CreateFixture(it),b}function zi(V){const g=[V.m_fixtureA.m_body,V.m_fixtureB.m_body],m=g.find(R=>{var E;return((E=R.m_userData)==null?void 0:E.kind)=="PLAYER"}),j=g.find(R=>{var E;return((E=R.m_userData)==null?void 0:E.kind)=="BALL"}),b=g.find(R=>{var E;return((E=R.m_userData)==null?void 0:E.kind)=="GROUND"});return{player:m,ball:j,ground:b}}class Na{constructor(g){Hs(this,"position");Hs(this,"velocity");Hs(this,"angularVelocity");this.position=g.GetPosition().Clone(),this.velocity=g.GetLinearVelocity(),this.angularVelocity=g.GetAngularVelocity()}apply(g){g.SetPosition(this.position),g.SetLinearVelocity(this.velocity),g.SetAngularVelocity(this.angularVelocity)}}function ja(V){let g,m,j,b,R,E,it,k,z,mt,rt,ut,N=V[0][0]+"",Bt,At,Jt=V[0][1]+"",Ht,xt=`${ps}px`,nt=`${no}px`,It,ae,Ae;return j=new io({props:{color:"red",radius:Ee,eyeAngle:V[5](V[2],0),x:V[2][0].GetPosition().x,y:V[2][0].GetPosition().y}}),b=new io({props:{color:"blue",radius:Ee,eyeAngle:V[5](V[2],1),x:V[2][1].GetPosition().x,y:V[2][1].GetPosition().y}}),{c(){g=Nt("svg"),m=Nt("g"),Oi(j.$$.fragment),Oi(b.$$.fragment),R=Nt("circle"),k=Nt("rect"),z=Nt("rect"),mt=Nt("style"),rt=Li(`.score {
      font: bold 30px sans-serif;
    }
  `),ut=Nt("text"),Bt=Li(N),At=Nt("text"),Ht=Li(Jt),X(R,"fill","yellow"),X(R,"cx",E=V[1].GetPosition().x),X(R,"cy",it=V[1].GetPosition().y),X(R,"r",Wi),X(k,"fill","gray"),X(k,"width",ni),X(k,"height",Xi),X(k,"x",-ni/2),X(k,"y","0"),X(z,"fill","gray"),X(z,"width",si),X(z,"height",xs),X(z,"x",-si/2),X(z,"y",-xs),X(m,"transform",`
      translate(`+ps/2+" "+no+`)
      scale(`+ps/ii+" "+-ps/ii+`)
      translate(0 `+xs+`)
    `),X(ut,"x",Ws),X(ut,"y",Ws),X(ut,"fill","red"),X(ut,"class","score"),X(At,"x",ps-Ws),X(At,"y",Ws),X(At,"fill","blue"),X(At,"class","score"),X(g,"class","game"),Ti(g,"width",xt,!1),Ti(g,"height",nt,!1),Ti(g,"marginLeft","10px",!1)},m(at,qt){mo(at,g,qt),kt(g,m),ti(j,m,null),ti(b,m,null),kt(m,R),kt(m,k),kt(m,z),kt(g,mt),kt(mt,rt),kt(g,ut),kt(ut,Bt),kt(g,At),kt(At,Ht),It=!0,ae||(Ae=[$n(window,"keydown",V[4]),$n(window,"keyup",V[3])],ae=!0)},p(at,[qt]){const K={};qt&4&&(K.eyeAngle=at[5](at[2],0)),qt&4&&(K.x=at[2][0].GetPosition().x),qt&4&&(K.y=at[2][0].GetPosition().y),j.$set(K);const H={};qt&4&&(H.eyeAngle=at[5](at[2],1)),qt&4&&(H.x=at[2][1].GetPosition().x),qt&4&&(H.y=at[2][1].GetPosition().y),b.$set(H),(!It||qt&2&&E!==(E=at[1].GetPosition().x))&&X(R,"cx",E),(!It||qt&2&&it!==(it=at[1].GetPosition().y))&&X(R,"cy",it),(!It||qt&1)&&N!==(N=at[0][0]+"")&&to(Bt,N),(!It||qt&1)&&Jt!==(Jt=at[0][1]+"")&&to(Ht,Jt)},i(at){It||($s(j.$$.fragment,at),$s(b.$$.fragment,at),It=!0)},o(at){ji(j.$$.fragment,at),ji(b.$$.fragment,at),It=!1},d(at){at&&Zi(g),ei(j),ei(b),ae=!1,Vs(Ae)}}}function Oa(V){for(let g=V.length-1;g>0;g--){const m=Math.floor(Math.random()*(g+1));[V[g],V[m]]=[V[m],V[g]]}}function Ja(V,g,m){const j=Math.sqrt(2*Bs*qa),b=[{jump:!1,dir:0},{jump:!1,dir:0}];let R=[0,0],E=0,it=Math.round(Math.random()),{world:k,ball:z}=ki(),mt=[qi(k,0),qi(k,1)],rt;const ut=ki(),N=Yn({player:qi(ut.world,0)},ki());N.world.SetContactListener(new class extends Pt.exports.b2ContactListener{BeginContact(K){const{ball:H,ground:$}=zi(K);H&&$&&(rt=H.GetPosition().Clone())}});function Bt(){const K=z.GetPosition().x>0?1:0,$=Math.abs(z.GetPosition().x)>si/2?1-E:1-K;m(0,R[$]++,R),it=1-$}function At(){new Na(z).apply(N.ball),N.player.SetPositionXY(3*ii,0);let H=0,$,Gt;for(rt=void 0;!rt;){if(H++,H*Yt.timeStep>10)throw new Error("ball did not reach ground in 10 seconds");N.world.Step(Yt.timeStep,Yt.velocityIterations,Yt.positionIterations),!$&&N.ball.GetPosition().y<Ee+Wi&&($={pos:N.ball.GetPosition().Clone(),steps:H})}if(!$)throw new Error("ball reach ground without ever reaching reachable height ??");Gt={pos:rt,steps:H};const Kt=new Pt.exports.b2Vec2($.pos.x,$.pos.y).SelfSub(Gt.pos),le=Math.ceil(j/Bs/Yt.timeStep),fe=Kt.y/Kt.Length(),Pe=Math.abs(Ee/fe),Ie=1/oo/Yt.timeStep,Ke=Pe*Ie,Ne=Math.ceil(-mt[0].GetPosition().x*Ie);let je=[];for(let we=0;we<=le;we++){const $e=j*we*Yt.timeStep-Bs*Math.pow(we*Yt.timeStep,2)/2,gs=(Gt.pos.x+$e/$.pos.y*($.pos.x-Gt.pos.x)-mt[0].GetPosition().x)*Ie,oi=Math.max(-H,Math.floor(gs-Ke)),ri=Math.min(H,Math.ceil(gs+Ke),Ne);for(let Oe=oi;Oe<=ri;Oe++)for(let ts=-1;ts<=1;ts++)je.push({stepsGoingRight:Oe,lastStep:ts,stepsJumping:we})}Oa(je),console.log(je.slice(0,ka))}k.SetContactListener(new class extends Pt.exports.b2ContactListener{BeginContact(K){const{player:H,ball:$,ground:Gt}=zi(K);H&&$&&(E=H.m_userData.playerIndex),$&&Gt&&Bt()}EndContact(K){const{player:H,ball:$,ground:Gt}=zi(K);$&&At()}});const Jt=function(K){E=K,mt[0].SetPositionXY(-bs,0),mt[1].SetPositionXY(bs,0),z.SetAngularVelocity(0),z.SetLinearVelocity({x:0,y:Ss.vy}),z.SetPositionXY((K?1:-1)*Ss.x,Ss.y),nt=!1},Ht=function(K){for(let H=0;H<2;H++)K.key==Ye[H].jump&&(b[H].jump=!1),(K.key==Ye[H].left||K.key==Ye[H].right)&&(b[H].dir=0)},xt=function(K){for(let H=0;H<2;H++)K.key==Ye[H].jump&&(b[H].jump=!0),K.key==Ye[H].left&&(b[H].dir=-1),K.key==Ye[H].right&&(b[H].dir=1);K.key=="r"&&(m(0,R=[0,0]),Jt(Math.round(Math.random()))),K.key=="p"&&(nt=!nt)};let nt=!1,It=performance.now()/1e3;const ae=Ee+ni/2;function Ae(K){const H=mt[K],$=K==0?-1:1;let Gt,Kt,le=null,fe=null;if(H.GetPosition().x*$<ae?(Gt=0,le=ae*$):Gt=b[K].dir*oo,H.GetPosition().y<0&&(fe=0),H.GetPosition().y<=0?Kt=b[K].jump?j:0:Kt=H.GetLinearVelocity().y-Yt.timeStep*Bs,le!==null||fe!==null){const Pe=H.GetPosition();H.SetPosition({x:le!==null?le:Pe.x,y:fe!==null?fe:Pe.y})}H.SetLinearVelocity({x:Gt,y:Kt})}function at(){const K=Math.floor((performance.now()/1e3-It)/Yt.timeStep);It+=K*Yt.timeStep;for(let H=0;H<K;H++)Ae(0),Ae(1),k.Step(Yt.timeStep,Yt.velocityIterations,Yt.positionIterations),m(1,z),m(2,mt)}return Pa(async()=>{let K=requestAnimationFrame(function H(){nt?It=performance.now()/1e3:(it!==null&&(Jt(it),it=null),at()),K=requestAnimationFrame(H)});return()=>cancelAnimationFrame(K)}),[R,z,mt,Ht,xt,(K,H)=>{const $=K[H].GetPosition(),Gt=z.GetPosition(),Kt=$.x==Gt.x?270:180/Math.PI*Math.atan(-($.y-Gt.y)/($.x-Gt.x)),le=Gt.x<$.x?180:0;return 360+le-Kt}]}class Xa extends Qi{constructor(g){super(),Hi(this,g,Ja,ja,Ui,{})}}function Ua(V){let g,m;return g=new Xa({}),{c(){Oi(g.$$.fragment)},m(j,b){ti(g,j,b),m=!0},p:Cs,i(j){m||($s(g.$$.fragment,j),m=!0)},o(j){ji(g.$$.fragment,j),m=!1},d(j){ei(g,j)}}}class Za extends Qi{constructor(g){super(),Hi(this,g,null,Ua,Ui,{})}}new Za({target:document.getElementById("app")});
