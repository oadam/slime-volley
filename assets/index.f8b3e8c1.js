const aa=function(){const D=document.createElement("link").relList;if(D&&D.supports&&D.supports("modulepreload"))return;for(const b of document.querySelectorAll('link[rel="modulepreload"]'))U(b);new MutationObserver(b=>{for(const k of b)if(k.type==="childList")for(const K of k.addedNodes)K.tagName==="LINK"&&K.rel==="modulepreload"&&U(K)}).observe(document,{childList:!0,subtree:!0});function m(b){const k={};return b.integrity&&(k.integrity=b.integrity),b.referrerpolicy&&(k.referrerPolicy=b.referrerpolicy),b.crossorigin==="use-credentials"?k.credentials="include":b.crossorigin==="anonymous"?k.credentials="omit":k.credentials="same-origin",k}function U(b){if(b.ep)return;b.ep=!0;const k=m(b);fetch(b.href,k)}};aa();function ds(){}function On(w){return w()}function Tn(){return Object.create(null)}function ps(w){w.forEach(On)}function la(w){return typeof w=="function"}function Ii(w,D){return w!=w?D==D:w!==D||w&&typeof w=="object"||typeof w=="function"}function ma(w){return Object.keys(w).length===0}function Nt(w,D){w.appendChild(D)}function Jn(w,D,m){w.insertBefore(D,m||null)}function Gi(w){w.parentNode.removeChild(w)}function Xt(w){return document.createElementNS("http://www.w3.org/2000/svg",w)}function xi(w){return document.createTextNode(w)}function Rn(w,D,m,U){return w.addEventListener(D,m,U),()=>w.removeEventListener(D,m,U)}function N(w,D,m){m==null?w.removeAttribute(D):w.getAttribute(D)!==m&&w.setAttribute(D,m)}function _a(w){return Array.from(w.childNodes)}function kn(w,D){D=""+D,w.wholeText!==D&&(w.data=D)}function Si(w,D,m,U){m===null?w.style.removeProperty(D):w.style.setProperty(D,m,U?"important":"")}let fs;function hs(w){fs=w}function ha(){if(!fs)throw new Error("Function called outside component initialization");return fs}function ca(w){ha().$$.on_mount.push(w)}const _s=[],qn=[],zs=[],zn=[],ua=Promise.resolve();let bi=!1;function da(){bi||(bi=!0,ua.then(Xn))}function Vi(w){zs.push(w)}const Ci=new Set;let ks=0;function Xn(){const w=fs;do{for(;ks<_s.length;){const D=_s[ks];ks++,hs(D),fa(D.$$)}for(hs(null),_s.length=0,ks=0;qn.length;)qn.pop()();for(let D=0;D<zs.length;D+=1){const m=zs[D];Ci.has(m)||(Ci.add(m),m())}zs.length=0}while(_s.length);for(;zn.length;)zn.pop()();bi=!1,Ci.clear(),hs(w)}function fa(w){if(w.fragment!==null){w.update(),ps(w.before_update);const D=w.dirty;w.dirty=[-1],w.fragment&&w.fragment.p(w.ctx,D),w.after_update.forEach(Vi)}}const Es=new Set;let pa;function Ns(w,D){w&&w.i&&(Es.delete(w),w.i(D))}function wi(w,D,m,U){if(w&&w.o){if(Es.has(w))return;Es.add(w),pa.c.push(()=>{Es.delete(w),U&&(m&&w.d(1),U())}),w.o(D)}}const ya=typeof window!="undefined"?window:typeof globalThis!="undefined"?globalThis:global;function gi(w){w&&w.c()}function js(w,D,m,U){const{fragment:b,on_mount:k,on_destroy:K,after_update:ht}=w.$$;b&&b.m(D,m),U||Vi(()=>{const q=k.map(On).filter(la);K?K.push(...q):ps(q),w.$$.on_mount=[]}),ht.forEach(Vi)}function Os(w,D){const m=w.$$;m.fragment!==null&&(ps(m.on_destroy),m.fragment&&m.fragment.d(D),m.on_destroy=m.fragment=null,m.ctx=[])}function Ba(w,D){w.$$.dirty[0]===-1&&(_s.push(w),da(),w.$$.dirty.fill(0)),w.$$.dirty[D/31|0]|=1<<D%31}function Di(w,D,m,U,b,k,K,ht=[-1]){const q=fs;hs(w);const J=w.$$={fragment:null,ctx:null,props:k,update:ds,not_equal:b,bound:Tn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(D.context||(q?q.$$.context:[])),callbacks:Tn(),dirty:ht,skip_bound:!1,root:D.target||q.$$.root};K&&K(J.root);let ut=!1;if(J.ctx=m?m(w,D.props||{},(yt,dt,...j)=>{const At=j.length?j[0]:dt;return J.ctx&&b(J.ctx[yt],J.ctx[yt]=At)&&(!J.skip_bound&&J.bound[yt]&&J.bound[yt](At),ut&&Ba(w,yt)),dt}):[],J.update(),ut=!0,ps(J.before_update),J.fragment=U?U(J.ctx):!1,D.target){if(D.hydrate){const yt=_a(D.target);J.fragment&&J.fragment.l(yt),yt.forEach(Gi)}else J.fragment&&J.fragment.c();D.intro&&Ns(w.$$.fragment),js(w,D.target,D.anchor,D.customElement),Xn()}hs(q)}class Fi{$destroy(){Os(this,1),this.$destroy=ds}$on(D,m){const U=this.$$.callbacks[D]||(this.$$.callbacks[D]=[]);return U.push(m),()=>{const b=U.indexOf(m);b!==-1&&U.splice(b,1)}}$set(D){this.$$set&&!ma(D)&&(this.$$.skip_bound=!0,this.$$set(D),this.$$.skip_bound=!1)}}function Aa(w){let D,m,U,b,k,K,ht,q,J,ut,yt,dt,j,At,xt,St,Ht;return{c(){D=Xt("g"),m=Xt("defs"),U=Xt("clipPath"),b=Xt("rect"),ht=Xt("g"),q=Xt("circle"),J=Xt("g"),ut=Xt("circle"),j=Xt("circle"),N(b,"x",k=-w[1]),N(b,"y","0"),N(b,"width",K=2*w[1]),N(b,"height",w[1]),N(U,"id","hide-player-bottom"),N(q,"cx","0"),N(q,"cy","0"),N(q,"r",w[1]),N(q,"fill",w[0]),N(ut,"cx",yt=.8*w[1]),N(ut,"cy","0"),N(ut,"r",dt=.1*w[1]),N(ut,"fill","white"),N(j,"cx",At=.8*w[1]),N(j,"cy","0"),N(j,"r",xt=.05*w[1]),N(j,"fill","black"),N(J,"transform",St="rotate("+w[2]+")"),N(ht,"clip-path","url(#hide-player-bottom)"),N(D,"transform",Ht="translate("+w[3]+" "+w[4]+")")},m(mt,st){Jn(mt,D,st),Nt(D,m),Nt(m,U),Nt(U,b),Nt(D,ht),Nt(ht,q),Nt(ht,J),Nt(J,ut),Nt(J,j)},p(mt,[st]){st&2&&k!==(k=-mt[1])&&N(b,"x",k),st&2&&K!==(K=2*mt[1])&&N(b,"width",K),st&2&&N(b,"height",mt[1]),st&2&&N(q,"r",mt[1]),st&1&&N(q,"fill",mt[0]),st&2&&yt!==(yt=.8*mt[1])&&N(ut,"cx",yt),st&2&&dt!==(dt=.1*mt[1])&&N(ut,"r",dt),st&2&&At!==(At=.8*mt[1])&&N(j,"cx",At),st&2&&xt!==(xt=.05*mt[1])&&N(j,"r",xt),st&4&&St!==(St="rotate("+mt[2]+")")&&N(J,"transform",St),st&24&&Ht!==(Ht="translate("+mt[3]+" "+mt[4]+")")&&N(D,"transform",Ht)},i:ds,o:ds,d(mt){mt&&Gi(D)}}}function xa(w,D,m){let{color:U="red"}=D,{radius:b=1}=D,{eyeAngle:k=40}=D,{x:K=0}=D,{y:ht=0}=D;return w.$$set=q=>{"color"in q&&m(0,U=q.color),"radius"in q&&m(1,b=q.radius),"eyeAngle"in q&&m(2,k=q.eyeAngle),"x"in q&&m(3,K=q.x),"y"in q&&m(4,ht=q.y)},[U,b,k,K,ht]}class En extends Fi{constructor(D){super(),Di(this,D,xa,Aa,Ii,{color:0,radius:1,eyeAngle:2,x:3,y:4})}}var Sa=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},Et={exports:{}};(function(w,D){(function(m,U){U(D)})(Sa,function(m){function U(d,...t){if(!d)throw new Error(...t)}function b(d,t){return d!==void 0?d:t}const k=1e37,K=1e-5,ht=K*K,q=3.14159265359,J=2,ut=8,yt=.1,dt=2,j=.008,At=2/180*q,xt=2*j,St=8,Ht=32,mt=1,st=.2,Gt=8/180*q,$t=2,Me=$t*$t,rt=.5*q,Lt=rt*rt,xe=.2,Se=.75,jt=-1,Li=2147483647,Y=.75,Q=1,it=.25,Dt=.5,Qt=2,_e=Qt*Qt,vt=256,Ft=2.5,Pe=.5,Us=.01,Zs=2/180*q;function Zn(d){return null}function Hn(d){}function Qn(d,...t){}class Ti{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const Wn=new Ti(2,3,2),Yn="master",Kn="fbf51801d80fc389d43dc46524520e89043b6faf";function $n(d){return parseInt(d,10)}function to(d){return Math.abs(parseInt(d,10))}function Wt(d,t){const e=new Array(d);for(let i=0;i<d;++i)e[i]=t(i);return e}function eo(d){const t=new Array(d);for(let e=0;e<d;++e)t[e]=null;return t}function Ie(d,t=0){const e=new Array(d);for(let i=0;i<d;++i)e[i]=t;return e}const Ri=q/180,ki=180/q,Hs=2*q,at=Math.abs;function tt(d,t){return d<t?d:t}function H(d,t){return d>t?d:t}function gt(d,t,e){return d<t?t:d>e?e:d}function so(d,t){const e=d[0];d[0]=t[0],t[0]=e}const io=isFinite;function Ne(d){return d*d}function Qs(d){return 1/Math.sqrt(d)}const ye=Math.sqrt,qi=Math.pow;function no(d){return d*Ri}function oo(d){return d*ki}const ro=Math.cos,ao=Math.sin,lo=Math.acos,zi=Math.asin,Ws=Math.atan2;function mo(d){return d|=d>>1&2147483647,d|=d>>2&1073741823,d|=d>>4&268435455,d|=d>>8&16777215,d|=d>>16&65535,d+1}function _o(d){return d>0&&(d&d-1)===0}function ho(){return Math.random()*2-1}function co(d,t){return(t-d)*Math.random()+d}class s{constructor(...t){if(t[0]instanceof Float32Array){if(t[0].length!==2)throw new Error;this.data=t[0]}else{const e=typeof t[0]=="number"?t[0]:0,i=typeof t[1]=="number"?t[1]:0;this.data=new Float32Array([e,i])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}Clone(){return new s(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=K){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=K){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=tt(this.x,t.x),this.y=tt(this.y,t.y),this}SelfMaxV(t){return this.x=H(this.x,t.x),this.y=H(this.y,t.y),this}SelfAbs(){return this.x=at(this.x),this.y=at(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return Wt(t,e=>new s)}static AbsV(t,e){return e.x=at(t.x),e.y=at(t.y),e}static MinV(t,e,i){return i.x=tt(t.x,e.x),i.y=tt(t.y,e.y),i}static MaxV(t,e,i){return i.x=H(t.x,e.x),i.y=H(t.y,e.y),i}static ClampV(t,e,i,n){return n.x=gt(t.x,e.x,i.x),n.y=gt(t.y,e.y,i.y),n}static RotateV(t,e,i){const n=t.x,o=t.y,r=Math.cos(e),a=Math.sin(e);return i.x=r*n-a*o,i.y=a*n+r*o,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const n=t.x;return i.x=e*t.y,i.y=-e*n,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const n=e.x;return i.x=-t*e.y,i.y=t*n,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n}static SubVMulSV(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n}static AddVCrossSV(t,e,i,n){const o=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*o,n}static MidVV(t,e,i){return i.x=(t.x+e.x)*.5,i.y=(t.y+e.y)*.5,i}static ExtVV(t,e,i){return i.x=(e.x-t.x)*.5,i.y=(e.y-t.y)*.5,i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static DistanceSquaredVV(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}s.ZERO=new s(0,0),s.UNITX=new s(1,0),s.UNITY=new s(0,1),s.s_t0=new s,s.s_t1=new s,s.s_t2=new s,s.s_t3=new s;const uo=new s(0,0);class bt{constructor(...t){if(t[0]instanceof Float32Array){if(t[0].length!==3)throw new Error;this.data=t[0]}else{const e=typeof t[0]=="number"?t[0]:0,i=typeof t[1]=="number"?t[1]:0,n=typeof t[2]=="number"?t[2]:0;this.data=new Float32Array([e,i,n])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new bt(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const n=t.x,o=t.y,r=t.z,a=e.x,l=e.y,h=e.z;return i.x=o*h-r*l,i.y=r*a-n*h,i.z=n*l-o*a,i}}bt.ZERO=new bt(0,0,0),bt.s_t0=new bt;class ft{constructor(){this.data=new Float32Array([1,0,0,1]),this.ex=new s(this.data.subarray(0,2)),this.ey=new s(this.data.subarray(2,4))}Clone(){return new ft().Copy(this)}static FromVV(t,e){return new ft().SetVV(t,e)}static FromSSSS(t,e,i,n){return new ft().SetSSSS(t,e,i,n)}static FromAngle(t){return new ft().SetAngle(t)}SetSSSS(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,o=this.ey.y;let r=e*o-i*n;return r!==0&&(r=1/r),t.ex.x=r*o,t.ey.x=-r*i,t.ex.y=-r*n,t.ey.y=r*e,t}Solve(t,e,i){const n=this.ex.x,o=this.ey.x,r=this.ex.y,a=this.ey.y;let l=n*a-o*r;return l!==0&&(l=1/l),i.x=l*(a*t-o*e),i.y=l*(n*e-r*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,n=t.ey;return e.ex.x=at(i.x),e.ex.y=at(i.y),e.ey.x=at(n.x),e.ey.y=at(n.y),e}static MulMV(t,e,i){const n=t.ex,o=t.ey,r=e.x,a=e.y;return i.x=n.x*r+o.x*a,i.y=n.y*r+o.y*a,i}static MulTMV(t,e,i){const n=t.ex,o=t.ey,r=e.x,a=e.y;return i.x=n.x*r+n.y*a,i.y=o.x*r+o.y*a,i}static AddMM(t,e,i){const n=t.ex,o=t.ey,r=e.ex,a=e.ey;return i.ex.x=n.x+r.x,i.ex.y=n.y+r.y,i.ey.x=o.x+a.x,i.ey.y=o.y+a.y,i}static MulMM(t,e,i){const n=t.ex.x,o=t.ex.y,r=t.ey.x,a=t.ey.y,l=e.ex.x,h=e.ex.y,c=e.ey.x,_=e.ey.y;return i.ex.x=n*l+r*h,i.ex.y=o*l+a*h,i.ey.x=n*c+r*_,i.ey.y=o*c+a*_,i}static MulTMM(t,e,i){const n=t.ex.x,o=t.ex.y,r=t.ey.x,a=t.ey.y,l=e.ex.x,h=e.ex.y,c=e.ey.x,_=e.ey.y;return i.ex.x=n*l+o*h,i.ex.y=r*l+a*h,i.ey.x=n*c+o*_,i.ey.y=r*c+a*_,i}}ft.IDENTITY=new ft;class he{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new bt(this.data.subarray(0,3)),this.ey=new bt(this.data.subarray(3,6)),this.ez=new bt(this.data.subarray(6,9))}Clone(){return new he().Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,n){const o=this.ex.x,r=this.ex.y,a=this.ex.z,l=this.ey.x,h=this.ey.y,c=this.ey.z,_=this.ez.x,u=this.ez.y,f=this.ez.z;let p=o*(h*f-c*u)+r*(c*_-l*f)+a*(l*u-h*_);return p!==0&&(p=1/p),n.x=p*(t*(h*f-c*u)+e*(c*_-l*f)+i*(l*u-h*_)),n.y=p*(o*(e*f-i*u)+r*(i*_-t*f)+a*(t*u-e*_)),n.z=p*(o*(h*i-c*e)+r*(c*t-l*i)+a*(l*e-h*t)),n}Solve22(t,e,i){const n=this.ex.x,o=this.ey.x,r=this.ex.y,a=this.ey.y;let l=n*a-o*r;return l!==0&&(l=1/l),i.x=l*(a*t-o*e),i.y=l*(n*e-r*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,o=this.ey.y;let r=e*o-i*n;r!==0&&(r=1/r),t.ex.x=r*o,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*n,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=bt.DotV3V3(this.ex,bt.CrossV3V3(this.ey,this.ez,bt.s_t0));e!==0&&(e=1/e);const i=this.ex.x,n=this.ey.x,o=this.ez.x,r=this.ey.y,a=this.ez.y,l=this.ez.z;t.ex.x=e*(r*l-a*a),t.ex.y=e*(o*a-n*l),t.ex.z=e*(n*a-o*r),t.ey.x=t.ex.y,t.ey.y=e*(i*l-o*o),t.ey.z=e*(o*n-i*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-n*n)}static MulM33V3(t,e,i){const n=e.x,o=e.y,r=e.z;return i.x=t.ex.x*n+t.ey.x*o+t.ez.x*r,i.y=t.ex.y*n+t.ey.y*o+t.ez.y*r,i.z=t.ex.z*n+t.ey.z*o+t.ez.z*r,i}static MulM33XYZ(t,e,i,n,o){return o.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,o.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,o.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,o}static MulM33V2(t,e,i){const n=e.x,o=e.y;return i.x=t.ex.x*n+t.ey.x*o,i.y=t.ex.y*n+t.ey.y*o,i}static MulM33XY(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n}}he.IDENTITY=new he;class V{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return new V().Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const n=t.c,o=t.s,r=e.c,a=e.s;return i.s=o*r+n*a,i.c=n*r-o*a,i}static MulTRR(t,e,i){const n=t.c,o=t.s,r=e.c,a=e.s;return i.s=n*a-o*r,i.c=n*r+o*a,i}static MulRV(t,e,i){const n=t.c,o=t.s,r=e.x,a=e.y;return i.x=n*r-o*a,i.y=o*r+n*a,i}static MulTRV(t,e,i){const n=t.c,o=t.s,r=e.x,a=e.y;return i.x=n*r+o*a,i.y=-o*r+n*a,i}}V.IDENTITY=new V;class M{constructor(){this.p=new s,this.q=new V}Clone(){return new M().Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const n=t.q.c,o=t.q.s,r=e.x,a=e.y;return i.x=n*r-o*a+t.p.x,i.y=o*r+n*a+t.p.y,i}static MulTXV(t,e,i){const n=t.q.c,o=t.q.s,r=e.x-t.p.x,a=e.y-t.p.y;return i.x=n*r+o*a,i.y=-o*r+n*a,i}static MulXX(t,e,i){return V.MulRR(t.q,e.q,i.q),s.AddVV(V.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return V.MulTRR(t.q,e.q,i.q),V.MulTRV(t.q,s.SubVV(e.p,t.p,i.p),i.p),i}}M.IDENTITY=new M;class se{constructor(){this.localCenter=new s,this.c0=new s,this.c=new s,this.a0=0,this.a=0,this.alpha0=0}Clone(){return new se().Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(V.MulRV(t.q,this.localCenter,s.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=Hs*Math.floor(this.a0/Hs);this.a0-=t,this.a-=t}}class ct{constructor(...t){if(t[0]instanceof Float32Array){if(t[0].length!==4)throw new Error;this.data=t[0]}else{const e=typeof t[0]=="number"?t[0]:.5,i=typeof t[1]=="number"?t[1]:.5,n=typeof t[2]=="number"?t[2]:.5,o=typeof t[3]=="number"?t[3]:1;this.data=new Float32Array([e,i,n,o])}}get r(){return this.data[0]}set r(t){this.data[0]=t}get g(){return this.data[1]}set g(t){this.data[1]=t}get b(){return this.data[2]}set b(t){this.data[2]=t}get a(){return this.data[3]}set a(t){this.data[3]=t}Clone(){return new ct().Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return this.r===0&&this.g===0&&this.b===0&&this.a===0}Set(t,e,i,n=this.a){this.SetRGBA(t,e,i,n)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){ct.MixColors(this,t,e)}static MixColors(t,e,i){const n=i*(e.r-t.r),o=i*(e.g-t.g),r=i*(e.b-t.b),a=i*(e.a-t.a);t.r+=n,t.g+=o,t.b+=r,t.a+=a,e.r-=n,e.g-=o,e.b-=r,e.a-=a}MakeStyleString(t=this.a){return ct.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,n=1){return t*=255,e*=255,i*=255,n<1?`rgba(${t},${e},${i},${n})`:`rgb(${t},${e},${i})`}}ct.ZERO=new ct(0,0,0,0),ct.RED=new ct(1,0,0),ct.GREEN=new ct(0,1,0),ct.BLUE=new ct(0,0,1),function(d){d[d.e_none=0]="e_none",d[d.e_shapeBit=1]="e_shapeBit",d[d.e_jointBit=2]="e_jointBit",d[d.e_aabbBit=4]="e_aabbBit",d[d.e_pairBit=8]="e_pairBit",d[d.e_centerOfMassBit=16]="e_centerOfMassBit",d[d.e_particleBit=32]="e_particleBit",d[d.e_controllerBit=64]="e_controllerBit",d[d.e_all=63]="e_all"}(m.b2DrawFlags||(m.b2DrawFlags={}));class fo{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}}class je{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class po{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}class Ei{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=Wt(t,e=>null),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,t===null)throw new Error;return t}GetCount(){return this.m_count}}class yo{}class Bo{}class De{constructor(){this.m_buffer=s.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=s.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const o=s.DotVV(this.m_vertices[n],t);o>i&&(e=n,i=o)}return e}GetSupportVertex(t){let e=0,i=s.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const o=s.DotVV(this.m_vertices[n],t);o>i&&(e=n,i=o)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class Ys{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class Ks{constructor(){this.proxyA=new De,this.proxyB=new De,this.transformA=new M,this.transformB=new M,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class $s{constructor(){this.pointA=new s,this.pointB=new s,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}class Ao{constructor(){this.proxyA=new De,this.proxyB=new De,this.transformA=new M,this.transformB=new M,this.translationB=new s}}class xo{constructor(){this.point=new s,this.normal=new s,this.lambda=0,this.iterations=0}}m.b2_gjkCalls=0,m.b2_gjkIters=0,m.b2_gjkMaxIters=0;function So(){m.b2_gjkCalls=0,m.b2_gjkIters=0,m.b2_gjkMaxIters=0}class ys{constructor(){this.wA=new s,this.wB=new s,this.w=new s,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class de{constructor(){this.m_v1=new ys,this.m_v2=new ys,this.m_v3=new ys,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,n,o){this.m_count=t.count;const r=this.m_vertices;for(let a=0;a<this.m_count;++a){const l=r[a];l.indexA=t.indexA[a],l.indexB=t.indexB[a];const h=e.GetVertex(l.indexA),c=n.GetVertex(l.indexB);M.MulXV(i,h,l.wA),M.MulXV(o,c,l.wB),s.SubVV(l.wB,l.wA,l.w),l.a=0}if(this.m_count>1){const a=t.metric,l=this.GetMetric();(l<.5*a||2*a<l||l<K)&&(this.m_count=0)}if(this.m_count===0){const a=r[0];a.indexA=0,a.indexB=0;const l=e.GetVertex(0),h=n.GetVertex(0);M.MulXV(i,l,a.wA),M.MulXV(o,h,a.wB),s.SubVV(a.wB,a.wA,a.w),a.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return s.NegV(this.m_v1.w,t);case 2:{const e=s.SubVV(this.m_v2.w,this.m_v1.w,t);return s.CrossVV(e,s.NegV(this.m_v1.w,s.s_t0))>0?s.CrossOneV(e,t):s.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:return t.SetZero();default:return t.SetZero()}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break}}GetMetric(){switch(this.m_count){case 0:return 0;case 1:return 0;case 2:return s.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return s.CrossVV(s.SubVV(this.m_v2.w,this.m_v1.w,s.s_t0),s.SubVV(this.m_v3.w,this.m_v1.w,s.s_t1));default:return 0}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=s.SubVV(e,t,de.s_e12),n=-s.DotVV(t,i);if(n<=0){this.m_v1.a=1,this.m_count=1;return}const o=s.DotVV(e,i);if(o<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.Copy(this.m_v2);return}const r=1/(o+n);this.m_v1.a=o*r,this.m_v2.a=n*r,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=s.SubVV(e,t,de.s_e12),o=s.DotVV(t,n),a=s.DotVV(e,n),l=-o,h=s.SubVV(i,t,de.s_e13),c=s.DotVV(t,h),u=s.DotVV(i,h),f=-c,p=s.SubVV(i,e,de.s_e23),y=s.DotVV(e,p),A=s.DotVV(i,p),x=-y,C=s.CrossVV(n,h),v=C*s.CrossVV(e,i),g=C*s.CrossVV(i,t),I=C*s.CrossVV(t,e);if(l<=0&&f<=0){this.m_v1.a=1,this.m_count=1;return}if(a>0&&l>0&&I<=0){const T=1/(a+l);this.m_v1.a=a*T,this.m_v2.a=l*T,this.m_count=2;return}if(u>0&&f>0&&g<=0){const T=1/(u+f);this.m_v1.a=u*T,this.m_v3.a=f*T,this.m_count=2,this.m_v2.Copy(this.m_v3);return}if(a<=0&&x<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.Copy(this.m_v2);return}if(u<=0&&A<=0){this.m_v3.a=1,this.m_count=1,this.m_v1.Copy(this.m_v3);return}if(A>0&&x>0&&v<=0){const T=1/(A+x);this.m_v2.a=A*T,this.m_v3.a=x*T,this.m_count=2,this.m_v1.Copy(this.m_v3);return}const P=1/(v+g+I);this.m_v1.a=v*P,this.m_v2.a=g*P,this.m_v3.a=I*P,this.m_count=3}}de.s_e12=new s,de.s_e13=new s,de.s_e23=new s;const Co=new de,vo=[0,0,0],bo=[0,0,0],Vo=new s,wo=new s,go=new s,Mo=new s,Po=new s;function ti(d,t,e){++m.b2_gjkCalls;const i=e.proxyA,n=e.proxyB,o=e.transformA,r=e.transformB,a=Co;a.ReadCache(t,i,o,n,r);const l=a.m_vertices,h=20,c=vo,_=bo;let u=0,f=0;for(;f<h;){u=a.m_count;for(let A=0;A<u;++A)c[A]=l[A].indexA,_[A]=l[A].indexB;switch(a.m_count){case 1:break;case 2:a.Solve2();break;case 3:a.Solve3();break}if(a.m_count===3)break;const p=a.GetSearchDirection(wo);if(p.LengthSquared()<ht)break;const y=l[a.m_count];y.indexA=i.GetSupport(V.MulTRV(o.q,s.NegV(p,s.s_t0),Mo)),M.MulXV(o,i.GetVertex(y.indexA),y.wA),y.indexB=n.GetSupport(V.MulTRV(r.q,p,Po)),M.MulXV(r,n.GetVertex(y.indexB),y.wB),s.SubVV(y.wB,y.wA,y.w),++f,++m.b2_gjkIters;let B=!1;for(let A=0;A<u;++A)if(y.indexA===c[A]&&y.indexB===_[A]){B=!0;break}if(B)break;++a.m_count}if(m.b2_gjkMaxIters=H(m.b2_gjkMaxIters,f),a.GetWitnessPoints(d.pointA,d.pointB),d.distance=s.DistanceVV(d.pointA,d.pointB),d.iterations=f,a.WriteCache(t),e.useRadii){const p=i.m_radius,y=n.m_radius;if(d.distance>p+y&&d.distance>K){d.distance-=p+y;const B=s.SubVV(d.pointB,d.pointA,go);B.Normalize(),d.pointA.SelfMulAdd(p,B),d.pointB.SelfMulSub(y,B)}else{const B=s.MidVV(d.pointA,d.pointB,Vo);d.pointA.Copy(B),d.pointB.Copy(B),d.distance=0}}}const Io=new s,Go=new de,Ni=new s,ji=new s,Do=new s,Fo=new s,Lo=new s,To=new s;function Ro(d,t){d.iterations=0,d.lambda=1,d.normal.SetZero(),d.point.SetZero();const e=t.proxyA,i=t.proxyB,n=H(e.m_radius,xt),o=H(i.m_radius,xt),r=n+o,a=t.transformA,l=t.transformB,h=t.translationB,c=Io.Set(0,0);let _=0;const u=Go;u.m_count=0;const f=u.m_vertices;let p=e.GetSupport(V.MulTRV(a.q,s.NegV(h,s.s_t1),s.s_t0)),y=M.MulXV(a,e.GetVertex(p),Ni),B=i.GetSupport(V.MulTRV(l.q,h,s.s_t0)),A=M.MulXV(l,i.GetVertex(B),ji);const x=s.SubVV(y,A,Do),C=H(xt,r-xt),v=.5*j,g=20;let I=0;for(;I<g&&at(x.Length()-C)>v;){d.iterations+=1,p=e.GetSupport(V.MulTRV(a.q,s.NegV(x,s.s_t1),s.s_t0)),y=M.MulXV(a,e.GetVertex(p),Ni),B=i.GetSupport(V.MulTRV(l.q,x,s.s_t0)),A=M.MulXV(l,i.GetVertex(B),ji);const F=s.SubVV(y,A,Fo);x.Normalize();const R=s.DotVV(x,F),E=s.DotVV(x,h);if(R-C>_*E){if(E<=0||(_=(R-C)/E,_>1))return!1;c.Copy(x).SelfNeg(),u.m_count=0}const L=f[u.m_count];switch(L.indexA=B,L.wA.Copy(A).SelfMulAdd(_,h),L.indexB=p,L.wB.Copy(y),L.w.Copy(L.wB).SelfSub(L.wA),L.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3();break}if(u.m_count===3)return!1;u.GetClosestPoint(x),++I}const P=Lo,T=To;return u.GetWitnessPoints(P,T),x.LengthSquared()>0&&(c.Copy(x).SelfNeg(),c.Normalize()),d.normal.Copy(c),d.lambda=_,d.iterations=I,!0}(function(d){d[d.e_vertex=0]="e_vertex",d[d.e_face=1]="e_face"})(m.b2ContactFeatureType||(m.b2ContactFeatureType={}));class Oi{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=this._key&255,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class Oe{constructor(){this.cf=new Oi}Copy(t){return this.key=t.key,this}Clone(){return new Oe().Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class Bs{constructor(){this.localPoint=new s,this.normalImpulse=0,this.tangentImpulse=0,this.id=new Oe}static MakeArray(t){return Wt(t,e=>new Bs)}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}(function(d){d[d.e_unknown=-1]="e_unknown",d[d.e_circles=0]="e_circles",d[d.e_faceA=1]="e_faceA",d[d.e_faceB=2]="e_faceB"})(m.b2ManifoldType||(m.b2ManifoldType={}));class He{constructor(){this.points=Bs.MakeArray(J),this.localNormal=new s,this.localPoint=new s,this.type=m.b2ManifoldType.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<J;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=m.b2ManifoldType.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<J;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return new He().Copy(this)}}class Mt{constructor(){this.normal=new s,this.points=s.MakeArray(J),this.separations=Ie(J)}Initialize(t,e,i,n,o){if(t.pointCount!==0)switch(t.type){case m.b2ManifoldType.e_circles:{this.normal.Set(1,0);const r=M.MulXV(e,t.localPoint,Mt.Initialize_s_pointA),a=M.MulXV(n,t.points[0].localPoint,Mt.Initialize_s_pointB);s.DistanceSquaredVV(r,a)>ht&&s.SubVV(a,r,this.normal).SelfNormalize();const l=s.AddVMulSV(r,i,this.normal,Mt.Initialize_s_cA),h=s.SubVMulSV(a,o,this.normal,Mt.Initialize_s_cB);s.MidVV(l,h,this.points[0]),this.separations[0]=s.DotVV(s.SubVV(h,l,s.s_t0),this.normal);break}case m.b2ManifoldType.e_faceA:{V.MulRV(e.q,t.localNormal,this.normal);const r=M.MulXV(e,t.localPoint,Mt.Initialize_s_planePoint);for(let a=0;a<t.pointCount;++a){const l=M.MulXV(n,t.points[a].localPoint,Mt.Initialize_s_clipPoint),h=i-s.DotVV(s.SubVV(l,r,s.s_t0),this.normal),c=s.AddVMulSV(l,h,this.normal,Mt.Initialize_s_cA),_=s.SubVMulSV(l,o,this.normal,Mt.Initialize_s_cB);s.MidVV(c,_,this.points[a]),this.separations[a]=s.DotVV(s.SubVV(_,c,s.s_t0),this.normal)}break}case m.b2ManifoldType.e_faceB:{V.MulRV(n.q,t.localNormal,this.normal);const r=M.MulXV(n,t.localPoint,Mt.Initialize_s_planePoint);for(let a=0;a<t.pointCount;++a){const l=M.MulXV(e,t.points[a].localPoint,Mt.Initialize_s_clipPoint),h=o-s.DotVV(s.SubVV(l,r,s.s_t0),this.normal),c=s.AddVMulSV(l,h,this.normal,Mt.Initialize_s_cB),_=s.SubVMulSV(l,i,this.normal,Mt.Initialize_s_cA);s.MidVV(_,c,this.points[a]),this.separations[a]=s.DotVV(s.SubVV(_,c,s.s_t0),this.normal)}this.normal.SelfNeg();break}}}}Mt.Initialize_s_pointA=new s,Mt.Initialize_s_pointB=new s,Mt.Initialize_s_cA=new s,Mt.Initialize_s_cB=new s,Mt.Initialize_s_planePoint=new s,Mt.Initialize_s_clipPoint=new s,function(d){d[d.b2_nullState=0]="b2_nullState",d[d.b2_addState=1]="b2_addState",d[d.b2_persistState=2]="b2_persistState",d[d.b2_removeState=3]="b2_removeState"}(m.b2PointState||(m.b2PointState={}));function ko(d,t,e,i){let n;for(n=0;n<e.pointCount;++n){const r=e.points[n].id.key;d[n]=m.b2PointState.b2_removeState;for(let a=0,l=i.pointCount;a<l;++a)if(i.points[a].id.key===r){d[n]=m.b2PointState.b2_persistState;break}}for(;n<J;++n)d[n]=m.b2PointState.b2_nullState;for(n=0;n<i.pointCount;++n){const r=i.points[n].id.key;t[n]=m.b2PointState.b2_addState;for(let a=0,l=e.pointCount;a<l;++a)if(e.points[a].id.key===r){t[n]=m.b2PointState.b2_persistState;break}}for(;n<J;++n)t[n]=m.b2PointState.b2_nullState}class Ce{constructor(){this.v=new s,this.id=new Oe}static MakeArray(t){return Wt(t,e=>new Ce)}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class As{constructor(){this.p1=new s,this.p2=new s,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class ei{constructor(){this.normal=new s,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class Tt{constructor(){this.lowerBound=new s,this.upperBound=new s,this.m_cache_center=new s,this.m_cache_extent=new s}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}GetCenter(){return s.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return s.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){const t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y;return 2*(t+e)}Combine1(t){return this.lowerBound.x=tt(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=tt(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=H(this.upperBound.x,t.upperBound.x),this.upperBound.y=H(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=tt(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=tt(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=H(t.upperBound.x,e.upperBound.x),this.upperBound.y=H(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)}RayCast(t,e){let i=-k,n=k;const o=e.p1.x,r=e.p1.y,a=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,h=at(a),c=at(l),_=t.normal;if(h<K){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{const u=1/a;let f=(this.lowerBound.x-o)*u,p=(this.upperBound.x-o)*u,y=-1;if(f>p){const B=f;f=p,p=B,y=1}if(f>i&&(_.x=y,_.y=0,i=f),n=tt(n,p),i>n)return!1}if(c<K){if(r<this.lowerBound.y||this.upperBound.y<r)return!1}else{const u=1/l;let f=(this.lowerBound.y-r)*u,p=(this.upperBound.y-r)*u,y=-1;if(f>p){const B=f;f=p,p=B,y=1}if(f>i&&(_.x=0,_.y=y,i=f),n=tt(n,p),i>n)return!1}return i<0||e.maxFraction<i?!1:(t.fraction=i,!0)}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function si(d,t){return!(d.upperBound.x<t.lowerBound.x||d.upperBound.y<t.lowerBound.y||t.upperBound.x<d.lowerBound.x||t.upperBound.y<d.lowerBound.y)}function Qe(d,t,e,i,n){let o=0;const r=t[0],a=t[1],l=s.DotVV(e,r.v)-i,h=s.DotVV(e,a.v)-i;if(l<=0&&d[o++].Copy(r),h<=0&&d[o++].Copy(a),l*h<0){const c=l/(l-h),_=d[o].v;_.x=r.v.x+c*(a.v.x-r.v.x),_.y=r.v.y+c*(a.v.y-r.v.y);const u=d[o].id;u.cf.indexA=n,u.cf.indexB=r.id.cf.indexB,u.cf.typeA=m.b2ContactFeatureType.e_vertex,u.cf.typeB=m.b2ContactFeatureType.e_face,++o}return o}const qo=new Ks,zo=new Ys,Eo=new $s;function ii(d,t,e,i,n,o){const r=qo.Reset();r.proxyA.SetShape(d,t),r.proxyB.SetShape(e,i),r.transformA.Copy(n),r.transformB.Copy(o),r.useRadii=!0;const a=zo.Reset();a.count=0;const l=Eo.Reset();return ti(l,a,r),l.distance<10*K}function Pt(d){if(d===null)throw new Error;return d}class Ji{constructor(t=0){this.m_id=0,this.aabb=new Tt,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}get userData(){if(this._userData===null)throw new Error;return this._userData}set userData(t){if(this._userData!==null)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return this.child1===null}}class ot{constructor(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ei(256)}Query(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(n!==null&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(n!==null&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}RayCast(t,e){const i=t.p1,n=t.p2,o=s.SubVV(n,i,ot.s_r);o.Normalize();const r=s.CrossOneV(o,ot.s_v),a=s.AbsV(r,ot.s_abs_v);let l=t.maxFraction;const h=ot.s_segmentAABB;let c=i.x+l*(n.x-i.x),_=i.y+l*(n.y-i.y);h.lowerBound.x=tt(i.x,c),h.lowerBound.y=tt(i.y,_),h.upperBound.x=H(i.x,c),h.upperBound.y=H(i.y,_);const u=this.m_stack.Reset();for(u.Push(this.m_root);u.GetCount()>0;){const f=u.Pop();if(f===null||!si(f.aabb,h))continue;const p=f.aabb.GetCenter(),y=f.aabb.GetExtents();if(!(at(s.DotVV(r,s.SubVV(i,p,s.s_t0)))-s.DotVV(a,y)>0))if(f.IsLeaf()){const A=ot.s_subInput;A.p1.Copy(t.p1),A.p2.Copy(t.p2),A.maxFraction=l;const x=e(A,f);if(x===0)return;x>0&&(l=x,c=i.x+l*(n.x-i.x),_=i.y+l*(n.y-i.y),h.lowerBound.x=tt(i.x,c),h.lowerBound.y=tt(i.y,_),h.upperBound.x=H(i.x,c),h.upperBound.y=H(i.y,_))}else u.Push(f.child1),u.Push(f.child2)}}AllocateNode(){if(this.m_freeList!==null){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new Ji(ot.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),n=yt,o=yt;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-o,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+o,i.userData=e,i.height=0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);const n=yt,o=yt;t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-o,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+o;const r=dt*i.x,a=dt*i.y;return r<0?t.aabb.lowerBound.x+=r:t.aabb.upperBound.x+=r,a<0?t.aabb.lowerBound.y+=a:t.aabb.upperBound.y+=a,this.InsertLeaf(t),!0}InsertLeaf(t){if(++this.m_insertionCount,this.m_root===null){this.m_root=t,this.m_root.parent=null;return}const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const a=Pt(i.child1),l=Pt(i.child2),h=i.aabb.GetPerimeter(),c=ot.s_combinedAABB;c.Combine2(i.aabb,e);const _=c.GetPerimeter(),u=2*_,f=2*(_-h);let p;const y=ot.s_aabb;let B,A;a.IsLeaf()?(y.Combine2(e,a.aabb),p=y.GetPerimeter()+f):(y.Combine2(e,a.aabb),B=a.aabb.GetPerimeter(),A=y.GetPerimeter(),p=A-B+f);let x;if(l.IsLeaf()?(y.Combine2(e,l.aabb),x=y.GetPerimeter()+f):(y.Combine2(e,l.aabb),B=l.aabb.GetPerimeter(),A=y.GetPerimeter(),x=A-B+f),u<p&&u<x)break;p<x?i=a:i=l}const n=i.parent,o=this.AllocateNode();o.parent=n,o.aabb.Combine2(e,i.aabb),o.height=i.height+1,n!==null?(n.child1===i?n.child1=o:n.child2=o,o.child1=i,o.child2=t,i.parent=o,t.parent=o):(o.child1=i,o.child2=t,i.parent=o,t.parent=o,this.m_root=o);let r=t.parent;for(;r!==null;){r=this.Balance(r);const a=Pt(r.child1),l=Pt(r.child2);r.height=1+H(a.height,l.height),r.aabb.Combine2(a.aabb,l.aabb),r=r.parent}}RemoveLeaf(t){if(t===this.m_root){this.m_root=null;return}const e=Pt(t.parent),i=e&&e.parent,n=Pt(e.child1===t?e.child2:e.child1);if(i!==null){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);let o=i;for(;o!==null;){o=this.Balance(o);const r=Pt(o.child1),a=Pt(o.child2);o.aabb.Combine2(r.aabb,a.aabb),o.height=1+H(r.height,a.height),o=o.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=Pt(t.child1),i=Pt(t.child2),n=i.height-e.height;if(n>1){const o=Pt(i.child1),r=Pt(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,i.parent!==null?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,o.height>r.height?(i.child2=o,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),i.aabb.Combine2(t.aabb,o.aabb),t.height=1+H(e.height,r.height),i.height=1+H(t.height,o.height)):(i.child2=r,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),i.aabb.Combine2(t.aabb,r.aabb),t.height=1+H(e.height,o.height),i.height=1+H(t.height,r.height)),i}if(n<-1){const o=Pt(e.child1),r=Pt(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,e.parent!==null?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,o.height>r.height?(e.child2=o,t.child1=r,r.parent=t,t.aabb.Combine2(i.aabb,r.aabb),e.aabb.Combine2(t.aabb,o.aabb),t.height=1+H(i.height,r.height),e.height=1+H(t.height,o.height)):(e.child2=r,t.child1=o,o.parent=t,t.aabb.Combine2(i.aabb,o.aabb),e.aabb.Combine2(t.aabb,r.aabb),t.height=1+H(i.height,o.height),e.height=1+H(t.height,r.height)),e}return t}GetHeight(){return this.m_root===null?0:this.m_root.height}static GetAreaNode(t){if(t===null||t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=ot.GetAreaNode(t.child1),e+=ot.GetAreaNode(t.child2),e}GetAreaRatio(){if(this.m_root===null)return 0;const e=this.m_root.aabb.GetPerimeter();return ot.GetAreaNode(this.m_root)/e}static ComputeHeightNode(t){if(t===null||t.IsLeaf())return 0;const e=ot.ComputeHeightNode(t.child1),i=ot.ComputeHeightNode(t.child2);return 1+H(e,i)}ComputeHeight(){return ot.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(t===null||(this.m_root,t.IsLeaf()))return;const e=Pt(t.child1),i=Pt(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(t===null||t.IsLeaf())return;const e=Pt(t.child1),i=Pt(t.child2);ot.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(t===null||t.height<=1)return e;const i=Pt(t.child1),n=Pt(t.child2),o=at(n.height-i.height);return H(e,o)}GetMaxBalance(){return ot.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(t===null||t.height<=1)return;const i=t.child1,n=t.child2;ot.ShiftOriginNode(i,e),ot.ShiftOriginNode(n,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){ot.ShiftOriginNode(this.m_root,t)}}ot.s_r=new s,ot.s_v=new s,ot.s_abs_v=new s,ot.s_segmentAABB=new Tt,ot.s_subInput=new As,ot.s_combinedAABB=new Tt,ot.s_aabb=new Tt,ot.s_node_id=0;function No(d,t,e){const i=d[t];d[t]=d[e],d[e]=i}function jo(d,t){return d<t}function Oo(d,t=0,e=d.length-t,i=jo){let n=t;const o=[];let r=0;for(;;){for(;n+1<e;e++){const a=d[n+Math.floor(Math.random()*(e-n))];o[r++]=e;for(let l=n-1;;){for(;i(d[++l],a););for(;i(a,d[--e]););if(l>=e)break;No(d,l,e)}}if(r===0)break;n=e,e=o[--r]}return d}class Xi{constructor(t,e){this.proxyA=t,this.proxyB=e}}class Ui{constructor(){this.m_tree=new ot,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let i=0;i<this.m_moveCount;++i){const n=this.m_moveBuffer[i];if(n===null)continue;const o=n.aabb;this.m_tree.Query(o,r=>{if(r.m_id===n.m_id)return!0;let a,l;if(r.m_id<n.m_id?(a=r,l=n):(a=n,l=r),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new Xi(a,l);else{const h=this.m_pairBuffer[this.m_pairCount];h.proxyA=a,h.proxyB=l}return++this.m_pairCount,!0})}this.m_moveCount=0,Oo(this.m_pairBuffer,0,this.m_pairCount,Zi);let e=0;for(;e<this.m_pairCount;){const i=this.m_pairBuffer[e],n=i.proxyA.userData,o=i.proxyB.userData;for(t(n,o),++e;e<this.m_pairCount;){const r=this.m_pairBuffer[e];if(r.proxyA.m_id!==i.proxyA.m_id||r.proxyB.m_id!==i.proxyB.m_id)break;++e}}}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}function Zi(d,t){return d.proxyA.m_id<t.proxyA.m_id?!0:d.proxyA.m_id===t.proxyA.m_id?d.proxyB.m_id<t.proxyB.m_id:!1}m.b2_toiTime=0,m.b2_toiMaxTime=0,m.b2_toiCalls=0,m.b2_toiIters=0,m.b2_toiMaxIters=0,m.b2_toiRootIters=0,m.b2_toiMaxRootIters=0;function Jo(){m.b2_toiTime=0,m.b2_toiMaxTime=0,m.b2_toiCalls=0,m.b2_toiIters=0,m.b2_toiMaxIters=0,m.b2_toiRootIters=0,m.b2_toiMaxRootIters=0}const xs=new M,Ss=new M,ve=new s,be=new s,Je=new s,Hi=new s,Qi=new s;class ni{constructor(){this.proxyA=new De,this.proxyB=new De,this.sweepA=new se,this.sweepB=new se,this.tMax=0}}(function(d){d[d.e_unknown=0]="e_unknown",d[d.e_failed=1]="e_failed",d[d.e_overlapped=2]="e_overlapped",d[d.e_touching=3]="e_touching",d[d.e_separated=4]="e_separated"})(m.b2TOIOutputState||(m.b2TOIOutputState={}));class oi{constructor(){this.state=m.b2TOIOutputState.e_unknown,this.t=0}}(function(d){d[d.e_unknown=-1]="e_unknown",d[d.e_points=0]="e_points",d[d.e_faceA=1]="e_faceA",d[d.e_faceB=2]="e_faceB"})(m.b2SeparationFunctionType||(m.b2SeparationFunctionType={}));class Wi{constructor(){this.m_sweepA=new se,this.m_sweepB=new se,this.m_type=m.b2SeparationFunctionType.e_unknown,this.m_localPoint=new s,this.m_axis=new s}Initialize(t,e,i,n,o,r){this.m_proxyA=e,this.m_proxyB=n;const a=t.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(o);const l=xs,h=Ss;if(this.m_sweepA.GetTransform(l,r),this.m_sweepB.GetTransform(h,r),a===1){this.m_type=m.b2SeparationFunctionType.e_points;const c=this.m_proxyA.GetVertex(t.indexA[0]),_=this.m_proxyB.GetVertex(t.indexB[0]),u=M.MulXV(l,c,ve),f=M.MulXV(h,_,be);s.SubVV(f,u,this.m_axis);const p=this.m_axis.Normalize();return this.m_localPoint.SetZero(),p}else if(t.indexA[0]===t.indexA[1]){this.m_type=m.b2SeparationFunctionType.e_faceB;const c=this.m_proxyB.GetVertex(t.indexB[0]),_=this.m_proxyB.GetVertex(t.indexB[1]);s.CrossVOne(s.SubVV(_,c,s.s_t0),this.m_axis).SelfNormalize();const u=V.MulRV(h.q,this.m_axis,Je);s.MidVV(c,_,this.m_localPoint);const f=M.MulXV(h,this.m_localPoint,be),p=this.m_proxyA.GetVertex(t.indexA[0]),y=M.MulXV(l,p,ve);let B=s.DotVV(s.SubVV(y,f,s.s_t0),u);return B<0&&(this.m_axis.SelfNeg(),B=-B),B}else{this.m_type=m.b2SeparationFunctionType.e_faceA;const c=this.m_proxyA.GetVertex(t.indexA[0]),_=this.m_proxyA.GetVertex(t.indexA[1]);s.CrossVOne(s.SubVV(_,c,s.s_t0),this.m_axis).SelfNormalize();const u=V.MulRV(l.q,this.m_axis,Je);s.MidVV(c,_,this.m_localPoint);const f=M.MulXV(l,this.m_localPoint,ve),p=this.m_proxyB.GetVertex(t.indexB[0]),y=M.MulXV(h,p,be);let B=s.DotVV(s.SubVV(y,f,s.s_t0),u);return B<0&&(this.m_axis.SelfNeg(),B=-B),B}}FindMinSeparation(t,e,i){const n=xs,o=Ss;switch(this.m_sweepA.GetTransform(n,i),this.m_sweepB.GetTransform(o,i),this.m_type){case m.b2SeparationFunctionType.e_points:{const r=V.MulTRV(n.q,this.m_axis,Hi),a=V.MulTRV(o.q,s.NegV(this.m_axis,s.s_t0),Qi);t[0]=this.m_proxyA.GetSupport(r),e[0]=this.m_proxyB.GetSupport(a);const l=this.m_proxyA.GetVertex(t[0]),h=this.m_proxyB.GetVertex(e[0]),c=M.MulXV(n,l,ve),_=M.MulXV(o,h,be);return s.DotVV(s.SubVV(_,c,s.s_t0),this.m_axis)}case m.b2SeparationFunctionType.e_faceA:{const r=V.MulRV(n.q,this.m_axis,Je),a=M.MulXV(n,this.m_localPoint,ve),l=V.MulTRV(o.q,s.NegV(r,s.s_t0),Qi);t[0]=-1,e[0]=this.m_proxyB.GetSupport(l);const h=this.m_proxyB.GetVertex(e[0]),c=M.MulXV(o,h,be);return s.DotVV(s.SubVV(c,a,s.s_t0),r)}case m.b2SeparationFunctionType.e_faceB:{const r=V.MulRV(o.q,this.m_axis,Je),a=M.MulXV(o,this.m_localPoint,be),l=V.MulTRV(n.q,s.NegV(r,s.s_t0),Hi);e[0]=-1,t[0]=this.m_proxyA.GetSupport(l);const h=this.m_proxyA.GetVertex(t[0]),c=M.MulXV(n,h,ve);return s.DotVV(s.SubVV(c,a,s.s_t0),r)}default:return t[0]=-1,e[0]=-1,0}}Evaluate(t,e,i){const n=xs,o=Ss;switch(this.m_sweepA.GetTransform(n,i),this.m_sweepB.GetTransform(o,i),this.m_type){case m.b2SeparationFunctionType.e_points:{const r=this.m_proxyA.GetVertex(t),a=this.m_proxyB.GetVertex(e),l=M.MulXV(n,r,ve),h=M.MulXV(o,a,be);return s.DotVV(s.SubVV(h,l,s.s_t0),this.m_axis)}case m.b2SeparationFunctionType.e_faceA:{const r=V.MulRV(n.q,this.m_axis,Je),a=M.MulXV(n,this.m_localPoint,ve),l=this.m_proxyB.GetVertex(e),h=M.MulXV(o,l,be);return s.DotVV(s.SubVV(h,a,s.s_t0),r)}case m.b2SeparationFunctionType.e_faceB:{const r=V.MulRV(o.q,this.m_axis,Je),a=M.MulXV(o,this.m_localPoint,be),l=this.m_proxyA.GetVertex(t),h=M.MulXV(n,l,ve);return s.DotVV(s.SubVV(h,a,s.s_t0),r)}default:return 0}}}const Xo=new je,Uo=new Ys,Zo=new Ks,Ho=new $s,Qo=new Wi,Wo=[0],Yo=[0],Ko=new se,$o=new se;function ri(d,t){const e=Xo.Reset();++m.b2_toiCalls,d.state=m.b2TOIOutputState.e_unknown,d.t=t.tMax;const i=t.proxyA,n=t.proxyB,o=H(ut,H(i.m_count,n.m_count)),r=Ko.Copy(t.sweepA),a=$o.Copy(t.sweepB);r.Normalize(),a.Normalize();const l=t.tMax,h=i.m_radius+n.m_radius,c=H(j,h-3*j),_=.25*j;let u=0;const f=20;let p=0;const y=Uo;y.count=0;const B=Zo;for(B.proxyA.Copy(t.proxyA),B.proxyB.Copy(t.proxyB),B.useRadii=!1;;){const x=xs,C=Ss;r.GetTransform(x,u),a.GetTransform(C,u),B.transformA.Copy(x),B.transformB.Copy(C);const v=Ho;if(ti(v,y,B),v.distance<=0){d.state=m.b2TOIOutputState.e_overlapped,d.t=0;break}if(v.distance<c+_){d.state=m.b2TOIOutputState.e_touching,d.t=u;break}const g=Qo;g.Initialize(y,i,r,n,a,u);let I=!1,P=l,T=0;for(;;){const F=Wo,R=Yo;let E=g.FindMinSeparation(F,R,P);if(E>c+_){d.state=m.b2TOIOutputState.e_separated,d.t=l,I=!0;break}if(E>c-_){u=P;break}let L=g.Evaluate(F[0],R[0],u);if(L<c-_){d.state=m.b2TOIOutputState.e_failed,d.t=u,I=!0;break}if(L<=c+_){d.state=m.b2TOIOutputState.e_touching,d.t=u,I=!0;break}let G=0,X=u,O=P;for(;;){let $=0;G&1?$=X+(c-L)*(O-X)/(E-L):$=.5*(X+O),++G,++m.b2_toiRootIters;const lt=g.Evaluate(F[0],R[0],$);if(at(lt-c)<_){P=$;break}if(lt>c?(X=$,L=lt):(O=$,E=lt),G===50)break}if(m.b2_toiMaxRootIters=H(m.b2_toiMaxRootIters,G),++T,T===o)break}if(++p,++m.b2_toiIters,I)break;if(p===f){d.state=m.b2TOIOutputState.e_failed,d.t=u;break}}m.b2_toiMaxIters=H(m.b2_toiMaxIters,p);const A=e.GetMilliseconds();m.b2_toiMaxTime=H(m.b2_toiMaxTime,A),m.b2_toiTime+=A}const tr=new s,er=new s;function Yi(d,t,e,i,n){d.pointCount=0;const o=M.MulXV(e,t.m_p,tr),r=M.MulXV(n,i.m_p,er),a=s.DistanceSquaredVV(o,r),l=t.m_radius+i.m_radius;a>l*l||(d.type=m.b2ManifoldType.e_circles,d.localPoint.Copy(t.m_p),d.localNormal.SetZero(),d.pointCount=1,d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0)}const sr=new s,ir=new s,nr=new s;function Ki(d,t,e,i,n){d.pointCount=0;const o=M.MulXV(n,i.m_p,sr),r=M.MulTXV(e,o,ir);let a=0,l=-k;const h=t.m_radius+i.m_radius,c=t.m_count,_=t.m_vertices,u=t.m_normals;for(let C=0;C<c;++C){const v=s.DotVV(u[C],s.SubVV(r,_[C],s.s_t0));if(v>h)return;v>l&&(l=v,a=C)}const f=a,p=(f+1)%c,y=_[f],B=_[p];if(l<K){d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,d.localNormal.Copy(u[a]),s.MidVV(y,B,d.localPoint),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0;return}const A=s.DotVV(s.SubVV(r,y,s.s_t0),s.SubVV(B,y,s.s_t1)),x=s.DotVV(s.SubVV(r,B,s.s_t0),s.SubVV(y,B,s.s_t1));if(A<=0){if(s.DistanceSquaredVV(r,y)>h*h)return;d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,s.SubVV(r,y,d.localNormal).SelfNormalize(),d.localPoint.Copy(y),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0}else if(x<=0){if(s.DistanceSquaredVV(r,B)>h*h)return;d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,s.SubVV(r,B,d.localNormal).SelfNormalize(),d.localPoint.Copy(B),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0}else{const C=s.MidVV(y,B,nr);if(s.DotVV(s.SubVV(r,C,s.s_t1),u[f])>h)return;d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,d.localNormal.Copy(u[f]).SelfNormalize(),d.localPoint.Copy(C),d.points[0].localPoint.Copy(i.m_p),d.points[0].id.key=0}}const or=new s,rr=new s,ar=new s,lr=new s;function Cs(d,t,e,i,n){const o=d.m_vertices,r=d.m_normals,a=i.m_count,l=i.m_vertices,h=V.MulRV(t.q,r[e],or),c=V.MulTRV(n.q,h,rr);let _=0,u=k;for(let B=0;B<a;++B){const A=s.DotVV(l[B],c);A<u&&(u=A,_=B)}const f=M.MulXV(t,o[e],ar),p=M.MulXV(n,l[_],lr);return s.DotVV(s.SubVV(p,f,s.s_t0),h)}const mr=new s,_r=new s;function $i(d,t,e,i,n){const o=t.m_count,r=t.m_normals,a=s.SubVV(M.MulXV(n,i.m_centroid,s.s_t0),M.MulXV(e,t.m_centroid,s.s_t1),mr),l=V.MulTRV(e.q,a,_r);let h=0,c=-k;for(let C=0;C<o;++C){const v=s.DotVV(r[C],l);v>c&&(c=v,h=C)}let _=Cs(t,e,h,i,n);const u=(h+o-1)%o,f=Cs(t,e,u,i,n),p=(h+1)%o,y=Cs(t,e,p,i,n);let B=0,A=0,x=0;if(f>_&&f>y)x=-1,B=u,A=f;else if(y>_)x=1,B=p,A=y;else return d[0]=h,_;for(;x===-1?h=(B+o-1)%o:h=(B+1)%o,_=Cs(t,e,h,i,n),_>A;)B=h,A=_;return d[0]=B,A}const hr=new s;function cr(d,t,e,i,n,o){const r=t.m_normals,a=n.m_count,l=n.m_vertices,h=n.m_normals,c=V.MulTRV(o.q,V.MulRV(e.q,r[i],s.s_t0),hr);let _=0,u=k;for(let C=0;C<a;++C){const v=s.DotVV(c,h[C]);v<u&&(u=v,_=C)}const f=_,p=(f+1)%a,y=d[0];M.MulXV(o,l[f],y.v);const B=y.id.cf;B.indexA=i,B.indexB=f,B.typeA=m.b2ContactFeatureType.e_face,B.typeB=m.b2ContactFeatureType.e_vertex;const A=d[1];M.MulXV(o,l[p],A.v);const x=A.id.cf;x.indexA=i,x.indexB=p,x.typeA=m.b2ContactFeatureType.e_face,x.typeB=m.b2ContactFeatureType.e_vertex}const ur=Ce.MakeArray(2),dr=Ce.MakeArray(2),fr=Ce.MakeArray(2),pr=[0],yr=[0],Br=new s,Ar=new s,xr=new s,Sr=new s,Cr=new s,vr=new s,br=new s,Vr=new s;function tn(d,t,e,i,n){d.pointCount=0;const o=t.m_radius+i.m_radius,r=pr;r[0]=0;const a=$i(r,t,e,i,n);if(a>o)return;const l=yr;l[0]=0;const h=$i(l,i,n,t,e);if(h>o)return;let c,_,u,f,p=0,y=0;const B=.98,A=.001;h>B*a+A?(c=i,_=t,u=n,f=e,p=l[0],d.type=m.b2ManifoldType.e_faceB,y=1):(c=t,_=i,u=e,f=n,p=r[0],d.type=m.b2ManifoldType.e_faceA,y=0);const x=ur;cr(x,c,u,p,_,f);const C=c.m_count,v=c.m_vertices,g=p,I=(p+1)%C,P=v[g],T=v[I],F=s.SubVV(T,P,Br);F.Normalize();const R=s.CrossVOne(F,Ar),E=s.MidVV(P,T,xr),L=V.MulRV(u.q,F,Cr),G=s.CrossVOne(L,Sr),X=M.MulXV(u,P,br),O=M.MulXV(u,T,Vr),$=s.DotVV(G,X),lt=-s.DotVV(L,X)+o,_t=s.DotVV(L,O)+o,kt=dr,qt=fr;let zt;const Ue=s.NegV(L,vr);if(zt=Qe(kt,x,Ue,lt,g),zt<2||(zt=Qe(qt,kt,L,_t,I),zt<2))return;d.localNormal.Copy(R),d.localPoint.Copy(E);let Ae=0;for(let Ze=0;Ze<J;++Ze){const Kt=qt[Ze];if(s.DotVV(G,Kt.v)-$<=o){const It=d.points[Ae];if(M.MulTXV(f,Kt.v,It.localPoint),It.id.Copy(Kt.id),y){const pe=It.id.cf;It.id.cf.indexA=pe.indexB,It.id.cf.indexB=pe.indexA,It.id.cf.typeA=pe.typeB,It.id.cf.typeB=pe.typeA}++Ae}}d.pointCount=Ae}const wr=new s,gr=new s,ai=new s,Mr=new s,Pr=new s,Ir=new s,Gr=new s,Dr=new Oe;function li(d,t,e,i,n){d.pointCount=0;const o=M.MulTXV(e,M.MulXV(n,i.m_p,s.s_t0),wr),r=t.m_vertex1,a=t.m_vertex2,l=s.SubVV(a,r,gr),h=s.DotVV(l,s.SubVV(a,o,s.s_t0)),c=s.DotVV(l,s.SubVV(o,r,s.s_t0)),_=t.m_radius+i.m_radius,u=Dr;if(u.cf.indexB=0,u.cf.typeB=m.b2ContactFeatureType.e_vertex,c<=0){const x=r,C=s.SubVV(o,x,ai);if(s.DotVV(C,C)>_*_)return;if(t.m_hasVertex0){const g=t.m_vertex0,I=r,P=s.SubVV(I,g,Mr);if(s.DotVV(P,s.SubVV(I,o,s.s_t0))>0)return}u.cf.indexA=0,u.cf.typeA=m.b2ContactFeatureType.e_vertex,d.pointCount=1,d.type=m.b2ManifoldType.e_circles,d.localNormal.SetZero(),d.localPoint.Copy(x),d.points[0].id.Copy(u),d.points[0].localPoint.Copy(i.m_p);return}if(h<=0){const x=a,C=s.SubVV(o,x,ai);if(s.DotVV(C,C)>_*_)return;if(t.m_hasVertex3){const g=t.m_vertex3,I=a,P=s.SubVV(g,I,Pr);if(s.DotVV(P,s.SubVV(o,I,s.s_t0))>0)return}u.cf.indexA=1,u.cf.typeA=m.b2ContactFeatureType.e_vertex,d.pointCount=1,d.type=m.b2ManifoldType.e_circles,d.localNormal.SetZero(),d.localPoint.Copy(x),d.points[0].id.Copy(u),d.points[0].localPoint.Copy(i.m_p);return}const f=s.DotVV(l,l),p=Ir;p.x=1/f*(h*r.x+c*a.x),p.y=1/f*(h*r.y+c*a.y);const y=s.SubVV(o,p,ai);if(s.DotVV(y,y)>_*_)return;const A=Gr.Set(-l.y,l.x);s.DotVV(A,s.SubVV(o,r,s.s_t0))<0&&A.Set(-A.x,-A.y),A.Normalize(),u.cf.indexA=0,u.cf.typeA=m.b2ContactFeatureType.e_face,d.pointCount=1,d.type=m.b2ManifoldType.e_faceA,d.localNormal.Copy(A),d.localPoint.Copy(r),d.points[0].id.Copy(u),d.points[0].localPoint.Copy(i.m_p)}var ie;(function(d){d[d.e_unknown=0]="e_unknown",d[d.e_edgeA=1]="e_edgeA",d[d.e_edgeB=2]="e_edgeB"})(ie||(ie={}));class en{constructor(){this.type=ie.e_unknown,this.index=0,this.separation=0}}class Fr{constructor(){this.vertices=[],this.normals=[],this.count=0}}class Lr{constructor(){this.i1=0,this.i2=0,this.v1=new s,this.v2=new s,this.normal=new s,this.sideNormal1=new s,this.sideOffset1=0,this.sideNormal2=new s,this.sideOffset2=0}}var vs;(function(d){d[d.e_isolated=0]="e_isolated",d[d.e_concave=1]="e_concave",d[d.e_convex=2]="e_convex"})(vs||(vs={}));class Bt{constructor(){this.m_polygonB=new Fr,this.m_xf=new M,this.m_centroidB=new s,this.m_v0=new s,this.m_v1=new s,this.m_v2=new s,this.m_v3=new s,this.m_normal0=new s,this.m_normal1=new s,this.m_normal2=new s,this.m_normal=new s,this.m_type1=vs.e_isolated,this.m_type2=vs.e_isolated,this.m_lowerLimit=new s,this.m_upperLimit=new s,this.m_radius=0,this.m_front=!1}Collide(t,e,i,n,o){M.MulTXX(i,o,this.m_xf),M.MulXV(this.m_xf,n.m_centroid,this.m_centroidB),this.m_v0.Copy(e.m_vertex0),this.m_v1.Copy(e.m_vertex1),this.m_v2.Copy(e.m_vertex2),this.m_v3.Copy(e.m_vertex3);const r=e.m_hasVertex0,a=e.m_hasVertex3,l=s.SubVV(this.m_v2,this.m_v1,Bt.s_edge1);l.Normalize(),this.m_normal1.Set(l.y,-l.x);const h=s.DotVV(this.m_normal1,s.SubVV(this.m_centroidB,this.m_v1,s.s_t0));let c=0,_=0,u=!1,f=!1;if(r){const F=s.SubVV(this.m_v1,this.m_v0,Bt.s_edge0);F.Normalize(),this.m_normal0.Set(F.y,-F.x),u=s.CrossVV(F,l)>=0,c=s.DotVV(this.m_normal0,s.SubVV(this.m_centroidB,this.m_v0,s.s_t0))}if(a){const F=s.SubVV(this.m_v3,this.m_v2,Bt.s_edge2);F.Normalize(),this.m_normal2.Set(F.y,-F.x),f=s.CrossVV(l,F)>0,_=s.DotVV(this.m_normal2,s.SubVV(this.m_centroidB,this.m_v2,s.s_t0))}r&&a?u&&f?(this.m_front=c>=0||h>=0||_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):u?(this.m_front=c>=0||h>=0&&_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):f?(this.m_front=_>=0||c>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=c>=0&&h>=0&&_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):r?u?(this.m_front=c>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=c>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):a?f?(this.m_front=h>=0||_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=n.m_count;for(let F=0;F<n.m_count;++F)this.m_polygonB.vertices.length<=F&&this.m_polygonB.vertices.push(new s),this.m_polygonB.normals.length<=F&&this.m_polygonB.normals.push(new s),M.MulXV(this.m_xf,n.m_vertices[F],this.m_polygonB.vertices[F]),V.MulRV(this.m_xf.q,n.m_normals[F],this.m_polygonB.normals[F]);this.m_radius=n.m_radius+e.m_radius,t.pointCount=0;const p=this.ComputeEdgeSeparation(Bt.s_edgeAxis);if(p.type===ie.e_unknown||p.separation>this.m_radius)return;const y=this.ComputePolygonSeparation(Bt.s_polygonAxis);if(y.type!==ie.e_unknown&&y.separation>this.m_radius)return;const B=.98,A=.001;let x;y.type===ie.e_unknown?x=p:y.separation>B*p.separation+A?x=y:x=p;const C=Bt.s_ie,v=Bt.s_rf;if(x.type===ie.e_edgeA){t.type=m.b2ManifoldType.e_faceA;let F=0,R=s.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(let O=1;O<this.m_polygonB.count;++O){const $=s.DotVV(this.m_normal,this.m_polygonB.normals[O]);$<R&&(R=$,F=O)}const E=F,L=(E+1)%this.m_polygonB.count,G=C[0];G.v.Copy(this.m_polygonB.vertices[E]),G.id.cf.indexA=0,G.id.cf.indexB=E,G.id.cf.typeA=m.b2ContactFeatureType.e_face,G.id.cf.typeB=m.b2ContactFeatureType.e_vertex;const X=C[1];X.v.Copy(this.m_polygonB.vertices[L]),X.id.cf.indexA=0,X.id.cf.indexB=L,X.id.cf.typeA=m.b2ContactFeatureType.e_face,X.id.cf.typeB=m.b2ContactFeatureType.e_vertex,this.m_front?(v.i1=0,v.i2=1,v.v1.Copy(this.m_v1),v.v2.Copy(this.m_v2),v.normal.Copy(this.m_normal1)):(v.i1=1,v.i2=0,v.v1.Copy(this.m_v2),v.v2.Copy(this.m_v1),v.normal.Copy(this.m_normal1).SelfNeg())}else{t.type=m.b2ManifoldType.e_faceB;const F=C[0];F.v.Copy(this.m_v1),F.id.cf.indexA=0,F.id.cf.indexB=x.index,F.id.cf.typeA=m.b2ContactFeatureType.e_vertex,F.id.cf.typeB=m.b2ContactFeatureType.e_face;const R=C[1];R.v.Copy(this.m_v2),R.id.cf.indexA=0,R.id.cf.indexB=x.index,R.id.cf.typeA=m.b2ContactFeatureType.e_vertex,R.id.cf.typeB=m.b2ContactFeatureType.e_face,v.i1=x.index,v.i2=(v.i1+1)%this.m_polygonB.count,v.v1.Copy(this.m_polygonB.vertices[v.i1]),v.v2.Copy(this.m_polygonB.vertices[v.i2]),v.normal.Copy(this.m_polygonB.normals[v.i1])}v.sideNormal1.Set(v.normal.y,-v.normal.x),v.sideNormal2.Copy(v.sideNormal1).SelfNeg(),v.sideOffset1=s.DotVV(v.sideNormal1,v.v1),v.sideOffset2=s.DotVV(v.sideNormal2,v.v2);const g=Bt.s_clipPoints1,I=Bt.s_clipPoints2;let P=0;if(P=Qe(g,C,v.sideNormal1,v.sideOffset1,v.i1),P<J||(P=Qe(I,g,v.sideNormal2,v.sideOffset2,v.i2),P<J))return;x.type===ie.e_edgeA?(t.localNormal.Copy(v.normal),t.localPoint.Copy(v.v1)):(t.localNormal.Copy(n.m_normals[v.i1]),t.localPoint.Copy(n.m_vertices[v.i1]));let T=0;for(let F=0;F<J;++F){let R;if(R=s.DotVV(v.normal,s.SubVV(I[F].v,v.v1,s.s_t0)),R<=this.m_radius){const E=t.points[T];x.type===ie.e_edgeA?(M.MulTXV(this.m_xf,I[F].v,E.localPoint),E.id.Copy(I[F].id)):(E.localPoint.Copy(I[F].v),E.id.cf.typeA=I[F].id.cf.typeB,E.id.cf.typeB=I[F].id.cf.typeA,E.id.cf.indexA=I[F].id.cf.indexB,E.id.cf.indexB=I[F].id.cf.indexA),++T}}t.pointCount=T}ComputeEdgeSeparation(t){const e=t;e.type=ie.e_edgeA,e.index=this.m_front?0:1,e.separation=k;for(let i=0;i<this.m_polygonB.count;++i){const n=s.DotVV(this.m_normal,s.SubVV(this.m_polygonB.vertices[i],this.m_v1,s.s_t0));n<e.separation&&(e.separation=n)}return e}ComputePolygonSeparation(t){const e=t;e.type=ie.e_unknown,e.index=-1,e.separation=-k;const i=Bt.s_perp.Set(-this.m_normal.y,this.m_normal.x);for(let n=0;n<this.m_polygonB.count;++n){const o=s.NegV(this.m_polygonB.normals[n],Bt.s_n),r=s.DotVV(o,s.SubVV(this.m_polygonB.vertices[n],this.m_v1,s.s_t0)),a=s.DotVV(o,s.SubVV(this.m_polygonB.vertices[n],this.m_v2,s.s_t0)),l=tt(r,a);if(l>this.m_radius)return e.type=ie.e_edgeB,e.index=n,e.separation=l,e;if(s.DotVV(o,i)>=0){if(s.DotVV(s.SubVV(o,this.m_upperLimit,s.s_t0),this.m_normal)<-At)continue}else if(s.DotVV(s.SubVV(o,this.m_lowerLimit,s.s_t0),this.m_normal)<-At)continue;l>e.separation&&(e.type=ie.e_edgeB,e.index=n,e.separation=l)}return e}}Bt.s_edge1=new s,Bt.s_edge0=new s,Bt.s_edge2=new s,Bt.s_ie=Ce.MakeArray(2),Bt.s_rf=new Lr,Bt.s_clipPoints1=Ce.MakeArray(2),Bt.s_clipPoints2=Ce.MakeArray(2),Bt.s_edgeAxis=new en,Bt.s_polygonAxis=new en,Bt.s_n=new s,Bt.s_perp=new s;const Tr=new Bt;function mi(d,t,e,i,n){Tr.Collide(d,t,e,i,n)}class bs{constructor(){this.mass=0,this.center=new s(0,0),this.I=0}}(function(d){d[d.e_unknown=-1]="e_unknown",d[d.e_circleShape=0]="e_circleShape",d[d.e_edgeShape=1]="e_edgeShape",d[d.e_polygonShape=2]="e_polygonShape",d[d.e_chainShape=3]="e_chainShape",d[d.e_shapeTypeCount=4]="e_shapeTypeCount"})(m.b2ShapeType||(m.b2ShapeType={}));class Fe{constructor(t,e){this.m_type=m.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=t,this.m_radius=e}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class Ot extends Fe{constructor(t=0){super(m.b2ShapeType.e_circleShape,t),this.m_p=new s}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return new Ot().Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=M.MulXV(t,this.m_p,Ot.TestPoint_s_center),n=s.SubVV(e,i,Ot.TestPoint_s_d);return s.DotVV(n,n)<=Ne(this.m_radius)}ComputeDistance(t,e,i,n){const o=M.MulXV(t,this.m_p,Ot.ComputeDistance_s_center);return s.SubVV(e,o,i),i.Normalize()-this.m_radius}RayCast(t,e,i,n){const o=M.MulXV(i,this.m_p,Ot.RayCast_s_position),r=s.SubVV(e.p1,o,Ot.RayCast_s_s),a=s.DotVV(r,r)-Ne(this.m_radius),l=s.SubVV(e.p2,e.p1,Ot.RayCast_s_r),h=s.DotVV(r,l),c=s.DotVV(l,l),_=h*h-c*a;if(_<0||c<K)return!1;let u=-(h+ye(_));return 0<=u&&u<=e.maxFraction*c?(u/=c,t.fraction=u,s.AddVMulSV(r,u,l,t.normal).SelfNormalize(),!0):!1}ComputeAABB(t,e,i){const n=M.MulXV(e,this.m_p,Ot.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)}ComputeMass(t,e){const i=Ne(this.m_radius);t.mass=e*q*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+s.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const o=M.MulXV(i,this.m_p,new s),r=-(s.DotVV(t,o)-e);if(r<-this.m_radius+K)return 0;if(r>this.m_radius)return n.Copy(o),q*this.m_radius*this.m_radius;const a=this.m_radius*this.m_radius,l=r*r,h=a*(zi(r/this.m_radius)+q/2)+r*ye(a-l),c=-2/3*qi(a-l,1.5)/h;return n.x=o.x+t.x*c,n.y=o.y+t.y*c,h}Dump(t){t(`    const shape: b2CircleShape = new b2CircleShape();
`),t(`    shape.m_radius = %.15f;
`,this.m_radius),t(`    shape.m_p.Set(%.15f, %.15f);
`,this.m_p.x,this.m_p.y)}}Ot.TestPoint_s_center=new s,Ot.TestPoint_s_d=new s,Ot.ComputeDistance_s_center=new s,Ot.RayCast_s_position=new s,Ot.RayCast_s_s=new s,Ot.RayCast_s_r=new s,Ot.ComputeAABB_s_p=new s;class Z extends Fe{constructor(){super(m.b2ShapeType.e_polygonShape,xt),this.m_centroid=new s(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return new Z().Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=s.MakeArray(this.m_count),this.m_normals=s.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if(typeof t[0][0]=="number"){const e=t[0];if(e.length%2!==0)throw new Error;return this._Set(i=>({x:e[i*2],y:e[i*2+1]}),e.length/2)}else{const e=t[0],i=t[1]||e.length;return this._Set(n=>e[n],i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const n=[];for(let c=0;c<i;++c){const _=t(c);let u=!0;for(let f=0;f<n.length;++f)if(s.DistanceSquaredVV(_,n[f])<.5*j*(.5*j)){u=!1;break}u&&n.push(_)}if(i=n.length,i<3)return this.SetAsBox(1,1);let o=0,r=n[0].x;for(let c=1;c<i;++c){const _=n[c].x;(_>r||_===r&&n[c].y<n[o].y)&&(o=c,r=_)}const a=[];let l=0,h=o;for(;;){a[l]=h;let c=0;for(let _=1;_<i;++_){if(c===h){c=_;continue}const u=s.SubVV(n[c],n[a[l]],Z.Set_s_r),f=s.SubVV(n[_],n[a[l]],Z.Set_s_v),p=s.CrossVV(u,f);p<0&&(c=_),p===0&&f.LengthSquared()>u.LengthSquared()&&(c=_)}if(++l,h=c,c===o)break}this.m_count=l,this.m_vertices=s.MakeArray(this.m_count),this.m_normals=s.MakeArray(this.m_count);for(let c=0;c<l;++c)this.m_vertices[c].Copy(n[a[c]]);for(let c=0;c<l;++c){const _=this.m_vertices[c],u=this.m_vertices[(c+1)%l],f=s.SubVV(u,_,s.s_t0);s.CrossVOne(f,this.m_normals[c]).SelfNormalize()}return Z.ComputeCentroid(this.m_vertices,l,this.m_centroid),this}SetAsBox(t,e,i,n=0){if(this.m_count=4,this.m_vertices=s.MakeArray(this.m_count),this.m_normals=s.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const o=new M;o.SetPosition(i),o.SetRotationAngle(n);for(let r=0;r<this.m_count;++r)M.MulXV(o,this.m_vertices[r],this.m_vertices[r]),V.MulRV(o.q,this.m_normals[r],this.m_normals[r])}return this}TestPoint(t,e){const i=M.MulTXV(t,e,Z.TestPoint_s_pLocal);for(let n=0;n<this.m_count;++n)if(s.DotVV(this.m_normals[n],s.SubVV(i,this.m_vertices[n],s.s_t0))>0)return!1;return!0}ComputeDistance(t,e,i,n){const o=M.MulTXV(t,e,Z.ComputeDistance_s_pLocal);let r=-k;const a=Z.ComputeDistance_s_normalForMaxDistance.Copy(o);for(let l=0;l<this.m_count;++l){const h=s.DotVV(this.m_normals[l],s.SubVV(o,this.m_vertices[l],s.s_t0));h>r&&(r=h,a.Copy(this.m_normals[l]))}if(r>0){const l=Z.ComputeDistance_s_minDistance.Copy(a);let h=r*r;for(let c=0;c<this.m_count;++c){const _=s.SubVV(o,this.m_vertices[c],Z.ComputeDistance_s_distance),u=_.LengthSquared();h>u&&(l.Copy(_),h=u)}return V.MulRV(t.q,l,i),i.Normalize(),Math.sqrt(h)}else return V.MulRV(t.q,a,i),r}RayCast(t,e,i,n){const o=M.MulTXV(i,e.p1,Z.RayCast_s_p1),r=M.MulTXV(i,e.p2,Z.RayCast_s_p2),a=s.SubVV(r,o,Z.RayCast_s_d);let l=0,h=e.maxFraction,c=-1;for(let _=0;_<this.m_count;++_){const u=s.DotVV(this.m_normals[_],s.SubVV(this.m_vertices[_],o,s.s_t0)),f=s.DotVV(this.m_normals[_],a);if(f===0){if(u<0)return!1}else f<0&&u<l*f?(l=u/f,c=_):f>0&&u<h*f&&(h=u/f);if(h<l)return!1}return c>=0?(t.fraction=l,V.MulRV(i.q,this.m_normals[c],t.normal),!0):!1}ComputeAABB(t,e,i){const n=M.MulXV(e,this.m_vertices[0],t.lowerBound),o=t.upperBound.Copy(n);for(let a=0;a<this.m_count;++a){const l=M.MulXV(e,this.m_vertices[a],Z.ComputeAABB_s_v);s.MinV(l,n,n),s.MaxV(l,o,o)}const r=this.m_radius;n.SelfSubXY(r,r),o.SelfAddXY(r,r)}ComputeMass(t,e){const i=Z.ComputeMass_s_center.SetZero();let n=0,o=0;const r=Z.ComputeMass_s_s.SetZero();for(let l=0;l<this.m_count;++l)r.SelfAdd(this.m_vertices[l]);r.SelfMul(1/this.m_count);const a=1/3;for(let l=0;l<this.m_count;++l){const h=s.SubVV(this.m_vertices[l],r,Z.ComputeMass_s_e1),c=s.SubVV(this.m_vertices[(l+1)%this.m_count],r,Z.ComputeMass_s_e2),_=s.CrossVV(h,c),u=.5*_;n+=u,i.SelfAdd(s.MulSV(u*a,s.AddVV(h,c,s.s_t0),s.s_t1));const f=h.x,p=h.y,y=c.x,B=c.y,A=f*f+y*f+y*y,x=p*p+B*p+B*B;o+=.25*a*_*(A+x)}t.mass=e*n,i.SelfMul(1/n),s.AddVV(i,r,t.center),t.I=e*o,t.I+=t.mass*(s.DotVV(t.center,t.center)-s.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,n=this.m_vertices[e],o=s.SubVV(this.m_vertices[i],n,Z.Validate_s_e);for(let r=0;r<this.m_count;++r){if(r===e||r===i)continue;const a=s.SubVV(this.m_vertices[r],n,Z.Validate_s_v);if(s.CrossVV(o,a)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const o=V.MulTRV(i.q,t,Z.ComputeSubmergedArea_s_normalL),r=e-s.DotVV(t,i.p),a=[];let l=0,h=-1,c=-1,_=!1;for(let P=0;P<this.m_count;++P){a[P]=s.DotVV(o,this.m_vertices[P])-r;const T=a[P]<-K;P>0&&(T?_||(h=P-1,l++):_&&(c=P-1,l++)),_=T}switch(l){case 0:if(_){const P=Z.ComputeSubmergedArea_s_md;return this.ComputeMass(P,1),M.MulXV(i,P.center,n),P.mass}else return 0;case 1:h===-1?h=this.m_count-1:c=this.m_count-1;break}const u=(h+1)%this.m_count,f=(c+1)%this.m_count,p=(0-a[h])/(a[u]-a[h]),y=(0-a[c])/(a[f]-a[c]),B=Z.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[h].x*(1-p)+this.m_vertices[u].x*p,this.m_vertices[h].y*(1-p)+this.m_vertices[u].y*p),A=Z.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[c].x*(1-y)+this.m_vertices[f].x*y,this.m_vertices[c].y*(1-y)+this.m_vertices[f].y*y);let x=0;const C=Z.ComputeSubmergedArea_s_center.SetZero();let v=this.m_vertices[u],g,I=u;for(;I!==f;){I=(I+1)%this.m_count,I===f?g=A:g=this.m_vertices[I];const P=.5*((v.x-B.x)*(g.y-B.y)-(v.y-B.y)*(g.x-B.x));x+=P,C.x+=P*(B.x+v.x+g.x)/3,C.y+=P*(B.y+v.y+g.y)/3,v=g}return C.SelfMul(1/x),M.MulXV(i,C,n),x}Dump(t){t(`    const shape: b2PolygonShape = new b2PolygonShape();
`),t(`    const vs: b2Vec2[] = [];
`);for(let e=0;e<this.m_count;++e)t(`    vs[%d] = new b2Vec2(%.15f, %.15f);
`,e,this.m_vertices[e].x,this.m_vertices[e].y);t(`    shape.Set(vs, %d);
`,this.m_count)}static ComputeCentroid(t,e,i){const n=i;n.SetZero();let o=0;const r=Z.ComputeCentroid_s_pRef.SetZero(),a=1/3;for(let l=0;l<e;++l){const h=r,c=t[l],_=t[(l+1)%e],u=s.SubVV(c,h,Z.ComputeCentroid_s_e1),f=s.SubVV(_,h,Z.ComputeCentroid_s_e2),p=s.CrossVV(u,f),y=.5*p;o+=y,n.x+=y*a*(h.x+c.x+_.x),n.y+=y*a*(h.y+c.y+_.y)}return n.SelfMul(1/o),n}}Z.Set_s_r=new s,Z.Set_s_v=new s,Z.TestPoint_s_pLocal=new s,Z.ComputeDistance_s_pLocal=new s,Z.ComputeDistance_s_normalForMaxDistance=new s,Z.ComputeDistance_s_minDistance=new s,Z.ComputeDistance_s_distance=new s,Z.RayCast_s_p1=new s,Z.RayCast_s_p2=new s,Z.RayCast_s_d=new s,Z.ComputeAABB_s_v=new s,Z.ComputeMass_s_center=new s,Z.ComputeMass_s_s=new s,Z.ComputeMass_s_e1=new s,Z.ComputeMass_s_e2=new s,Z.Validate_s_e=new s,Z.Validate_s_v=new s,Z.ComputeSubmergedArea_s_normalL=new s,Z.ComputeSubmergedArea_s_md=new bs,Z.ComputeSubmergedArea_s_intoVec=new s,Z.ComputeSubmergedArea_s_outoVec=new s,Z.ComputeSubmergedArea_s_center=new s,Z.ComputeCentroid_s_pRef=new s,Z.ComputeCentroid_s_e1=new s,Z.ComputeCentroid_s_e2=new s;class nt extends Fe{constructor(){super(m.b2ShapeType.e_edgeShape,xt),this.m_vertex1=new s,this.m_vertex2=new s,this.m_vertex0=new s,this.m_vertex3=new s,this.m_hasVertex0=!1,this.m_hasVertex3=!1}Set(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}Clone(){return new nt().Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const o=M.MulXV(t,this.m_vertex1,nt.ComputeDistance_s_v1),r=M.MulXV(t,this.m_vertex2,nt.ComputeDistance_s_v2),a=s.SubVV(e,o,nt.ComputeDistance_s_d),l=s.SubVV(r,o,nt.ComputeDistance_s_s),h=s.DotVV(a,l);if(h>0){const c=s.DotVV(l,l);h>c?s.SubVV(e,r,a):a.SelfMulSub(h/c,l)}return i.Copy(a),i.Normalize()}RayCast(t,e,i,n){const o=M.MulTXV(i,e.p1,nt.RayCast_s_p1),r=M.MulTXV(i,e.p2,nt.RayCast_s_p2),a=s.SubVV(r,o,nt.RayCast_s_d),l=this.m_vertex1,h=this.m_vertex2,c=s.SubVV(h,l,nt.RayCast_s_e),_=t.normal.Set(c.y,-c.x).SelfNormalize(),u=s.DotVV(_,s.SubVV(l,o,s.s_t0)),f=s.DotVV(_,a);if(f===0)return!1;const p=u/f;if(p<0||e.maxFraction<p)return!1;const y=s.AddVMulSV(o,p,a,nt.RayCast_s_q),B=s.SubVV(h,l,nt.RayCast_s_r),A=s.DotVV(B,B);if(A===0)return!1;const x=s.DotVV(s.SubVV(y,l,s.s_t0),B)/A;return x<0||1<x?!1:(t.fraction=p,V.MulRV(i.q,t.normal,t.normal),u>0&&t.normal.SelfNeg(),!0)}ComputeAABB(t,e,i){const n=M.MulXV(e,this.m_vertex1,nt.ComputeAABB_s_v1),o=M.MulXV(e,this.m_vertex2,nt.ComputeAABB_s_v2);s.MinV(n,o,t.lowerBound),s.MaxV(n,o,t.upperBound);const r=this.m_radius;t.lowerBound.SelfSubXY(r,r),t.upperBound.SelfAddXY(r,r)}ComputeMass(t,e){t.mass=0,s.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t(`    const shape: b2EdgeShape = new b2EdgeShape();
`),t(`    shape.m_radius = %.15f;
`,this.m_radius),t(`    shape.m_vertex0.Set(%.15f, %.15f);
`,this.m_vertex0.x,this.m_vertex0.y),t(`    shape.m_vertex1.Set(%.15f, %.15f);
`,this.m_vertex1.x,this.m_vertex1.y),t(`    shape.m_vertex2.Set(%.15f, %.15f);
`,this.m_vertex2.x,this.m_vertex2.y),t(`    shape.m_vertex3.Set(%.15f, %.15f);
`,this.m_vertex3.x,this.m_vertex3.y),t(`    shape.m_hasVertex0 = %s;
`,this.m_hasVertex0),t(`    shape.m_hasVertex3 = %s;
`,this.m_hasVertex3)}}nt.ComputeDistance_s_v1=new s,nt.ComputeDistance_s_v2=new s,nt.ComputeDistance_s_d=new s,nt.ComputeDistance_s_s=new s,nt.RayCast_s_p1=new s,nt.RayCast_s_p2=new s,nt.RayCast_s_d=new s,nt.RayCast_s_e=new s,nt.RayCast_s_q=new s,nt.RayCast_s_r=new s,nt.ComputeAABB_s_v1=new s,nt.ComputeAABB_s_v2=new s;class fe extends Fe{constructor(){super(m.b2ShapeType.e_chainShape,xt),this.m_vertices=[],this.m_count=0,this.m_prevVertex=new s,this.m_nextVertex=new s,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1}CreateLoop(...t){if(typeof t[0][0]=="number"){const e=t[0];if(e.length%2!==0)throw new Error;return this._CreateLoop(i=>({x:e[i*2],y:e[i*2+1]}),e.length/2)}else{const e=t[0],i=t[1]||e.length;return this._CreateLoop(n=>e[n],i)}}_CreateLoop(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=s.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}CreateChain(...t){if(typeof t[0][0]=="number"){const e=t[0];if(e.length%2!==0)throw new Error;return this._CreateChain(i=>({x:e[i*2],y:e[i*2+1]}),e.length/2)}else{const e=t[0],i=t[1]||e.length;return this._CreateChain(n=>e[n],i)}}_CreateChain(t,e){this.m_count=e,this.m_vertices=s.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}SetPrevVertex(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this}SetNextVertex(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this}Clone(){return new fe().Copy(this)}Copy(t){return super.Copy(t),this._CreateChain(e=>t.m_vertices[e],t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const o=fe.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,n),o.ComputeDistance(t,e,i,0)}RayCast(t,e,i,n){const o=fe.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[n]),o.m_vertex2.Copy(this.m_vertices[(n+1)%this.m_count]),o.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const n=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],r=M.MulXV(e,n,fe.ComputeAABB_s_v1),a=M.MulXV(e,o,fe.ComputeAABB_s_v2);s.MinV(r,a,t.lowerBound),s.MaxV(r,a,t.upperBound)}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t(`    const shape: b2ChainShape = new b2ChainShape();
`),t(`    const vs: b2Vec2[] = [];
`);for(let e=0;e<this.m_count;++e)t(`    vs[%d] = new bVec2(%.15f, %.15f);
`,e,this.m_vertices[e].x,this.m_vertices[e].y);t(`    shape.CreateChain(vs, %d);
`,this.m_count),t(`    shape.m_prevVertex.Set(%.15f, %.15f);
`,this.m_prevVertex.x,this.m_prevVertex.y),t(`    shape.m_nextVertex.Set(%.15f, %.15f);
`,this.m_nextVertex.x,this.m_nextVertex.y),t(`    shape.m_hasPrevVertex = %s;
`,this.m_hasPrevVertex?"true":"false"),t(`    shape.m_hasNextVertex = %s;
`,this.m_hasNextVertex?"true":"false")}}fe.ComputeDistance_s_edgeShape=new nt,fe.RayCast_s_edgeShape=new nt,fe.ComputeAABB_s_v1=new s,fe.ComputeAABB_s_v2=new s;class Ge{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return new Ge().Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}Ge.DEFAULT=new Ge;class sn{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new Ge}}class Le{constructor(t,e){this.aabb=new Tt,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e,i){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{const n=Le.Synchronize_s_aabb1,o=Le.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(n,t,this.childIndex),this.fixture.m_shape.ComputeAABB(o,e,this.childIndex),this.aabb.Combine2(n,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}}}Le.Synchronize_s_aabb1=new Tt,Le.Synchronize_s_aabb2=new Tt;class nn{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new Ge,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=b(e.userData,null),this.m_friction=b(e.friction,.2),this.m_restitution=b(e.restitution,0),this.m_filter.Copy(b(e.filter,Ge.DEFAULT)),this.m_isSensor=b(e.isSensor,!1),this.m_density=b(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();(i===this||n===this)&&e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new bs){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t(`    const fd: b2FixtureDef = new b2FixtureDef();
`),t(`    fd.friction = %.15f;
`,this.m_friction),t(`    fd.restitution = %.15f;
`,this.m_restitution),t(`    fd.density = %.15f;
`,this.m_density),t(`    fd.isSensor = %s;
`,this.m_isSensor?"true":"false"),t(`    fd.filter.categoryBits = %d;
`,this.m_filter.categoryBits),t(`    fd.filter.maskBits = %d;
`,this.m_filter.maskBits),t(`    fd.filter.groupIndex = %d;
`,this.m_filter.groupIndex),this.m_shape.Dump(t),t(`
`),t(`    fd.shape = shape;
`),t(`
`),t(`    bodies[%d].CreateFixture(fd);
`,e)}CreateProxies(){if(this.m_proxies.length!==0)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new Le(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}SynchronizeProxies(t,e,i){for(const n of this.m_proxies)n.Synchronize(t,e,i)}}(function(d){d[d.b2_unknown=-1]="b2_unknown",d[d.b2_staticBody=0]="b2_staticBody",d[d.b2_kinematicBody=1]="b2_kinematicBody",d[d.b2_dynamicBody=2]="b2_dynamicBody"})(m.b2BodyType||(m.b2BodyType={}));class Rr{constructor(){this.type=m.b2BodyType.b2_staticBody,this.position=new s(0,0),this.angle=0,this.linearVelocity=new s(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}}class Jt{constructor(t,e){this.m_type=m.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new M,this.m_xf0=new M,this.m_sweep=new se,this.m_linearVelocity=new s,this.m_angularVelocity=0,this.m_force=new s,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=b(t.bullet,!1),this.m_fixedRotationFlag=b(t.fixedRotation,!1),this.m_autoSleepFlag=b(t.allowSleep,!0),this.m_awakeFlag=b(t.awake,!0),this.m_activeFlag=b(t.active,!0),this.m_world=e,this.m_xf.p.Copy(b(t.position,s.ZERO)),this.m_xf.q.SetAngle(b(t.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(b(t.linearVelocity,s.ZERO)),this.m_angularVelocity=b(t.angularVelocity,0),this.m_linearDamping=b(t.linearDamping,0),this.m_angularDamping=b(t.angularDamping,0),this.m_gravityScale=b(t.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=b(t.type,m.b2BodyType.b2_staticBody),t.type===m.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e=0){return t instanceof Fe?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new nn(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e}CreateFixtureShapeDensity(t,e=0){const i=Jt.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;e!==null;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let n=this.m_contactList;for(;n;){const o=n.contact;n=n.next;const r=o.GetFixtureA(),a=o.GetFixtureB();(t===r||t===a)&&this.m_world.m_contactManager.Destroy(o)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),M.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(this.m_xf,this.m_xf,s.ZERO);this.m_world.m_contactManager.FindNewContacts()}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(t){this.m_type!==m.b2BodyType.b2_staticBody&&(s.DotVV(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(t){this.m_type!==m.b2BodyType.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(t,e,i=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))}ApplyForceToCenter(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))}ApplyTorque(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))}ApplyLinearImpulse(t,e,i=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)))}ApplyLinearImpulseToCenter(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))}ApplyAngularImpulse(t,e=!0){this.m_type===m.b2BodyType.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*s.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*s.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==m.b2BodyType.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&!this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*s.DotVV(t.center,t.center),this.m_invI=1/this.m_I);const e=Jt.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t.center),M.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(this.m_sweep.c,e,s.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===m.b2BodyType.b2_staticBody||this.m_type===m.b2BodyType.b2_kinematicBody){this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a;return}const t=Jt.ResetMassData_s_localCenter.SetZero();for(let i=this.m_fixtureList;i;i=i.m_next){if(i.m_density===0)continue;const n=i.GetMassData(Jt.ResetMassData_s_massData);this.m_mass+=n.mass,t.x+=n.center.x*n.mass,t.y+=n.center.y*n.mass,this.m_I+=n.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,t.x*=this.m_invMass,t.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*s.DotVV(t,t),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const e=Jt.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t),M.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(this.m_sweep.c,e,s.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return M.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return V.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return M.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return V.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(t,this.m_sweep.c,s.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t)return;this.m_type=t,this.ResetMassData(),this.m_type===m.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let e=this.m_contactList;for(;e;){const i=e;e=e.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(let i=this.m_fixtureList;i;i=i.m_next)i.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}IsAwake(){return this.m_awakeFlag}SetActive(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(let e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(let i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxies();let e=this.m_contactList;for(;e;){const i=e;e=e.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null}}IsActive(){return this.m_activeFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(t){const e=this.m_islandIndex;t(`{
`),t(`  const bd: b2BodyDef = new b2BodyDef();
`);let i="";switch(this.m_type){case m.b2BodyType.b2_staticBody:i="b2BodyType.b2_staticBody";break;case m.b2BodyType.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case m.b2BodyType.b2_dynamicBody:i="b2BodyType.b2_dynamicBody";break}t(`  bd.type = %s;
`,i),t(`  bd.position.Set(%.15f, %.15f);
`,this.m_xf.p.x,this.m_xf.p.y),t(`  bd.angle = %.15f;
`,this.m_sweep.a),t(`  bd.linearVelocity.Set(%.15f, %.15f);
`,this.m_linearVelocity.x,this.m_linearVelocity.y),t(`  bd.angularVelocity = %.15f;
`,this.m_angularVelocity),t(`  bd.linearDamping = %.15f;
`,this.m_linearDamping),t(`  bd.angularDamping = %.15f;
`,this.m_angularDamping),t(`  bd.allowSleep = %s;
`,this.m_autoSleepFlag?"true":"false"),t(`  bd.awake = %s;
`,this.m_awakeFlag?"true":"false"),t(`  bd.fixedRotation = %s;
`,this.m_fixedRotationFlag?"true":"false"),t(`  bd.bullet = %s;
`,this.m_bulletFlag?"true":"false"),t(`  bd.active = %s;
`,this.m_activeFlag?"true":"false"),t(`  bd.gravityScale = %.15f;
`,this.m_gravityScale),t(`
`),t(`  bodies[%d] = this.m_world.CreateBody(bd);
`,this.m_islandIndex),t(`
`);for(let n=this.m_fixtureList;n;n=n.m_next)t(`  {
`),n.Dump(t,e),t(`  }
`);t(`}
`)}SynchronizeFixtures(){const t=Jt.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),V.MulRV(t.q,this.m_sweep.localCenter,t.p),s.SubVV(this.m_sweep.c0,t.p,t.p);const e=s.SubVV(this.m_sweep.c,this.m_sweep.c0,Jt.SynchronizeFixtures_s_displacement);for(let i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,e)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),V.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),s.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(t){return this.m_type===m.b2BodyType.b2_staticBody&&t.m_type===m.b2BodyType.b2_staticBody?!1:this.ShouldCollideConnected(t)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),V.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),s.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}Jt.CreateFixtureShapeDensity_s_def=new sn,Jt.SetMassData_s_oldCenter=new s,Jt.ResetMassData_s_localCenter=new s,Jt.ResetMassData_s_oldCenter=new s,Jt.ResetMassData_s_massData=new bs,Jt.SynchronizeFixtures_s_xf1=new M,Jt.SynchronizeFixtures_s_displacement=new s,function(d){d[d.e_unknownJoint=0]="e_unknownJoint",d[d.e_revoluteJoint=1]="e_revoluteJoint",d[d.e_prismaticJoint=2]="e_prismaticJoint",d[d.e_distanceJoint=3]="e_distanceJoint",d[d.e_pulleyJoint=4]="e_pulleyJoint",d[d.e_mouseJoint=5]="e_mouseJoint",d[d.e_gearJoint=6]="e_gearJoint",d[d.e_wheelJoint=7]="e_wheelJoint",d[d.e_weldJoint=8]="e_weldJoint",d[d.e_frictionJoint=9]="e_frictionJoint",d[d.e_ropeJoint=10]="e_ropeJoint",d[d.e_motorJoint=11]="e_motorJoint",d[d.e_areaJoint=12]="e_areaJoint"}(m.b2JointType||(m.b2JointType={})),function(d){d[d.e_inactiveLimit=0]="e_inactiveLimit",d[d.e_atLowerLimit=1]="e_atLowerLimit",d[d.e_atUpperLimit=2]="e_atUpperLimit",d[d.e_equalLimits=3]="e_equalLimits"}(m.b2LimitState||(m.b2LimitState={}));class kr{constructor(){this.linear=new s,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}}class _i{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(this._other===null)throw new Error;return this._other}set other(t){if(this._other!==null)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class ne{constructor(t){this.type=m.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=t}}class oe{constructor(t){this.m_type=m.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new _i(this),this.m_edgeB=new _i(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_edgeA.other=t.bodyB,this.m_edgeB.other=t.bodyA,this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=b(t.collideConnected,!1),this.m_userData=b(t.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsActive(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t(`// Dump is not supported for this joint type.
`)}ShiftOrigin(t){}}class on extends ne{constructor(){super(m.b2JointType.e_distanceJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.length=1,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=s.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0}}class re extends oe{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_gamma=0,this.m_impulse=0,this.m_length=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new s,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=t.length}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){this.m_length=t}Length(){return this.m_length}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2DistanceJointDef = new b2DistanceJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.length = %.15f;
`,this.m_length),t(`  jd.frequencyHz = %.15f;
`,this.m_frequencyHz),t(`  jd.dampingRatio = %.15f;
`,this.m_dampingRatio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(a);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),V.MulRV(c,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),V.MulRV(_,this.m_lalcB,this.m_rB),this.m_u.x=r.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=r.y+this.m_rB.y-e.y-this.m_rA.y;const u=this.m_u.Length();u>j?this.m_u.SelfMul(1/u):this.m_u.SetZero();const f=s.CrossVV(this.m_rA,this.m_u),p=s.CrossVV(this.m_rB,this.m_u);let y=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=y!==0?1/y:0,this.m_frequencyHz>0){const B=u-this.m_length,A=2*q*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*A,C=this.m_mass*A*A,v=t.step.dt;this.m_gamma=v*(x+v*C),this.m_gamma=this.m_gamma!==0?1/this.m_gamma:0,this.m_bias=B*v*C*this.m_gamma,y+=this.m_gamma,this.m_mass=y!==0?1/y:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const B=s.MulSV(this.m_impulse,this.m_u,re.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,B),o-=this.m_invIA*s.CrossVV(this.m_rA,B),l.SelfMulAdd(this.m_invMassB,B),h+=this.m_invIB*s.CrossVV(this.m_rB,B)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=s.AddVCrossSV(e,i,this.m_rA,re.SolveVelocityConstraints_s_vpA),a=s.AddVCrossSV(n,o,this.m_rB,re.SolveVelocityConstraints_s_vpB),l=s.DotVV(this.m_u,s.SubVV(a,r,s.s_t0)),h=-this.m_mass*(l+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=h;const c=s.MulSV(h,this.m_u,re.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,c),i-=this.m_invIA*s.CrossVV(this.m_rA,c),n.SelfMulAdd(this.m_invMassB,c),o+=this.m_invIB*s.CrossVV(this.m_rB,c),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){if(this.m_frequencyHz>0)return!0;const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o),l=V.MulRV(r,this.m_lalcA,this.m_rA),h=V.MulRV(a,this.m_lalcB,this.m_rB),c=this.m_u;c.x=n.x+h.x-e.x-l.x,c.y=n.y+h.y-e.y-l.y;let u=this.m_u.Normalize()-this.m_length;u=gt(u,-st,st);const f=-this.m_mass*u,p=s.MulSV(f,c,re.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*s.CrossVV(l,p),n.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*s.CrossVV(h,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,at(u)<j}}re.InitVelocityConstraints_s_P=new s,re.SolveVelocityConstraints_s_vpA=new s,re.SolveVelocityConstraints_s_vpB=new s,re.SolveVelocityConstraints_s_P=new s,re.SolvePositionConstraints_s_P=new s;class qr extends ne{constructor(){super(m.b2JointType.e_areaJoint),this.bodies=[],this.frequencyHz=0,this.dampingRatio=0}AddBody(t){this.bodies.push(t),this.bodies.length===1?this.bodyA=t:this.bodies.length===2&&(this.bodyB=t)}}class rn extends oe{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new s,this.m_bodies=t.bodies,this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_targetLengths=Ie(t.bodies.length),this.m_normals=s.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=s.MakeArray(t.bodies.length);const e=new on;e.frequencyHz=this.m_frequencyHz,e.dampingRatio=this.m_dampingRatio,this.m_targetArea=0;for(let i=0;i<this.m_bodies.length;++i){const n=this.m_bodies[i],o=this.m_bodies[(i+1)%this.m_bodies.length],r=n.GetWorldCenter(),a=o.GetWorldCenter();this.m_targetLengths[i]=s.DistanceVV(r,a),this.m_targetArea+=s.CrossVV(r,a),e.Initialize(n,o,r,a),this.m_joints[i]=n.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetFrequency(t){this.m_frequencyHz=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)}GetDampingRatio(){return this.m_dampingRatio}Dump(t){t(`Area joint dumping is not supported.
`)}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],o=t.positions[i.m_islandIndex].c,r=t.positions[n.m_islandIndex].c,a=this.m_deltas[e];s.SubVV(r,o,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,o=this.m_deltas[e];n.x+=i.m_invMass*o.y*.5*this.m_impulse,n.y+=i.m_invMass*-o.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let o=0;o<this.m_bodies.length;++o){const r=this.m_bodies[o],a=t.velocities[r.m_islandIndex].v,l=this.m_deltas[o];e+=l.LengthSquared()/r.GetMass(),i+=s.CrossVV(a,l)}const n=-2*i/e;this.m_impulse+=n;for(let o=0;o<this.m_bodies.length;++o){const r=this.m_bodies[o],a=t.velocities[r.m_islandIndex].v,l=this.m_deltas[o];a.x+=r.m_invMass*l.y*.5*n,a.y+=r.m_invMass*-l.x*.5*n}}SolvePositionConstraints(t){let e=0,i=0;for(let a=0;a<this.m_bodies.length;++a){const l=this.m_bodies[a],h=this.m_bodies[(a+1)%this.m_bodies.length],c=t.positions[l.m_islandIndex].c,_=t.positions[h.m_islandIndex].c,u=s.SubVV(_,c,this.m_delta);let f=u.Length();f<K&&(f=1),this.m_normals[a].x=u.y/f,this.m_normals[a].y=-u.x/f,e+=f,i+=s.CrossVV(c,_)}i*=.5;const n=this.m_targetArea-i,o=.5*n/e;let r=!0;for(let a=0;a<this.m_bodies.length;++a){const l=this.m_bodies[a],h=t.positions[l.m_islandIndex].c,c=(a+1)%this.m_bodies.length,_=s.AddVV(this.m_normals[a],this.m_normals[c],this.m_delta);_.SelfMul(o);const u=_.LengthSquared();u>Ne(st)&&_.SelfMul(st/ye(u)),u>Ne(j)&&(r=!1),h.x+=_.x,h.y+=_.y}return r}}class zr extends ne{constructor(){super(m.b2JointType.e_frictionJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}class Ve extends oe{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_linearImpulse=new s,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new ft,this.m_angularMass=0,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_K=new ft,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=b(t.maxForce,0),this.m_maxTorque=b(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const c=V.MulRV(l,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const _=V.MulRV(h,this.m_lalcB,this.m_rB),u=this.m_invMassA,f=this.m_invMassB,p=this.m_invIA,y=this.m_invIB,B=this.m_K;if(B.ex.x=u+f+p*c.y*c.y+y*_.y*_.y,B.ex.y=-p*c.x*c.y-y*_.x*_.y,B.ey.x=B.ex.y,B.ey.y=u+f+p*c.x*c.x+y*_.x*_.x,B.GetInverse(this.m_linearMass),this.m_angularMass=p+y,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const A=this.m_linearImpulse;i.SelfMulSub(u,A),n-=p*(s.CrossVV(this.m_rA,A)+this.m_angularImpulse),r.SelfMulAdd(f,A),a+=y*(s.CrossVV(this.m_rB,A)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,c=t.step.dt;{const _=o-i;let u=-this.m_angularMass*_;const f=this.m_angularImpulse,p=c*this.m_maxTorque;this.m_angularImpulse=gt(this.m_angularImpulse+u,-p,p),u=this.m_angularImpulse-f,i-=l*u,o+=h*u}{const _=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),Ve.SolveVelocityConstraints_s_Cdot_v2),u=ft.MulMV(this.m_linearMass,_,Ve.SolveVelocityConstraints_s_impulseV).SelfNeg(),f=Ve.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(u);const p=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),s.SubVV(this.m_linearImpulse,f,u),e.SelfMulSub(r,u),i-=l*s.CrossVV(this.m_rA,u),n.SelfMulAdd(a,u),o+=h*s.CrossVV(this.m_rB,u)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2FrictionJointDef = new b2FrictionJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.maxForce = %.15f;
`,this.m_maxForce),t(`  jd.maxTorque = %.15f;
`,this.m_maxTorque),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}Ve.SolveVelocityConstraints_s_Cdot_v2=new s,Ve.SolveVelocityConstraints_s_impulseV=new s,Ve.SolveVelocityConstraints_s_oldImpulseV=new s;class Er extends ne{constructor(){super(m.b2JointType.e_gearJoint),this.ratio=1}}class pt extends oe{constructor(t){super(t),this.m_typeA=m.b2JointType.e_unknownJoint,this.m_typeB=m.b2JointType.e_unknownJoint,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_localAnchorC=new s,this.m_localAnchorD=new s,this.m_localAxisC=new s,this.m_localAxisD=new s,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new s,this.m_lcB=new s,this.m_lcC=new s,this.m_lcD=new s,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new s,this.m_JvBD=new s,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new V,this.m_qB=new V,this.m_qC=new V,this.m_qD=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_lalcC=new s,this.m_lalcD=new s,this.m_joint1=t.joint1,this.m_joint2=t.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType();let e,i;this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const n=this.m_bodyA.m_xf,o=this.m_bodyA.m_sweep.a,r=this.m_bodyC.m_xf,a=this.m_bodyC.m_sweep.a;if(this.m_typeA===m.b2JointType.e_revoluteJoint){const u=t.joint1;this.m_localAnchorC.Copy(u.m_localAnchorA),this.m_localAnchorA.Copy(u.m_localAnchorB),this.m_referenceAngleA=u.m_referenceAngle,this.m_localAxisC.SetZero(),e=o-a-this.m_referenceAngleA}else{const u=t.joint1;this.m_localAnchorC.Copy(u.m_localAnchorA),this.m_localAnchorA.Copy(u.m_localAnchorB),this.m_referenceAngleA=u.m_referenceAngle,this.m_localAxisC.Copy(u.m_localXAxisA);const f=this.m_localAnchorC,p=V.MulTRV(r.q,s.AddVV(V.MulRV(n.q,this.m_localAnchorA,s.s_t0),s.SubVV(n.p,r.p,s.s_t1),s.s_t0),s.s_t0);e=s.DotVV(s.SubVV(p,f,s.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const l=this.m_bodyB.m_xf,h=this.m_bodyB.m_sweep.a,c=this.m_bodyD.m_xf,_=this.m_bodyD.m_sweep.a;if(this.m_typeB===m.b2JointType.e_revoluteJoint){const u=t.joint2;this.m_localAnchorD.Copy(u.m_localAnchorA),this.m_localAnchorB.Copy(u.m_localAnchorB),this.m_referenceAngleB=u.m_referenceAngle,this.m_localAxisD.SetZero(),i=h-_-this.m_referenceAngleB}else{const u=t.joint2;this.m_localAnchorD.Copy(u.m_localAnchorA),this.m_localAnchorB.Copy(u.m_localAnchorB),this.m_referenceAngleB=u.m_referenceAngle,this.m_localAxisD.Copy(u.m_localXAxisA);const f=this.m_localAnchorD,p=V.MulTRV(c.q,s.AddVV(V.MulRV(l.q,this.m_localAnchorB,s.s_t0),s.SubVV(l.p,c.p,s.s_t1),s.s_t0),s.s_t0);i=s.DotVV(s.SubVV(p,f,s.s_t0),this.m_localAxisD)}this.m_ratio=b(t.ratio,1),this.m_constant=e+this.m_ratio*i,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=t.positions[this.m_indexC].a,h=t.velocities[this.m_indexC].v;let c=t.velocities[this.m_indexC].w;const _=t.positions[this.m_indexD].a,u=t.velocities[this.m_indexD].v;let f=t.velocities[this.m_indexD].w;const p=this.m_qA.SetAngle(e),y=this.m_qB.SetAngle(o),B=this.m_qC.SetAngle(l),A=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===m.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const x=V.MulRV(B,this.m_localAxisC,pt.InitVelocityConstraints_s_u);s.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const C=V.MulRV(B,this.m_lalcC,pt.InitVelocityConstraints_s_rC);s.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const v=V.MulRV(p,this.m_lalcA,pt.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(x),this.m_JwC=s.CrossVV(C,x),this.m_JwA=s.CrossVV(v,x),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===m.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const x=V.MulRV(A,this.m_localAxisD,pt.InitVelocityConstraints_s_u);s.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const C=V.MulRV(A,this.m_lalcD,pt.InitVelocityConstraints_s_rD);s.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const v=V.MulRV(y,this.m_lalcB,pt.InitVelocityConstraints_s_rB);s.MulSV(this.m_ratio,x,this.m_JvBD),this.m_JwD=this.m_ratio*s.CrossVV(C,x),this.m_JwB=this.m_ratio*s.CrossVV(v,x),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(i.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),n+=this.m_iA*this.m_impulse*this.m_JwA,r.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,h.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),c-=this.m_iC*this.m_impulse*this.m_JwC,u.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),f-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a,t.velocities[this.m_indexC].w=c,t.velocities[this.m_indexD].w=f}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=t.velocities[this.m_indexC].v;let a=t.velocities[this.m_indexC].w;const l=t.velocities[this.m_indexD].v;let h=t.velocities[this.m_indexD].w,c=s.DotVV(this.m_JvAC,s.SubVV(e,r,s.s_t0))+s.DotVV(this.m_JvBD,s.SubVV(n,l,s.s_t0));c+=this.m_JwA*i-this.m_JwC*a+(this.m_JwB*o-this.m_JwD*h);const _=-this.m_mass*c;this.m_impulse+=_,e.SelfMulAdd(this.m_mA*_,this.m_JvAC),i+=this.m_iA*_*this.m_JwA,n.SelfMulAdd(this.m_mB*_,this.m_JvBD),o+=this.m_iB*_*this.m_JwB,r.SelfMulSub(this.m_mC*_,this.m_JvAC),a-=this.m_iC*_*this.m_JwC,l.SelfMulSub(this.m_mD*_,this.m_JvBD),h-=this.m_iD*_*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=h}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=t.positions[this.m_indexC].c;let a=t.positions[this.m_indexC].a;const l=t.positions[this.m_indexD].c;let h=t.positions[this.m_indexD].a;const c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(o),u=this.m_qC.SetAngle(a),f=this.m_qD.SetAngle(h),p=0;let y,B;const A=this.m_JvAC,x=this.m_JvBD;let C,v,g,I,P=0;if(this.m_typeA===m.b2JointType.e_revoluteJoint)A.SetZero(),C=1,g=1,P+=this.m_iA+this.m_iC,y=i-a-this.m_referenceAngleA;else{const R=V.MulRV(u,this.m_localAxisC,pt.SolvePositionConstraints_s_u),E=V.MulRV(u,this.m_lalcC,pt.SolvePositionConstraints_s_rC),L=V.MulRV(c,this.m_lalcA,pt.SolvePositionConstraints_s_rA);A.Copy(R),g=s.CrossVV(E,R),C=s.CrossVV(L,R),P+=this.m_mC+this.m_mA+this.m_iC*g*g+this.m_iA*C*C;const G=this.m_lalcC,X=V.MulTRV(u,s.AddVV(L,s.SubVV(e,r,s.s_t0),s.s_t0),s.s_t0);y=s.DotVV(s.SubVV(X,G,s.s_t0),this.m_localAxisC)}if(this.m_typeB===m.b2JointType.e_revoluteJoint)x.SetZero(),v=this.m_ratio,I=this.m_ratio,P+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),B=o-h-this.m_referenceAngleB;else{const R=V.MulRV(f,this.m_localAxisD,pt.SolvePositionConstraints_s_u),E=V.MulRV(f,this.m_lalcD,pt.SolvePositionConstraints_s_rD),L=V.MulRV(_,this.m_lalcB,pt.SolvePositionConstraints_s_rB);s.MulSV(this.m_ratio,R,x),I=this.m_ratio*s.CrossVV(E,R),v=this.m_ratio*s.CrossVV(L,R),P+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*I*I+this.m_iB*v*v;const G=this.m_lalcD,X=V.MulTRV(f,s.AddVV(L,s.SubVV(n,l,s.s_t0),s.s_t0),s.s_t0);B=s.DotVV(s.SubVV(X,G,s.s_t0),this.m_localAxisD)}const T=y+this.m_ratio*B-this.m_constant;let F=0;return P>0&&(F=-T/P),e.SelfMulAdd(this.m_mA*F,A),i+=this.m_iA*F*C,n.SelfMulAdd(this.m_mB*F,x),o+=this.m_iB*F*v,r.SelfMulSub(this.m_mC*F,A),a-=this.m_iC*F*g,l.SelfMulSub(this.m_mD*F,x),h-=this.m_iD*F*I,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,t.positions[this.m_indexC].a=a,t.positions[this.m_indexD].a=h,p<j}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return s.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,o=this.m_joint2.m_index;t(`  const jd: b2GearJointDef = new b2GearJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.joint1 = joints[%d];
`,n),t(`  jd.joint2 = joints[%d];
`,o),t(`  jd.ratio = %.15f;
`,this.m_ratio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}pt.InitVelocityConstraints_s_u=new s,pt.InitVelocityConstraints_s_rA=new s,pt.InitVelocityConstraints_s_rB=new s,pt.InitVelocityConstraints_s_rC=new s,pt.InitVelocityConstraints_s_rD=new s,pt.SolvePositionConstraints_s_u=new s,pt.SolvePositionConstraints_s_rA=new s,pt.SolvePositionConstraints_s_rB=new s,pt.SolvePositionConstraints_s_rC=new s,pt.SolvePositionConstraints_s_rD=new s;class Nr extends ne{constructor(){super(m.b2JointType.e_motorJoint),this.linearOffset=new s(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i}}class we extends oe{constructor(t){super(t),this.m_linearOffset=new s,this.m_angularOffset=0,this.m_linearImpulse=new s,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_linearError=new s,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new ft,this.m_angularMass=0,this.m_qA=new V,this.m_qB=new V,this.m_K=new ft,this.m_linearOffset.Copy(b(t.linearOffset,s.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=b(t.maxForce,0),this.m_maxTorque=b(t.maxTorque,0),this.m_correctionFactor=b(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return s.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){s.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(a),u=V.MulRV(c,s.SubVV(this.m_linearOffset,this.m_localCenterA,s.s_t0),this.m_rA),f=V.MulRV(_,s.NegV(this.m_localCenterB,s.s_t0),this.m_rB),p=this.m_invMassA,y=this.m_invMassB,B=this.m_invIA,A=this.m_invIB,x=this.m_K;if(x.ex.x=p+y+B*u.y*u.y+A*f.y*f.y,x.ex.y=-B*u.x*u.y-A*f.x*f.y,x.ey.x=x.ex.y,x.ey.y=p+y+B*u.x*u.x+A*f.x*f.x,x.GetInverse(this.m_linearMass),this.m_angularMass=B+A,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),s.SubVV(s.AddVV(r,f,s.s_t0),s.AddVV(e,u,s.s_t1),this.m_linearError),this.m_angularError=a-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const C=this.m_linearImpulse;n.SelfMulSub(p,C),o-=B*(s.CrossVV(u,C)+this.m_angularImpulse),l.SelfMulAdd(y,C),h+=A*(s.CrossVV(f,C)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,c=t.step.dt,_=t.step.inv_dt;{const u=o-i+_*this.m_correctionFactor*this.m_angularError;let f=-this.m_angularMass*u;const p=this.m_angularImpulse,y=c*this.m_maxTorque;this.m_angularImpulse=gt(this.m_angularImpulse+f,-y,y),f=this.m_angularImpulse-p,i-=l*f,o+=h*f}{const u=this.m_rA,f=this.m_rB,p=s.AddVV(s.SubVV(s.AddVV(n,s.CrossSV(o,f,s.s_t0),s.s_t0),s.AddVV(e,s.CrossSV(i,u,s.s_t1),s.s_t1),s.s_t2),s.MulSV(_*this.m_correctionFactor,this.m_linearError,s.s_t3),we.SolveVelocityConstraints_s_Cdot_v2),y=ft.MulMV(this.m_linearMass,p,we.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),B=we.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);const A=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>A*A&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(A)),s.SubVV(this.m_linearImpulse,B,y),e.SelfMulSub(r,y),i-=l*s.CrossVV(u,y),n.SelfMulAdd(a,y),o+=h*s.CrossVV(f,y)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2MotorJointDef = new b2MotorJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.linearOffset.Set(%.15f, %.15f);
`,this.m_linearOffset.x,this.m_linearOffset.y),t(`  jd.angularOffset = %.15f;
`,this.m_angularOffset),t(`  jd.maxForce = %.15f;
`,this.m_maxForce),t(`  jd.maxTorque = %.15f;
`,this.m_maxTorque),t(`  jd.correctionFactor = %.15f;
`,this.m_correctionFactor),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}we.SolveVelocityConstraints_s_Cdot_v2=new s,we.SolveVelocityConstraints_s_impulse_v2=new s,we.SolveVelocityConstraints_s_oldImpulse_v2=new s;class jr extends ne{constructor(){super(m.b2JointType.e_mouseJoint),this.target=new s,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7}}class ge extends oe{constructor(t){super(t),this.m_localAnchorB=new s,this.m_targetA=new s,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_beta=0,this.m_impulse=new s,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new s,this.m_localCenterB=new s,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new ft,this.m_C=new s,this.m_qB=new V,this.m_lalcB=new s,this.m_K=new ft,this.m_targetA.Copy(b(t.target,s.ZERO)),M.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=b(t.maxForce,0),this.m_impulse.SetZero(),this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),l=2*q*this.m_frequencyHz,h=2*a*this.m_dampingRatio*l,c=a*(l*l),_=t.step.dt;this.m_gamma=_*(h+_*c),this.m_gamma!==0&&(this.m_gamma=1/this.m_gamma),this.m_beta=_*c*this.m_gamma,s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),V.MulRV(r,this.m_lalcB,this.m_rB);const u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),o*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,o+=this.m_invIB*s.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const n=s.AddVCrossSV(e,i,this.m_rB,ge.SolveVelocityConstraints_s_Cdot),o=ft.MulMV(this.m_mass,s.AddVV(n,s.AddVV(this.m_C,s.MulSV(this.m_gamma,this.m_impulse,s.s_t0),s.s_t0),s.s_t0).SelfNeg(),ge.SolveVelocityConstraints_s_impulse),r=ge.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);const a=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>a*a&&this.m_impulse.SelfMul(a/this.m_impulse.Length()),s.SubVV(this.m_impulse,r,o),e.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*s.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return s.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t(`Mouse joint dumping is not supported.
`)}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}ge.SolveVelocityConstraints_s_Cdot=new s,ge.SolveVelocityConstraints_s_impulse=new s,ge.SolveVelocityConstraints_s_oldImpulse=new s;class Or extends ne{constructor(){super(m.b2JointType.e_prismaticJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.localAxisA=new s(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class et extends oe{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_localXAxisA=new s,this.m_localYAxisA=new s,this.m_referenceAngle=0,this.m_impulse=new bt(0,0,0),this.m_motorImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new s(0,0),this.m_perp=new s(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new he,this.m_K3=new he,this.m_K2=new ft,this.m_motorMass=0,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_rA=new s,this.m_rB=new s,this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_localXAxisA.Copy(b(t.localAxisA,new s(1,0))).SelfNormalize(),s.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=b(t.referenceAngle,0),this.m_lowerTranslation=b(t.lowerTranslation,0),this.m_upperTranslation=b(t.upperTranslation,0),this.m_maxMotorForce=b(t.maxMotorForce,0),this.m_motorSpeed=b(t.motorSpeed,0),this.m_enableLimit=b(t.enableLimit,!1),this.m_enableMotor=b(t.enableMotor,!1)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(a);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const u=V.MulRV(c,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const f=V.MulRV(_,this.m_lalcB,this.m_rB),p=s.AddVV(s.SubVV(r,e,s.s_t0),s.SubVV(f,u,s.s_t1),et.InitVelocityConstraints_s_d),y=this.m_invMassA,B=this.m_invMassB,A=this.m_invIA,x=this.m_invIB;if(V.MulRV(c,this.m_localXAxisA,this.m_axis),this.m_a1=s.CrossVV(s.AddVV(p,u,s.s_t0),this.m_axis),this.m_a2=s.CrossVV(f,this.m_axis),this.m_motorMass=y+B+A*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),V.MulRV(c,this.m_localYAxisA,this.m_perp),this.m_s1=s.CrossVV(s.AddVV(p,u,s.s_t0),this.m_perp),this.m_s2=s.CrossVV(f,this.m_perp),this.m_K.ex.x=y+B+A*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=A*this.m_s1+x*this.m_s2,this.m_K.ex.z=A*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=A+x,this.m_K.ey.y===0&&(this.m_K.ey.y=1),this.m_K.ey.z=A*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=y+B+A*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){const C=s.DotVV(this.m_axis,p);at(this.m_upperTranslation-this.m_lowerTranslation)<2*j?this.m_limitState=m.b2LimitState.e_equalLimits:C<=this.m_lowerTranslation?this.m_limitState!==m.b2LimitState.e_atLowerLimit&&(this.m_limitState=m.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):C>=this.m_upperTranslation?this.m_limitState!==m.b2LimitState.e_atUpperLimit&&(this.m_limitState=m.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;const C=s.AddVV(s.MulSV(this.m_impulse.x,this.m_perp,s.s_t0),s.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,s.s_t1),et.InitVelocityConstraints_s_P),v=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,g=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;n.SelfMulSub(y,C),o-=A*v,l.SelfMulAdd(B,C),h+=x*g}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==m.b2LimitState.e_equalLimits){const u=s.DotVV(this.m_axis,s.SubVV(n,e,s.s_t0))+this.m_a2*o-this.m_a1*i;let f=this.m_motorMass*(this.m_motorSpeed-u);const p=this.m_motorImpulse,y=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=gt(this.m_motorImpulse+f,-y,y),f=this.m_motorImpulse-p;const B=s.MulSV(f,this.m_axis,et.SolveVelocityConstraints_s_P),A=f*this.m_a1,x=f*this.m_a2;e.SelfMulSub(r,B),i-=l*A,n.SelfMulAdd(a,B),o+=h*x}const c=s.DotVV(this.m_perp,s.SubVV(n,e,s.s_t0))+this.m_s2*o-this.m_s1*i,_=o-i;if(this.m_enableLimit&&this.m_limitState!==m.b2LimitState.e_inactiveLimit){const u=s.DotVV(this.m_axis,s.SubVV(n,e,s.s_t0))+this.m_a2*o-this.m_a1*i,f=et.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),p=this.m_K.Solve33(-c,-_,-u,et.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(p),this.m_limitState===m.b2LimitState.e_atLowerLimit?this.m_impulse.z=H(this.m_impulse.z,0):this.m_limitState===m.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=tt(this.m_impulse.z,0));const y=-c-(this.m_impulse.z-f.z)*this.m_K.ez.x,B=-_-(this.m_impulse.z-f.z)*this.m_K.ez.y,A=this.m_K.Solve22(y,B,et.SolveVelocityConstraints_s_f2r);A.x+=f.x,A.y+=f.y,this.m_impulse.x=A.x,this.m_impulse.y=A.y,p.x=this.m_impulse.x-f.x,p.y=this.m_impulse.y-f.y,p.z=this.m_impulse.z-f.z;const x=s.AddVV(s.MulSV(p.x,this.m_perp,s.s_t0),s.MulSV(p.z,this.m_axis,s.s_t1),et.SolveVelocityConstraints_s_P),C=p.x*this.m_s1+p.y+p.z*this.m_a1,v=p.x*this.m_s2+p.y+p.z*this.m_a2;e.SelfMulSub(r,x),i-=l*C,n.SelfMulAdd(a,x),o+=h*v}else{const u=this.m_K.Solve22(-c,-_,et.SolveVelocityConstraints_s_df2);this.m_impulse.x+=u.x,this.m_impulse.y+=u.y;const f=s.MulSV(u.x,this.m_perp,et.SolveVelocityConstraints_s_P),p=u.x*this.m_s1+u.y,y=u.x*this.m_s2+u.y;e.SelfMulSub(r,f),i-=l*p,n.SelfMulAdd(a,f),o+=h*y}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o),l=this.m_invMassA,h=this.m_invMassB,c=this.m_invIA,_=this.m_invIB,u=V.MulRV(r,this.m_lalcA,this.m_rA),f=V.MulRV(a,this.m_lalcB,this.m_rB),p=s.SubVV(s.AddVV(n,f,s.s_t0),s.AddVV(e,u,s.s_t1),et.SolvePositionConstraints_s_d),y=V.MulRV(r,this.m_localXAxisA,this.m_axis),B=s.CrossVV(s.AddVV(p,u,s.s_t0),y),A=s.CrossVV(f,y),x=V.MulRV(r,this.m_localYAxisA,this.m_perp),C=s.CrossVV(s.AddVV(p,u,s.s_t0),x),v=s.CrossVV(f,x);let g=et.SolvePositionConstraints_s_impulse;const I=s.DotVV(x,p),P=o-i-this.m_referenceAngle;let T=at(I);const F=at(P);let R=!1,E=0;if(this.m_enableLimit){const O=s.DotVV(y,p);at(this.m_upperTranslation-this.m_lowerTranslation)<2*j?(E=gt(O,-st,st),T=H(T,at(O)),R=!0):O<=this.m_lowerTranslation?(E=gt(O-this.m_lowerTranslation+j,-st,0),T=H(T,this.m_lowerTranslation-O),R=!0):O>=this.m_upperTranslation&&(E=gt(O-this.m_upperTranslation-j,0,st),T=H(T,O-this.m_upperTranslation),R=!0)}if(R){const O=l+h+c*C*C+_*v*v,$=c*C+_*v,lt=c*C*B+_*v*A;let _t=c+_;_t===0&&(_t=1);const kt=c*B+_*A,qt=l+h+c*B*B+_*A*A,zt=this.m_K3;zt.ex.SetXYZ(O,$,lt),zt.ey.SetXYZ($,_t,kt),zt.ez.SetXYZ(lt,kt,qt),g=zt.Solve33(-I,-P,-E,g)}else{const O=l+h+c*C*C+_*v*v,$=c*C+_*v;let lt=c+_;lt===0&&(lt=1);const _t=this.m_K2;_t.ex.Set(O,$),_t.ey.Set($,lt);const kt=_t.Solve(-I,-P,et.SolvePositionConstraints_s_impulse1);g.x=kt.x,g.y=kt.y,g.z=0}const L=s.AddVV(s.MulSV(g.x,x,s.s_t0),s.MulSV(g.z,y,s.s_t1),et.SolvePositionConstraints_s_P),G=g.x*C+g.y+g.z*B,X=g.x*v+g.y+g.z*A;return e.SelfMulSub(l,L),i-=c*G,n.SelfMulAdd(h,L),o+=_*X,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,T<=j&&F<=At}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,et.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,et.GetJointTranslation_s_pB),i=s.SubVV(e,t,et.GetJointTranslation_s_d),n=this.m_bodyA.GetWorldVector(this.m_localXAxisA,et.GetJointTranslation_s_axis);return s.DotVV(i,n)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;s.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=V.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=V.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),o=s.AddVV(t.m_sweep.c,i,s.s_t0),r=s.AddVV(e.m_sweep.c,n,s.s_t1),a=s.SubVV(r,o,s.s_t2),l=t.GetWorldVector(this.m_localXAxisA,this.m_axis),h=t.m_linearVelocity,c=e.m_linearVelocity,_=t.m_angularVelocity,u=e.m_angularVelocity;return s.DotVV(a,s.CrossSV(_,l,s.s_t0))+s.DotVV(l,s.SubVV(s.AddVCrossSV(c,u,n,s.s_t0),s.AddVCrossSV(h,_,i,s.s_t1),s.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){(t!==this.m_lowerTranslation||e!==this.m_upperTranslation)&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.localAxisA.Set(%.15f, %.15f);
`,this.m_localXAxisA.x,this.m_localXAxisA.y),t(`  jd.referenceAngle = %.15f;
`,this.m_referenceAngle),t(`  jd.enableLimit = %s;
`,this.m_enableLimit?"true":"false"),t(`  jd.lowerTranslation = %.15f;
`,this.m_lowerTranslation),t(`  jd.upperTranslation = %.15f;
`,this.m_upperTranslation),t(`  jd.enableMotor = %s;
`,this.m_enableMotor?"true":"false"),t(`  jd.motorSpeed = %.15f;
`,this.m_motorSpeed),t(`  jd.maxMotorForce = %.15f;
`,this.m_maxMotorForce),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}et.InitVelocityConstraints_s_d=new s,et.InitVelocityConstraints_s_P=new s,et.SolveVelocityConstraints_s_P=new s,et.SolveVelocityConstraints_s_f2r=new s,et.SolveVelocityConstraints_s_f1=new bt,et.SolveVelocityConstraints_s_df3=new bt,et.SolveVelocityConstraints_s_df2=new s,et.SolvePositionConstraints_s_d=new s,et.SolvePositionConstraints_s_impulse=new bt,et.SolvePositionConstraints_s_impulse1=new s,et.SolvePositionConstraints_s_P=new s,et.GetJointTranslation_s_pA=new s,et.GetJointTranslation_s_pB=new s,et.GetJointTranslation_s_d=new s,et.GetJointTranslation_s_axis=new s;const Jr=2;class Xr extends ne{constructor(){super(m.b2JointType.e_pulleyJoint),this.groundAnchorA=new s(-1,1),this.groundAnchorB=new s(1,1),this.localAnchorA=new s(-1,0),this.localAnchorB=new s(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,n,o,r,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(o,this.localAnchorA),this.bodyB.GetLocalPoint(r,this.localAnchorB),this.lengthA=s.DistanceVV(o,i),this.lengthB=s.DistanceVV(r,n),this.ratio=a}}class Ct extends oe{constructor(t){super(t),this.m_groundAnchorA=new s,this.m_groundAnchorB=new s,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new s,this.m_uB=new s,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_groundAnchorA.Copy(b(t.groundAnchorA,new s(-1,1))),this.m_groundAnchorB.Copy(b(t.groundAnchorB,new s(1,0))),this.m_localAnchorA.Copy(b(t.localAnchorA,new s(-1,0))),this.m_localAnchorB.Copy(b(t.localAnchorB,new s(1,0))),this.m_lengthA=b(t.lengthA,0),this.m_lengthB=b(t.lengthB,0),this.m_ratio=b(t.ratio,1),this.m_constant=b(t.lengthA,0)+this.m_ratio*b(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(a);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),V.MulRV(c,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),V.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(r).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const u=this.m_uA.Length(),f=this.m_uB.Length();u>10*j?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),f>10*j?this.m_uB.SelfMul(1/f):this.m_uB.SetZero();const p=s.CrossVV(this.m_rA,this.m_uA),y=s.CrossVV(this.m_rB,this.m_uB),B=this.m_invMassA+this.m_invIA*p*p,A=this.m_invMassB+this.m_invIB*y*y;if(this.m_mass=B+this.m_ratio*this.m_ratio*A,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const x=s.MulSV(-this.m_impulse,this.m_uA,Ct.InitVelocityConstraints_s_PA),C=s.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,Ct.InitVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,x),o+=this.m_invIA*s.CrossVV(this.m_rA,x),l.SelfMulAdd(this.m_invMassB,C),h+=this.m_invIB*s.CrossVV(this.m_rB,C)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=s.AddVCrossSV(e,i,this.m_rA,Ct.SolveVelocityConstraints_s_vpA),a=s.AddVCrossSV(n,o,this.m_rB,Ct.SolveVelocityConstraints_s_vpB),l=-s.DotVV(this.m_uA,r)-this.m_ratio*s.DotVV(this.m_uB,a),h=-this.m_mass*l;this.m_impulse+=h;const c=s.MulSV(-h,this.m_uA,Ct.SolveVelocityConstraints_s_PA),_=s.MulSV(-this.m_ratio*h,this.m_uB,Ct.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,c),i+=this.m_invIA*s.CrossVV(this.m_rA,c),n.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*s.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=V.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=V.MulRV(a,this.m_lalcB,this.m_rB),c=this.m_uA.Copy(e).SelfAdd(l).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(n).SelfAdd(h).SelfSub(this.m_groundAnchorB),u=c.Length(),f=_.Length();u>10*j?c.SelfMul(1/u):c.SetZero(),f>10*j?_.SelfMul(1/f):_.SetZero();const p=s.CrossVV(l,c),y=s.CrossVV(h,_),B=this.m_invMassA+this.m_invIA*p*p,A=this.m_invMassB+this.m_invIB*y*y;let x=B+this.m_ratio*this.m_ratio*A;x>0&&(x=1/x);const C=this.m_constant-u-this.m_ratio*f,v=at(C),g=-x*C,I=s.MulSV(-g,c,Ct.SolvePositionConstraints_s_PA),P=s.MulSV(-this.m_ratio*g,_,Ct.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,I),i+=this.m_invIA*s.CrossVV(l,I),n.SelfMulAdd(this.m_invMassB,P),o+=this.m_invIB*s.CrossVV(h,P),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,v<j}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Ct.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return s.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Ct.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return s.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2PulleyJointDef = new b2PulleyJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.groundAnchorA.Set(%.15f, %.15f);
`,this.m_groundAnchorA.x,this.m_groundAnchorA.y),t(`  jd.groundAnchorB.Set(%.15f, %.15f);
`,this.m_groundAnchorB.x,this.m_groundAnchorB.y),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.lengthA = %.15f;
`,this.m_lengthA),t(`  jd.lengthB = %.15f;
`,this.m_lengthB),t(`  jd.ratio = %.15f;
`,this.m_ratio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}Ct.InitVelocityConstraints_s_PA=new s,Ct.InitVelocityConstraints_s_PB=new s,Ct.SolveVelocityConstraints_s_vpA=new s,Ct.SolveVelocityConstraints_s_vpB=new s,Ct.SolveVelocityConstraints_s_PA=new s,Ct.SolveVelocityConstraints_s_PB=new s,Ct.SolvePositionConstraints_s_PA=new s,Ct.SolvePositionConstraints_s_PB=new s,Ct.GetCurrentLengthA_s_p=new s,Ct.GetCurrentLengthB_s_p=new s;class Ur extends ne{constructor(){super(m.b2JointType.e_revoluteJoint),this.localAnchorA=new s(0,0),this.localAnchorB=new s(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Vt extends oe{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_impulse=new bt,this.m_motorImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new he,this.m_motorMass=0,this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_K=new ft,this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_referenceAngle=b(t.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=b(t.lowerAngle,0),this.m_upperAngle=b(t.upperAngle,0),this.m_maxMotorTorque=b(t.maxMotorTorque,0),this.m_motorSpeed=b(t.motorSpeed,0),this.m_enableLimit=b(t.enableLimit,!1),this.m_enableMotor=b(t.enableMotor,!1),this.m_limitState=m.b2LimitState.e_inactiveLimit}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),V.MulRV(l,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),V.MulRV(h,this.m_lalcB,this.m_rB);const c=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=u+f===0;if(this.m_mass.ex.x=c+_+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*f,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*f,this.m_mass.ez.x=-this.m_rA.y*u-this.m_rB.y*f,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=c+_+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*f,this.m_mass.ez.y=this.m_rA.x*u+this.m_rB.x*f,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=u+f,this.m_motorMass=u+f,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),(!this.m_enableMotor||p)&&(this.m_motorImpulse=0),this.m_enableLimit&&!p){const y=o-e-this.m_referenceAngle;at(this.m_upperAngle-this.m_lowerAngle)<2*At?this.m_limitState=m.b2LimitState.e_equalLimits:y<=this.m_lowerAngle?(this.m_limitState!==m.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=m.b2LimitState.e_atLowerLimit):y>=this.m_upperAngle?(this.m_limitState!==m.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=m.b2LimitState.e_atUpperLimit):(this.m_limitState=m.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=m.b2LimitState.e_inactiveLimit;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;const y=Vt.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,y),n-=u*(s.CrossVV(this.m_rA,y)+this.m_motorImpulse+this.m_impulse.z),r.SelfMulAdd(_,y),a+=f*(s.CrossVV(this.m_rB,y)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,c=l+h===0;if(this.m_enableMotor&&this.m_limitState!==m.b2LimitState.e_equalLimits&&!c){const _=o-i-this.m_motorSpeed;let u=-this.m_motorMass*_;const f=this.m_motorImpulse,p=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=gt(this.m_motorImpulse+u,-p,p),u=this.m_motorImpulse-f,i-=l*u,o+=h*u}if(this.m_enableLimit&&this.m_limitState!==m.b2LimitState.e_inactiveLimit&&!c){const _=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),Vt.SolveVelocityConstraints_s_Cdot1),u=o-i,f=this.m_mass.Solve33(_.x,_.y,u,Vt.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===m.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(f);else if(this.m_limitState===m.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+f.z<0){const B=-_.x+this.m_impulse.z*this.m_mass.ez.x,A=-_.y+this.m_impulse.z*this.m_mass.ez.y,x=this.m_mass.Solve22(B,A,Vt.SolveVelocityConstraints_s_reduced_v2);f.x=x.x,f.y=x.y,f.z=-this.m_impulse.z,this.m_impulse.x+=x.x,this.m_impulse.y+=x.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(f);else if(this.m_limitState===m.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+f.z>0){const B=-_.x+this.m_impulse.z*this.m_mass.ez.x,A=-_.y+this.m_impulse.z*this.m_mass.ez.y,x=this.m_mass.Solve22(B,A,Vt.SolveVelocityConstraints_s_reduced_v2);f.x=x.x,f.y=x.y,f.z=-this.m_impulse.z,this.m_impulse.x+=x.x,this.m_impulse.y+=x.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(f);const p=Vt.SolveVelocityConstraints_s_P.Set(f.x,f.y);e.SelfMulSub(r,p),i-=l*(s.CrossVV(this.m_rA,p)+f.z),n.SelfMulAdd(a,p),o+=h*(s.CrossVV(this.m_rB,p)+f.z)}else{const _=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),Vt.SolveVelocityConstraints_s_Cdot_v2),u=this.m_mass.Solve22(-_.x,-_.y,Vt.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=u.x,this.m_impulse.y+=u.y,e.SelfMulSub(r,u),i-=l*s.CrossVV(this.m_rA,u),n.SelfMulAdd(a,u),o+=h*s.CrossVV(this.m_rB,u)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);let l=0,h=0;const c=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==m.b2LimitState.e_inactiveLimit&&!c){const _=o-i-this.m_referenceAngle;let u=0;if(this.m_limitState===m.b2LimitState.e_equalLimits){const f=gt(_-this.m_lowerAngle,-Gt,Gt);u=-this.m_motorMass*f,l=at(f)}else if(this.m_limitState===m.b2LimitState.e_atLowerLimit){let f=_-this.m_lowerAngle;l=-f,f=gt(f+At,-Gt,0),u=-this.m_motorMass*f}else if(this.m_limitState===m.b2LimitState.e_atUpperLimit){let f=_-this.m_upperAngle;l=f,f=gt(f-At,0,Gt),u=-this.m_motorMass*f}i-=this.m_invIA*u,o+=this.m_invIB*u}{r.SetAngle(i),a.SetAngle(o),s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const _=V.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const u=V.MulRV(a,this.m_lalcB,this.m_rB),f=s.SubVV(s.AddVV(n,u,s.s_t0),s.AddVV(e,_,s.s_t1),Vt.SolvePositionConstraints_s_C_v2);h=f.Length();const p=this.m_invMassA,y=this.m_invMassB,B=this.m_invIA,A=this.m_invIB,x=this.m_K;x.ex.x=p+y+B*_.y*_.y+A*u.y*u.y,x.ex.y=-B*_.x*_.y-A*u.x*u.y,x.ey.x=x.ex.y,x.ey.y=p+y+B*_.x*_.x+A*u.x*u.x;const C=x.Solve(f.x,f.y,Vt.SolvePositionConstraints_s_impulse).SelfNeg();e.SelfMulSub(p,C),i-=B*s.CrossVV(_,C),n.SelfMulAdd(y,C),o+=A*s.CrossVV(u,C)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,h<=j&&l<=At}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){(t!==this.m_lowerAngle||e!==this.m_upperAngle)&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.referenceAngle = %.15f;
`,this.m_referenceAngle),t(`  jd.enableLimit = %s;
`,this.m_enableLimit?"true":"false"),t(`  jd.lowerAngle = %.15f;
`,this.m_lowerAngle),t(`  jd.upperAngle = %.15f;
`,this.m_upperAngle),t(`  jd.enableMotor = %s;
`,this.m_enableMotor?"true":"false"),t(`  jd.motorSpeed = %.15f;
`,this.m_motorSpeed),t(`  jd.maxMotorTorque = %.15f;
`,this.m_maxMotorTorque),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}Vt.InitVelocityConstraints_s_P=new s,Vt.SolveVelocityConstraints_s_P=new s,Vt.SolveVelocityConstraints_s_Cdot_v2=new s,Vt.SolveVelocityConstraints_s_Cdot1=new s,Vt.SolveVelocityConstraints_s_impulse_v3=new bt,Vt.SolveVelocityConstraints_s_reduced_v2=new s,Vt.SolveVelocityConstraints_s_impulse_v2=new s,Vt.SolvePositionConstraints_s_C_v2=new s,Vt.SolvePositionConstraints_s_impulse=new s;class Zr extends ne{constructor(){super(m.b2JointType.e_ropeJoint),this.localAnchorA=new s(-1,0),this.localAnchorB=new s(1,0),this.maxLength=0}}class ae extends oe{constructor(t){super(t),this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_maxLength=0,this.m_length=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new s,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_state=m.b2LimitState.e_inactiveLimit,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_localAnchorA.Copy(b(t.localAnchorA,new s(-1,0))),this.m_localAnchorB.Copy(b(t.localAnchorB,new s(1,0))),this.m_maxLength=b(t.maxLength,0)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(a);if(s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),V.MulRV(c,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),V.MulRV(_,this.m_lalcB,this.m_rB),this.m_u.Copy(r).SelfAdd(this.m_rB).SelfSub(e).SelfSub(this.m_rA),this.m_length=this.m_u.Length(),this.m_length-this.m_maxLength>0?this.m_state=m.b2LimitState.e_atUpperLimit:this.m_state=m.b2LimitState.e_inactiveLimit,this.m_length>j)this.m_u.SelfMul(1/this.m_length);else{this.m_u.SetZero(),this.m_mass=0,this.m_impulse=0;return}const f=s.CrossVV(this.m_rA,this.m_u),p=s.CrossVV(this.m_rB,this.m_u),y=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=y!==0?1/y:0,t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const B=s.MulSV(this.m_impulse,this.m_u,ae.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,B),o-=this.m_invIA*s.CrossVV(this.m_rA,B),l.SelfMulAdd(this.m_invMassB,B),h+=this.m_invIB*s.CrossVV(this.m_rB,B)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=s.AddVCrossSV(e,i,this.m_rA,ae.SolveVelocityConstraints_s_vpA),a=s.AddVCrossSV(n,o,this.m_rB,ae.SolveVelocityConstraints_s_vpB),l=this.m_length-this.m_maxLength;let h=s.DotVV(this.m_u,s.SubVV(a,r,s.s_t0));l<0&&(h+=t.step.inv_dt*l);let c=-this.m_mass*h;const _=this.m_impulse;this.m_impulse=tt(0,this.m_impulse+c),c=this.m_impulse-_;const u=s.MulSV(c,this.m_u,ae.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*s.CrossVV(this.m_rA,u),n.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*s.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=V.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=V.MulRV(a,this.m_lalcB,this.m_rB),c=this.m_u.Copy(n).SelfAdd(h).SelfSub(e).SelfSub(l),_=c.Normalize();let u=_-this.m_maxLength;u=gt(u,0,st);const f=-this.m_mass*u,p=s.MulSV(f,c,ae.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*s.CrossVV(l,p),n.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*s.CrossVV(h,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,_-this.m_maxLength<j}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return s.MulSV(t*this.m_impulse,this.m_u,e)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxLength(t){this.m_maxLength=t}GetMaxLength(){return this.m_maxLength}GetLimitState(){return this.m_state}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2RopeJointDef = new b2RopeJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.maxLength = %.15f;
`,this.m_maxLength),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}ae.InitVelocityConstraints_s_P=new s,ae.SolveVelocityConstraints_s_vpA=new s,ae.SolveVelocityConstraints_s_vpB=new s,ae.SolveVelocityConstraints_s_P=new s,ae.SolvePositionConstraints_s_P=new s;class Hr extends ne{constructor(){super(m.b2JointType.e_weldJoint),this.localAnchorA=new s,this.localAnchorB=new s,this.referenceAngle=0,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class wt extends oe{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new bt(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new s,this.m_rB=new s,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new he,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_K=new he,this.m_frequencyHz=b(t.frequencyHz,0),this.m_dampingRatio=b(t.dampingRatio,0),this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_referenceAngle=b(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),V.MulRV(l,this.m_lalcA,this.m_rA),s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),V.MulRV(h,this.m_lalcB,this.m_rB);const c=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=this.m_K;if(p.ex.x=c+_+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*f,p.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*f,p.ez.x=-this.m_rA.y*u-this.m_rB.y*f,p.ex.y=p.ey.x,p.ey.y=c+_+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*f,p.ez.y=this.m_rA.x*u+this.m_rB.x*f,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=u+f,this.m_frequencyHz>0){p.GetInverse22(this.m_mass);let y=u+f;const B=y>0?1/y:0,A=o-e-this.m_referenceAngle,x=2*q*this.m_frequencyHz,C=2*B*this.m_dampingRatio*x,v=B*x*x,g=t.step.dt;this.m_gamma=g*(C+g*v),this.m_gamma=this.m_gamma!==0?1/this.m_gamma:0,this.m_bias=A*g*v*this.m_gamma,y+=this.m_gamma,this.m_mass.ez.z=y!==0?1/y:0}else p.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const y=wt.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,y),n-=u*(s.CrossVV(this.m_rA,y)+this.m_impulse.z),r.SelfMulAdd(_,y),a+=f*(s.CrossVV(this.m_rB,y)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB;if(this.m_frequencyHz>0){const c=o-i,_=-this.m_mass.ez.z*(c+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=_,i-=l*_,o+=h*_;const u=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),wt.SolveVelocityConstraints_s_Cdot1),f=he.MulM33XY(this.m_mass,u.x,u.y,wt.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;const p=f;e.SelfMulSub(r,p),i-=l*s.CrossVV(this.m_rA,p),n.SelfMulAdd(a,p),o+=h*s.CrossVV(this.m_rB,p)}else{const c=s.SubVV(s.AddVCrossSV(n,o,this.m_rB,s.s_t0),s.AddVCrossSV(e,i,this.m_rA,s.s_t1),wt.SolveVelocityConstraints_s_Cdot1),_=o-i,u=he.MulM33XYZ(this.m_mass,c.x,c.y,_,wt.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(u);const f=wt.SolveVelocityConstraints_s_P.Set(u.x,u.y);e.SelfMulSub(r,f),i-=l*(s.CrossVV(this.m_rA,f)+u.z),n.SelfMulAdd(a,f),o+=h*(s.CrossVV(this.m_rB,f)+u.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o),l=this.m_invMassA,h=this.m_invMassB,c=this.m_invIA,_=this.m_invIB;s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const u=V.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const f=V.MulRV(a,this.m_lalcB,this.m_rB);let p,y;const B=this.m_K;if(B.ex.x=l+h+u.y*u.y*c+f.y*f.y*_,B.ey.x=-u.y*u.x*c-f.y*f.x*_,B.ez.x=-u.y*c-f.y*_,B.ex.y=B.ey.x,B.ey.y=l+h+u.x*u.x*c+f.x*f.x*_,B.ez.y=u.x*c+f.x*_,B.ex.z=B.ez.x,B.ey.z=B.ez.y,B.ez.z=c+_,this.m_frequencyHz>0){const A=s.SubVV(s.AddVV(n,f,s.s_t0),s.AddVV(e,u,s.s_t1),wt.SolvePositionConstraints_s_C1);p=A.Length(),y=0;const x=B.Solve22(A.x,A.y,wt.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(l,x),i-=c*s.CrossVV(u,x),n.SelfMulAdd(h,x),o+=_*s.CrossVV(f,x)}else{const A=s.SubVV(s.AddVV(n,f,s.s_t0),s.AddVV(e,u,s.s_t1),wt.SolvePositionConstraints_s_C1),x=o-i-this.m_referenceAngle;p=A.Length(),y=at(x);const C=B.Solve33(A.x,A.y,x,wt.SolvePositionConstraints_s_impulse).SelfNeg(),v=wt.SolvePositionConstraints_s_P.Set(C.x,C.y);e.SelfMulSub(l,v),i-=c*(s.CrossVV(this.m_rA,v)+C.z),n.SelfMulAdd(h,v),o+=_*(s.CrossVV(this.m_rB,v)+C.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,p<=j&&y<=At}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2WeldJointDef = new b2WeldJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.referenceAngle = %.15f;
`,this.m_referenceAngle),t(`  jd.frequencyHz = %.15f;
`,this.m_frequencyHz),t(`  jd.dampingRatio = %.15f;
`,this.m_dampingRatio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}wt.InitVelocityConstraints_s_P=new s,wt.SolveVelocityConstraints_s_Cdot1=new s,wt.SolveVelocityConstraints_s_impulse1=new s,wt.SolveVelocityConstraints_s_impulse=new bt,wt.SolveVelocityConstraints_s_P=new s,wt.SolvePositionConstraints_s_C1=new s,wt.SolvePositionConstraints_s_P=new s,wt.SolvePositionConstraints_s_impulse=new bt;class Qr extends ne{constructor(){super(m.b2JointType.e_wheelJoint),this.localAnchorA=new s(0,0),this.localAnchorB=new s(0,0),this.localAxisA=new s(1,0),this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.frequencyHz=2,this.dampingRatio=.7}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)}}class te extends oe{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_localAnchorA=new s,this.m_localAnchorB=new s,this.m_localXAxisA=new s,this.m_localYAxisA=new s,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new s,this.m_localCenterB=new s,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new s,this.m_ay=new s,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new V,this.m_qB=new V,this.m_lalcA=new s,this.m_lalcB=new s,this.m_rA=new s,this.m_rB=new s,this.m_frequencyHz=b(t.frequencyHz,2),this.m_dampingRatio=b(t.dampingRatio,.7),this.m_localAnchorA.Copy(b(t.localAnchorA,s.ZERO)),this.m_localAnchorB.Copy(b(t.localAnchorB,s.ZERO)),this.m_localXAxisA.Copy(b(t.localAxisA,s.UNITX)),s.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_maxMotorTorque=b(t.maxMotorTorque,0),this.m_motorSpeed=b(t.motorSpeed,0),this.m_enableMotor=b(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero()}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_frequencyHz=t}GetSpringFrequencyHz(){return this.m_frequencyHz}SetSpringDampingRatio(t){this.m_dampingRatio=t}GetSpringDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,o=this.m_invIB,r=t.positions[this.m_indexA].c,a=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v;let h=t.velocities[this.m_indexA].w;const c=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,u=t.velocities[this.m_indexB].v;let f=t.velocities[this.m_indexB].w;const p=this.m_qA.SetAngle(a),y=this.m_qB.SetAngle(_);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const B=V.MulRV(p,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const A=V.MulRV(y,this.m_lalcB,this.m_rB),x=s.SubVV(s.AddVV(c,A,s.s_t0),s.AddVV(r,B,s.s_t1),te.InitVelocityConstraints_s_d);if(V.MulRV(p,this.m_localYAxisA,this.m_ay),this.m_sAy=s.CrossVV(s.AddVV(x,B,s.s_t0),this.m_ay),this.m_sBy=s.CrossVV(A,this.m_ay),this.m_mass=e+i+n*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){V.MulRV(p,this.m_localXAxisA,this.m_ax),this.m_sAx=s.CrossVV(s.AddVV(x,B,s.s_t0),this.m_ax),this.m_sBx=s.CrossVV(A,this.m_ax);const C=e+i+n*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(C>0){this.m_springMass=1/C;const v=s.DotVV(x,this.m_ax),g=2*q*this.m_frequencyHz,I=2*this.m_springMass*this.m_dampingRatio*g,P=this.m_springMass*g*g,T=t.step.dt;this.m_gamma=T*(I+T*P),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=v*T*P*this.m_gamma,this.m_springMass=C+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const C=s.AddVV(s.MulSV(this.m_impulse,this.m_ay,s.s_t0),s.MulSV(this.m_springImpulse,this.m_ax,s.s_t1),te.InitVelocityConstraints_s_P),v=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,g=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,C),h-=this.m_invIA*v,u.SelfMulAdd(this.m_invMassB,C),f+=this.m_invIB*g}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=h,t.velocities[this.m_indexB].w=f}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,o=this.m_invIB,r=t.velocities[this.m_indexA].v;let a=t.velocities[this.m_indexA].w;const l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;{const c=s.DotVV(this.m_ax,s.SubVV(l,r,s.s_t0))+this.m_sBx*h-this.m_sAx*a,_=-this.m_springMass*(c+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=_;const u=s.MulSV(_,this.m_ax,te.SolveVelocityConstraints_s_P),f=_*this.m_sAx,p=_*this.m_sBx;r.SelfMulSub(e,u),a-=n*f,l.SelfMulAdd(i,u),h+=o*p}{const c=h-a-this.m_motorSpeed;let _=-this.m_motorMass*c;const u=this.m_motorImpulse,f=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=gt(this.m_motorImpulse+_,-f,f),_=this.m_motorImpulse-u,a-=n*_,h+=o*_}{const c=s.DotVV(this.m_ay,s.SubVV(l,r,s.s_t0))+this.m_sBy*h-this.m_sAy*a,_=-this.m_mass*c;this.m_impulse+=_;const u=s.MulSV(_,this.m_ay,te.SolveVelocityConstraints_s_P),f=_*this.m_sAy,p=_*this.m_sBy;r.SelfMulSub(e,u),a-=n*f,l.SelfMulAdd(i,u),h+=o*p}t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=h}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),a=this.m_qB.SetAngle(o);s.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=V.MulRV(r,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=V.MulRV(a,this.m_lalcB,this.m_rB),c=s.AddVV(s.SubVV(n,e,s.s_t0),s.SubVV(h,l,s.s_t1),te.SolvePositionConstraints_s_d),_=V.MulRV(r,this.m_localYAxisA,this.m_ay),u=s.CrossVV(s.AddVV(c,l,s.s_t0),_),f=s.CrossVV(h,_),p=s.DotVV(c,this.m_ay),y=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let B;y!==0?B=-p/y:B=0;const A=s.MulSV(B,_,te.SolvePositionConstraints_s_P),x=B*u,C=B*f;return e.SelfMulSub(this.m_invMassA,A),i-=this.m_invIA*x,n.SelfMulAdd(this.m_invMassB,A),o+=this.m_invIB*C,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,at(p)<=j}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new s),n=e.GetWorldPoint(this.m_localAnchorB,new s),o=s.SubVV(n,i,new s),r=t.GetWorldVector(this.m_localXAxisA,new s);return s.DotVV(o,r)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;s.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=V.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);s.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=V.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),o=s.AddVV(t.m_sweep.c,i,s.s_t0),r=s.AddVV(e.m_sweep.c,n,s.s_t1),a=s.SubVV(r,o,s.s_t2),l=t.GetWorldVector(this.m_localXAxisA,new s),h=t.m_linearVelocity,c=e.m_linearVelocity,_=t.m_angularVelocity,u=e.m_angularVelocity;return s.DotVV(a,s.CrossSV(_,l,s.s_t0))+s.DotVV(l,s.SubVV(s.AddVCrossSV(c,u,n,s.s_t0),s.AddVCrossSV(h,_,i,s.s_t1),s.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t(`  const jd: b2WheelJointDef = new b2WheelJointDef();
`),t(`  jd.bodyA = bodies[%d];
`,e),t(`  jd.bodyB = bodies[%d];
`,i),t(`  jd.collideConnected = %s;
`,this.m_collideConnected?"true":"false"),t(`  jd.localAnchorA.Set(%.15f, %.15f);
`,this.m_localAnchorA.x,this.m_localAnchorA.y),t(`  jd.localAnchorB.Set(%.15f, %.15f);
`,this.m_localAnchorB.x,this.m_localAnchorB.y),t(`  jd.localAxisA.Set(%.15f, %.15f);
`,this.m_localXAxisA.x,this.m_localXAxisA.y),t(`  jd.enableMotor = %s;
`,this.m_enableMotor?"true":"false"),t(`  jd.motorSpeed = %.15f;
`,this.m_motorSpeed),t(`  jd.maxMotorTorque = %.15f;
`,this.m_maxMotorTorque),t(`  jd.frequencyHz = %.15f;
`,this.m_frequencyHz),t(`  jd.dampingRatio = %.15f;
`,this.m_dampingRatio),t(`  joints[%d] = this.m_world.CreateJoint(jd);
`,this.m_index)}}te.InitVelocityConstraints_s_d=new s,te.InitVelocityConstraints_s_P=new s,te.SolveVelocityConstraints_s_P=new s,te.SolvePositionConstraints_s_d=new s,te.SolvePositionConstraints_s_P=new s;function hi(d,t){return ye(d*t)}function ci(d,t){return d>t?d:t}class ui{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(this._other===null)throw new Error;return this._other}set other(t){if(this._other!==null)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class le{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new ui(this),this.m_nodeB=new ui(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new He,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new He}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),o=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),o.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=hi(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=ci(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=hi(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=ci(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const n=this.m_touchingFlag,o=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),a=o||r,l=this.m_fixtureA.GetBody(),h=this.m_fixtureB.GetBody(),c=l.GetTransform(),_=h.GetTransform();if(a){const u=this.GetShapeA(),f=this.GetShapeB();i=ii(u,this.m_indexA,f,this.m_indexB,c,_),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,c,_),i=this.m_manifold.pointCount>0;for(let u=0;u<this.m_manifold.pointCount;++u){const f=this.m_manifold.points[u];f.normalImpulse=0,f.tangentImpulse=0;const p=f.id;for(let y=0;y<this.m_oldManifold.pointCount;++y){const B=this.m_oldManifold.points[y];if(B.id.key===p.key){f.normalImpulse=B.normalImpulse,f.tangentImpulse=B.tangentImpulse;break}}}i!==n&&(l.SetAwake(!0),h.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!a&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=le.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=j;const n=le.ComputeTOI_s_output;return ri(n,i),n.t}}le.ComputeTOI_s_input=new ni,le.ComputeTOI_s_output=new oi;class We extends le{static Create(){return new We}static Destroy(t){}Evaluate(t,e,i){Yi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Ye extends le{static Create(){return new Ye}static Destroy(t){}Evaluate(t,e,i){tn(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Ke extends le{static Create(){return new Ke}static Destroy(t){}Evaluate(t,e,i){Ki(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class $e extends le{static Create(){return new $e}static Destroy(t){}Evaluate(t,e,i){li(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class ts extends le{static Create(){return new ts}static Destroy(t){}Evaluate(t,e,i){mi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Te extends le{static Create(){return new Te}static Destroy(t){}Evaluate(t,e,i){const n=Te.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),li(t,n,e,this.GetShapeB(),i)}}Te.Evaluate_s_edge=new nt;class Re extends le{static Create(){return new Re}static Destroy(t){}Evaluate(t,e,i){const n=Re.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),mi(t,n,e,this.GetShapeB(),i)}}Re.Evaluate_s_edge=new nt;class an{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class ln{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,n){const o=[];function r(){return o.pop()||t()}function a(l){o.push(l)}this.m_registers[i][n].pool=o,this.m_registers[i][n].createFcn=r,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=o,this.m_registers[n][i].createFcn=r,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!1)}InitializeRegisters(){for(let t=0;t<m.b2ShapeType.e_shapeTypeCount;t++){this.m_registers[t]=[];for(let e=0;e<m.b2ShapeType.e_shapeTypeCount;e++)this.m_registers[t][e]=new an}this.AddType(We.Create,We.Destroy,m.b2ShapeType.e_circleShape,m.b2ShapeType.e_circleShape),this.AddType(Ke.Create,Ke.Destroy,m.b2ShapeType.e_polygonShape,m.b2ShapeType.e_circleShape),this.AddType(Ye.Create,Ye.Destroy,m.b2ShapeType.e_polygonShape,m.b2ShapeType.e_polygonShape),this.AddType($e.Create,$e.Destroy,m.b2ShapeType.e_edgeShape,m.b2ShapeType.e_circleShape),this.AddType(ts.Create,ts.Destroy,m.b2ShapeType.e_edgeShape,m.b2ShapeType.e_polygonShape),this.AddType(Te.Create,Te.Destroy,m.b2ShapeType.e_chainShape,m.b2ShapeType.e_circleShape),this.AddType(Re.Create,Re.Destroy,m.b2ShapeType.e_chainShape,m.b2ShapeType.e_polygonShape)}Create(t,e,i,n){const o=t.GetType(),r=i.GetType(),a=this.m_registers[o][r];if(a.createFcn){const l=a.createFcn();return a.primary?l.Reset(t,e,i,n):l.Reset(i,n,t,e),l}else return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)}}class Wr{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t,e){}}class Vs{ShouldCollide(t,e){const i=t.GetBody(),n=e.GetBody();if(n.GetType()===m.b2BodyType.b2_staticBody&&i.GetType()===m.b2BodyType.b2_staticBody||!n.ShouldCollideConnected(i))return!1;const o=t.GetFilterData(),r=e.GetFilterData();return o.groupIndex===r.groupIndex&&o.groupIndex!==0?o.groupIndex>0:(o.maskBits&r.categoryBits)!==0&&(o.categoryBits&r.maskBits)!==0}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}Vs.b2_defaultFilter=new Vs;class mn{constructor(){this.normalImpulses=Ie(J),this.tangentImpulses=Ie(J),this.count=0}}class ws{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}ws.b2_defaultListener=new ws;class Be{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class _n{ReportFixture(t,e,i,n){return n}ReportParticle(t,e,i,n,o){return 0}ShouldQueryParticleSystem(t){return!0}}class hn{constructor(){this.m_broadPhase=new Ui,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=Vs.b2_defaultFilter,this.m_contactListener=ws.b2_defaultListener,this.m_contactFactory=new ln}AddPair(t,e){let i=t.fixture,n=e.fixture,o=t.childIndex,r=e.childIndex,a=i.GetBody(),l=n.GetBody();if(a===l)return;let h=l.GetContactList();for(;h;){if(h.other===a){const _=h.contact.GetFixtureA(),u=h.contact.GetFixtureB(),f=h.contact.GetChildIndexA(),p=h.contact.GetChildIndexB();if(_===i&&u===n&&f===o&&p===r||_===n&&u===i&&f===r&&p===o)return}h=h.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n))return;const c=this.m_contactFactory.Create(i,o,n,r);c!==null&&(i=c.GetFixtureA(),n=c.GetFixtureB(),o=c.GetChildIndexA(),r=c.GetChildIndexB(),a=i.m_body,l=n.m_body,c.m_prev=null,c.m_next=this.m_contactList,this.m_contactList!==null&&(this.m_contactList.m_prev=c),this.m_contactList=c,c.m_nodeA.other=l,c.m_nodeA.prev=null,c.m_nodeA.next=a.m_contactList,a.m_contactList!==null&&(a.m_contactList.prev=c.m_nodeA),a.m_contactList=c.m_nodeA,c.m_nodeB.other=a,c.m_nodeB.prev=null,c.m_nodeB.next=l.m_contactList,l.m_contactList!==null&&(l.m_contactList.prev=c.m_nodeB),l.m_contactList=c.m_nodeB,!i.IsSensor()&&!n.IsSensor()&&(a.SetAwake(!0),l.SetAwake(!0)),++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs((t,e)=>{this.AddPair(t,e)})}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),o=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===o.m_contactList&&(o.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let t=this.m_contactList;for(;t;){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=t.GetChildIndexA(),o=t.GetChildIndexB(),r=e.GetBody(),a=i.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(e,i)){const f=t;t=f.m_next,this.Destroy(f);continue}t.m_filterFlag=!1}const l=r.IsAwake()&&r.m_type!==m.b2BodyType.b2_staticBody,h=a.IsAwake()&&a.m_type!==m.b2BodyType.b2_staticBody;if(!l&&!h){t=t.m_next;continue}const c=e.m_proxies[n].treeNode,_=i.m_proxies[o].treeNode;if(!si(c.aabb,_.aabb)){const f=t;t=f.m_next,this.Destroy(f);continue}t.Update(this.m_contactListener),t=t.m_next}}}class di{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class ke{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class es{constructor(){this.c=new s,this.a=0}static MakeArray(t){return Wt(t,e=>new es)}}class ss{constructor(){this.v=new s,this.w=0}static MakeArray(t){return Wt(t,e=>new ss)}}class cn{constructor(){this.step=new ke}}let fi=!1;class gs{constructor(){this.rA=new s,this.rB=new s,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return Wt(t,e=>new gs)}}class is{constructor(){this.points=gs.MakeArray(J),this.normal=new s,this.tangent=new s,this.normalMass=new ft,this.K=new ft,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return Wt(t,e=>new is)}}class ns{constructor(){this.localPoints=s.MakeArray(J),this.localNormal=new s,this.localPoint=new s,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new s,this.localCenterB=new s,this.invIA=0,this.invIB=0,this.type=m.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return Wt(t,e=>new ns)}}class un{constructor(){this.step=new ke,this.count=0}}class ce{constructor(){this.normal=new s,this.point=new s,this.separation=0}Initialize(t,e,i,n){const o=ce.Initialize_s_pointA,r=ce.Initialize_s_pointB,a=ce.Initialize_s_planePoint,l=ce.Initialize_s_clipPoint;switch(t.type){case m.b2ManifoldType.e_circles:{M.MulXV(e,t.localPoint,o),M.MulXV(i,t.localPoints[0],r),s.SubVV(r,o,this.normal).SelfNormalize(),s.MidVV(o,r,this.point),this.separation=s.DotVV(s.SubVV(r,o,s.s_t0),this.normal)-t.radiusA-t.radiusB;break}case m.b2ManifoldType.e_faceA:{V.MulRV(e.q,t.localNormal,this.normal),M.MulXV(e,t.localPoint,a),M.MulXV(i,t.localPoints[n],l),this.separation=s.DotVV(s.SubVV(l,a,s.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(l);break}case m.b2ManifoldType.e_faceB:{V.MulRV(i.q,t.localNormal,this.normal),M.MulXV(i,t.localPoint,a),M.MulXV(e,t.localPoints[n],l),this.separation=s.DotVV(s.SubVV(l,a,s.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(l),this.normal.SelfNeg();break}}}}ce.Initialize_s_pointA=new s,ce.Initialize_s_pointB=new s,ce.Initialize_s_planePoint=new s,ce.Initialize_s_clipPoint=new s;class z{constructor(){this.m_step=new ke,this.m_positionConstraints=ns.MakeArray(1024),this.m_velocityConstraints=is.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const e=H(this.m_positionConstraints.length*2,this.m_count);for(;this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new ns}if(this.m_velocityConstraints.length<this.m_count){const e=H(this.m_velocityConstraints.length*2,this.m_count);for(;this.m_velocityConstraints.length<e;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new is}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let e=0;e<this.m_count;++e){const i=this.m_contacts[e],n=i.m_fixtureA,o=i.m_fixtureB,r=n.GetShape(),a=o.GetShape(),l=r.m_radius,h=a.m_radius,c=n.GetBody(),_=o.GetBody(),u=i.GetManifold(),f=u.pointCount,p=this.m_velocityConstraints[e];p.friction=i.m_friction,p.restitution=i.m_restitution,p.tangentSpeed=i.m_tangentSpeed,p.indexA=c.m_islandIndex,p.indexB=_.m_islandIndex,p.invMassA=c.m_invMass,p.invMassB=_.m_invMass,p.invIA=c.m_invI,p.invIB=_.m_invI,p.contactIndex=e,p.pointCount=f,p.K.SetZero(),p.normalMass.SetZero();const y=this.m_positionConstraints[e];y.indexA=c.m_islandIndex,y.indexB=_.m_islandIndex,y.invMassA=c.m_invMass,y.invMassB=_.m_invMass,y.localCenterA.Copy(c.m_sweep.localCenter),y.localCenterB.Copy(_.m_sweep.localCenter),y.invIA=c.m_invI,y.invIB=_.m_invI,y.localNormal.Copy(u.localNormal),y.localPoint.Copy(u.localPoint),y.pointCount=f,y.radiusA=l,y.radiusB=h,y.type=u.type;for(let B=0;B<f;++B){const A=u.points[B],x=p.points[B];this.m_step.warmStarting?(x.normalImpulse=this.m_step.dtRatio*A.normalImpulse,x.tangentImpulse=this.m_step.dtRatio*A.tangentImpulse):(x.normalImpulse=0,x.tangentImpulse=0),x.rA.SetZero(),x.rB.SetZero(),x.normalMass=0,x.tangentMass=0,x.velocityBias=0,y.localPoints[B].Copy(A.localPoint)}}return this}InitializeVelocityConstraints(){const t=z.InitializeVelocityConstraints_s_xfA,e=z.InitializeVelocityConstraints_s_xfB,i=z.InitializeVelocityConstraints_s_worldManifold,n=1e3;for(let o=0;o<this.m_count;++o){const r=this.m_velocityConstraints[o],a=this.m_positionConstraints[o],l=a.radiusA,h=a.radiusB,c=this.m_contacts[r.contactIndex].GetManifold(),_=r.indexA,u=r.indexB,f=r.invMassA,p=r.invMassB,y=r.invIA,B=r.invIB,A=a.localCenterA,x=a.localCenterB,C=this.m_positions[_].c,v=this.m_positions[_].a,g=this.m_velocities[_].v,I=this.m_velocities[_].w,P=this.m_positions[u].c,T=this.m_positions[u].a,F=this.m_velocities[u].v,R=this.m_velocities[u].w;t.q.SetAngle(v),e.q.SetAngle(T),s.SubVV(C,V.MulRV(t.q,A,s.s_t0),t.p),s.SubVV(P,V.MulRV(e.q,x,s.s_t0),e.p),i.Initialize(c,t,l,e,h),r.normal.Copy(i.normal),s.CrossVOne(r.normal,r.tangent);const E=r.pointCount;for(let L=0;L<E;++L){const G=r.points[L];s.SubVV(i.points[L],C,G.rA),s.SubVV(i.points[L],P,G.rB);const X=s.CrossVV(G.rA,r.normal),O=s.CrossVV(G.rB,r.normal),$=f+p+y*X*X+B*O*O;G.normalMass=$>0?1/$:0;const lt=r.tangent,_t=s.CrossVV(G.rA,lt),kt=s.CrossVV(G.rB,lt),qt=f+p+y*_t*_t+B*kt*kt;G.tangentMass=qt>0?1/qt:0,G.velocityBias=0;const zt=s.DotVV(r.normal,s.SubVV(s.AddVCrossSV(F,R,G.rB,s.s_t0),s.AddVCrossSV(g,I,G.rA,s.s_t1),s.s_t0));zt<-mt&&(G.velocityBias+=-r.restitution*zt)}if(r.pointCount===2&&fi){const L=r.points[0],G=r.points[1],X=s.CrossVV(L.rA,r.normal),O=s.CrossVV(L.rB,r.normal),$=s.CrossVV(G.rA,r.normal),lt=s.CrossVV(G.rB,r.normal),_t=f+p+y*X*X+B*O*O,kt=f+p+y*$*$+B*lt*lt,qt=f+p+y*X*$+B*O*lt;_t*_t<n*(_t*kt-qt*qt)?(r.K.ex.Set(_t,qt),r.K.ey.Set(qt,kt),r.K.GetInverse(r.normalMass)):r.pointCount=1}}}WarmStart(){const t=z.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],n=i.indexA,o=i.indexB,r=i.invMassA,a=i.invIA,l=i.invMassB,h=i.invIB,c=i.pointCount,_=this.m_velocities[n].v;let u=this.m_velocities[n].w;const f=this.m_velocities[o].v;let p=this.m_velocities[o].w;const y=i.normal,B=i.tangent;for(let A=0;A<c;++A){const x=i.points[A];s.AddVV(s.MulSV(x.normalImpulse,y,s.s_t0),s.MulSV(x.tangentImpulse,B,s.s_t1),t),u-=a*s.CrossVV(x.rA,t),_.SelfMulSub(r,t),p+=h*s.CrossVV(x.rB,t),f.SelfMulAdd(l,t)}this.m_velocities[n].w=u,this.m_velocities[o].w=p}}SolveVelocityConstraints(){const t=z.SolveVelocityConstraints_s_dv,e=z.SolveVelocityConstraints_s_dv1,i=z.SolveVelocityConstraints_s_dv2,n=z.SolveVelocityConstraints_s_P,o=z.SolveVelocityConstraints_s_a,r=z.SolveVelocityConstraints_s_b,a=z.SolveVelocityConstraints_s_x,l=z.SolveVelocityConstraints_s_d,h=z.SolveVelocityConstraints_s_P1,c=z.SolveVelocityConstraints_s_P2,_=z.SolveVelocityConstraints_s_P1P2;for(let u=0;u<this.m_count;++u){const f=this.m_velocityConstraints[u],p=f.indexA,y=f.indexB,B=f.invMassA,A=f.invIA,x=f.invMassB,C=f.invIB,v=f.pointCount,g=this.m_velocities[p].v;let I=this.m_velocities[p].w;const P=this.m_velocities[y].v;let T=this.m_velocities[y].w;const F=f.normal,R=f.tangent,E=f.friction;for(let L=0;L<v;++L){const G=f.points[L];s.SubVV(s.AddVCrossSV(P,T,G.rB,s.s_t0),s.AddVCrossSV(g,I,G.rA,s.s_t1),t);const X=s.DotVV(t,R)-f.tangentSpeed;let O=G.tangentMass*-X;const $=E*G.normalImpulse,lt=gt(G.tangentImpulse+O,-$,$);O=lt-G.tangentImpulse,G.tangentImpulse=lt,s.MulSV(O,R,n),g.SelfMulSub(B,n),I-=A*s.CrossVV(G.rA,n),P.SelfMulAdd(x,n),T+=C*s.CrossVV(G.rB,n)}if(f.pointCount===1||fi===!1)for(let L=0;L<v;++L){const G=f.points[L];s.SubVV(s.AddVCrossSV(P,T,G.rB,s.s_t0),s.AddVCrossSV(g,I,G.rA,s.s_t1),t);const X=s.DotVV(t,F);let O=-G.normalMass*(X-G.velocityBias);const $=H(G.normalImpulse+O,0);O=$-G.normalImpulse,G.normalImpulse=$,s.MulSV(O,F,n),g.SelfMulSub(B,n),I-=A*s.CrossVV(G.rA,n),P.SelfMulAdd(x,n),T+=C*s.CrossVV(G.rB,n)}else{const L=f.points[0],G=f.points[1];o.Set(L.normalImpulse,G.normalImpulse),s.SubVV(s.AddVCrossSV(P,T,L.rB,s.s_t0),s.AddVCrossSV(g,I,L.rA,s.s_t1),e),s.SubVV(s.AddVCrossSV(P,T,G.rB,s.s_t0),s.AddVCrossSV(g,I,G.rA,s.s_t1),i);let X=s.DotVV(e,F),O=s.DotVV(i,F);for(r.x=X-L.velocityBias,r.y=O-G.velocityBias,r.SelfSub(ft.MulMV(f.K,o,s.s_t0));;){if(ft.MulMV(f.normalMass,r,a).SelfNeg(),a.x>=0&&a.y>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,h),s.MulSV(l.y,F,c),s.AddVV(h,c,_),g.SelfMulSub(B,_),I-=A*(s.CrossVV(L.rA,h)+s.CrossVV(G.rA,c)),P.SelfMulAdd(x,_),T+=C*(s.CrossVV(L.rB,h)+s.CrossVV(G.rB,c)),L.normalImpulse=a.x,G.normalImpulse=a.y;break}if(a.x=-L.normalMass*r.x,a.y=0,X=0,O=f.K.ex.y*a.x+r.y,a.x>=0&&O>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,h),s.MulSV(l.y,F,c),s.AddVV(h,c,_),g.SelfMulSub(B,_),I-=A*(s.CrossVV(L.rA,h)+s.CrossVV(G.rA,c)),P.SelfMulAdd(x,_),T+=C*(s.CrossVV(L.rB,h)+s.CrossVV(G.rB,c)),L.normalImpulse=a.x,G.normalImpulse=a.y;break}if(a.x=0,a.y=-G.normalMass*r.y,X=f.K.ey.x*a.y+r.x,O=0,a.y>=0&&X>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,h),s.MulSV(l.y,F,c),s.AddVV(h,c,_),g.SelfMulSub(B,_),I-=A*(s.CrossVV(L.rA,h)+s.CrossVV(G.rA,c)),P.SelfMulAdd(x,_),T+=C*(s.CrossVV(L.rB,h)+s.CrossVV(G.rB,c)),L.normalImpulse=a.x,G.normalImpulse=a.y;break}if(a.x=0,a.y=0,X=r.x,O=r.y,X>=0&&O>=0){s.SubVV(a,o,l),s.MulSV(l.x,F,h),s.MulSV(l.y,F,c),s.AddVV(h,c,_),g.SelfMulSub(B,_),I-=A*(s.CrossVV(L.rA,h)+s.CrossVV(G.rA,c)),P.SelfMulAdd(x,_),T+=C*(s.CrossVV(L.rB,h)+s.CrossVV(G.rB,c)),L.normalImpulse=a.x,G.normalImpulse=a.y;break}break}}this.m_velocities[p].w=I,this.m_velocities[y].w=T}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let n=0;n<e.pointCount;++n)i.points[n].normalImpulse=e.points[n].normalImpulse,i.points[n].tangentImpulse=e.points[n].tangentImpulse}}SolvePositionConstraints(){const t=z.SolvePositionConstraints_s_xfA,e=z.SolvePositionConstraints_s_xfB,i=z.SolvePositionConstraints_s_psm,n=z.SolvePositionConstraints_s_rA,o=z.SolvePositionConstraints_s_rB,r=z.SolvePositionConstraints_s_P;let a=0;for(let l=0;l<this.m_count;++l){const h=this.m_positionConstraints[l],c=h.indexA,_=h.indexB,u=h.localCenterA,f=h.invMassA,p=h.invIA,y=h.localCenterB,B=h.invMassB,A=h.invIB,x=h.pointCount,C=this.m_positions[c].c;let v=this.m_positions[c].a;const g=this.m_positions[_].c;let I=this.m_positions[_].a;for(let P=0;P<x;++P){t.q.SetAngle(v),e.q.SetAngle(I),s.SubVV(C,V.MulRV(t.q,u,s.s_t0),t.p),s.SubVV(g,V.MulRV(e.q,y,s.s_t0),e.p),i.Initialize(h,t,e,P);const T=i.normal,F=i.point,R=i.separation;s.SubVV(F,C,n),s.SubVV(F,g,o),a=tt(a,R);const E=gt(xe*(R+j),-st,0),L=s.CrossVV(n,T),G=s.CrossVV(o,T),X=f+B+p*L*L+A*G*G,O=X>0?-E/X:0;s.MulSV(O,T,r),C.SelfMulSub(f,r),v-=p*s.CrossVV(n,r),g.SelfMulAdd(B,r),I+=A*s.CrossVV(o,r)}this.m_positions[c].a=v,this.m_positions[_].a=I}return a>-3*j}SolveTOIPositionConstraints(t,e){const i=z.SolveTOIPositionConstraints_s_xfA,n=z.SolveTOIPositionConstraints_s_xfB,o=z.SolveTOIPositionConstraints_s_psm,r=z.SolveTOIPositionConstraints_s_rA,a=z.SolveTOIPositionConstraints_s_rB,l=z.SolveTOIPositionConstraints_s_P;let h=0;for(let c=0;c<this.m_count;++c){const _=this.m_positionConstraints[c],u=_.indexA,f=_.indexB,p=_.localCenterA,y=_.localCenterB,B=_.pointCount;let A=0,x=0;(u===t||u===e)&&(A=_.invMassA,x=_.invIA);let C=0,v=0;(f===t||f===e)&&(C=_.invMassB,v=_.invIB);const g=this.m_positions[u].c;let I=this.m_positions[u].a;const P=this.m_positions[f].c;let T=this.m_positions[f].a;for(let F=0;F<B;++F){i.q.SetAngle(I),n.q.SetAngle(T),s.SubVV(g,V.MulRV(i.q,p,s.s_t0),i.p),s.SubVV(P,V.MulRV(n.q,y,s.s_t0),n.p),o.Initialize(_,i,n,F);const R=o.normal,E=o.point,L=o.separation;s.SubVV(E,g,r),s.SubVV(E,P,a),h=tt(h,L);const G=gt(Se*(L+j),-st,0),X=s.CrossVV(r,R),O=s.CrossVV(a,R),$=A+C+x*X*X+v*O*O,lt=$>0?-G/$:0;s.MulSV(lt,R,l),g.SelfMulSub(A,l),I-=x*s.CrossVV(r,l),P.SelfMulAdd(C,l),T+=v*s.CrossVV(a,l)}this.m_positions[u].a=I,this.m_positions[f].a=T}return h>=-1.5*j}}z.InitializeVelocityConstraints_s_xfA=new M,z.InitializeVelocityConstraints_s_xfB=new M,z.InitializeVelocityConstraints_s_worldManifold=new Mt,z.WarmStart_s_P=new s,z.SolveVelocityConstraints_s_dv=new s,z.SolveVelocityConstraints_s_dv1=new s,z.SolveVelocityConstraints_s_dv2=new s,z.SolveVelocityConstraints_s_P=new s,z.SolveVelocityConstraints_s_a=new s,z.SolveVelocityConstraints_s_b=new s,z.SolveVelocityConstraints_s_x=new s,z.SolveVelocityConstraints_s_d=new s,z.SolveVelocityConstraints_s_P1=new s,z.SolveVelocityConstraints_s_P2=new s,z.SolveVelocityConstraints_s_P1P2=new s,z.SolvePositionConstraints_s_xfA=new M,z.SolvePositionConstraints_s_xfB=new M,z.SolvePositionConstraints_s_psm=new ce,z.SolvePositionConstraints_s_rA=new s,z.SolvePositionConstraints_s_rB=new s,z.SolvePositionConstraints_s_P=new s,z.SolveTOIPositionConstraints_s_xfA=new M,z.SolveTOIPositionConstraints_s_xfB=new M,z.SolveTOIPositionConstraints_s_psm=new ce,z.SolveTOIPositionConstraints_s_rA=new s,z.SolveTOIPositionConstraints_s_rB=new s,z.SolveTOIPositionConstraints_s_P=new s;class Rt{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=es.MakeArray(1024),this.m_velocities=ss.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t){const o=H(this.m_positions.length*2,t);for(;this.m_positions.length<o;)this.m_positions[this.m_positions.length]=new es}if(this.m_velocities.length<t){const o=H(this.m_velocities.length*2,t);for(;this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new ss}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(t,e,i,n){const o=Rt.s_timer.Reset(),r=e.dt;for(let _=0;_<this.m_bodyCount;++_){const u=this.m_bodies[_];this.m_positions[_].c.Copy(u.m_sweep.c);const f=u.m_sweep.a,p=this.m_velocities[_].v.Copy(u.m_linearVelocity);let y=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===m.b2BodyType.b2_dynamicBody&&(p.x+=r*(u.m_gravityScale*i.x+u.m_invMass*u.m_force.x),p.y+=r*(u.m_gravityScale*i.y+u.m_invMass*u.m_force.y),y+=r*u.m_invI*u.m_torque,p.SelfMul(1/(1+r*u.m_linearDamping)),y*=1/(1+r*u.m_angularDamping)),this.m_positions[_].a=f,this.m_velocities[_].w=y}o.Reset();const a=Rt.s_solverData;a.step.Copy(e),a.positions=this.m_positions,a.velocities=this.m_velocities;const l=Rt.s_contactSolverDef;l.step.Copy(e),l.contacts=this.m_contacts,l.count=this.m_contactCount,l.positions=this.m_positions,l.velocities=this.m_velocities;const h=Rt.s_contactSolver.Initialize(l);h.InitializeVelocityConstraints(),e.warmStarting&&h.WarmStart();for(let _=0;_<this.m_jointCount;++_)this.m_joints[_].InitVelocityConstraints(a);t.solveInit=o.GetMilliseconds(),o.Reset();for(let _=0;_<e.velocityIterations;++_){for(let u=0;u<this.m_jointCount;++u)this.m_joints[u].SolveVelocityConstraints(a);h.SolveVelocityConstraints()}h.StoreImpulses(),t.solveVelocity=o.GetMilliseconds();for(let _=0;_<this.m_bodyCount;++_){const u=this.m_positions[_].c;let f=this.m_positions[_].a;const p=this.m_velocities[_].v;let y=this.m_velocities[_].w;const B=s.MulSV(r,p,Rt.s_translation);if(s.DotVV(B,B)>Me){const x=$t/B.Length();p.SelfMul(x)}const A=r*y;A*A>Lt&&(y*=rt/at(A)),u.x+=r*p.x,u.y+=r*p.y,f+=r*y,this.m_positions[_].a=f,this.m_velocities[_].w=y}o.Reset();let c=!1;for(let _=0;_<e.positionIterations;++_){const u=h.SolvePositionConstraints();let f=!0;for(let p=0;p<this.m_jointCount;++p){const y=this.m_joints[p].SolvePositionConstraints(a);f=f&&y}if(u&&f){c=!0;break}}for(let _=0;_<this.m_bodyCount;++_){const u=this.m_bodies[_];u.m_sweep.c.Copy(this.m_positions[_].c),u.m_sweep.a=this.m_positions[_].a,u.m_linearVelocity.Copy(this.m_velocities[_].v),u.m_angularVelocity=this.m_velocities[_].w,u.SynchronizeTransform()}if(t.solvePosition=o.GetMilliseconds(),this.Report(h.m_velocityConstraints),n){let _=k;const u=Us*Us,f=Zs*Zs;for(let p=0;p<this.m_bodyCount;++p){const y=this.m_bodies[p];y.GetType()!==m.b2BodyType.b2_staticBody&&(!y.m_autoSleepFlag||y.m_angularVelocity*y.m_angularVelocity>f||s.DotVV(y.m_linearVelocity,y.m_linearVelocity)>u?(y.m_sleepTime=0,_=0):(y.m_sleepTime+=r,_=tt(_,y.m_sleepTime)))}if(_>=Pe&&c)for(let p=0;p<this.m_bodyCount;++p)this.m_bodies[p].SetAwake(!1)}}SolveTOI(t,e,i){for(let a=0;a<this.m_bodyCount;++a){const l=this.m_bodies[a];this.m_positions[a].c.Copy(l.m_sweep.c),this.m_positions[a].a=l.m_sweep.a,this.m_velocities[a].v.Copy(l.m_linearVelocity),this.m_velocities[a].w=l.m_angularVelocity}const n=Rt.s_contactSolverDef;n.contacts=this.m_contacts,n.count=this.m_contactCount,n.step.Copy(t),n.positions=this.m_positions,n.velocities=this.m_velocities;const o=Rt.s_contactSolver.Initialize(n);for(let a=0;a<t.positionIterations&&!o.SolveTOIPositionConstraints(e,i);++a);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,o.InitializeVelocityConstraints();for(let a=0;a<t.velocityIterations;++a)o.SolveVelocityConstraints();const r=t.dt;for(let a=0;a<this.m_bodyCount;++a){const l=this.m_positions[a].c;let h=this.m_positions[a].a;const c=this.m_velocities[a].v;let _=this.m_velocities[a].w;const u=s.MulSV(r,c,Rt.s_translation);if(s.DotVV(u,u)>Me){const y=$t/u.Length();c.SelfMul(y)}const f=r*_;f*f>Lt&&(_*=rt/at(f)),l.SelfMulAdd(r,c),h+=r*_,this.m_positions[a].a=h,this.m_velocities[a].w=_;const p=this.m_bodies[a];p.m_sweep.c.Copy(l),p.m_sweep.a=h,p.m_linearVelocity.Copy(c),p.m_angularVelocity=_,p.SynchronizeTransform()}this.Report(o.m_velocityConstraints)}Report(t){if(this.m_listener!==null)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const n=t[e],o=Rt.s_impulse;o.count=n.pointCount;for(let r=0;r<n.pointCount;++r)o.normalImpulses[r]=n.points[r].normalImpulse,o.tangentImpulses[r]=n.points[r].tangentImpulse;this.m_listener.PostSolve(i,o)}}}Rt.s_timer=new je,Rt.s_solverData=new cn,Rt.s_contactSolverDef=new un,Rt.s_contactSolver=new z,Rt.s_translation=new s,Rt.s_impulse=new mn,function(d){d[d.b2_waterParticle=0]="b2_waterParticle",d[d.b2_zombieParticle=2]="b2_zombieParticle",d[d.b2_wallParticle=4]="b2_wallParticle",d[d.b2_springParticle=8]="b2_springParticle",d[d.b2_elasticParticle=16]="b2_elasticParticle",d[d.b2_viscousParticle=32]="b2_viscousParticle",d[d.b2_powderParticle=64]="b2_powderParticle",d[d.b2_tensileParticle=128]="b2_tensileParticle",d[d.b2_colorMixingParticle=256]="b2_colorMixingParticle",d[d.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",d[d.b2_barrierParticle=1024]="b2_barrierParticle",d[d.b2_staticPressureParticle=2048]="b2_staticPressureParticle",d[d.b2_reactiveParticle=4096]="b2_reactiveParticle",d[d.b2_repulsiveParticle=8192]="b2_repulsiveParticle",d[d.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",d[d.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",d[d.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",d[d.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle"}(m.b2ParticleFlag||(m.b2ParticleFlag={}));class pi{constructor(){this.flags=0,this.position=new s,this.velocity=new s,this.color=new ct(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}}function dn(d,t,e){const o=Math.ceil(Math.sqrt(d/(.01*t))*e);return gt(o,1,8)}class fn{constructor(){this.m_index=jt}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}(function(d){d[d.b2_solidParticleGroup=1]="b2_solidParticleGroup",d[d.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",d[d.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",d[d.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",d[d.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",d[d.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask"})(m.b2ParticleGroupFlag||(m.b2ParticleGroupFlag={}));class pn{constructor(){this.flags=0,this.groupFlags=0,this.position=new s,this.angle=0,this.linearVelocity=new s,this.angularVelocity=0,this.color=new ct,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}}class os{constructor(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new s,this.m_linearVelocity=new s,this.m_angularVelocity=0,this.m_transform=new M,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){if(!this.m_system.m_flagsBuffer.data)throw new Error;let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(t){t|=this.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,t)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=os.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),s.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(this.m_system.m_world.IsLocked())throw new Error;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;const t=new s,e=new s;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[n]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[n]);if(this.m_mass>0){const n=1/this.m_mass;this.m_center.SelfMul(n),this.m_linearVelocity.SelfMul(n)}this.m_inertia=0,this.m_angularVelocity=0;for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)s.SubVV(this.m_system.m_positionBuffer.data[n],this.m_center,t),s.SubVV(this.m_system.m_velocityBuffer.data[n],this.m_linearVelocity,e),this.m_inertia+=i*s.DotVV(t,t),this.m_angularVelocity+=i*s.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}os.GetLinearVelocityFromWorldPoint_s_t0=new s;class Yr{constructor(t){this.m_front=0,this.m_back=0,this.m_capacity=0,this.m_buffer=Wt(t,e=>null),this.m_capacity=t}Push(t){if(this.m_back>=this.m_capacity){for(let e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0,this.m_back>=this.m_capacity&&(this.m_capacity>0?(this.m_buffer.concat(Wt(this.m_capacity,e=>null)),this.m_capacity*=2):(this.m_buffer.concat(Wt(1,e=>null)),this.m_capacity=1))}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_buffer[this.m_front]=null,this.m_front++}Empty(){return this.m_front===this.m_back}Front(){const t=this.m_buffer[this.m_front];if(!t)throw new Error;return t}}class Kr{constructor(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=Wt(t,e=>new $r),this.m_generatorCapacity=t}AddGenerator(t,e,i){const n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i}Generate(t,e){const i=1/t,n=new s(+k,+k),o=new s(-k,-k);let r=0;for(let l=0;l<this.m_generatorCount;l++){const h=this.m_generatorBuffer[l];h.necessary&&(s.MinV(n,h.center,n),s.MaxV(o,h.center,o),++r)}if(r===0){this.m_countX=0,this.m_countY=0;return}n.x-=e,n.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(i*(o.x-n.x)),this.m_countY=1+Math.floor(i*(o.y-n.y)),this.m_diagram=[];const a=new Yr(4*this.m_countX*this.m_countY);for(let l=0;l<this.m_generatorCount;l++){const h=this.m_generatorBuffer[l];h.center.SelfSub(n).SelfMul(i);const c=Math.floor(h.center.x),_=Math.floor(h.center.y);c>=0&&_>=0&&c<this.m_countX&&_<this.m_countY&&a.Push(new me(c,_,c+_*this.m_countX,h))}for(;!a.Empty();){const l=a.Front(),h=l.m_x,c=l.m_y,_=l.m_i,u=l.m_generator;a.Pop(),this.m_diagram[_]||(this.m_diagram[_]=u,h>0&&a.Push(new me(h-1,c,_-1,u)),c>0&&a.Push(new me(h,c-1,_-this.m_countX,u)),h<this.m_countX-1&&a.Push(new me(h+1,c,_+1,u)),c<this.m_countY-1&&a.Push(new me(h,c+1,_+this.m_countX,u)))}for(let l=0;l<this.m_countY;l++)for(let h=0;h<this.m_countX-1;h++){const c=h+l*this.m_countX,_=this.m_diagram[c],u=this.m_diagram[c+1];_!==u&&(a.Push(new me(h,l,c,u)),a.Push(new me(h+1,l,c+1,_)))}for(let l=0;l<this.m_countY-1;l++)for(let h=0;h<this.m_countX;h++){const c=h+l*this.m_countX,_=this.m_diagram[c],u=this.m_diagram[c+this.m_countX];_!==u&&(a.Push(new me(h,l,c,u)),a.Push(new me(h,l+1,c+this.m_countX,_)))}for(;!a.Empty();){const l=a.Front(),h=l.m_x,c=l.m_y,_=l.m_i,u=l.m_generator;a.Pop();const f=this.m_diagram[_],p=u;if(f!==p){const y=f.center.x-h,B=f.center.y-c,A=p.center.x-h,x=p.center.y-c,C=y*y+B*B,v=A*A+x*x;C>v&&(this.m_diagram[_]=p,h>0&&a.Push(new me(h-1,c,_-1,p)),c>0&&a.Push(new me(h,c-1,_-this.m_countX,p)),h<this.m_countX-1&&a.Push(new me(h+1,c,_+1,p)),c<this.m_countY-1&&a.Push(new me(h,c+1,_+this.m_countX,p)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){const n=i+e*this.m_countX,o=this.m_diagram[n],r=this.m_diagram[n+1],a=this.m_diagram[n+this.m_countX],l=this.m_diagram[n+1+this.m_countX];r!==a&&(o!==r&&o!==a&&(o.necessary||r.necessary||a.necessary)&&t(o.tag,r.tag,a.tag),l!==r&&l!==a&&(o.necessary||r.necessary||a.necessary)&&t(r.tag,l.tag,a.tag))}}}class $r{constructor(){this.center=new s,this.tag=0,this.necessary=!1}}class me{constructor(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n}}function Ms(d,t,e){const i=d[t];d[t]=d[e],d[e]=i}function yn(d,t){return d<t}function Ps(d,t=0,e=d.length-t,i=yn){let n=t;const o=[];let r=0;for(;;){for(;n+1<e;e++){const a=d[n+Math.floor(Math.random()*(e-n))];o[r++]=e;for(let l=n-1;;){for(;i(d[++l],a););for(;i(a,d[--e]););if(l>=e)break;Ms(d,l,e)}}if(r===0)break;n=e,e=o[--r]}return d}function Bn(d,t=0,e=d.length-t,i=yn){return Ps(d,t,e,i)}function An(d,t,e=d.length){let i=0;for(let n=0;n<e;++n)if(!t(d[n])){if(n===i){++i;continue}Ms(d,i++,n)}return i}function xn(d,t,e,i,n){let o=e-t;for(;o>0;){const r=Math.floor(o/2);let a=t+r;n(d[a],i)?(t=++a,o-=r+1):o=r}return t}function Sn(d,t,e,i,n){let o=e-t;for(;o>0;){const r=Math.floor(o/2);let a=t+r;n(i,d[a])?o=r:(t=++a,o-=r+1)}return t}function ee(d,t,e,i){let n=e;for(;t!==n;)Ms(d,t++,n++),n===i?n=e:t===e&&(e=n)}function ta(d,t,e,i){if(t===e)return e;let n=t;for(;++t!==e;)i(d[n],d[t])||Ms(d,++n,t);return++n}class qe{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){const t=this.capacity?2*this.capacity:vt;this.Reserve(t)}Free(){this.data.length!==0&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){this.count=An(this.data,t,this.count)}Unique(t){this.count=ta(this.data,0,this.count,t)}}class yi extends Be{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const i=t.GetShape().GetChildCount();for(let n=0;n<i;n++){const o=t.GetAABB(n),r=this.m_system.GetInsideBoundsEnumerator(o);let a;for(;(a=r.GetNext())>=0;)this.ReportFixtureAndParticle(t,n,a)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class Cn{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new s,this.flags=0}SetIndices(t,e){this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&at(this.weight-t.weight)<.01&&s.DistanceSquaredVV(this.normal,t.normal)<1e-4}}class vn{constructor(){this.index=0,this.weight=0,this.normal=new s,this.mass=0}}class bn{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class Vn{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new s(0,0),this.pb=new s(0,0),this.pc=new s(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class Is{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return new Is().Copy(this)}}class S{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new ue,this.m_flagsBuffer=new ue,this.m_positionBuffer=new ue,this.m_velocityBuffer=new ue,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new ue,this.m_groupBuffer=[],this.m_userDataBuffer=new ue,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new ue,this.m_bodyContactCountBuffer=new ue,this.m_consecutiveContactStepsBuffer=new ue,this.m_stuckParticleBuffer=new qe(()=>0),this.m_proxyBuffer=new qe(()=>new ze),this.m_contactBuffer=new qe(()=>new Cn),this.m_bodyContactBuffer=new qe(()=>new vn),this.m_pairBuffer=new qe(()=>new bn),this.m_triadBuffer=new qe(()=>new Vn),this.m_expirationTimeBuffer=new ue,this.m_indexByExpirationTimeBuffer=new ue,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new Is,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+S.yOffset>>>0<<S.yShift)+(S.xScale*t+S.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<S.yShift)+(e<<S.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){const l=this.m_count?2*this.m_count:vt;this.ReallocateInternalAllocatedBuffers(l)}if(this.m_count>=this.m_internalAllocatedCapacity)if(this.m_def.destroyByAge)this.DestroyOldestParticle(0,!1),this.SolveZombie();else return jt;const e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new s).Copy(b(t.position,s.ZERO)),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new s).Copy(b(t.velocity,s.ZERO)),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new s).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0);const i=new ct().Copy(b(t.color,ct.ZERO));(this.m_colorBuffer.data||!i.IsZero())&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new ct).Copy(i)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);const n=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],o=b(t.lifetime,0),r=o>0;(this.m_expirationTimeBuffer.data||r)&&(this.SetParticleLifetime(e,r?o:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),n.index=e;const a=b(t.group,null);return this.m_groupBuffer[e]=a,a&&(a.m_firstIndex<a.m_lastIndex?(this.RotateBuffer(a.m_firstIndex,a.m_lastIndex,e),a.m_lastIndex=e+1):(a.m_firstIndex=e,a.m_lastIndex=e+1)),this.SetParticleFlags(e,b(t.flags,0)),e}GetParticleHandleFromIndex(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||(e=new fn,e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(t,e=!1){let i=m.b2ParticleFlag.b2_zombieParticle;e&&(i|=m.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|i)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],o=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:o,e)}DestroyParticlesInShape(t,e,i=!1){const n=S.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;const o=new In(this,t,e,i),r=n;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(o,r),o.Destroyed()}CreateParticleGroup(t){const e=S.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;const i=e;i.SetPositionAngle(b(t.position,s.ZERO),b(t.angle,0));const n=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,b(t.shapeCount,t.shapes.length),t,i),t.positionData){const l=b(t.particleCount,t.positionData.length);for(let h=0;h<l;h++){const c=t.positionData[h];this.CreateParticleForGroup(t,i,c)}}const o=this.m_count;let r=new os(this);r.m_firstIndex=n,r.m_lastIndex=o,r.m_strength=b(t.strength,1),r.m_userData=t.userData,r.m_transform.Copy(i),r.m_prev=null,r.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=r),this.m_groupList=r,++this.m_groupCount;for(let l=n;l<o;l++)this.m_groupBuffer[l]=r;this.SetGroupFlags(r,b(t.groupFlags,0));const a=new Gs;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(n,o,a),t.group&&(this.JoinParticleGroups(t.group,r),r=t.group),r}JoinParticleGroups(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);const i=new Gn(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let o=e.m_firstIndex;o<e.m_lastIndex;o++)this.m_groupBuffer[o]=t;const n=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,n),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);const e=t.GetParticleCount(),i=Wt(e,o=>new gn);S.InitializeParticleLists(t,i),this.MergeParticleListsInContact(t,i);const n=S.FindLongestParticleList(t,i);this.MergeZombieParticleListNodes(t,i,n),this.CreateParticleGroupsFromParticleList(t,i,n),this.UpdatePairsAndTriadsWithParticleList(t,i)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(t,e){this.m_flagsBuffer.data[t]&~e&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&e&&(e&m.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),e&m.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=e),this.m_flagsBuffer.data[t]=e}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)}SetPositionBuffer(t){if(t instanceof Float32Array){if(t.length%2!==0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new s(t.subarray(n*2,n*2+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)}SetVelocityBuffer(t){if(t instanceof Float32Array){if(t.length%2!==0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new s(t.subarray(n*2,n*2+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)}SetColorBuffer(t){if(t instanceof Float32Array){if(t.length%4!==0)throw new Error;const e=t.length/4,i=new Array(e);for(let n=0;n<e;++n)i[n]=new ct(t.subarray(n*4,n*4+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)}SetUserDataBuffer(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){const t=S.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data;let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n],r=o.indexA,a=o.indexB,l=o.normal,h=s.SubVV(e[a],e[r],t),c=s.DotVV(h,l);c<0&&(i+=c*c)}return .5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){const i=this.m_indexByExpirationTimeBuffer.data===null;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){const r=this.GetParticleCount();for(let a=0;a<r;++a)this.m_indexByExpirationTimeBuffer.data[a]=a}const n=e/this.m_def.lifetimeGranularity,o=n>0?this.GetQuantizedTimeElapsed()+n:n;o!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=o,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){const n=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),a=new s().Copy(i).SelfMul(1/r);for(let l=t;l<e;l++)n[l].SelfAdd(a)}static IsSignificantForce(t){return t.x!==0||t.y!==0}ParticleApplyForce(t,e){S.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){const n=new s().Copy(i).SelfMul(1/(e-t));if(S.IsSignificantForce(n)){this.PrepareForceBuffer();for(let o=t;o<e;o++)this.m_forceBuffer[o].SelfAdd(n)}}GetNext(){return this.m_next}QueryAABB(t,e){if(this.m_proxyBuffer.count===0)return;const i=0,n=this.m_proxyBuffer.count,o=xn(this.m_proxyBuffer.data,i,n,S.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),ze.CompareProxyTag),r=Sn(this.m_proxyBuffer.data,o,n,S.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),ze.CompareTagProxy),a=this.m_positionBuffer.data;for(let l=o;l<r;++l){const c=this.m_proxyBuffer.data[l].index,_=a[c];if(e.lowerBound.x<_.x&&_.x<e.upperBound.x&&e.lowerBound.y<_.y&&_.y<e.upperBound.y&&!t.ReportParticle(this,c))break}}QueryShapeAABB(t,e,i,n=0){const r=S.QueryShapeAABB_s_aabb;e.ComputeAABB(r,i,n),this.QueryAABB(t,r)}QueryPointAABB(t,e,i=j){const o=S.QueryPointAABB_s_aabb;o.lowerBound.Set(e.x-i,e.y-i),o.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,o)}RayCast(t,e,i){const n=S.RayCast_s_aabb,o=S.RayCast_s_p,r=S.RayCast_s_v,a=S.RayCast_s_n,l=S.RayCast_s_point;if(this.m_proxyBuffer.count===0)return;const h=this.m_positionBuffer.data,c=n;s.MinV(e,i,c.lowerBound),s.MaxV(e,i,c.upperBound);let _=1;const u=s.SubVV(i,e,r),f=s.DotVV(u,u),p=this.GetInsideBoundsEnumerator(c);let y;for(;(y=p.GetNext())>=0;){const B=s.SubVV(e,h[y],o),A=s.DotVV(B,u),x=s.DotVV(B,B),C=A*A-f*(x-this.m_squaredDiameter);if(C>=0){const v=ye(C);let g=(-A-v)/f;if(g>_||g<0&&(g=(-A+v)/f,g<0||g>_))continue;const I=s.AddVMulSV(B,g,u,a);I.Normalize();const P=t.ReportParticle(this,y,s.AddVMulSV(e,g,u,l),I,g);if(_=tt(_,P),_<=0)break}}}ComputeAABB(t){const e=this.GetParticleCount();t.lowerBound.x=+k,t.lowerBound.y=+k,t.upperBound.x=-k,t.upperBound.y=-k;const i=this.m_positionBuffer.data;for(let n=0;n<e;n++){const o=i[n];s.MinV(t.lowerBound,o,t.lowerBound),s.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){t!==null&&(t.length=0)}FreeUserOverridableBuffer(t){t.userSuppliedCapacity===0&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){if(i<=e)throw new Error;const n=t?t.slice():[];return n.length=i,n}ReallocateBuffer5(t,e,i,n,o){if(n<=i)throw new Error;if(!(!e||n<=e))throw new Error;return(!o||t)&&!e&&(t=this.ReallocateBuffer3(t,i,n)),t}ReallocateBuffer4(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)}RequestBuffer(t){return t||(this.m_internalAllocatedCapacity===0&&this.ReallocateInternalAllocatedBuffers(vt),t=[],t.length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(i,n){return n&&i>n?n:i}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);const i=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,i){const n=new pi;n.flags=b(t.flags,0),M.MulXV(e,i,n.position),s.AddVV(b(t.linearVelocity,s.ZERO),s.CrossSV(b(t.angularVelocity,0),s.SubVV(n.position,b(t.position,s.ZERO),s.s_t0),s.s_t0),n.velocity),n.color.Copy(b(t.color,ct.ZERO)),n.lifetime=b(t.lifetime,0),n.userData=t.userData,this.CreateParticle(n)}CreateParticlesStrokeShapeForGroup(t,e,i){const n=S.CreateParticlesStrokeShapeForGroup_s_edge,o=S.CreateParticlesStrokeShapeForGroup_s_d,r=S.CreateParticlesStrokeShapeForGroup_s_p;let a=b(e.stride,0);a===0&&(a=this.GetParticleStride());let l=0;const h=t.GetChildCount();for(let c=0;c<h;c++){let _=null;t.GetType()===m.b2ShapeType.e_edgeShape?_=t:(_=n,t.GetChildEdge(_,c));const u=s.SubVV(_.m_vertex2,_.m_vertex1,o),f=u.Length();for(;l<f;){const p=s.AddVMulSV(_.m_vertex1,l/f,u,r);this.CreateParticleForGroup(e,i,p),l+=a}l-=f}}CreateParticlesFillShapeForGroup(t,e,i){const n=S.CreateParticlesFillShapeForGroup_s_aabb,o=S.CreateParticlesFillShapeForGroup_s_p;let r=b(e.stride,0);r===0&&(r=this.GetParticleStride());const a=M.IDENTITY,l=n;t.ComputeAABB(l,a,0);for(let h=Math.floor(l.lowerBound.y/r)*r;h<l.upperBound.y;h+=r)for(let c=Math.floor(l.lowerBound.x/r)*r;c<l.upperBound.x;c+=r){const _=o.Set(c,h);t.TestPoint(a,_)&&this.CreateParticleForGroup(e,i,_)}}CreateParticlesWithShapeForGroup(t,e,i){switch(t.GetType()){case m.b2ShapeType.e_edgeShape:case m.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,e,i);break;case m.b2ShapeType.e_polygonShape:case m.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(t,e,i);break}}CreateParticlesWithShapesForGroup(t,e,i,n){const o=new Dn(t,e);this.CreateParticlesFillShapeForGroup(o,i,n)}CloneParticle(t,e){const i=new pi;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;const n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){const o=this.m_handleIndexBuffer.data[t];o&&o.SetIndex(n),this.m_handleIndexBuffer.data[n]=o,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(t,e){return(t&(m.b2ParticleFlag.b2_wallParticle|m.b2ParticleFlag.b2_springParticle|m.b2ParticleFlag.b2_elasticParticle))!==0||e!==null&&(e.GetGroupFlags()&m.b2ParticleGroupFlag.b2_rigidParticleGroup)!==0}UpdatePairsAndTriads(t,e,i){const n=S.UpdatePairsAndTriads_s_dab,o=S.UpdatePairsAndTriads_s_dbc,r=S.UpdatePairsAndTriads_s_dca,a=this.m_positionBuffer.data;let l=0;for(let h=t;h<e;h++)l|=this.m_flagsBuffer.data[h];if(l&S.k_pairFlags)for(let h=0;h<this.m_contactBuffer.count;h++){const c=this.m_contactBuffer.data[h],_=c.indexA,u=c.indexB,f=this.m_flagsBuffer.data[_],p=this.m_flagsBuffer.data[u],y=this.m_groupBuffer[_],B=this.m_groupBuffer[u];if(_>=t&&_<e&&u>=t&&u<e&&!((f|p)&m.b2ParticleFlag.b2_zombieParticle)&&(f|p)&S.k_pairFlags&&(i.IsNecessary(_)||i.IsNecessary(u))&&S.ParticleCanBeConnected(f,y)&&S.ParticleCanBeConnected(p,B)&&i.ShouldCreatePair(_,u)){const A=this.m_pairBuffer.data[this.m_pairBuffer.Append()];A.indexA=_,A.indexB=u,A.flags=c.flags,A.strength=tt(y?y.m_strength:1,B?B.m_strength:1),A.distance=s.DistanceVV(a[_],a[u])}Bn(this.m_pairBuffer.data,0,this.m_pairBuffer.count,S.ComparePairIndices),this.m_pairBuffer.Unique(S.MatchPairIndices)}if(l&S.k_triadFlags){const h=new Kr(e-t);for(let f=t;f<e;f++){const p=this.m_flagsBuffer.data[f],y=this.m_groupBuffer[f];!(p&m.b2ParticleFlag.b2_zombieParticle)&&S.ParticleCanBeConnected(p,y)&&h.AddGenerator(a[f],f,i.IsNecessary(f))}const c=this.GetParticleStride();h.Generate(c/2,c*2);const _=this,u=(f,p,y)=>{const B=_.m_flagsBuffer.data[f],A=_.m_flagsBuffer.data[p],x=_.m_flagsBuffer.data[y];if((B|A|x)&S.k_triadFlags&&i.ShouldCreateTriad(f,p,y)){const C=a[f],v=a[p],g=a[y],I=s.SubVV(C,v,n),P=s.SubVV(v,g,o),T=s.SubVV(g,C,r),F=_e*_.m_squaredDiameter;if(s.DotVV(I,I)>F||s.DotVV(P,P)>F||s.DotVV(T,T)>F)return;const R=_.m_groupBuffer[f],E=_.m_groupBuffer[p],L=_.m_groupBuffer[y],G=_.m_triadBuffer.data[_.m_triadBuffer.Append()];G.indexA=f,G.indexB=p,G.indexC=y,G.flags=B|A|x,G.strength=tt(tt(R?R.m_strength:1,E?E.m_strength:1),L?L.m_strength:1);const X=(C.x+v.x+g.x)/3,O=(C.y+v.y+g.y)/3;G.pa.x=C.x-X,G.pa.y=C.y-O,G.pb.x=v.x-X,G.pb.y=v.y-O,G.pc.x=g.x-X,G.pc.y=g.y-O,G.ka=-s.DotVV(T,I),G.kb=-s.DotVV(I,P),G.kc=-s.DotVV(P,T),G.s=s.CrossVV(C,v)+s.CrossVV(v,g)+s.CrossVV(g,C)}};h.GetNodes(u),Bn(this.m_triadBuffer.data,0,this.m_triadBuffer.count,S.CompareTriadIndices),this.m_triadBuffer.Unique(S.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){const t=new Fn(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&=~m.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~m.b2ParticleFlag.b2_reactiveParticle}static ComparePairIndices(t,e){const i=t.indexA-e.indexA;return i!==0?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){const i=t.indexA-e.indexA;if(i!==0)return i<0;const n=t.indexB-e.indexB;return n!==0?n<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){const i=t.GetBufferIndex(),n=t.GetParticleCount();for(let o=0;o<n;o++){const r=e[o];r.list=r,r.next=null,r.count=1,r.index=o+i}}MergeParticleListsInContact(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n],r=o.indexA,a=o.indexB;if(!t.ContainsParticle(r)||!t.ContainsParticle(a))continue;let l=e[r-i].list,h=e[a-i].list;if(l!==h){if(l.count<h.count){const c=l;l=h,h=c}S.MergeParticleLists(l,h)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;const n=i.next;if(n)i=n;else{i.next=t.next;break}}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){const i=t.GetParticleCount();let n=e[0];for(let o=0;o<i;o++){const r=e[o];n.count<r.count&&(n=r)}return n}MergeZombieParticleListNodes(t,e,i){const n=t.GetParticleCount();for(let o=0;o<n;o++){const r=e[o];r!==i&&this.m_flagsBuffer.data[r.index]&m.b2ParticleFlag.b2_zombieParticle&&S.MergeParticleListAndNode(i,r)}}static MergeParticleListAndNode(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(t,e,i){const n=t.GetParticleCount(),o=new pn;o.groupFlags=t.GetGroupFlags(),o.userData=t.GetUserData();for(let r=0;r<n;r++){const a=e[r];if(!a.count||a===i)continue;const l=this.CreateParticleGroup(o);for(let h=a;h;h=h.next){const c=h.index,_=this.CloneParticle(c,l);this.m_flagsBuffer.data[c]|=m.b2ParticleFlag.b2_zombieParticle,h.index=_}}}UpdatePairsAndTriadsWithParticleList(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_pairBuffer.count;n++){const o=this.m_pairBuffer.data[n],r=o.indexA,a=o.indexB;t.ContainsParticle(r)&&(o.indexA=e[r-i].index),t.ContainsParticle(a)&&(o.indexB=e[a-i].index)}for(let n=0;n<this.m_triadBuffer.count;n++){const o=this.m_triadBuffer.data[n],r=o.indexA,a=o.indexB,l=o.indexC;t.ContainsParticle(r)&&(o.indexA=e[r-i].index),t.ContainsParticle(a)&&(o.indexB=e[a-i].index),t.ContainsParticle(l)&&(o.indexC=e[l-i].index)}}ComputeDepth(){const t=[];let e=0;for(let r=0;r<this.m_contactBuffer.count;r++){const a=this.m_contactBuffer.data[r],l=a.indexA,h=a.indexB,c=this.m_groupBuffer[l],_=this.m_groupBuffer[h];c&&c===_&&c.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(t[e++]=a)}const i=[];let n=0;for(let r=this.m_groupList;r;r=r.GetNext())if(r.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){i[n++]=r,this.SetGroupFlags(r,r.m_groupFlags&~m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(let a=r.m_firstIndex;a<r.m_lastIndex;a++)this.m_accumulationBuffer[a]=0}for(let r=0;r<e;r++){const a=t[r],l=a.indexA,h=a.indexB,c=a.weight;this.m_accumulationBuffer[l]+=c,this.m_accumulationBuffer[h]+=c}for(let r=0;r<n;r++){const a=i[r];for(let l=a.m_firstIndex;l<a.m_lastIndex;l++){const h=this.m_accumulationBuffer[l];this.m_depthBuffer[l]=h<.8?0:k}}const o=ye(this.m_count)>>0;for(let r=0;r<o;r++){let a=!1;for(let l=0;l<e;l++){const h=t[l],c=h.indexA,_=h.indexB,u=1-h.weight,f=this.m_depthBuffer[c],p=this.m_depthBuffer[_],y=p+u,B=f+u;f>y&&(this.m_depthBuffer[c]=y,a=!0),p>B&&(this.m_depthBuffer[_]=B,a=!0)}if(!a)break}for(let r=0;r<n;r++){const a=i[r];for(let l=a.m_firstIndex;l<a.m_lastIndex;l++)this.m_depthBuffer[l]<k?this.m_depthBuffer[l]*=this.m_particleDiameter:this.m_depthBuffer[l]=0}}GetInsideBoundsEnumerator(t){const e=S.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=S.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),n=0,o=this.m_proxyBuffer.count,r=xn(this.m_proxyBuffer.data,n,o,e,ze.CompareProxyTag),a=Sn(this.m_proxyBuffer.data,n,o,i,ze.CompareTagProxy);return new wn(this,e,i,r,a)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){const n=this.m_flagsBuffer.data,o=this.m_positionBuffer.data,r=s.SubVV(o[e],o[t],S.AddContact_s_d),a=s.DotVV(r,r);if(0<a&&a<this.m_squaredDiameter){let l=Qs(a);const h=this.m_contactBuffer.data[this.m_contactBuffer.Append()];h.indexA=t,h.indexB=e,h.flags=n[t]|n[e],h.weight=1-a*l*this.m_inverseDiameter,h.normal.x=l*r.x,h.normal.y=l*r.y}}FindContacts_Reference(t){const i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let n=0,o=0;n<i;n++){const r=S.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,0);for(let h=n+1;h<i&&!(r<this.m_proxyBuffer.data[h].tag);h++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[h].index,this.m_contactBuffer);const a=S.computeRelativeTag(this.m_proxyBuffer.data[n].tag,-1,1);for(;o<i&&!(a<=this.m_proxyBuffer.data[o].tag);o++);const l=S.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,1);for(let h=o;h<i&&!(l<this.m_proxyBuffer.data[h].tag);h++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[h].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){const e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let n=0;n<this.m_proxyBuffer.count;++n){const o=this.m_proxyBuffer.data[n],r=o.index,a=e[r];o.tag=S.computeTag(i*a.x,i*a.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){Ps(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,ze.CompareProxyProxy)}FilterContacts(t){const e=this.GetParticleContactFilter();if(e===null)return;const i=this,n=o=>(o.flags&m.b2ParticleFlag.b2_particleContactFilterParticle)!==0&&!e.ShouldCollideParticleParticle(i,o.indexA,o.indexB);this.m_contactBuffer.RemoveIf(n)}NotifyContactListenerPreContact(t){if(this.GetParticleContactListener()!==null)throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){const e=this.GetParticleContactListener();if(e!==null){for(let i=0;i<this.m_contactBuffer.count;++i){const n=this.m_contactBuffer.data[i];e.BeginContactParticleParticle(this,n)}throw new Error}}static b2ParticleContactIsZombie(t){return(t.flags&m.b2ParticleFlag.b2_zombieParticle)===m.b2ParticleFlag.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);const e=new Pn;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(S.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(this.GetFixtureContactListener()!==null)throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){const e=this.GetFixtureContactListener();if(e!==null){for(let i=0;i<this.m_bodyContactBuffer.count;i++){const n=this.m_bodyContactBuffer.data[i];e.BeginContactFixtureParticle(this,n)}throw new Error}}UpdateBodyContacts(){const t=S.UpdateBodyContacts_s_aabb,e=new Mn;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){const o=this.GetParticleCount();for(let r=0;r<o;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);const i=t;this.ComputeAABB(i),this.UpdateBodyContacts_callback===null&&(this.UpdateBodyContacts_callback=new Ee(this));const n=this.UpdateBodyContacts_callback;n.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(n,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(t){const e=S.Solve_s_subStep;if(this.m_count!==0&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(t),this.m_allParticleFlags&m.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<t.particleIterations;this.m_iterationIndex++){++this.m_timestamp;const i=e.Copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&m.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&m.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(i),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(i),this.SolvePressure(i),this.SolveDamping(i),this.m_allParticleFlags&S.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&m.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_springParticle&&this.SolveSpring(i),this.LimitVelocity(i),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&m.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(i),this.SolveCollision(i),this.m_allGroupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(i),this.m_allParticleFlags&m.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(let n=0;n<this.m_count;n++)this.m_positionBuffer.data[n].SelfMulAdd(i.dt,this.m_velocityBuffer.data[n])}}SolveCollision(t){const e=S.SolveCollision_s_aabb,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=e;o.lowerBound.x=+k,o.lowerBound.y=+k,o.upperBound.x=-k,o.upperBound.y=-k;for(let a=0;a<this.m_count;a++){const l=n[a],h=i[a],c=h.x+t.dt*l.x,_=h.y+t.dt*l.y;o.lowerBound.x=tt(o.lowerBound.x,tt(h.x,c)),o.lowerBound.y=tt(o.lowerBound.y,tt(h.y,_)),o.upperBound.x=H(o.upperBound.x,H(h.x,c)),o.upperBound.y=H(o.upperBound.y,H(h.y,_))}this.SolveCollision_callback===null&&(this.SolveCollision_callback=new Yt(this,t));const r=this.SolveCollision_callback;r.m_step=t,this.m_world.QueryAABB(r,o)}LimitVelocity(t){const e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let n=0;n<this.m_count;n++){const o=e[n],r=s.DotVV(o,o);r>i&&o.SelfMul(ye(i/r))}}SolveGravity(t){const e=S.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,n=s.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let o=0;o<this.m_count;o++)i[o].SelfAdd(n)}SolveBarrier(t){const e=S.SolveBarrier_s_aabb,i=S.SolveBarrier_s_va,n=S.SolveBarrier_s_vb,o=S.SolveBarrier_s_pba,r=S.SolveBarrier_s_vba,a=S.SolveBarrier_s_vc,l=S.SolveBarrier_s_pca,h=S.SolveBarrier_s_vca,c=S.SolveBarrier_s_qba,_=S.SolveBarrier_s_qca,u=S.SolveBarrier_s_dv,f=S.SolveBarrier_s_f,p=this.m_positionBuffer.data,y=this.m_velocityBuffer.data;for(let x=0;x<this.m_count;x++)(this.m_flagsBuffer.data[x]&S.k_barrierWallFlags)!==0&&y[x].SetZero();const B=Ft*t.dt,A=this.GetParticleMass();for(let x=0;x<this.m_pairBuffer.count;x++){const C=this.m_pairBuffer.data[x];if(C.flags&m.b2ParticleFlag.b2_barrierParticle){const v=C.indexA,g=C.indexB,I=p[v],P=p[g],T=e;s.MinV(I,P,T.lowerBound),s.MaxV(I,P,T.upperBound);const F=this.m_groupBuffer[v],R=this.m_groupBuffer[g],E=this.GetLinearVelocity(F,v,I,i),L=this.GetLinearVelocity(R,g,P,n),G=s.SubVV(P,I,o),X=s.SubVV(L,E,r),O=this.GetInsideBoundsEnumerator(T);let $;for(;($=O.GetNext())>=0;){const lt=p[$],_t=this.m_groupBuffer[$];if(F!==_t&&R!==_t){const kt=this.GetLinearVelocity(_t,$,lt,a),qt=s.SubVV(lt,I,l),zt=s.SubVV(kt,E,h),Ue=s.CrossVV(X,zt),Ae=s.CrossVV(G,zt)-s.CrossVV(qt,X),Ze=s.CrossVV(G,qt);let Kt,Zt;const It=c,pe=_;if(Ue===0){if(Ae===0||(Zt=-Ze/Ae,!(Zt>=0&&Zt<B))||(s.AddVMulSV(G,Zt,X,It),s.AddVMulSV(qt,Zt,zt,pe),Kt=s.DotVV(It,pe)/s.DotVV(It,It),!(Kt>=0&&Kt<=1)))continue}else{const as=Ae*Ae-4*Ze*Ue;if(as<0)continue;const ls=ye(as);let Ts=(-Ae-ls)/(2*Ue),Rs=(-Ae+ls)/(2*Ue);if(Ts>Rs){const ra=Ts;Ts=Rs,Rs=ra}if(Zt=Ts,s.AddVMulSV(G,Zt,X,It),s.AddVMulSV(qt,Zt,zt,pe),Kt=s.DotVV(It,pe)/s.DotVV(It,It),!(Zt>=0&&Zt<B&&Kt>=0&&Kt<=1)&&(Zt=Rs,!(Zt>=0&&Zt<B)||(s.AddVMulSV(G,Zt,X,It),s.AddVMulSV(qt,Zt,zt,pe),Kt=s.DotVV(It,pe)/s.DotVV(It,It),!(Kt>=0&&Kt<=1))))continue}const Ls=u;Ls.x=E.x+Kt*X.x-kt.x,Ls.y=E.y+Kt*X.y-kt.y;const Ai=s.MulSV(A,Ls,f);if(_t&&this.IsRigidGroup(_t)){const as=_t.GetMass(),ls=_t.GetInertia();as>0&&_t.m_linearVelocity.SelfMulAdd(1/as,Ai),ls>0&&(_t.m_angularVelocity+=s.CrossVV(s.SubVV(lt,_t.GetCenter(),s.s_t0),Ai)/ls)}else y[$].SelfAdd(Ls);this.ParticleApplyForce($,Ai.SelfMul(-t.inv_dt))}}}}}SolveStaticPressure(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);const e=this.GetCriticalPressure(t),i=this.m_def.staticPressureStrength*e,n=it*e,o=this.m_def.staticPressureRelaxation;for(let r=0;r<this.m_def.staticPressureIterations;r++){for(let a=0;a<this.m_count;a++)this.m_accumulationBuffer[a]=0;for(let a=0;a<this.m_contactBuffer.count;a++){const l=this.m_contactBuffer.data[a];if(l.flags&m.b2ParticleFlag.b2_staticPressureParticle){const h=l.indexA,c=l.indexB,_=l.weight;this.m_accumulationBuffer[h]+=_*this.m_staticPressureBuffer[c],this.m_accumulationBuffer[c]+=_*this.m_staticPressureBuffer[h]}}for(let a=0;a<this.m_count;a++){const l=this.m_weightBuffer[a];if(this.m_flagsBuffer.data[a]&m.b2ParticleFlag.b2_staticPressureParticle){const c=(this.m_accumulationBuffer[a]+i*(l-Q))/(l+o);this.m_staticPressureBuffer[a]=gt(c,0,n)}else this.m_staticPressureBuffer[a]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],i=e.index,n=e.weight;this.m_weightBuffer[i]+=n}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],i=e.indexA,n=e.indexB,o=e.weight;this.m_weightBuffer[i]+=o,this.m_weightBuffer[n]+=o}}SolvePressure(t){const e=S.SolvePressure_s_f,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.GetCriticalPressure(t),r=this.m_def.pressureStrength*o,a=it*o;for(let c=0;c<this.m_count;c++){const _=this.m_weightBuffer[c],u=r*H(0,_-Q);this.m_accumulationBuffer[c]=tt(u,a)}if(this.m_allParticleFlags&S.k_noPressureFlags)for(let c=0;c<this.m_count;c++)this.m_flagsBuffer.data[c]&S.k_noPressureFlags&&(this.m_accumulationBuffer[c]=0);if(this.m_allParticleFlags&m.b2ParticleFlag.b2_staticPressureParticle)for(let c=0;c<this.m_count;c++)this.m_flagsBuffer.data[c]&m.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[c]+=this.m_staticPressureBuffer[c]);const l=t.dt/(this.m_def.density*this.m_particleDiameter),h=this.GetParticleInvMass();for(let c=0;c<this.m_bodyContactBuffer.count;c++){const _=this.m_bodyContactBuffer.data[c],u=_.index,f=_.body,p=_.weight,y=_.mass,B=_.normal,A=i[u],x=this.m_accumulationBuffer[u]+r*p,C=s.MulSV(l*p*y*x,B,e);n[u].SelfMulSub(h,C),f.ApplyLinearImpulse(C,A,!0)}for(let c=0;c<this.m_contactBuffer.count;c++){const _=this.m_contactBuffer.data[c],u=_.indexA,f=_.indexB,p=_.weight,y=_.normal,B=this.m_accumulationBuffer[u]+this.m_accumulationBuffer[f],A=s.MulSV(l*p*B,y,e);n[u].SelfSub(A),n[f].SelfAdd(A)}}SolveDamping(t){const e=S.SolveDamping_s_v,i=S.SolveDamping_s_f,n=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,r=this.m_def.dampingStrength,a=1/this.GetCriticalVelocity(t),l=this.GetParticleInvMass();for(let h=0;h<this.m_bodyContactBuffer.count;h++){const c=this.m_bodyContactBuffer.data[h],_=c.index,u=c.body,f=c.weight,p=c.mass,y=c.normal,B=n[_],A=s.SubVV(u.GetLinearVelocityFromWorldPoint(B,s.s_t0),o[_],e),x=s.DotVV(A,y);if(x<0){const C=H(r*f,tt(-a*x,.5)),v=s.MulSV(C*p*x,y,i);o[_].SelfMulAdd(l,v),u.ApplyLinearImpulse(v.SelfNeg(),B,!0)}}for(let h=0;h<this.m_contactBuffer.count;h++){const c=this.m_contactBuffer.data[h],_=c.indexA,u=c.indexB,f=c.weight,p=c.normal,y=s.SubVV(o[u],o[_],e),B=s.DotVV(y,p);if(B<0){const A=H(r*f,tt(-a*B,.5)),x=s.MulSV(A*B,p,i);o[_].SelfAdd(x),o[u].SelfSub(x)}}}SolveRigidDamping(){const t=S.SolveRigidDamping_s_t0,e=S.SolveRigidDamping_s_t1,i=S.SolveRigidDamping_s_p,n=S.SolveRigidDamping_s_v,o=[0],r=[0],a=[0],l=[0],h=[0],c=[0],_=this.m_positionBuffer.data,u=this.m_def.dampingStrength;for(let f=0;f<this.m_bodyContactBuffer.count;f++){const p=this.m_bodyContactBuffer.data[f],y=p.index,B=this.m_groupBuffer[y];if(B&&this.IsRigidGroup(B)){const A=p.body,x=p.normal,C=p.weight,v=_[y],g=s.SubVV(A.GetLinearVelocityFromWorldPoint(v,t),B.GetLinearVelocityFromWorldPoint(v,e),n),I=s.DotVV(g,x);if(I<0){this.InitDampingParameterWithRigidGroupOrParticle(o,r,a,!0,B,y,v,x),this.InitDampingParameter(l,h,c,A.GetMass(),A.GetInertia()-A.GetMass()*A.GetLocalCenter().LengthSquared(),A.GetWorldCenter(),v,x);const P=u*tt(C,1)*this.ComputeDampingImpulse(o[0],r[0],a[0],l[0],h[0],c[0],I);this.ApplyDamping(o[0],r[0],a[0],!0,B,y,P,x),A.ApplyLinearImpulse(s.MulSV(-P,x,s.s_t0),v,!0)}}}for(let f=0;f<this.m_contactBuffer.count;f++){const p=this.m_contactBuffer.data[f],y=p.indexA,B=p.indexB,A=p.normal,x=p.weight,C=this.m_groupBuffer[y],v=this.m_groupBuffer[B],g=this.IsRigidGroup(C),I=this.IsRigidGroup(v);if(C!==v&&(g||I)){const P=s.MidVV(_[y],_[B],i),T=s.SubVV(this.GetLinearVelocity(v,B,P,t),this.GetLinearVelocity(C,y,P,e),n),F=s.DotVV(T,A);if(F<0){this.InitDampingParameterWithRigidGroupOrParticle(o,r,a,g,C,y,P,A),this.InitDampingParameterWithRigidGroupOrParticle(l,h,c,I,v,B,P,A);const R=u*x*this.ComputeDampingImpulse(o[0],r[0],a[0],l[0],h[0],c[0],F);this.ApplyDamping(o[0],r[0],a[0],g,C,y,R,A),this.ApplyDamping(l[0],h[0],c[0],I,v,B,-R,A)}}}}SolveExtraDamping(){const t=S.SolveExtraDamping_s_v,e=S.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,n=this.m_positionBuffer.data,o=this.GetParticleInvMass();for(let r=0;r<this.m_bodyContactBuffer.count;r++){const a=this.m_bodyContactBuffer.data[r],l=a.index;if(this.m_flagsBuffer.data[l]&S.k_extraDampingFlags){const h=a.body,c=a.mass,_=a.normal,u=n[l],f=s.SubVV(h.GetLinearVelocityFromWorldPoint(u,s.s_t0),i[l],t),p=s.DotVV(f,_);if(p<0){const y=s.MulSV(.5*c*p,_,e);i[l].SelfMulAdd(o,y),h.ApplyLinearImpulse(y.SelfNeg(),u,!0)}}}}SolveWall(){const t=this.m_velocityBuffer.data;for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&m.b2ParticleFlag.b2_wallParticle&&t[e].SetZero()}SolveRigid(t){const e=S.SolveRigid_s_position,i=S.SolveRigid_s_rotation,n=S.SolveRigid_s_transform,o=S.SolveRigid_s_velocityTransform,r=this.m_positionBuffer.data,a=this.m_velocityBuffer.data;for(let l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();const h=i;h.SetAngle(t.dt*l.m_angularVelocity);const c=s.AddVV(l.m_center,s.SubVV(s.MulSV(t.dt,l.m_linearVelocity,s.s_t0),V.MulRV(h,l.m_center,s.s_t1),s.s_t0),e),_=n;_.SetPositionRotation(c,h),M.MulXX(_,l.m_transform,l.m_transform);const u=o;u.p.x=t.inv_dt*_.p.x,u.p.y=t.inv_dt*_.p.y,u.q.s=t.inv_dt*_.q.s,u.q.c=t.inv_dt*(_.q.c-1);for(let f=l.m_firstIndex;f<l.m_lastIndex;f++)M.MulXV(u,r[f],a[f])}}SolveElastic(t){const e=S.SolveElastic_s_pa,i=S.SolveElastic_s_pb,n=S.SolveElastic_s_pc,o=S.SolveElastic_s_r,r=S.SolveElastic_s_t0,a=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,h=t.inv_dt*this.m_def.elasticStrength;for(let c=0;c<this.m_triadBuffer.count;c++){const _=this.m_triadBuffer.data[c];if(_.flags&m.b2ParticleFlag.b2_elasticParticle){const u=_.indexA,f=_.indexB,p=_.indexC,y=_.pa,B=_.pb,A=_.pc,x=e.Copy(a[u]),C=i.Copy(a[f]),v=n.Copy(a[p]),g=l[u],I=l[f],P=l[p];x.SelfMulAdd(t.dt,g),C.SelfMulAdd(t.dt,I),v.SelfMulAdd(t.dt,P);const T=(x.x+C.x+v.x)/3,F=(x.y+C.y+v.y)/3;x.x-=T,x.y-=F,C.x-=T,C.y-=F,v.x-=T,v.y-=F;const R=o;R.s=s.CrossVV(y,x)+s.CrossVV(B,C)+s.CrossVV(A,v),R.c=s.DotVV(y,x)+s.DotVV(B,C)+s.DotVV(A,v);const E=R.s*R.s+R.c*R.c;let L=Qs(E);isFinite(L)||(L=198177537e11),R.s*=L,R.c*=L;const G=h*_.strength;V.MulRV(R,y,r),s.SubVV(r,x,r),s.MulSV(G,r,r),g.SelfAdd(r),V.MulRV(R,B,r),s.SubVV(r,C,r),s.MulSV(G,r,r),I.SelfAdd(r),V.MulRV(R,A,r),s.SubVV(r,v,r),s.MulSV(G,r,r),P.SelfAdd(r)}}}SolveSpring(t){const e=S.SolveSpring_s_pa,i=S.SolveSpring_s_pb,n=S.SolveSpring_s_d,o=S.SolveSpring_s_f,r=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,l=t.inv_dt*this.m_def.springStrength;for(let h=0;h<this.m_pairBuffer.count;h++){const c=this.m_pairBuffer.data[h];if(c.flags&m.b2ParticleFlag.b2_springParticle){const _=c.indexA,u=c.indexB,f=e.Copy(r[_]),p=i.Copy(r[u]),y=a[_],B=a[u];f.SelfMulAdd(t.dt,y),p.SelfMulAdd(t.dt,B);const A=s.SubVV(p,f,n),x=c.distance,C=A.Length(),v=l*c.strength,g=s.MulSV(v*(x-C)/C,A,o);y.SelfSub(g),B.SelfAdd(g)}}}SolveTensile(t){const e=S.SolveTensile_s_weightedNormal,i=S.SolveTensile_s_s,n=S.SolveTensile_s_f,o=this.m_velocityBuffer.data;for(let c=0;c<this.m_count;c++)this.m_accumulation2Buffer[c]=new s,this.m_accumulation2Buffer[c].SetZero();for(let c=0;c<this.m_contactBuffer.count;c++){const _=this.m_contactBuffer.data[c];if(_.flags&m.b2ParticleFlag.b2_tensileParticle){const u=_.indexA,f=_.indexB,p=_.weight,y=_.normal,B=s.MulSV((1-p)*p,y,e);this.m_accumulation2Buffer[u].SelfSub(B),this.m_accumulation2Buffer[f].SelfAdd(B)}}const r=this.GetCriticalVelocity(t),a=this.m_def.surfaceTensionPressureStrength*r,l=this.m_def.surfaceTensionNormalStrength*r,h=Dt*r;for(let c=0;c<this.m_contactBuffer.count;c++){const _=this.m_contactBuffer.data[c];if(_.flags&m.b2ParticleFlag.b2_tensileParticle){const u=_.indexA,f=_.indexB,p=_.weight,y=_.normal,B=this.m_weightBuffer[u]+this.m_weightBuffer[f],A=s.SubVV(this.m_accumulation2Buffer[f],this.m_accumulation2Buffer[u],i),x=tt(a*(B-2)+l*s.DotVV(A,y),h)*p,C=s.MulSV(x,y,n);o[u].SelfSub(C),o[f].SelfAdd(C)}}}SolveViscous(){const t=S.SolveViscous_s_v,e=S.SolveViscous_s_f,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.m_def.viscousStrength,r=this.GetParticleInvMass();for(let a=0;a<this.m_bodyContactBuffer.count;a++){const l=this.m_bodyContactBuffer.data[a],h=l.index;if(this.m_flagsBuffer.data[h]&m.b2ParticleFlag.b2_viscousParticle){const c=l.body,_=l.weight,u=l.mass,f=i[h],p=s.SubVV(c.GetLinearVelocityFromWorldPoint(f,s.s_t0),n[h],t),y=s.MulSV(o*u*_,p,e);n[h].SelfMulAdd(r,y),c.ApplyLinearImpulse(y.SelfNeg(),f,!0)}}for(let a=0;a<this.m_contactBuffer.count;a++){const l=this.m_contactBuffer.data[a];if(l.flags&m.b2ParticleFlag.b2_viscousParticle){const h=l.indexA,c=l.indexB,_=l.weight,u=s.SubVV(n[c],n[h],t),f=s.MulSV(o*_,u,e);n[h].SelfAdd(f),n[c].SelfSub(f)}}}SolveRepulsive(t){const e=S.SolveRepulsive_s_f,i=this.m_velocityBuffer.data,n=this.m_def.repulsiveStrength*this.GetCriticalVelocity(t);for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o];if(r.flags&m.b2ParticleFlag.b2_repulsiveParticle){const a=r.indexA,l=r.indexB;if(this.m_groupBuffer[a]!==this.m_groupBuffer[l]){const h=r.weight,c=r.normal,_=s.MulSV(n*h,c,e);i[a].SelfSub(_),i[l].SelfAdd(_)}}}}SolvePowder(t){const e=S.SolvePowder_s_f,i=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.m_def.powderStrength*this.GetCriticalVelocity(t),r=1-Y,a=this.GetParticleInvMass();for(let l=0;l<this.m_bodyContactBuffer.count;l++){const h=this.m_bodyContactBuffer.data[l],c=h.index;if(this.m_flagsBuffer.data[c]&m.b2ParticleFlag.b2_powderParticle){const _=h.weight;if(_>r){const u=h.body,f=h.mass,p=i[c],y=h.normal,B=s.MulSV(o*f*(_-r),y,e);n[c].SelfMulSub(a,B),u.ApplyLinearImpulse(B,p,!0)}}}for(let l=0;l<this.m_contactBuffer.count;l++){const h=this.m_contactBuffer.data[l];if(h.flags&m.b2ParticleFlag.b2_powderParticle){const c=h.weight;if(c>r){const _=h.indexA,u=h.indexB,f=h.normal,p=s.MulSV(o*(c-r),f,e);n[_].SelfSub(p),n[u].SelfAdd(p)}}}}SolveSolid(t){const e=S.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);const n=t.inv_dt*this.m_def.ejectionStrength;for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o],a=r.indexA,l=r.indexB;if(this.m_groupBuffer[a]!==this.m_groupBuffer[l]){const h=r.weight,c=r.normal,_=this.m_depthBuffer[a]+this.m_depthBuffer[l],u=s.MulSV(n*_*h,c,e);i[a].SelfSub(u),i[l].SelfAdd(u)}}}SolveForce(t){const e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let n=0;n<this.m_count;n++)e[n].SelfMulAdd(i,this.m_forceBuffer[n]);this.m_hasForce=!1}SolveColorMixing(){const t=.5*this.m_def.colorMixingStrength;if(t)for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e],n=i.indexA,o=i.indexB;if(this.m_flagsBuffer.data[n]&this.m_flagsBuffer.data[o]&m.b2ParticleFlag.b2_colorMixingParticle){const r=this.m_colorBuffer.data[n],a=this.m_colorBuffer.data[o];ct.MixColors(r,a,t)}}}SolveZombie(){let t=0;const e=[];for(let o=0;o<this.m_count;o++)e[o]=jt;let i=0;for(let o=0;o<this.m_count;o++){const r=this.m_flagsBuffer.data[o];if(r&m.b2ParticleFlag.b2_zombieParticle){const a=this.m_world.m_destructionListener;if(r&m.b2ParticleFlag.b2_destructionListenerParticle&&a&&a.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){const l=this.m_handleIndexBuffer.data[o];l&&(l.SetIndex(jt),this.m_handleIndexBuffer.data[o]=null)}e[o]=jt}else{if(e[o]=t,o!==t){if(this.m_handleIndexBuffer.data){const a=this.m_handleIndexBuffer.data[o];a&&a.SetIndex(t),this.m_handleIndexBuffer.data[t]=a}this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[t]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[o])}t++,i|=r}}const n={IsProxyInvalid:o=>o.index<0,IsContactInvalid:o=>o.indexA<0||o.indexB<0,IsBodyContactInvalid:o=>o.index<0,IsPairInvalid:o=>o.indexA<0||o.indexB<0,IsTriadInvalid:o=>o.indexA<0||o.indexB<0||o.indexC<0};for(let o=0;o<this.m_proxyBuffer.count;o++){const r=this.m_proxyBuffer.data[o];r.index=e[r.index]}this.m_proxyBuffer.RemoveIf(n.IsProxyInvalid);for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o];r.indexA=e[r.indexA],r.indexB=e[r.indexB]}this.m_contactBuffer.RemoveIf(n.IsContactInvalid);for(let o=0;o<this.m_bodyContactBuffer.count;o++){const r=this.m_bodyContactBuffer.data[o];r.index=e[r.index]}this.m_bodyContactBuffer.RemoveIf(n.IsBodyContactInvalid);for(let o=0;o<this.m_pairBuffer.count;o++){const r=this.m_pairBuffer.data[o];r.indexA=e[r.indexA],r.indexB=e[r.indexB]}this.m_pairBuffer.RemoveIf(n.IsPairInvalid);for(let o=0;o<this.m_triadBuffer.count;o++){const r=this.m_triadBuffer.data[o];r.indexA=e[r.indexA],r.indexB=e[r.indexB],r.indexC=e[r.indexC]}if(this.m_triadBuffer.RemoveIf(n.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data){let o=0;for(let r=0;r<this.m_count;r++){const a=e[this.m_indexByExpirationTimeBuffer.data[r]];a!==jt&&(this.m_indexByExpirationTimeBuffer.data[o++]=a)}}for(let o=this.m_groupList;o;o=o.GetNext()){let r=t,a=0,l=!1;for(let h=o.m_firstIndex;h<o.m_lastIndex;h++){const c=e[h];c>=0?(r=tt(r,c),a=H(a,c+1)):l=!0}r<a?(o.m_firstIndex=r,o.m_lastIndex=a,l&&o.m_groupFlags&m.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(o,o.m_groupFlags|m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(o.m_firstIndex=0,o.m_lastIndex=0,o.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(o,o.m_groupFlags|m.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=t,this.m_allParticleFlags=i,this.m_needsUpdateAllParticleFlags=!1;for(let o=this.m_groupList;o;){const r=o.GetNext();o.m_groupFlags&m.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(o),o=r}}SolveLifetimes(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);const e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,o=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(Ps(n,0,o,(a,l)=>{const h=i[a],c=i[l],_=h<=0,u=c<=0;return _===u?h>c:_}),this.m_expirationTimeBufferRequiresSorting=!1);for(let r=o-1;r>=0;--r){const a=n[r],l=i[a];if(e<l||l<=0)break;this.DestroyParticle(a)}}RotateBuffer(t,e,i){if(t===e||e===i)return;function n(o){return o<t?o:o<e?o+i-e:o<i?o+t-e:o}if(ee(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&ee(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&ee(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&ee(this.m_consecutiveContactStepsBuffer.data,t,e,i),ee(this.m_positionBuffer.data,t,e,i),ee(this.m_velocityBuffer.data,t,e,i),ee(this.m_groupBuffer,t,e,i),this.m_hasForce&&ee(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&ee(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&ee(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&ee(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&ee(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){ee(this.m_handleIndexBuffer.data,t,e,i);for(let o=t;o<i;++o){const r=this.m_handleIndexBuffer.data[o];r&&r.SetIndex(n(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){ee(this.m_expirationTimeBuffer.data,t,e,i);const o=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(let a=0;a<o;++a)r[a]=n(r[a])}for(let o=0;o<this.m_proxyBuffer.count;o++){const r=this.m_proxyBuffer.data[o];r.index=n(r.index)}for(let o=0;o<this.m_contactBuffer.count;o++){const r=this.m_contactBuffer.data[o];r.indexA=n(r.indexA),r.indexB=n(r.indexB)}for(let o=0;o<this.m_bodyContactBuffer.count;o++){const r=this.m_bodyContactBuffer.data[o];r.index=n(r.index)}for(let o=0;o<this.m_pairBuffer.count;o++){const r=this.m_pairBuffer.data[o];r.indexA=n(r.indexA),r.indexB=n(r.indexB)}for(let o=0;o<this.m_triadBuffer.count;o++){const r=this.m_triadBuffer.data[o];r.indexA=n(r.indexA),r.indexB=n(r.indexB),r.indexC=n(r.indexC)}for(let o=this.m_groupList;o;o=o.GetNext())o.m_firstIndex=n(o.m_firstIndex),o.m_lastIndex=n(o.m_lastIndex-1)+1}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){const e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return Y*this.m_particleDiameter}GetParticleMass(){const t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){const t=this.m_inverseDiameter*(1/Y);return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&m.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e){t.data=e,t.userSuppliedCapacity=e.length}SetGroupFlags(t,e){const i=t.m_groupFlags;(i^e)&m.b2ParticleGroupFlag.b2_solidParticleGroup&&(e|=m.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),i&~e&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&e&&(e&m.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=e),t.m_groupFlags=e}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){Ps(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,S.BodyContactCompare);const t=S.RemoveSpuriousBodyContacts_s_n,e=S.RemoveSpuriousBodyContacts_s_pos,i=S.RemoveSpuriousBodyContacts_s_normal,n=3,o=this;let r=-1,a=0;const l=h=>{if(h.index!==r&&(a=0,r=h.index),a++>n)return!0;const c=t.Copy(h.normal);c.SelfMul(o.m_particleDiameter*(1-h.weight));const _=s.AddVV(o.m_positionBuffer.data[h.index],c,e);if(!h.fixture.TestPoint(_)){const u=h.fixture.GetShape().GetChildCount();for(let f=0;f<u;f++){const p=i;if(h.fixture.ComputeDistance(_,p,f)<j)return!1}return!0}return!1};this.m_bodyContactBuffer.count=An(this.m_bodyContactBuffer.data,l,this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],this.m_bodyContactCountBuffer.data[t]===2&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==jt}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(t){return!(t&m.b2ParticleFlag.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(t){return t!==null&&(t.m_groupFlags&m.b2ParticleGroupFlag.b2_rigidParticleGroup)!==0}GetLinearVelocity(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,n,o,r,a,l){t[0]=n>0?1/n:0,e[0]=o>0?1/o:0,i[0]=s.CrossVV(s.SubVV(a,r,s.s_t0),l)}InitDampingParameterWithRigidGroupOrParticle(t,e,i,n,o,r,a,l){if(o&&n)this.InitDampingParameter(t,e,i,o.GetMass(),o.GetInertia(),o.GetCenter(),a,l);else{const h=this.m_flagsBuffer.data[r];this.InitDampingParameter(t,e,i,h&m.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,l)}}ComputeDampingImpulse(t,e,i,n,o,r,a){const l=t+e*i*i+n+o*r*r;return l>0?a/l:0}ApplyDamping(t,e,i,n,o,r,a,l){o&&n?(o.m_linearVelocity.SelfMulAdd(a*t,l),o.m_angularVelocity+=a*i*e):this.m_velocityBuffer.data[r].SelfMulAdd(a*t,l)}}S.xTruncBits=12,S.yTruncBits=12,S.tagBits=8*4,S.yOffset=1<<S.yTruncBits-1,S.yShift=S.tagBits-S.yTruncBits,S.xShift=S.tagBits-S.yTruncBits-S.xTruncBits,S.xScale=1<<S.xShift,S.xOffset=S.xScale*(1<<S.xTruncBits-1),S.yMask=(1<<S.yTruncBits)-1<<S.yShift,S.xMask=~S.yMask,S.DestroyParticlesInShape_s_aabb=new Tt,S.CreateParticleGroup_s_transform=new M,S.ComputeCollisionEnergy_s_v=new s,S.QueryShapeAABB_s_aabb=new Tt,S.QueryPointAABB_s_aabb=new Tt,S.RayCast_s_aabb=new Tt,S.RayCast_s_p=new s,S.RayCast_s_v=new s,S.RayCast_s_n=new s,S.RayCast_s_point=new s,S.k_pairFlags=m.b2ParticleFlag.b2_springParticle,S.k_triadFlags=m.b2ParticleFlag.b2_elasticParticle,S.k_noPressureFlags=m.b2ParticleFlag.b2_powderParticle|m.b2ParticleFlag.b2_tensileParticle,S.k_extraDampingFlags=m.b2ParticleFlag.b2_staticPressureParticle,S.k_barrierWallFlags=m.b2ParticleFlag.b2_barrierParticle|m.b2ParticleFlag.b2_wallParticle,S.CreateParticlesStrokeShapeForGroup_s_edge=new nt,S.CreateParticlesStrokeShapeForGroup_s_d=new s,S.CreateParticlesStrokeShapeForGroup_s_p=new s,S.CreateParticlesFillShapeForGroup_s_aabb=new Tt,S.CreateParticlesFillShapeForGroup_s_p=new s,S.UpdatePairsAndTriads_s_dab=new s,S.UpdatePairsAndTriads_s_dbc=new s,S.UpdatePairsAndTriads_s_dca=new s,S.AddContact_s_d=new s,S.UpdateBodyContacts_s_aabb=new Tt,S.Solve_s_subStep=new ke,S.SolveCollision_s_aabb=new Tt,S.SolveGravity_s_gravity=new s,S.SolveBarrier_s_aabb=new Tt,S.SolveBarrier_s_va=new s,S.SolveBarrier_s_vb=new s,S.SolveBarrier_s_pba=new s,S.SolveBarrier_s_vba=new s,S.SolveBarrier_s_vc=new s,S.SolveBarrier_s_pca=new s,S.SolveBarrier_s_vca=new s,S.SolveBarrier_s_qba=new s,S.SolveBarrier_s_qca=new s,S.SolveBarrier_s_dv=new s,S.SolveBarrier_s_f=new s,S.SolvePressure_s_f=new s,S.SolveDamping_s_v=new s,S.SolveDamping_s_f=new s,S.SolveRigidDamping_s_t0=new s,S.SolveRigidDamping_s_t1=new s,S.SolveRigidDamping_s_p=new s,S.SolveRigidDamping_s_v=new s,S.SolveExtraDamping_s_v=new s,S.SolveExtraDamping_s_f=new s,S.SolveRigid_s_position=new s,S.SolveRigid_s_rotation=new V,S.SolveRigid_s_transform=new M,S.SolveRigid_s_velocityTransform=new M,S.SolveElastic_s_pa=new s,S.SolveElastic_s_pb=new s,S.SolveElastic_s_pc=new s,S.SolveElastic_s_r=new V,S.SolveElastic_s_t0=new s,S.SolveSpring_s_pa=new s,S.SolveSpring_s_pb=new s,S.SolveSpring_s_d=new s,S.SolveSpring_s_f=new s,S.SolveTensile_s_weightedNormal=new s,S.SolveTensile_s_s=new s,S.SolveTensile_s_f=new s,S.SolveViscous_s_v=new s,S.SolveViscous_s_f=new s,S.SolveRepulsive_s_f=new s,S.SolvePowder_s_f=new s,S.SolveSolid_s_f=new s,S.RemoveSpuriousBodyContacts_s_n=new s,S.RemoveSpuriousBodyContacts_s_pos=new s,S.RemoveSpuriousBodyContacts_s_normal=new s;class ue{constructor(){this._data=null,this.userSuppliedCapacity=0}get data(){return this._data}set data(t){this._data=t}}class ze{constructor(){this.index=jt,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}}class wn{constructor(t,e,i,n,o){this.m_system=t,this.m_xLower=(e&S.xMask)>>>0,this.m_xUpper=(i&S.xMask)>>>0,this.m_yLower=(e&S.yMask)>>>0,this.m_yUpper=(i&S.yMask)>>>0,this.m_first=n,this.m_last=o}GetNext(){for(;this.m_first<this.m_last;){const t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&S.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return jt}}class gn{constructor(){this.next=null,this.count=0,this.index=0}}class Bi{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}}class ea{constructor(t,e){this.second=jt,this.first=t,this.second=e}}class Mn extends Bi{Initialize(t,e){}Find(t){return jt}}class sa{constructor(t,e){this.first=jt,this.second=jt,this.first=t,this.second=e}}class Pn extends Bi{Initialize(t,e){}Find(t){return jt}}class Gs{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}}class In extends Be{constructor(t,e,i,n){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=n,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t!==this.m_system?!1:(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}}class Gn extends Gs{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}}class Dn extends Fe{constructor(t,e=t.length){super(m.b2ShapeType.e_unknown,0),this.m_shapeCount=0,this.m_shapes=t,this.m_shapeCount=e}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,n){return 0}RayCast(t,e,i,n){return!1}ComputeAABB(t,e,i){const n=new Tt;t.lowerBound.x=+k,t.lowerBound.y=+k,t.upperBound.x=-k,t.upperBound.y=-k;for(let o=0;o<this.m_shapeCount;o++){const r=this.m_shapes[o].GetChildCount();for(let a=0;a<r;a++){const l=n;this.m_shapes[o].ComputeAABB(l,e,a),t.Combine1(l)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,n){return 0}Dump(t){}}class Fn extends Gs{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(t){return(this.m_flagsBuffer.data[t]&m.b2ParticleFlag.b2_reactiveParticle)!==0}}class Ee extends yi{constructor(t,e=null){super(t),this.m_contactFilter=null,this.m_contactFilter=e}ShouldCollideFixtureParticle(t,e,i){return this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&m.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,i):!0}ReportFixtureAndParticle(t,e,i){const n=Ee.ReportFixtureAndParticle_s_n,o=Ee.ReportFixtureAndParticle_s_rp,r=this.m_system.m_positionBuffer.data[i],a=n,l=t.ComputeDistance(r,a,e);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(t,this.m_system,i)){const h=t.GetBody(),c=h.GetWorldCenter(),_=h.GetMass(),u=h.GetInertia()-_*h.GetLocalCenter().LengthSquared(),f=_>0?1/_:0,p=u>0?1/u:0,y=this.m_system.m_flagsBuffer.data[i]&m.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),B=s.SubVV(r,c,o),A=s.CrossVV(B,a),x=y+f+p*A*A,C=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];C.index=i,C.body=h,C.fixture=t,C.weight=1-l*this.m_system.m_inverseDiameter,C.normal.Copy(a.SelfNeg()),C.mass=x>0?1/x:0,this.m_system.DetectStuckParticle(i)}}}Ee.ReportFixtureAndParticle_s_n=new s,Ee.ReportFixtureAndParticle_s_rp=new s;class Yt extends yi{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(t,e,i){const n=Yt.ReportFixtureAndParticle_s_p1,o=Yt.ReportFixtureAndParticle_s_output,r=Yt.ReportFixtureAndParticle_s_input,a=Yt.ReportFixtureAndParticle_s_p,l=Yt.ReportFixtureAndParticle_s_v,h=Yt.ReportFixtureAndParticle_s_f,c=t.GetBody(),_=this.m_system.m_positionBuffer.data[i],u=this.m_system.m_velocityBuffer.data[i],f=o,p=r;if(this.m_system.m_iterationIndex===0){const y=M.MulTXV(c.m_xf0,_,n);t.GetShape().GetType()===m.b2ShapeType.e_circleShape&&(y.SelfSub(c.GetLocalCenter()),V.MulRV(c.m_xf0.q,y,y),V.MulTRV(c.m_xf.q,y,y),y.SelfAdd(c.GetLocalCenter())),M.MulXV(c.m_xf,y,p.p1)}else p.p1.Copy(_);if(s.AddVMulSV(_,this.m_step.dt,u,p.p2),p.maxFraction=1,t.RayCast(f,p,e)){const y=f.normal,B=a;B.x=(1-f.fraction)*p.p1.x+f.fraction*p.p2.x+j*y.x,B.y=(1-f.fraction)*p.p1.y+f.fraction*p.p2.y+j*y.y;const A=l;A.x=this.m_step.inv_dt*(B.x-_.x),A.y=this.m_step.inv_dt*(B.y-_.y),this.m_system.m_velocityBuffer.data[i].Copy(A);const x=h;x.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(u.x-A.x),x.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(u.y-A.y),this.m_system.ParticleApplyForce(i,x)}}ReportParticle(t,e){return!1}}Yt.ReportFixtureAndParticle_s_p1=new s,Yt.ReportFixtureAndParticle_s_output=new ei,Yt.ReportFixtureAndParticle_s_input=new As,Yt.ReportFixtureAndParticle_s_p=new s,Yt.ReportFixtureAndParticle_s_v=new s,Yt.ReportFixtureAndParticle_s_f=new s;class W{constructor(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new hn,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new s,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new di,this.m_island=new Rt,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new Jt(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const r=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(r.joint),this.DestroyJoint(r.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const r=i;i=i.nextController,r.controller.RemoveBody(t)}let n=t.m_contactList;for(;n;){const r=n;n=n.next,this.m_contactManager.Destroy(r.contact)}t.m_contactList=null;let o=t.m_fixtureList;for(;o;){const r=o;o=o.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(r),r.DestroyProxies(),r.Reset(),t.m_fixtureList=o,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(t){switch(t.type){case m.b2JointType.e_distanceJoint:return new re(t);case m.b2JointType.e_mouseJoint:return new ge(t);case m.b2JointType.e_prismaticJoint:return new et(t);case m.b2JointType.e_revoluteJoint:return new Vt(t);case m.b2JointType.e_pulleyJoint:return new Ct(t);case m.b2JointType.e_gearJoint:return new pt(t);case m.b2JointType.e_wheelJoint:return new te(t);case m.b2JointType.e_weldJoint:return new wt(t);case m.b2JointType.e_frictionJoint:return new Ve(t);case m.b2JointType.e_ropeJoint:return new ae(t);case m.b2JointType.e_motorJoint:return new we(t);case m.b2JointType.e_areaJoint:return new rn(t)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=W._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,n=e.m_bodyB;if(!e.m_collideConnected){let r=n.GetContactList();for(;r;)r.other===i&&r.contact.FlagForFiltering(),r=r.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,n=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),W._Joint_Destroy(t),--this.m_jointCount,!n){let o=i.GetContactList();for(;o;)o.other===e&&o.contact.FlagForFiltering(),o=o.next}}CreateParticleSystem(t){if(this.IsLocked())throw new Error;const e=new S(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)}CalculateReasonableParticleIterations(t){if(this.m_particleSystemList===null)return 1;function e(i){let n=k;for(let o=i.GetParticleSystemList();o!==null;o=o.m_next)n=tt(n,o.GetRadius());return n}return dn(this.m_gravity.Length(),e(this),t)}Step(t,e,i,n=this.CalculateReasonableParticleIterations(t)){const o=W.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;const r=W.Step_s_step;r.dt=t,r.velocityIterations=e,r.positionIterations=i,r.particleIterations=n,t>0?r.inv_dt=1/t:r.inv_dt=0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;const a=W.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=a.GetMilliseconds(),this.m_stepComplete&&r.dt>0){const l=W.Step_s_timer.Reset();for(let h=this.m_particleSystemList;h;h=h.m_next)h.Solve(r);this.Solve(r),this.m_profile.solve=l.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){const l=W.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=l.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){if(this.m_debugDraw===null)return;const e=t.GetParticleCount();if(e){const i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){const o=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,o,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}DrawDebugData(){if(this.m_debugDraw===null)return;const t=this.m_debugDraw.GetFlags(),e=W.DrawDebugData_s_color.SetRGB(0,0,0);if(t&m.b2DrawFlags.e_shapeBit)for(let i=this.m_bodyList;i;i=i.m_next){const n=i.m_xf;this.m_debugDraw.PushTransform(n);for(let o=i.GetFixtureList();o;o=o.m_next)i.IsActive()?i.GetType()===m.b2BodyType.b2_staticBody?(e.SetRGB(.5,.9,.5),this.DrawShape(o,e)):i.GetType()===m.b2BodyType.b2_kinematicBody?(e.SetRGB(.5,.5,.9),this.DrawShape(o,e)):i.IsAwake()?(e.SetRGB(.9,.7,.7),this.DrawShape(o,e)):(e.SetRGB(.6,.6,.6),this.DrawShape(o,e)):(e.SetRGB(.5,.5,.3),this.DrawShape(o,e));this.m_debugDraw.PopTransform(n)}if(t&m.b2DrawFlags.e_particleBit)for(let i=this.m_particleSystemList;i;i=i.m_next)this.DrawParticleSystem(i);if(t&m.b2DrawFlags.e_jointBit)for(let i=this.m_jointList;i;i=i.m_next)this.DrawJoint(i);if(t&m.b2DrawFlags.e_aabbBit){e.SetRGB(.9,.3,.9);const i=W.DrawDebugData_s_vs;for(let n=this.m_bodyList;n;n=n.m_next)if(!!n.IsActive())for(let o=n.GetFixtureList();o;o=o.m_next)for(let r=0;r<o.m_proxyCount;++r){const l=o.m_proxies[r].treeNode.aabb;i[0].Set(l.lowerBound.x,l.lowerBound.y),i[1].Set(l.upperBound.x,l.lowerBound.y),i[2].Set(l.upperBound.x,l.upperBound.y),i[3].Set(l.lowerBound.x,l.upperBound.y),this.m_debugDraw.DrawPolygon(i,4,e)}}if(t&m.b2DrawFlags.e_centerOfMassBit)for(let i=this.m_bodyList;i;i=i.m_next){const n=W.DrawDebugData_s_xf;n.q.Copy(i.m_xf.q),n.p.Copy(i.GetWorldCenter()),this.m_debugDraw.DrawTransform(n)}if(t&m.b2DrawFlags.e_controllerBit)for(let i=this.m_controllerList;i;i=i.m_next)i.Draw(this.m_debugDraw)}QueryAABB(...t){t[0]instanceof Be?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,n=>{const r=n.userData.fixture;return t?t.ReportFixture(r):i?i(r):!0}),t instanceof Be)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryAABB(t,e)}QueryAllAABB(t,e=[]){return this.QueryAABB(t,i=>(e.push(i),!0)),e}QueryPointAABB(...t){t[0]instanceof Be?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,n=>{const r=n.userData.fixture;return t?t.ReportFixture(r):i?i(r):!0}),t instanceof Be)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,i=>(e.push(i),!0)),e}QueryFixtureShape(...t){t[0]instanceof Be?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,n,o){const r=W.QueryFixtureShape_s_aabb;if(e.ComputeAABB(r,n,i),this.m_contactManager.m_broadPhase.Query(r,a=>{const l=a.userData,h=l.fixture;if(ii(e,i,h.GetShape(),l.childIndex,n,h.GetBody().GetTransform())){if(t)return t.ReportFixture(h);if(o)return o(h)}return!0}),t instanceof Be)for(let a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.QueryAABB(t,r)}QueryAllFixtureShape(t,e,i,n=[]){return this.QueryFixtureShape(t,e,i,o=>(n.push(o),!0)),n}QueryFixturePoint(...t){t[0]instanceof Be?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,n=>{const r=n.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(i)return i(r)}return!0}),t)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,i=>(e.push(i),!0)),e}RayCast(...t){t[0]instanceof _n?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,n){const o=W.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(e),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,(r,a)=>{const l=a.userData,h=l.fixture,c=l.childIndex,_=W.RayCast_s_output;if(h.RayCast(_,r,c)){const f=_.fraction,p=W.RayCast_s_point;if(p.Set((1-f)*e.x+f*i.x,(1-f)*e.y+f*i.y),t)return t.ReportFixture(h,p,_.normal,f);if(n)return n(h,p,_.normal,f)}return r.maxFraction}),t)for(let r=this.m_particleSystemList;r;r=r.m_next)t.ShouldQueryParticleSystem(r)&&r.RayCast(t,e,i)}RayCastOne(t,e){let i=null,n=1;return this.RayCast(t,e,(o,r,a,l)=>(l<n&&(n=l,i=o),n)),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,(n,o,r,a)=>(i.push(n),1)),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!s.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(t){if(this.m_locked)return;t(`const g: b2Vec2 = new b2Vec2(%.15f, %.15f);
`,this.m_gravity.x,this.m_gravity.y),t(`this.m_world.SetGravity(g);
`),t(`const bodies: b2Body[] = [];
`),t(`const joints: b2Joint[] = [];
`);let e=0;for(let i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=e,i.Dump(t),++e;e=0;for(let i=this.m_jointList;i;i=i.m_next)i.m_index=e,++e;for(let i=this.m_jointList;i;i=i.m_next)i.m_type!==m.b2JointType.e_gearJoint&&(t(`{
`),i.Dump(t),t(`}
`));for(let i=this.m_jointList;i;i=i.m_next)i.m_type===m.b2JointType.e_gearJoint&&(t(`{
`),i.Dump(t),t(`}
`))}DrawJoint(t){if(this.m_debugDraw===null)return;const e=t.GetBodyA(),i=t.GetBodyB(),n=e.m_xf,o=i.m_xf,r=n.p,a=o.p,l=t.GetAnchorA(W.DrawJoint_s_p1),h=t.GetAnchorB(W.DrawJoint_s_p2),c=W.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(t.m_type){case m.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,h,c);break;case m.b2JointType.e_pulleyJoint:{const _=t,u=_.GetGroundAnchorA(),f=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(u,l,c),this.m_debugDraw.DrawSegment(f,h,c),this.m_debugDraw.DrawSegment(u,f,c);break}case m.b2JointType.e_mouseJoint:{const _=W.DrawJoint_s_c;_.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,_),this.m_debugDraw.DrawPoint(h,4,_),_.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,h,_);break}default:this.m_debugDraw.DrawSegment(r,l,c),this.m_debugDraw.DrawSegment(l,h,c),this.m_debugDraw.DrawSegment(a,h,c)}}DrawShape(t,e){if(this.m_debugDraw===null)return;const i=t.GetShape();switch(i.m_type){case m.b2ShapeType.e_circleShape:{const n=i,o=n.m_p,r=n.m_radius,a=s.UNITX;this.m_debugDraw.DrawSolidCircle(o,r,a,e);break}case m.b2ShapeType.e_edgeShape:{const n=i,o=n.m_vertex1,r=n.m_vertex2;this.m_debugDraw.DrawSegment(o,r,e);break}case m.b2ShapeType.e_chainShape:{const n=i,o=n.m_count,r=n.m_vertices,a=W.DrawShape_s_ghostColor.SetRGBA(.75*e.r,.75*e.g,.75*e.b,e.a);let l=r[0];if(this.m_debugDraw.DrawPoint(l,4,e),n.m_hasPrevVertex){const h=n.m_prevVertex;this.m_debugDraw.DrawSegment(h,l,a),this.m_debugDraw.DrawCircle(h,.1,a)}for(let h=1;h<o;++h){const c=r[h];this.m_debugDraw.DrawSegment(l,c,e),this.m_debugDraw.DrawPoint(c,4,e),l=c}if(n.m_hasNextVertex){const h=n.m_nextVertex;this.m_debugDraw.DrawSegment(h,l,a),this.m_debugDraw.DrawCircle(h,.1,a)}break}case m.b2ShapeType.e_polygonShape:{const n=i,o=n.m_count,r=n.m_vertices;this.m_debugDraw.DrawSolidPolygon(r,o,e);break}}}Solve(t){for(let o=this.m_bodyList;o;o=o.m_next)o.m_xf0.Copy(o.m_xf);for(let o=this.m_controllerList;o;o=o.m_next)o.Step(t);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const e=this.m_island;e.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(let o=this.m_contactManager.m_contactList;o;o=o.m_next)o.m_islandFlag=!1;for(let o=this.m_jointList;o;o=o.m_next)o.m_islandFlag=!1;const i=this.s_stack;for(let o=this.m_bodyList;o;o=o.m_next){if(o.m_islandFlag||!o.IsAwake()||!o.IsActive()||o.GetType()===m.b2BodyType.b2_staticBody)continue;e.Clear();let r=0;for(i[r++]=o,o.m_islandFlag=!0;r>0;){const l=i[--r];if(!l)throw new Error;if(e.AddBody(l),l.m_awakeFlag=!0,l.GetType()!==m.b2BodyType.b2_staticBody){for(let h=l.m_contactList;h;h=h.next){const c=h.contact;if(c.m_islandFlag||!c.IsEnabled()||!c.IsTouching())continue;const _=c.m_fixtureA.m_isSensor,u=c.m_fixtureB.m_isSensor;if(_||u)continue;e.AddContact(c),c.m_islandFlag=!0;const f=h.other;f.m_islandFlag||(i[r++]=f,f.m_islandFlag=!0)}for(let h=l.m_jointList;h;h=h.next){if(h.joint.m_islandFlag)continue;const c=h.other;!c.IsActive()||(e.AddJoint(h.joint),h.joint.m_islandFlag=!0,!c.m_islandFlag&&(i[r++]=c,c.m_islandFlag=!0))}}}const a=new di;e.Solve(a,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=a.solveInit,this.m_profile.solveVelocity+=a.solveVelocity,this.m_profile.solvePosition+=a.solvePosition;for(let l=0;l<e.m_bodyCount;++l){const h=e.m_bodies[l];h.GetType()===m.b2BodyType.b2_staticBody&&(h.m_islandFlag=!1)}}for(let o=0;o<i.length&&i[o];++o)i[o]=null;const n=new je;for(let o=this.m_bodyList;o;o=o.m_next)!o.m_islandFlag||o.GetType()!==m.b2BodyType.b2_staticBody&&o.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=n.GetMilliseconds()}SolveTOI(t){const e=this.m_island;if(e.Initialize(2*Ht,Ht,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let i=this.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1,i.m_sweep.alpha0=0;for(let i=this.m_contactManager.m_contactList;i;i=i.m_next)i.m_toiFlag=!1,i.m_islandFlag=!1,i.m_toiCount=0,i.m_toi=1}for(;;){let i=null,n=1;for(let u=this.m_contactManager.m_contactList;u;u=u.m_next){if(!u.IsEnabled()||u.m_toiCount>St)continue;let f=1;if(u.m_toiFlag)f=u.m_toi;else{const p=u.GetFixtureA(),y=u.GetFixtureB();if(p.IsSensor()||y.IsSensor())continue;const B=p.GetBody(),A=y.GetBody(),x=B.m_type,C=A.m_type,v=B.IsAwake()&&x!==m.b2BodyType.b2_staticBody,g=A.IsAwake()&&C!==m.b2BodyType.b2_staticBody;if(!v&&!g)continue;const I=B.IsBullet()||x!==m.b2BodyType.b2_dynamicBody,P=A.IsBullet()||C!==m.b2BodyType.b2_dynamicBody;if(!I&&!P)continue;let T=B.m_sweep.alpha0;B.m_sweep.alpha0<A.m_sweep.alpha0?(T=A.m_sweep.alpha0,B.m_sweep.Advance(T)):A.m_sweep.alpha0<B.m_sweep.alpha0&&(T=B.m_sweep.alpha0,A.m_sweep.Advance(T));const F=u.GetChildIndexA(),R=u.GetChildIndexB(),E=W.SolveTOI_s_toi_input;E.proxyA.SetShape(p.GetShape(),F),E.proxyB.SetShape(y.GetShape(),R),E.sweepA.Copy(B.m_sweep),E.sweepB.Copy(A.m_sweep),E.tMax=1;const L=W.SolveTOI_s_toi_output;ri(L,E);const G=L.t;L.state===m.b2TOIOutputState.e_touching?f=tt(T+(1-T)*G,1):f=1,u.m_toi=f,u.m_toiFlag=!0}f<n&&(i=u,n=f)}if(i===null||1-10*K<n){this.m_stepComplete=!0;break}const o=i.GetFixtureA(),r=i.GetFixtureB(),a=o.GetBody(),l=r.GetBody(),h=W.SolveTOI_s_backup1.Copy(a.m_sweep),c=W.SolveTOI_s_backup2.Copy(l.m_sweep);if(a.Advance(n),l.Advance(n),i.Update(this.m_contactManager.m_contactListener),i.m_toiFlag=!1,++i.m_toiCount,!i.IsEnabled()||!i.IsTouching()){i.SetEnabled(!1),a.m_sweep.Copy(h),l.m_sweep.Copy(c),a.SynchronizeTransform(),l.SynchronizeTransform();continue}a.SetAwake(!0),l.SetAwake(!0),e.Clear(),e.AddBody(a),e.AddBody(l),e.AddContact(i),a.m_islandFlag=!0,l.m_islandFlag=!0,i.m_islandFlag=!0;for(let u=0;u<2;++u){const f=u===0?a:l;if(f.m_type===m.b2BodyType.b2_dynamicBody)for(let p=f.m_contactList;p&&!(e.m_bodyCount===e.m_bodyCapacity||e.m_contactCount===e.m_contactCapacity);p=p.next){const y=p.contact;if(y.m_islandFlag)continue;const B=p.other;if(B.m_type===m.b2BodyType.b2_dynamicBody&&!f.IsBullet()&&!B.IsBullet())continue;const A=y.m_fixtureA.m_isSensor,x=y.m_fixtureB.m_isSensor;if(A||x)continue;const C=W.SolveTOI_s_backup.Copy(B.m_sweep);if(B.m_islandFlag||B.Advance(n),y.Update(this.m_contactManager.m_contactListener),!y.IsEnabled()){B.m_sweep.Copy(C),B.SynchronizeTransform();continue}if(!y.IsTouching()){B.m_sweep.Copy(C),B.SynchronizeTransform();continue}y.m_islandFlag=!0,e.AddContact(y),!B.m_islandFlag&&(B.m_islandFlag=!0,B.m_type!==m.b2BodyType.b2_staticBody&&B.SetAwake(!0),e.AddBody(B))}}const _=W.SolveTOI_s_subStep;_.dt=(1-n)*t.dt,_.inv_dt=1/_.dt,_.dtRatio=1,_.positionIterations=20,_.velocityIterations=t.velocityIterations,_.particleIterations=t.particleIterations,_.warmStarting=!1,e.SolveTOI(_,a.m_islandIndex,l.m_islandIndex);for(let u=0;u<e.m_bodyCount;++u){const f=e.m_bodies[u];if(f.m_islandFlag=!1,f.m_type===m.b2BodyType.b2_dynamicBody){f.SynchronizeFixtures();for(let p=f.m_contactList;p;p=p.next)p.contact.m_toiFlag=!1,p.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t}}W.Step_s_step=new ke,W.Step_s_stepTimer=new je,W.Step_s_timer=new je,W.DrawDebugData_s_color=new ct(0,0,0),W.DrawDebugData_s_vs=s.MakeArray(4),W.DrawDebugData_s_xf=new M,W.QueryFixtureShape_s_aabb=new Tt,W.RayCast_s_input=new As,W.RayCast_s_output=new ei,W.RayCast_s_point=new s,W.DrawJoint_s_p1=new s,W.DrawJoint_s_p2=new s,W.DrawJoint_s_color=new ct(.5,.8,.8),W.DrawJoint_s_c=new ct,W.DrawShape_s_ghostColor=new ct,W.SolveTOI_s_subStep=new ke,W.SolveTOI_s_backup=new se,W.SolveTOI_s_backup1=new se,W.SolveTOI_s_backup2=new se,W.SolveTOI_s_toi_input=new ni,W.SolveTOI_s_toi_output=new oi;class Ln{constructor(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e}}class Xe{constructor(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}GetNext(){return this.m_next}GetPrev(){return this.m_prev}GetBodyList(){return this.m_bodyList}AddBody(t){const e=new Ln(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount}RemoveBody(t){if(this.m_bodyCount<=0)throw new Error;let e=this.m_bodyList;for(;e&&e.body!==t;)e=e.nextBody;if(e===null)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount}Clear(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0}}class ia extends Xe{constructor(){super(...arguments),this.normal=new s(0,1),this.offset=0,this.density=0,this.velocity=new s(0,0),this.linearDrag=0,this.angularDrag=0,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=new s(0,0)}Step(t){if(!!this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body;if(!i.IsAwake())continue;const n=new s,o=new s;let r=0,a=0;for(let c=i.GetFixtureList();c;c=c.m_next){const _=new s,u=c.GetShape().ComputeSubmergedArea(this.normal,this.offset,i.GetTransform(),_);r+=u,n.x+=u*_.x,n.y+=u*_.y;let f=0;this.useDensity?f=c.GetDensity():f=1,a+=u*f,o.x+=u*_.x*f,o.y+=u*_.y*f}if(n.x/=r,n.y/=r,o.x/=a,o.y/=a,r<K)continue;const l=this.gravity.Clone().SelfNeg();l.SelfMul(this.density*r),i.ApplyForce(l,o);const h=i.GetLinearVelocityFromWorldPoint(n,new s);h.SelfSub(this.velocity),h.SelfMul(-this.linearDrag*r),i.ApplyForce(h,n),i.ApplyTorque(-i.GetInertia()/i.GetMass()*r*i.GetAngularVelocity()*this.angularDrag)}}}Draw(t){const i=new s,n=new s;i.x=this.normal.x*this.offset+this.normal.y*100,i.y=this.normal.y*this.offset-this.normal.x*100,n.x=this.normal.x*this.offset-this.normal.y*100,n.y=this.normal.y*this.offset+this.normal.x*100;const o=new ct(0,0,.8);t.DrawSegment(i,n,o)}}class Ds extends Xe{constructor(){super(...arguments),this.A=new s(0,0)}Step(t){const e=s.MulSV(t.dt,this.A,Ds.Step_s_dtA);for(let i=this.m_bodyList;i;i=i.nextBody){const n=i.body;!n.IsAwake()||n.SetLinearVelocity(s.AddVV(n.GetLinearVelocity(),e,s.s_t0))}}Draw(t){}}Ds.Step_s_dtA=new s;class na extends Xe{constructor(){super(...arguments),this.F=new s(0,0)}Step(t){for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body;!i.IsAwake()||i.ApplyForce(this.F,i.GetWorldCenter())}}Draw(t){}}class rs extends Xe{constructor(){super(...arguments),this.G=1,this.invSqr=!0}Step(t){if(this.invSqr)for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body,n=i.GetWorldCenter(),o=i.GetMass();for(let r=this.m_bodyList;r&&r!==e;r=r.nextBody){const a=r.body,l=a.GetWorldCenter(),h=a.GetMass(),c=l.x-n.x,_=l.y-n.y,u=c*c+_*_;if(u<K)continue;const f=rs.Step_s_f.Set(c,_);f.SelfMul(this.G/u/ye(u)*o*h),i.IsAwake()&&i.ApplyForce(f,n),a.IsAwake()&&a.ApplyForce(f.SelfMul(-1),l)}}else for(let e=this.m_bodyList;e;e=e.nextBody){const i=e.body,n=i.GetWorldCenter(),o=i.GetMass();for(let r=this.m_bodyList;r&&r!==e;r=r.nextBody){const a=r.body,l=a.GetWorldCenter(),h=a.GetMass(),c=l.x-n.x,_=l.y-n.y,u=c*c+_*_;if(u<K)continue;const f=rs.Step_s_f.Set(c,_);f.SelfMul(this.G/u*o*h),i.IsAwake()&&i.ApplyForce(f,n),a.IsAwake()&&a.ApplyForce(f.SelfMul(-1),l)}}}Draw(t){}}rs.Step_s_f=new s;class Fs extends Xe{constructor(){super(...arguments),this.T=new ft,this.maxTimestep=0}Step(t){let e=t.dt;if(!(e<=K)){e>this.maxTimestep&&this.maxTimestep>0&&(e=this.maxTimestep);for(let i=this.m_bodyList;i;i=i.nextBody){const n=i.body;if(!n.IsAwake())continue;const o=n.GetWorldVector(ft.MulMV(this.T,n.GetLocalVector(n.GetLinearVelocity(),s.s_t0),s.s_t1),Fs.Step_s_damping);n.SetLinearVelocity(s.AddVV(n.GetLinearVelocity(),s.MulSV(e,o,s.s_t0),s.s_t1))}}}Draw(t){}SetAxisAligned(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,t>0||e>0?this.maxTimestep=1/H(t,e):this.maxTimestep=0}}Fs.Step_s_damping=new s;class oa{constructor(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new s(0,0),this.damping=.1,this.k2=.9,this.k3=.1}}class Ut{constructor(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new s,this.m_damping=0,this.m_k2=1,this.m_k3=.1}GetVertexCount(){return this.m_count}GetVertices(){return this.m_ps}Initialize(t){this.m_count=t.count,this.m_ps=s.MakeArray(this.m_count),this.m_p0s=s.MakeArray(this.m_count),this.m_vs=s.MakeArray(this.m_count),this.m_ims=Ie(this.m_count);for(let n=0;n<this.m_count;++n){this.m_ps[n].Copy(t.vertices[n]),this.m_p0s[n].Copy(t.vertices[n]),this.m_vs[n].SetZero();const o=t.masses[n];o>0?this.m_ims[n]=1/o:this.m_ims[n]=0}const e=this.m_count-1,i=this.m_count-2;this.m_Ls=Ie(e),this.m_as=Ie(i);for(let n=0;n<e;++n){const o=this.m_ps[n],r=this.m_ps[n+1];this.m_Ls[n]=s.DistanceVV(o,r)}for(let n=0;n<i;++n){const o=this.m_ps[n],r=this.m_ps[n+1],a=this.m_ps[n+2],l=s.SubVV(r,o,s.s_t0),h=s.SubVV(a,r,s.s_t1),c=s.CrossVV(l,h),_=s.DotVV(l,h);this.m_as[n]=Ws(c,_)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3}Step(t,e){if(t===0)return;const i=Math.exp(-t*this.m_damping);for(let o=0;o<this.m_count;++o)this.m_p0s[o].Copy(this.m_ps[o]),this.m_ims[o]>0&&this.m_vs[o].SelfMulAdd(t,this.m_gravity),this.m_vs[o].SelfMul(i),this.m_ps[o].SelfMulAdd(t,this.m_vs[o]);for(let o=0;o<e;++o)this.SolveC2(),this.SolveC3(),this.SolveC2();const n=1/t;for(let o=0;o<this.m_count;++o)s.MulSV(n,s.SubVV(this.m_ps[o],this.m_p0s[o],s.s_t0),this.m_vs[o])}SolveC2(){const t=this.m_count-1;for(let e=0;e<t;++e){const i=this.m_ps[e],n=this.m_ps[e+1],o=s.SubVV(n,i,Ut.s_d),r=o.Normalize(),a=this.m_ims[e],l=this.m_ims[e+1];if(a+l===0)continue;const h=a/(a+l),c=l/(a+l);i.SelfMulSub(this.m_k2*h*(this.m_Ls[e]-r),o),n.SelfMulAdd(this.m_k2*c*(this.m_Ls[e]-r),o)}}SetAngle(t){const e=this.m_count-2;for(let i=0;i<e;++i)this.m_as[i]=t}SolveC3(){const t=this.m_count-2;for(let e=0;e<t;++e){const i=this.m_ps[e],n=this.m_ps[e+1],o=this.m_ps[e+2],r=this.m_ims[e],a=this.m_ims[e+1],l=this.m_ims[e+2],h=s.SubVV(n,i,Ut.s_d1),c=s.SubVV(o,n,Ut.s_d2),_=h.LengthSquared(),u=c.LengthSquared();if(_*u===0)continue;const f=s.CrossVV(h,c),p=s.DotVV(h,c);let y=Ws(f,p);const B=s.MulSV(-1/_,h.SelfSkew(),Ut.s_Jd1),A=s.MulSV(1/u,c.SelfSkew(),Ut.s_Jd2),x=s.NegV(B,Ut.s_J1),C=s.SubVV(B,A,Ut.s_J2),v=A;let g=r*s.DotVV(x,x)+a*s.DotVV(C,C)+l*s.DotVV(v,v);if(g===0)continue;g=1/g;let I=y-this.m_as[e];for(;I>q;)y-=2*q,I=y-this.m_as[e];for(;I<-q;)y+=2*q,I=y-this.m_as[e];const P=-this.m_k3*g*I;i.SelfMulAdd(r*P,x),n.SelfMulAdd(a*P,C),o.SelfMulAdd(l*P,v)}}Draw(t){const e=new ct(.4,.5,.7);for(let i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)}}Ut.s_d=new s,Ut.s_d1=new s,Ut.s_d2=new s,Ut.s_Jd1=new s,Ut.s_Jd2=new s,Ut.s_J1=new s,Ut.s_J2=new s,m.b2AABB=Tt,m.b2Abs=at,m.b2Acos=lo,m.b2Alloc=Zn,m.b2AreaJoint=rn,m.b2AreaJointDef=qr,m.b2Asin=zi,m.b2Assert=U,m.b2Atan2=Ws,m.b2BlockAllocator=yo,m.b2Body=Jt,m.b2BodyDef=Rr,m.b2BroadPhase=Ui,m.b2BuoyancyController=ia,m.b2CalculateParticleIterations=dn,m.b2ChainAndCircleContact=Te,m.b2ChainAndPolygonContact=Re,m.b2ChainShape=fe,m.b2CircleContact=We,m.b2CircleShape=Ot,m.b2Clamp=gt,m.b2ClipSegmentToLine=Qe,m.b2ClipVertex=Ce,m.b2CollideCircles=Yi,m.b2CollideEdgeAndCircle=li,m.b2CollideEdgeAndPolygon=mi,m.b2CollidePolygonAndCircle=Ki,m.b2CollidePolygons=tn,m.b2Color=ct,m.b2ConstantAccelController=Ds,m.b2ConstantForceController=na,m.b2Contact=le,m.b2ContactEdge=ui,m.b2ContactFactory=ln,m.b2ContactFeature=Oi,m.b2ContactFilter=Vs,m.b2ContactID=Oe,m.b2ContactImpulse=mn,m.b2ContactListener=ws,m.b2ContactManager=hn,m.b2ContactPositionConstraint=ns,m.b2ContactRegister=an,m.b2ContactSolver=z,m.b2ContactSolverDef=un,m.b2ContactVelocityConstraint=is,m.b2Controller=Xe,m.b2ControllerEdge=Ln,m.b2Cos=ro,m.b2Counter=po,m.b2DegToRad=no,m.b2DestructionListener=Wr,m.b2Distance=ti,m.b2DistanceInput=Ks,m.b2DistanceJoint=re,m.b2DistanceJointDef=on,m.b2DistanceOutput=$s,m.b2DistanceProxy=De,m.b2Draw=fo,m.b2DynamicTree=ot,m.b2EdgeAndCircleContact=$e,m.b2EdgeAndPolygonContact=ts,m.b2EdgeShape=nt,m.b2Filter=Ge,m.b2Fixture=nn,m.b2FixtureDef=sn,m.b2FixtureParticleQueryCallback=yi,m.b2FixtureProxy=Le,m.b2Free=Hn,m.b2FrictionJoint=Ve,m.b2FrictionJointDef=zr,m.b2GearJoint=pt,m.b2GearJointDef=Er,m.b2GetPointStates=ko,m.b2GravityController=rs,m.b2GrowableBuffer=qe,m.b2GrowableStack=Ei,m.b2InvSqrt=Qs,m.b2IsPowerOfTwo=_o,m.b2IsValid=io,m.b2Island=Rt,m.b2Jacobian=kr,m.b2Joint=oe,m.b2JointDef=ne,m.b2JointEdge=_i,m.b2Log=Qn,m.b2MakeArray=Wt,m.b2MakeNullArray=eo,m.b2MakeNumberArray=Ie,m.b2Manifold=He,m.b2ManifoldPoint=Bs,m.b2MassData=bs,m.b2Mat22=ft,m.b2Mat33=he,m.b2Max=H,m.b2Maybe=b,m.b2Min=tt,m.b2MixFriction=hi,m.b2MixRestitution=ci,m.b2MotorJoint=we,m.b2MotorJointDef=Nr,m.b2MouseJoint=ge,m.b2MouseJointDef=jr,m.b2NextPowerOfTwo=mo,m.b2Pair=Xi,m.b2PairLessThan=Zi,m.b2ParseInt=$n,m.b2ParseUInt=to,m.b2ParticleBodyContact=vn,m.b2ParticleContact=Cn,m.b2ParticleDef=pi,m.b2ParticleGroup=os,m.b2ParticleGroupDef=pn,m.b2ParticleHandle=fn,m.b2ParticlePair=bn,m.b2ParticlePairSet=Pn,m.b2ParticleSystem=S,m.b2ParticleSystemDef=Is,m.b2ParticleSystem_CompositeShape=Dn,m.b2ParticleSystem_ConnectionFilter=Gs,m.b2ParticleSystem_DestroyParticlesInShapeCallback=In,m.b2ParticleSystem_FixedSetAllocator=Bi,m.b2ParticleSystem_FixtureParticle=ea,m.b2ParticleSystem_FixtureParticleSet=Mn,m.b2ParticleSystem_InsideBoundsEnumerator=wn,m.b2ParticleSystem_JoinParticleGroupsFilter=Gn,m.b2ParticleSystem_ParticleListNode=gn,m.b2ParticleSystem_ParticlePair=sa,m.b2ParticleSystem_Proxy=ze,m.b2ParticleSystem_ReactiveFilter=Fn,m.b2ParticleSystem_SolveCollisionCallback=Yt,m.b2ParticleSystem_UpdateBodyContactsCallback=Ee,m.b2ParticleSystem_UserOverridableBuffer=ue,m.b2ParticleTriad=Vn,m.b2PolygonAndCircleContact=Ke,m.b2PolygonContact=Ye,m.b2PolygonShape=Z,m.b2Position=es,m.b2PositionSolverManifold=ce,m.b2Pow=qi,m.b2PrismaticJoint=et,m.b2PrismaticJointDef=Or,m.b2Profile=di,m.b2PulleyJoint=Ct,m.b2PulleyJointDef=Xr,m.b2QueryCallback=Be,m.b2RadToDeg=oo,m.b2Random=ho,m.b2RandomRange=co,m.b2RayCastCallback=_n,m.b2RayCastInput=As,m.b2RayCastOutput=ei,m.b2RevoluteJoint=Vt,m.b2RevoluteJointDef=Ur,m.b2Rope=Ut,m.b2RopeDef=oa,m.b2RopeJoint=ae,m.b2RopeJointDef=Zr,m.b2Rot=V,m.b2SeparationFunction=Wi,m.b2Shape=Fe,m.b2ShapeCast=Ro,m.b2ShapeCastInput=Ao,m.b2ShapeCastOutput=xo,m.b2Simplex=de,m.b2SimplexCache=Ys,m.b2SimplexVertex=ys,m.b2Sin=ao,m.b2SolverData=cn,m.b2Sq=Ne,m.b2Sqrt=ye,m.b2StackAllocator=Bo,m.b2Swap=so,m.b2Sweep=se,m.b2TOIInput=ni,m.b2TOIOutput=oi,m.b2TensorDampingController=Fs,m.b2TestOverlapAABB=si,m.b2TestOverlapShape=ii,m.b2TimeOfImpact=ri,m.b2TimeStep=ke,m.b2Timer=je,m.b2Transform=M,m.b2TreeNode=Ji,m.b2Vec2=s,m.b2Vec2_zero=uo,m.b2Vec3=bt,m.b2Velocity=ss,m.b2VelocityConstraintPoint=gs,m.b2Version=Ti,m.b2WeldJoint=wt,m.b2WeldJointDef=Hr,m.b2WheelJoint=te,m.b2WheelJointDef=Qr,m.b2World=W,m.b2WorldManifold=Mt,m.b2_180_over_pi=ki,m.b2_aabbExtension=yt,m.b2_aabbMultiplier=dt,m.b2_angularSleepTolerance=Zs,m.b2_angularSlop=At,m.b2_barrierCollisionTime=Ft,m.b2_baumgarte=xe,m.b2_branch=Yn,m.b2_commit=Kn,m.b2_epsilon=K,m.b2_epsilon_sq=ht,m.b2_gjk_reset=So,m.b2_invalidParticleIndex=jt,m.b2_linearSleepTolerance=Us,m.b2_linearSlop=j,m.b2_maxAngularCorrection=Gt,m.b2_maxFloat=k,m.b2_maxLinearCorrection=st,m.b2_maxManifoldPoints=J,m.b2_maxParticleForce=Dt,m.b2_maxParticleIndex=Li,m.b2_maxParticlePressure=it,m.b2_maxPolygonVertices=ut,m.b2_maxRotation=rt,m.b2_maxRotationSquared=Lt,m.b2_maxSubSteps=St,m.b2_maxTOIContacts=Ht,m.b2_maxTranslation=$t,m.b2_maxTranslationSquared=Me,m.b2_maxTriadDistance=Qt,m.b2_maxTriadDistanceSquared=_e,m.b2_minParticleSystemBufferCapacity=vt,m.b2_minParticleWeight=Q,m.b2_minPulleyLength=Jr,m.b2_particleStride=Y,m.b2_pi=q,m.b2_pi_over_180=Ri,m.b2_polygonRadius=xt,m.b2_timeToSleep=Pe,m.b2_toiBaumgarte=Se,m.b2_toi_reset=Jo,m.b2_two_pi=Hs,m.b2_velocityThreshold=mt,m.b2_version=Wn,m.g_blockSolve=fi,Object.defineProperty(m,"__esModule",{value:!0})})})(Et,Et.exports);const{window:Nn}=ya;function Ca(w){let D,m,U,b,k,K,ht,q,J,ut,yt,dt,j=w[2][0]+"",At,xt,St=w[2][1]+"",Ht,mt=`${w[3]}px`,st=`${w[4]}px`,Gt,$t,Me;return U=new En({props:{color:"red",radius:cs,eyeAngle:w[7](0),x:w[1][0].GetPosition().x,y:w[1][0].GetPosition().y}}),b=new En({props:{color:"blue",radius:cs,eyeAngle:w[7](1),x:w[1][1].GetPosition().x,y:w[1][1].GetPosition().y}}),{c(){D=Xt("svg"),m=Xt("g"),gi(U.$$.fragment),gi(b.$$.fragment),k=Xt("circle"),q=Xt("rect"),J=Xt("rect"),ut=Xt("style"),yt=xi(`.score {
      font: bold 30px sans-serif;
    }
  `),dt=Xt("text"),At=xi(j),xt=Xt("text"),Ht=xi(St),N(k,"fill","yellow"),N(k,"cx",K=w[0].GetPosition().x),N(k,"cy",ht=w[0].GetPosition().y),N(k,"r",Un),N(q,"fill","gray"),N(q,"width",Xs),N(q,"height",Pi),N(q,"x",-Xs/2),N(q,"y","0"),N(J,"fill","gray"),N(J,"width",Js),N(J,"height",us),N(J,"x",-Js/2),N(J,"y",-us),N(m,"transform",`
      translate(`+w[3]/2+" "+w[4]+`)
      scale(`+w[3]/Mi+" "+-w[3]/Mi+`)
      translate(0 `+us+`)
    `),N(dt,"x",qs),N(dt,"y",qs),N(dt,"fill","red"),N(dt,"class","score"),N(xt,"x",w[3]-qs),N(xt,"y",qs),N(xt,"fill","blue"),N(xt,"class","score"),N(D,"class","game"),Si(D,"width",mt,!1),Si(D,"height",st,!1),Si(D,"marginLeft","10px",!1)},m(rt,Lt){Jn(rt,D,Lt),Nt(D,m),js(U,m,null),js(b,m,null),Nt(m,k),Nt(m,q),Nt(m,J),Nt(D,ut),Nt(ut,yt),Nt(D,dt),Nt(dt,At),Nt(D,xt),Nt(xt,Ht),Gt=!0,$t||(Me=[Rn(Nn,"keydown",w[6]),Rn(Nn,"keyup",w[5])],$t=!0)},p(rt,[Lt]){const xe={};Lt&2&&(xe.x=rt[1][0].GetPosition().x),Lt&2&&(xe.y=rt[1][0].GetPosition().y),U.$set(xe);const Se={};Lt&2&&(Se.x=rt[1][1].GetPosition().x),Lt&2&&(Se.y=rt[1][1].GetPosition().y),b.$set(Se),(!Gt||Lt&1&&K!==(K=rt[0].GetPosition().x))&&N(k,"cx",K),(!Gt||Lt&1&&ht!==(ht=rt[0].GetPosition().y))&&N(k,"cy",ht),(!Gt||Lt&4)&&j!==(j=rt[2][0]+"")&&kn(At,j),(!Gt||Lt&4)&&St!==(St=rt[2][1]+"")&&kn(Ht,St)},i(rt){Gt||(Ns(U.$$.fragment,rt),Ns(b.$$.fragment,rt),Gt=!0)},o(rt){wi(U.$$.fragment,rt),wi(b.$$.fragment,rt),Gt=!1},d(rt){rt&&Gi(D),Os(U),Os(b),$t=!1,ps(Me)}}}const qs=50,Js=30,Mi=40,cs=1.8,jn=20,va=1,Un=.3,ba=.4,ms=.8,Pi=1.5,us=.1,Xs=.15,vi=10;function Va(w,D,m){const U=[{left:"q",jump:"z",right:"d"},{left:"ArrowLeft",jump:"ArrowUp",right:"ArrowRight"}],b=.9*window.innerWidth,k=.9*window.innerHeight,K=30/3.6,ht=.8*Js/2,q={x:ht,y:5,vy:5},J={timeStep:1/60,velocityIterations:6,positionIterations:2},ut=[{jump:!1,dir:0},{jump:!1,dir:0}],yt=new Et.exports.b2Vec2(0,-vi),dt=new Et.exports.b2World(yt);{const Y=new Et.exports.b2BodyDef;Y.position.Set(0,-us/2),Y.userData={kind:"GROUND"};const Q=dt.CreateBody(Y),it=new Et.exports.b2PolygonShape;it.SetAsBox(Mi*5,us/2),Q.CreateFixture(it,0)}const j=function(Y){st=Y,mt[0].SetPositionXY(-ht,0),mt[1].SetPositionXY(ht,0),St.SetAngularVelocity(0),St.SetLinearVelocity({x:0,y:q.vy}),St.SetPositionXY((Y?1:-1)*q.x,q.y),rt=!1},At=function(Y){for(let Q=0;Q<2;Q++)Y.key==U[Q].jump&&(ut[Q].jump=!1),(Y.key==U[Q].left||Y.key==U[Q].right)&&(ut[Q].dir=0)},xt=function(Y){for(let Q=0;Q<2;Q++)Y.key==U[Q].jump&&(ut[Q].jump=!0),Y.key==U[Q].left&&(ut[Q].dir=-1),Y.key==U[Q].right&&(ut[Q].dir=1);Y.key=="r"&&(m(2,$t=[0,0]),j(Math.round(Math.random()))),Y.key=="p"&&(rt=!rt)};let St;{const Y=new Et.exports.b2BodyDef;Y.type=Et.exports.b2BodyType.b2_dynamicBody,Y.position.Set(q.x,q.y),Y.userData={kind:"BALL"},Y.linearDamping=ba,St=dt.CreateBody(Y);const Q=new Et.exports.b2CircleShape;Q.Set({x:0,y:0},Un);const it=new Et.exports.b2FixtureDef;it.shape=Q,it.density=1,it.restitution=ms,it.friction=ms,St.CreateFixture(it)}{const Y=new Et.exports.b2BodyDef;Y.position.Set(0,Pi/2);const Q=dt.CreateBody(Y),it=new Et.exports.b2PolygonShape;it.SetAsBox(Xs/2,Pi/2);const Dt=new Et.exports.b2FixtureDef;Dt.shape=it,Dt.restitution=ms,Dt.friction=ms,Q.CreateFixture(Dt)}function Ht(Y,Q){const it=new Et.exports.b2BodyDef;it.type=Et.exports.b2BodyType.b2_kinematicBody,it.position.Set(Y,0),it.userData={kind:"PLAYER",playerIndex:Q};const Dt=dt.CreateBody(it),Qt=new Et.exports.b2ChainShape,_e=[];for(let Ft=0;Ft<jn;Ft++){const Pe=Math.PI*(1-Ft/(jn-1));_e.push({x:Math.cos(Pe)*cs,y:Math.sin(Pe)*cs})}Qt.CreateLoop(_e);const vt=new Et.exports.b2FixtureDef;return vt.shape=Qt,vt.density=1,vt.restitution=ms,Dt.CreateFixture(vt),Dt}let mt=[Ht(-ht,0),Ht(ht,1)],st=0,Gt=Math.round(Math.random()),$t=[0,0];class Me extends Et.exports.b2ContactListener{BeginContact(Q){const it=[Q.m_fixtureA.m_body,Q.m_fixtureB.m_body],Dt=it.find(vt=>{var Ft;return((Ft=vt.m_userData)==null?void 0:Ft.kind)=="PLAYER"}),Qt=it.find(vt=>{var Ft;return((Ft=vt.m_userData)==null?void 0:Ft.kind)=="BALL"}),_e=it.find(vt=>{var Ft;return((Ft=vt.m_userData)==null?void 0:Ft.kind)=="GROUND"});if(Dt&&Qt&&(st=Dt.m_userData.playerIndex),Qt&&_e){const vt=St.GetPosition().x>0?1:0,Pe=Math.abs(St.GetPosition().x)>Js/2?1-st:1-vt;m(2,$t[Pe]++,$t),Gt=1-Pe}}}dt.SetContactListener(new Me);let rt=!1,Lt=performance.now()/1e3;const xe=cs+Xs/2;function Se(Y){const Q=mt[Y],it=Y==0?-1:1;let Dt,Qt,_e=null,vt=null;if(Q.GetPosition().x*it<xe?(Dt=0,_e=xe*it):Dt=ut[Y].dir*K,Q.GetPosition().y<0&&(vt=0),Q.GetPosition().y<=0?Qt=ut[Y].jump?Math.sqrt(2*vi*va):0:Qt=Q.GetLinearVelocity().y-J.timeStep*vi,_e!==null||vt!==null){const Ft=Q.GetPosition();Q.SetPosition({x:_e!==null?_e:Ft.x,y:vt!==null?vt:Ft.y})}Q.SetLinearVelocity({x:Dt,y:Qt})}function jt(){const Y=Math.floor((performance.now()/1e3-Lt)/J.timeStep);Lt+=Y*J.timeStep;for(let Q=0;Q<Y;Q++)Se(0),Se(1),dt.Step(J.timeStep,J.velocityIterations,J.positionIterations),m(0,St),m(1,mt)}return ca(async()=>{let Y=requestAnimationFrame(function Q(){rt?Lt=performance.now()/1e3:(Gt!==null&&(j(Gt),Gt=null),jt()),Y=requestAnimationFrame(Q)});return()=>cancelAnimationFrame(Y)}),[St,mt,$t,b,k,At,xt,Y=>{const Q=mt[Y].GetPosition(),it=St.GetPosition(),Dt=Q.x==it.x?270:180/Math.PI*Math.atan(-(Q.y-it.y)/(Q.x-it.x)),Qt=it.x<Q.x?180:0;return 360+Qt-Dt}]}class wa extends Fi{constructor(D){super(),Di(this,D,Va,Ca,Ii,{})}}function ga(w){let D,m;return D=new wa({}),{c(){gi(D.$$.fragment)},m(U,b){js(D,U,b),m=!0},p:ds,i(U){m||(Ns(D.$$.fragment,U),m=!0)},o(U){wi(D.$$.fragment,U),m=!1},d(U){Os(D,U)}}}class Ma extends Fi{constructor(D){super(),Di(this,D,null,ga,Ii,{})}}new Ma({target:document.getElementById("app")});
